<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Track your daily puzzle games, build streaks, compete with friends, and never miss a Wordle again!">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Game Shelf">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Game Shelf">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Game Shelf - Daily Puzzle Tracker">
    <meta property="og:description" content="Track your daily puzzle games, build streaks, and compete with friends!">
    <meta property="og:image" content="icons/og-image.png">
    
    <!-- Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
    <title>Game Shelf - Your Daily Puzzle Hub</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2940;
            --bg-hover: #2a3a5a;
            --accent-gold: #f4d35e;
            --accent-green: #4ade80;
            --accent-blue: #60a5fa;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-orange: #fb923c;
            --accent-pink: #f472b6;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #6b7280;
        }

        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #e8e8ed;
            --bg-card: #ffffff;
            --bg-hover: #f0f0f5;
            --accent-gold: #d4a012;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a5a;
            --text-muted: #8b8b9a;
        }

        body.light-mode .game-card,
        body.light-mode .community-card,
        body.light-mode .discover-card,
        body.light-mode .review-card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.light-mode .header h1 {
            background: linear-gradient(135deg, #d4a012, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
        }

        body.light-mode .share-preview {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
            border-color: var(--accent-purple);
        }

        body.light-mode .nav-tab.active {
            background: var(--accent-gold);
            color: #fff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--bg-secondary);
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .menu-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        /* User Account */
        .user-account {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sign-in-btn {
            background: var(--accent-gold);
            border: none;
            color: #000;
            padding: 8px 14px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sign-in-btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .header-right {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Currency Badges in Header */
        .currency-badges {
            display: flex;
            gap: 6px;
        }
        
        .currency-badge {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 5px 8px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            border: 1px solid transparent;
        }
        
        .token-badge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(167, 139, 250, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.4);
            color: #a78bfa;
        }
        
        .token-badge:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(167, 139, 250, 0.25) 100%);
            transform: scale(1.05);
            border-color: #a78bfa;
        }
        
        .coin-badge {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.15) 100%);
            border-color: rgba(255, 193, 7, 0.4);
            color: var(--accent-gold);
        }

        .coin-badge:hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 152, 0, 0.25) 100%);
            transform: scale(1.05);
            border-color: var(--accent-gold);
        }
        
        .pro-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #000;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .currency-badge.earning {
            animation: coinPulse 0.5s ease;
        }

        @keyframes coinPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .coin-popup {
            position: fixed;
            top: 60px;
            right: 20px;
            background: linear-gradient(135deg, #2a2a1a 0%, #1a1a0a 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 12px 20px;
            color: var(--accent-gold);
            font-weight: 700;
            font-size: 1.1rem;
            z-index: 10000;
            animation: coinPopIn 0.5s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        @keyframes coinPopIn {
            0% { opacity: 0; transform: translateY(-20px) scale(0.8); }
            50% { transform: translateY(5px) scale(1.1); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .user-avatar-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
            padding: 0;
            background: var(--bg-secondary);
        }

        .user-avatar-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(244, 211, 94, 0.4);
        }

        .user-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sync-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            border: 2px solid var(--bg-primary);
        }

        .sync-indicator.syncing {
            background: var(--accent-orange);
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* User Profile Modal */
        .profile-section {
            text-align: center;
            padding: 20px 0;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            margin-bottom: 15px;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-email {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin: 15px 0;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .profile-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .sync-status.synced {
            color: var(--accent-green);
        }

        .sync-status.syncing {
            color: var(--accent-orange);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-gold);
            color: #000;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Bar */
        /* Hero Stats Bar */
        .hero-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .hero-goal {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .hero-goal:hover {
            background: var(--bg-hover);
        }

        .goal-ring-small {
            flex-shrink: 0;
        }

        .hero-goal-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .hero-goal-count {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .hero-goal-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .hero-stat {
            text-align: center;
            flex-shrink: 0;
        }

        .hero-stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .hero-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .hero-log-btn {
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .hero-log-btn:hover {
            background: var(--accent-gold);
            color: #000;
        }

        /* Smart Suggestion */
        .smart-suggestion {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 12px;
            padding: 12px 15px;
            margin-top: 15px;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .suggestion-content {
            flex: 1;
            min-width: 0;
        }

        .suggestion-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .suggestion-action {
            background: var(--accent-purple);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }

        .suggestion-action:hover {
            filter: brightness(1.1);
        }

        .suggestion-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
        }

        .suggestion-dismiss:hover {
            color: var(--text-primary);
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 20px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: var(--bg-hover);
        }

        .collapsible-header .section-title {
            margin: 0;
            font-size: 0.95rem;
        }

        .collapsible-chevron {
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .collapsible-chevron.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0 15px 15px;
        }

        .calendar-inner {
            padding-top: 5px;
        }

        .calendar-nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-nav-row button {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .calendar-nav-row button:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        /* Quick Log Modal */
        .quick-log-content {
            padding: 15px 0;
        }

        .quick-log-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .quick-log-content textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0 15px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-btn {
            background: var(--bg-hover);
            border: 2px dashed var(--text-muted);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .add-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Game Grid */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }

        .game-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }

        .game-card:hover {
            background: var(--bg-hover);
            transform: translateY(-3px);
        }

        .game-card.played-today {
            border-color: var(--accent-green);
        }

        .game-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        .game-card .name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .game-card .streak {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .game-card .streak.active {
            color: var(--accent-gold);
        }

        .game-card .check-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-green);
            color: #000;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .game-card .remove-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.3);
            border: none;
            color: var(--text-muted);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .game-card:hover .remove-btn {
            opacity: 1;
        }

        .game-card .remove-btn:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .game-card .settings-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.3);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-card:hover .settings-btn {
            opacity: 1;
        }

        .game-card .settings-btn:hover {
            background: var(--accent-blue);
        }

        .game-card .setup-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent-gold);
            color: #000;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .game-card:hover .setup-badge {
            display: none;
        }
        
        .game-card .tracking-source-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 0.7rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .game-card:hover .tracking-source-badge {
            opacity: 0;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-card .rating {
            margin-top: 5px;
        }

        .game-card .rating .star {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .game-card .rating .star.filled {
            color: var(--accent-gold);
        }

        /* Featured Games (Game Shelf) */
        .featured-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }

        .featured-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .featured-card:hover {
            background: var(--bg-hover);
            transform: translateY(-3px);
        }

        .featured-card.played-today {
            border-color: var(--accent-green);
        }

        .featured-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-purple);
            color: #000;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .sponsored-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-orange);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .partner-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-blue);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .featured-card .settings-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .featured-card:hover .settings-btn {
            opacity: 1;
        }

        .featured-card .settings-btn:hover {
            background: var(--accent-blue);
        }

        .featured-card .setup-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-gold);
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .featured-card:hover .setup-badge {
            display: none;
        }
        
        .featured-card .tracking-source-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.8rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .featured-card:hover .tracking-source-badge {
            opacity: 0;
        }
        
        .featured-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .featured-card .name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .featured-card .streak {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .featured-card .streak.active {
            color: var(--accent-gold);
        }

        /* New Game Spotlight */
        .spotlight-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            border: 2px solid var(--accent-orange);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .spotlight-card .icon {
            font-size: 4rem;
        }

        .spotlight-card .info {
            flex: 1;
        }

        .spotlight-card .badge {
            background: var(--accent-orange);
            color: #000;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 8px;
        }

        .spotlight-card h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .spotlight-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .spotlight-card .btn {
            padding: 10px 20px;
        }

        /* Community Links */
        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .community-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .community-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .community-card .icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .community-card.discord .icon { background: #5865F2; }
        .community-card.reddit .icon { background: #FF4500; }
        .community-card.twitter .icon { background: #1DA1F2; }
        .community-card.facebook .icon { background: #1877F2; }
        .community-card.youtube .icon { background: #FF0000; }
        .community-card.tiktok .icon { background: #000000; }
        .community-card.threads .icon { background: #000000; }
        .community-card.bluesky .icon { background: #0085FF; }
        .community-card.mastodon .icon { background: #6364FF; }

        /* Friends & Leaderboard */
        .friends-signin-prompt {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .signin-prompt-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .friends-signin-prompt h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .friends-signin-prompt p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .leaderboard-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            gap: 12px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item.current-user {
            background: rgba(255, 215, 0, 0.1);
        }

        .leaderboard-rank {
            font-weight: 800;
            font-size: 1.1rem;
            width: 30px;
            text-align: center;
            color: var(--text-muted);
        }

        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }

        .leaderboard-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .leaderboard-avatar.placeholder {
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }

        .leaderboard-score {
            font-weight: 800;
            color: var(--accent-gold);
            font-size: 1.1rem;
        }

        .leaderboard-score span {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .leaderboard-empty, .activity-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .activity-text strong {
            color: var(--accent-gold);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .activity-game-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Friends List */
        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .friend-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .friend-status.active {
            color: var(--accent-green);
        }

        .friends-count {
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .add-friend-btn {
            width: 100%;
        }

        /* Add Friend Modal */
        .friend-code-display {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .friend-code-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .friend-code {
            font-size: 1.8rem;
            font-weight: 800;
            font-family: monospace;
            color: var(--accent-gold);
            letter-spacing: 2px;
        }

        .friend-code-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: monospace;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .friend-code-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Brain Battle Section */
        .battle-signin-prompt {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .battle-signin-prompt h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .battle-signin-prompt p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Battle Quick Actions */
        .battle-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            border-color: var(--accent-gold);
            background: var(--bg-hover);
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, #1a3a1a 0%, #0d2a0d 100%);
            border-color: var(--accent-green);
        }

        .quick-action-btn.primary:hover {
            background: linear-gradient(135deg, #2a4a2a 0%, #1d3a1d 100%);
        }

        /* Legacy battle-actions (keeping for backwards compatibility) */
        .battle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .battle-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 18px 12px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--bg-hover);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .battle-action-btn:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        .battle-action-btn .action-icon {
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

        .battle-action-btn .action-text {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .battle-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--bg-hover);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .battle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .battle-card-header {
            height: 80px;
            background: linear-gradient(135deg, #4a90a4 0%, #2d5a6b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            position: relative;
        }
        
        .battle-card-header.challenge {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
        }

        .battle-card-header.group {
            background: linear-gradient(135deg, #4a90a4 0%, #2d5a6b 100%);
        }
        
        .battle-card-header.open {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a0072 100%);
        }

        .battle-card-header.tournament {
            background: linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%);
        }

        .battle-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-green);
            color: #fff;
            font-size: 0.65rem;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .battle-badge.live {
            background: #e53935;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .battle-card-content {
            padding: 15px;
        }

        .battle-card-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .battle-card-desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
            margin-bottom: 10px;
        }

        .battle-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .battle-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .battle-leaderboard {
            border-top: 1px solid var(--bg-hover);
            padding-top: 12px;
        }

        .battle-leaderboard-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
        }

        .battle-rank {
            width: 24px;
            text-align: center;
            font-weight: 700;
        }

        .battle-participant-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .battle-participant-name {
            flex: 1;
            font-size: 0.85rem;
        }

        .battle-participant-score {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .you-badge {
            background: rgba(255, 193, 7, 0.2);
            color: var(--accent-gold);
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .battle-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .battle-empty .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .battle-empty .empty-hint {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .tournament-card {
            background: linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%);
            border: 1px solid #2a5a2a;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tournament-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tournament-icon {
            font-size: 1.5rem;
        }

        .tournament-title {
            font-weight: 700;
        }

        .tournament-subtitle {
            color: var(--accent-green);
            font-size: 0.75rem;
        }

        .tournament-stats {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .tournament-stat {
            text-align: center;
        }

        .tournament-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        .tournament-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .tournament-progress {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .tournament-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, #8bc34a 100%);
        }

        .status-alive {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(76, 175, 80, 0.2);
            color: var(--accent-green);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-eliminated {
            background: rgba(229, 57, 53, 0.2);
            color: #e53935;
        }

        /* Battle Details Modal */
        .battle-details-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-stat {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 10px;
        }

        .detail-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-value.active {
            color: var(--accent-green);
        }

        .detail-value.completed {
            color: var(--text-muted);
        }

        .battle-details-leaderboard {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .detail-leaderboard-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .detail-leaderboard-row:last-child {
            border-bottom: none;
        }

        .detail-leaderboard-row.current-user {
            background: rgba(255, 193, 7, 0.1);
        }

        .detail-leaderboard-row.winner {
            background: rgba(76, 175, 80, 0.15);
        }

        .detail-rank {
            width: 30px;
            text-align: center;
            font-weight: 700;
        }

        .detail-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .detail-name {
            flex: 1;
        }

        .detail-score {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .winner-badge {
            background: var(--accent-green);
            color: #fff;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .invite-card .battle-card-header {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%) !important;
        }

        /* Tournament Modal */
        .tournament-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tournament-tab {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tournament-tab:hover {
            background: var(--bg-hover);
        }

        .tournament-tab.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }

        .tournaments-list-container {
            max-height: 60vh;
            overflow-y: auto;
        }

        .tournament-list-card {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid var(--bg-hover);
            transition: all 0.2s;
        }

        .tournament-list-card:hover {
            border-color: var(--accent-gold);
        }

        .tournament-list-card.joined {
            border-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .tournament-list-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tournament-list-icon {
            font-size: 1.8rem;
        }

        .tournament-list-info {
            flex: 1;
        }

        .tournament-list-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .tournament-list-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .tournament-list-game {
            font-size: 1.5rem;
        }

        .tournament-list-stats {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-top: 1px solid var(--bg-hover);
            border-bottom: 1px solid var(--bg-hover);
            margin-bottom: 12px;
        }

        .tl-stat {
            text-align: center;
        }

        .tl-stat-value {
            display: block;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .tl-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .tournament-list-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spots-warning {
            color: #ff9800;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tournament-detail-banner {
            background: linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .tournament-detail-banner.elimination {
            background: linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%);
        }

        .tournament-detail-banner.points {
            background: linear-gradient(135deg, #1a1a3a 0%, #0a0a2a 100%);
        }

        .tdb-prize-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .tdb-prize-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .prize-distribution {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .prize-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .prize-row:last-child {
            border-bottom: none;
        }

        .prize-place {
            color: var(--text-primary);
        }

        .prize-amount {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .tournament-rules {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tournament-rules p {
            margin-bottom: 8px;
        }

        .tournament-rules p:last-child {
            margin-bottom: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* Merch Store */
        .merch-balance-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 100%);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .merch-balance-amount {
            font-weight: 700;
            color: var(--accent-gold);
            flex: 1;
        }

        .merch-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .merch-tab {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .merch-tab:hover {
            background: var(--bg-hover);
        }

        .merch-tab.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }

        .merch-catalog {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-bottom: 10px;
        }

        .merch-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--bg-hover);
            transition: all 0.2s;
        }

        .merch-card:hover {
            border-color: var(--accent-gold);
        }

        .merch-card.owned {
            border-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .merch-card.unaffordable {
            opacity: 0.6;
        }

        .merch-image {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 8px;
        }

        .merch-info {
            text-align: center;
        }

        .merch-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .merch-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .merch-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .merch-price {
            font-weight: 700;
            color: var(--accent-gold);
            font-size: 0.85rem;
        }

        .merch-price.too-expensive {
            color: var(--text-muted);
        }

        .merch-owned {
            color: var(--accent-green);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .merch-footer-note {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: 10px;
            border-top: 1px solid var(--bg-hover);
            margin-top: 10px;
        }

        .merch-section-header {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 10px 0;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .merch-section-subtitle {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-muted);
        }

        .merch-earn-hint {
            font-size: 0.7rem;
            color: var(--accent-gold);
            font-weight: 500;
        }

        .reward-card {
            border-style: dashed;
            border-color: var(--bg-hover);
        }

        .reward-card:not(.owned) {
            opacity: 0.8;
        }

        .reward-card.owned {
            border-style: solid;
            border-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .popular-badge {
            background: var(--accent-gold);
            color: #000;
            font-size: 0.55rem;
            padding: 2px 5px;
            border-radius: 6px;
            font-weight: 700;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* Merch Details Modal */
        .merch-detail-image {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .merch-detail-info {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .mdi-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .mdi-row:last-child {
            border-bottom: none;
        }

        .mdi-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .mdi-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .mdi-value.can-afford {
            color: var(--accent-green);
        }

        .mdi-value.cannot-afford {
            color: #e53935;
        }

        .shipping-note {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Goody Tier Card Styles */
        .merch-card.goody-tier-card {
            position: relative;
            border: 2px solid var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(244, 211, 94, 0.05) 100%);
        }

        .tier-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .goody-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 8px 0;
        }

        .goody-brand strong {
            color: var(--accent-gold);
        }

        /* Gift Tier Modal Styles */
        .gift-tier-modal {
            max-height: 85vh;
            overflow-y: auto;
        }

        .gift-tier-modal .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 10;
        }

        .gift-tier-modal .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .category-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .cat-icon {
            font-size: 1rem;
        }

        .cat-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .featured-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 10px;
        }

        .fi-icon {
            font-size: 1.5rem;
            min-width: 30px;
            text-align: center;
        }

        .fi-info {
            flex: 1;
            min-width: 0;
        }

        .fi-name {
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fi-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .more-items-note {
            text-align: center;
            font-size: 0.8rem;
            color: var(--accent-gold);
            margin-top: 12px;
            font-weight: 600;
        }

        .hiw-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hiw-step {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .step-num {
            width: 24px;
            height: 24px;
            background: var(--accent-gold);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .tier-pricing {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .tp-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .tp-row:last-child {
            border-bottom: none;
        }

        .tp-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .tp-value {
            font-weight: 700;
        }

        .tp-row.can-afford .tp-value {
            color: var(--accent-green);
        }

        .tp-row.cannot-afford .tp-value {
            color: #e53935;
        }

        .btn-large {
            padding: 14px 20px;
            font-size: 1rem;
        }

        @media (max-width: 500px) {
            .featured-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Order Confirmation */
        .confirmation-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .order-summary {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .order-item-preview {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .order-item-name {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .order-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .order-status.pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .confirmation-note {
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
        }

        .confirmation-note ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }

        .confirmation-note li {
            margin-bottom: 5px;
        }

        /* Orders List */
        .order-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .order-card-image {
            font-size: 1.8rem;
        }

        .order-card-info {
            flex: 1;
        }

        .order-card-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .order-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .order-card-status {
            font-size: 0.75rem;
            color: var(--accent-green);
        }

        /* Create Battle Modal */
        .battle-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .battle-type-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .battle-type-btn:hover {
            border-color: var(--accent-gold);
        }

        .battle-type-btn.active {
            border-color: var(--accent-gold);
            background: rgba(255, 193, 7, 0.1);
        }

        .battle-type-btn .type-icon {
            font-size: 1.5rem;
        }

        .battle-type-btn .type-label {
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .game-checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .game-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .game-checkbox input {
            accent-color: var(--accent-gold);
        }

        .stakes-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stakes-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
        }

        .stakes-option input {
            accent-color: var(--accent-gold);
        }

        .wager-input {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wager-input input {
            flex: 1;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-hover);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .wager-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .friend-select-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .friend-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--bg-hover);
        }

        .friend-select-item:last-child {
            border-bottom: none;
        }

        .friend-select-item:hover {
            background: var(--bg-hover);
        }

        .friend-select-item.selected {
            background: rgba(255, 193, 7, 0.15);
        }

        .friend-select-item img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        /* Extension Modal */
        .extension-browser-tabs {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .ext-tab {
            flex: 1;
            min-width: 60px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ext-tab:hover {
            background: var(--bg-hover);
        }

        .ext-tab.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }

        .ext-instructions {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
        }

        .ext-step {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .ext-step:last-child {
            margin-bottom: 0;
        }

        .ext-step-num {
            width: 28px;
            height: 28px;
            background: var(--accent-purple);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .ext-step-content {
            flex: 1;
        }

        .ext-step-content strong {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .ext-step-content p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 4px 0 0 0;
        }

        .ext-step-content code {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-gold);
        }

        .community-card .info h4 {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .community-card .info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Reviews Section */
        .review-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .review-header .icon {
            font-size: 2.5rem;
        }

        .review-header .info h4 {
            font-size: 1.1rem;
        }

        .review-header .stars {
            color: var(--accent-gold);
        }

        .review-notes {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-height: 60px;
        }

        .review-notes:empty::before {
            content: 'No notes yet. Click to add...';
            color: var(--text-muted);
            font-style: italic;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Discover Grid */
        .discover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .discover-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .discover-card:hover {
            background: var(--bg-hover);
        }

        .discover-card .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .discover-card .icon {
            font-size: 2rem;
        }

        .discover-card .name {
            font-weight: 700;
        }

        .discover-card .source {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .discover-card .description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .discover-card .tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .discover-card .tag {
            background: var(--bg-secondary);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal h2 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Game List in Registration */
        .game-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .game-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .game-list-item:hover {
            background: var(--bg-hover);
        }

        .game-list-item.selected {
            background: var(--bg-hover);
            border: 2px solid var(--accent-green);
        }

        .game-list-item .icon {
            font-size: 1.5rem;
        }

        .game-list-item .info {
            flex: 1;
        }

        .game-list-item .name {
            font-weight: 600;
        }

        .game-list-item .source {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .game-list-item .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--text-muted);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: all 0.2s;
        }

        .game-list-item.selected .checkbox {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        /* Form Inputs */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Star Rating Input */
        .star-rating-input {
            display: flex;
            gap: 5px;
        }

        .star-rating-input .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating-input .star:hover,
        .star-rating-input .star.filled {
            color: var(--accent-gold);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: #000;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Wallet Modal */
        .wallet-dual-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        
        .wallet-currency-card {
            position: relative;
            padding: 16px;
            border-radius: 14px;
            text-align: center;
        }
        
        .wallet-currency-card.token-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(167, 139, 250, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .wallet-currency-card.coin-card {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .wallet-currency-card .currency-icon {
            font-size: 1.8rem;
            margin-bottom: 6px;
        }
        
        .wallet-currency-card .currency-amount {
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .token-card .currency-amount {
            color: #a78bfa;
        }
        
        .coin-card .currency-amount {
            color: var(--accent-gold);
        }
        
        .wallet-currency-card .currency-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .currency-badge-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        
        .currency-badge-tag.free {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }
        
        .currency-badge-tag.premium {
            background: rgba(255, 193, 7, 0.3);
            color: var(--accent-gold);
        }
        
        .wallet-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .wallet-actions .btn {
            flex: 1;
        }
        
        .wallet-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 8px;
        }
        
        .earn-item.highlight {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
        }
        
        .earn-item.highlight .earn-action {
            color: var(--accent-gold);
            font-weight: 600;
        }
        
        .earn-item.highlight .earn-amount {
            color: var(--accent-gold);
        }

        .wallet-balance-display {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 100%);
            border-radius: 16px;
            margin: 15px 0;
        }

        .wallet-balance-amount {
            font-size: 3rem;
            font-weight: 800;
            color: var(--accent-gold);
            text-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
        }

        .wallet-balance-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .wallet-section {
            margin-top: 20px;
        }

        .wallet-section-title {
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .earn-list {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .earn-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .earn-item:last-child {
            border-bottom: none;
        }

        .earn-action {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .earn-amount {
            color: var(--accent-green);
            font-weight: 700;
        }

        .transaction-list {
            background: var(--bg-secondary);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-reason {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .transaction-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1rem;
        }

        .transaction-amount.positive {
            color: var(--accent-green);
        }

        .transaction-amount.negative {
            color: var(--accent-red);
        }

        .transaction-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Buy Coins Button */
        .buy-coins-btn {
            width: 100%;
            margin-bottom: 15px;
        }

        /* Age Verification */
        .age-verification-notice {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .age-notice-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .age-verification-notice p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .age-verify-buttons {
            display: flex;
            gap: 10px;
        }
        
        .age-verify-buttons .btn {
            flex: 1;
        }

        /* New Coin Packs */
        .coin-packs-new {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .coin-pack-card {
            position: relative;
            padding: 16px 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .coin-pack-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }
        
        .coin-pack-card.popular {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
        }
        
        .coin-pack-card.best-value {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
        }
        
        .pack-popular-tag, .pack-best-tag {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        .pack-popular-tag {
            background: var(--accent-gold);
            color: #000;
        }
        
        .pack-best-tag {
            background: var(--accent-green);
            color: #fff;
        }
        
        .pack-name {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        
        .pack-coins-display {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .pack-price-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .pack-bonus {
            font-size: 0.7rem;
            color: var(--accent-green);
            margin-top: 4px;
        }
        
        /* Subscription Promo */
        .subscription-promo {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(167, 139, 250, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .subscription-promo:hover {
            border-color: #a78bfa;
            transform: translateY(-1px);
        }
        
        .promo-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .promo-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #000;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .promo-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .promo-arrow {
            color: #a78bfa;
            font-size: 1.2rem;
        }
        
        /* Subscription Modal */
        .subscription-benefits {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-hover);
        }
        
        .benefit-item:last-child {
            border-bottom: none;
        }
        
        .benefit-icon {
            font-size: 1.2rem;
        }
        
        .benefit-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .subscription-tiers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .sub-tier-card {
            position: relative;
            padding: 20px 15px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .sub-tier-card:hover {
            border-color: var(--accent-gold);
        }
        
        .sub-tier-card.annual {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
        }
        
        .sub-save-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: #fff;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        .sub-tier-name {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .sub-tier-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .sub-tier-price span {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-muted);
        }
        
        .sub-tier-detail {
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-top: 6px;
        }
        
        .subscription-note {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Game Tracking Settings Modal */
        #game-tracking-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #game-tracking-modal .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tracking-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--bg-hover);
        }
        
        .tracking-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .tracking-section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .tracking-section-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .tracking-source-options,
        .entry-method-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .tracking-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tracking-option:hover {
            background: var(--bg-hover);
        }
        
        .tracking-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .tracking-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tracking-option-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .tracking-option.selected .tracking-option-radio {
            border-color: var(--accent-blue);
        }
        
        .tracking-option.selected .tracking-option-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-blue);
            border-radius: 50%;
        }
        
        .tracking-option-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        .tracking-option-content {
            flex: 1;
        }
        
        .tracking-option-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .tracking-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .tracking-option .coming-soon-tag {
            font-size: 0.6rem;
            background: var(--accent-gold);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        .tracking-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .tracking-toggle input {
            display: none;
        }
        
        .toggle-slider {
            width: 44px;
            height: 24px;
            background: var(--bg-hover);
            border-radius: 12px;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
        }
        
        .tracking-toggle input:checked + .toggle-slider {
            background: var(--accent-green);
        }
        
        .tracking-toggle input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }
        
        .tracking-toggle input:disabled + .toggle-slider {
            opacity: 0.5;
        }
        
        .toggle-label {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .pro-feature-tag {
            font-size: 0.6rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        .tracking-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        /* Quick Source Setup Buttons */
        .quick-source-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .quick-source-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-source-btn:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }
        
        .quick-source-btn .qsb-icon {
            font-size: 1.5rem;
        }
        
        .quick-source-btn .qsb-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Legacy Coin Packs (keep for compatibility) */
        .coin-packs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .coin-pack {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .coin-pack:hover {
            border-color: var(--accent-gold);
            background: var(--bg-hover);
        }

        .coin-pack.popular {
            border-color: var(--accent-gold);
        }

        .coin-pack.best-value {
            border-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .pack-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: var(--accent-gold);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .coin-pack.best-value .pack-badge {
            background: var(--accent-green);
            color: #fff;
        }

        .pack-coins {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pack-price {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .coin-value-note {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        .coin-value-note p {
            margin: 0;
        }

        .coin-value-note p:first-child {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-secondary);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 15px;
                padding-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header .tagline {
                font-size: 0.85rem;
            }

            .coin-badge {
                padding: 6px 10px;
            }

            .wallet-balance {
                font-size: 0.8rem;
            }

            .header-right {
                gap: 8px;
            }

            .hero-stats {
                gap: 10px;
                padding: 10px;
            }

            .hero-goal-count {
                font-size: 1.2rem;
            }

            .hero-stat-value {
                font-size: 1.1rem;
            }

            .hero-log-btn {
                width: 40px;
                height: 40px;
            }

            .game-grid, .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .game-card {
                padding: 15px 10px;
            }

            .game-card .icon {
                font-size: 2rem;
            }

            .game-card .name {
                font-size: 0.85rem;
            }

            .nav-tabs {
                gap: 3px;
                padding: 4px;
            }

            .nav-tab {
                padding: 10px 8px;
                font-size: 0.75rem;
                min-width: 70px;
            }

            .section-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .section-title {
                font-size: 0.95rem;
            }

            .add-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .spotlight-card {
                flex-direction: column;
                text-align: center;
                padding: 20px 15px;
            }

            .spotlight-card .icon {
                font-size: 2.5rem;
                margin-bottom: 10px;
            }

            .community-grid {
                grid-template-columns: 1fr;
            }

            .share-preview {
                padding: 15px;
            }

            .share-stats-row {
                gap: 15px;
            }

            .share-stat-value {
                font-size: 1.4rem;
            }

            .share-games-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .share-buttons {
                flex-direction: column;
            }

            .share-buttons .btn {
                min-width: 100%;
            }

            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }

            .discover-grid {
                gap: 10px;
            }

            .discover-card {
                padding: 12px;
            }

            .discover-card .icon {
                font-size: 1.8rem;
            }

            .review-card {
                padding: 15px;
            }

            .chat-messages {
                max-height: 250px;
            }

            .featured-badge {
                font-size: 0.55rem;
                padding: 2px 5px;
            }

            /* Settings menu full width on mobile */
            .settings-menu {
                max-width: 100%;
            }

            /* Insights mobile */
            .insights-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .insight-card {
                padding: 15px;
            }

            .insight-value {
                font-size: 1.5rem;
            }

            .wrapped-section {
                padding: 20px;
            }

            .wrapped-title {
                font-size: 1.4rem;
            }

            .wrapped-stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .wrapped-stat-value {
                font-size: 1.4rem;
            }

            .daily-goal-section {
                padding: 15px;
            }

            .daily-goal-progress {
                gap: 12px;
            }

            .daily-goal-ring {
                width: 70px;
                height: 70px;
            }

            .daily-goal-count {
                font-size: 1.3rem;
            }

            .daily-goal-message {
                font-size: 1rem;
            }

            .game-ranking-list {
                font-size: 0.9rem;
            }

            .goal-options {
                grid-template-columns: repeat(2, 1fr);
            }

            /* User account mobile */
            .sign-in-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            .user-avatar-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 380px) {
            .game-grid, .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .game-card {
                padding: 12px 8px;
            }

            .game-card .icon {
                font-size: 1.8rem;
            }

            .game-card .name {
                font-size: 0.8rem;
            }

            .nav-tab {
                padding: 10px 8px;
                font-size: 0.7rem;
                min-height: 44px;
            }

            .hero-stats {
                gap: 8px;
                padding: 8px;
            }

            .goal-ring-small {
                width: 50px;
                height: 50px;
            }

            .hero-goal-count {
                font-size: 1rem;
            }

            .hero-stat-value {
                font-size: 1rem;
            }
        }

        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            .game-card {
                transition: transform 0.1s;
            }

            .game-card:active {
                transform: scale(0.98);
            }

            .nav-tab:active {
                opacity: 0.8;
            }

            .btn:active {
                transform: scale(0.98);
            }

            /* Ensure minimum touch target size */
            button, .btn, .nav-tab, .add-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .collapsible-header {
                min-height: 52px;
            }

            .calendar-nav-row button {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }

        /* RSS List */
        .rss-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rss-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rss-item:hover {
            background: var(--bg-hover);
        }

        .rss-icon {
            font-size: 1.5rem;
        }

        .rss-info {
            flex: 1;
        }

        .rss-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .rss-url {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .copy-btn {
            background: var(--bg-hover);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .rss-item:hover .copy-btn {
            background: var(--accent-gold);
            color: #000;
        }

        /* Chat/Discussion */
        .chat-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            background: var(--bg-secondary);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-message:last-child {
            margin-bottom: 0;
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-message-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .chat-message-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message:hover .chat-message-delete {
            opacity: 1;
        }

        .chat-message-delete:hover {
            color: var(--accent-red);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-hover);
        }

        .chat-input-container input {
            flex: 1;
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .chat-input-container input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .chat-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Calendar Heatmap */
        .calendar-section {
            margin-top: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 4px 0;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 1;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
        }

        .calendar-day.level-0 { background: var(--bg-card); }
        .calendar-day.level-1 { background: rgba(74, 222, 128, 0.25); }
        .calendar-day.level-2 { background: rgba(74, 222, 128, 0.5); }
        .calendar-day.level-3 { background: rgba(74, 222, 128, 0.75); }
        .calendar-day.level-4 { background: var(--accent-green); color: #000; }

        .calendar-day.today {
            border: 2px solid var(--accent-gold);
        }

        .calendar-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .calendar-month-label {
            text-align: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .calendar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .calendar-day:hover .calendar-tooltip {
            opacity: 1;
        }

        /* Share Success Modal */
        .share-success-modal {
            text-align: center;
            max-width: 380px;
        }

        /* Enhanced Share Screen */
        .enhanced-share-screen {
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .enhanced-share-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .enhanced-score-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-green), #2d8a4e);
            color: white;
            padding: 15px 30px;
            border-radius: 16px;
            margin: 10px 0;
        }

        .enhanced-score-badge.great {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
        }

        .enhanced-score-badge.amazing {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .enhanced-score-game {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .enhanced-score-result {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-top: 5px;
        }

        .enhanced-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            text-align: left;
        }

        .enhanced-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .enhanced-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .enhanced-stat-row .label {
            color: var(--text-secondary);
        }

        .enhanced-stat-row .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .enhanced-stat-row .value.win {
            color: var(--accent-green);
        }

        .enhanced-stat-row .value.lose {
            color: var(--accent-red);
        }

        .enhanced-friend-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .enhanced-friend-row:last-child {
            border-bottom: none;
        }

        .enhanced-friend-row.you {
            background: rgba(102, 126, 234, 0.1);
            margin: 0 -15px;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .enhanced-friend-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .enhanced-friend-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .enhanced-suggestion {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .enhanced-suggestion-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .enhanced-suggestion-text {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .enhanced-suggestion-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .enhanced-suggestion-btn:hover {
            transform: scale(1.02);
        }

        .enhanced-share-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.9rem;
            white-space: pre-wrap;
            text-align: left;
            margin: 15px 0;
        }

        .enhanced-share-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .enhanced-share-actions button {
            flex: 1;
        }

        /* Global Percentile Display */
        .enhanced-percentile-section {
            text-align: center;
            margin: 15px 0;
        }

        .enhanced-percentile {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .enhanced-percentile.legendary {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-color: #ffd700;
            color: #1a1a1a;
            animation: legendaryPulse 2s infinite;
        }

        .enhanced-percentile.amazing {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
        }

        .enhanced-percentile.great {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            border-color: #f6ad55;
            color: white;
        }

        .enhanced-percentile.good {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-color: #48bb78;
            color: white;
        }

        .enhanced-percentile.average {
            background: var(--bg-secondary);
            border-color: var(--border);
        }

        @keyframes legendaryPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        /* Nudge System Styles */
        .enhanced-section-divider {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 0 8px;
            margin-top: 8px;
            border-top: 1px solid var(--border);
        }

        .enhanced-friend-row.not-played {
            opacity: 0.7;
        }

        .nudge-container {
            display: flex;
            align-items: center;
        }

        .nudge-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3) !important;
            color: var(--accent-purple) !important;
            transition: all 0.2s;
        }

        .nudge-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            transform: scale(1.05);
        }

        /* Notification Settings */
        .notification-settings {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .notification-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .notification-setting-row:last-child {
            border-bottom: none;
        }

        .notification-setting-info {
            flex: 1;
        }

        .notification-setting-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .notification-setting-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .share-celebration {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: celebrateBounce 0.6s ease;
        }

        @keyframes celebrateBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .share-score-display {
            background: linear-gradient(135deg, var(--accent-green), #2d8a4e);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin: 15px 0;
        }

        .share-score-game {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .share-score-result {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .share-streak-badge {
            display: inline-block;
            background: var(--accent-gold);
            color: #1a1a1a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn-primary {
            background: linear-gradient(135deg, #5865F2, #4752C4);
            color: white;
        }

        .share-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
        }

        .share-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .share-btn-secondary:hover {
            background: var(--bg-hover);
        }

        .share-btn-skip {
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .share-btn-skip:hover {
            color: var(--text-secondary);
        }

        .share-preview {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            max-height: 150px;
            overflow-y: auto;
        }

        /* Battle Share Styles */
        .battle-share-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin: 15px 0;
            text-align: center;
        }

        .battle-share-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .battle-share-code {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .battle-share-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Daily Goal */
        .daily-goal-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            border-radius: 16px;
            border: 2px solid var(--accent-gold);
        }

        .daily-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .daily-goal-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .daily-goal-edit {
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .daily-goal-edit:hover {
            color: var(--accent-gold);
        }

        .daily-goal-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .daily-goal-ring {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }

        .daily-goal-ring svg {
            transform: rotate(-90deg);
        }

        .daily-goal-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .daily-goal-ring .bg {
            stroke: var(--bg-hover);
        }

        .daily-goal-ring .progress {
            stroke: var(--accent-gold);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .daily-goal-ring .complete {
            stroke: var(--accent-green);
        }

        .daily-goal-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .daily-goal-count {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .daily-goal-target {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .daily-goal-info {
            flex: 1;
        }

        .daily-goal-message {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .daily-goal-submessage {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .daily-goal-complete {
            color: var(--accent-green);
        }

        /* Insights Tab Styles */
        .insights-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .insights-period-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .insights-period-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insights-period-btn.active {
            background: var(--accent-gold);
            color: #000;
        }

        .insights-period-btn:hover:not(.active) {
            background: var(--bg-hover);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .insight-card.full-width {
            grid-column: span 2;
        }

        .insight-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-gold);
            line-height: 1;
            margin-bottom: 5px;
        }

        .insight-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .insight-change.positive {
            color: var(--accent-green);
        }

        .insight-change.negative {
            color: var(--accent-red);
        }

        /* Cross-Game Insights */
        .cross-insights-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .cross-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .cross-insight-item:last-child {
            margin-bottom: 0;
        }

        .cross-insight-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .cross-insight-text {
            flex: 1;
        }

        .cross-insight-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .cross-insight-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Game Rankings */
        .game-ranking-list {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .game-ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .game-ranking-item:last-child {
            border-bottom: none;
        }

        .game-ranking-position {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .game-ranking-item:nth-child(1) .game-ranking-position {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #000;
        }

        .game-ranking-item:nth-child(2) .game-ranking-position {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #000;
        }

        .game-ranking-item:nth-child(3) .game-ranking-position {
            background: linear-gradient(135deg, #cd7f32, #b8722b);
            color: #000;
        }

        .game-ranking-icon {
            font-size: 1.5rem;
        }

        .game-ranking-info {
            flex: 1;
        }

        .game-ranking-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .game-ranking-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .game-ranking-streak {
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Annual Wrapped */
        .wrapped-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }

        .wrapped-year {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .wrapped-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .wrapped-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .wrapped-stat {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
        }

        .wrapped-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
        }

        .wrapped-stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .wrapped-highlight {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wrapped-highlight-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .wrapped-highlight-value {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wrapped-share-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .wrapped-share-btn:hover {
            transform: scale(1.05);
        }

        /* Deep Link Share */
        .share-link-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .share-link-input {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .share-link-input input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-hover);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
        }

        .share-link-input button {
            padding: 10px 20px;
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        /* Best Day/Time */
        .best-time-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }

        .best-time-cell {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .best-time-cell.active {
            background: var(--accent-green);
            color: #000;
        }

        .best-time-label {
            text-align: center;
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Goal Setting Modal */
        .goal-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .goal-option {
            padding: 15px 10px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-option:hover {
            border-color: var(--accent-gold);
        }

        .goal-option.selected {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: #000;
        }

        .goal-option-value {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .goal-option-label {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Achievements */
        .achievements-section {
            margin-top: 25px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .achievement-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .achievement-card.unlocked {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-card), rgba(244, 211, 94, 0.1));
        }

        .achievement-card.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .achievement-card.locked .achievement-icon {
            filter: grayscale(1);
        }

        .achievement-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .achievement-card.unlocked .achievement-desc {
            color: var(--accent-gold);
        }

        .achievements-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .achievements-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .achievements-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-purple));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .achievements-progress-text {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-gold);
            min-width: 50px;
            text-align: right;
        }

        /* Share Text Parser */
        .parse-section {
            margin-top: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .parse-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parse-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .parse-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .parse-input::placeholder {
            color: var(--text-muted);
        }

        .parse-result {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            display: none;
        }

        .parse-result.show {
            display: block;
        }

        .parse-result.success {
            border-left: 4px solid var(--accent-green);
        }

        .parse-result.error {
            border-left: 4px solid var(--accent-red);
        }

        .parse-result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .parse-result-icon {
            font-size: 1.5rem;
        }

        .parse-result-game {
            font-weight: 700;
            color: var(--text-primary);
        }

        .parse-result-score {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .parse-btn {
            margin-top: 12px;
            width: 100%;
        }

        /* Share Shelf */
        .share-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-secondary);
        }

        .share-preview {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--accent-purple);
        }

        .share-preview-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .share-preview-header h3 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .share-preview-header p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .share-stats-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .share-stat {
            text-align: center;
        }

        .share-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .share-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .share-games-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .share-game-item {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
        }

        .share-game-item .icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .share-game-item .name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .share-game-item .streak {
            font-size: 0.65rem;
            color: var(--accent-gold);
        }

        .share-footer {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: var(--bg-card);
            z-index: 1500;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .settings-menu.active {
            transform: translateX(0);
        }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-header h2 {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .settings-close {
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .settings-item-label .icon {
            font-size: 1.2rem;
        }

        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: var(--accent-green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .settings-footer {
            padding: 20px;
            border-top: 1px solid var(--bg-secondary);
            text-align: center;
        }

        .settings-version {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .settings-copyright {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .settings-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-link:hover {
            color: var(--accent-gold);
        }

        .settings-link .icon {
            font-size: 1.2rem;
        }

        /* Theme Preview */
        .theme-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .theme-option {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
            background: var(--bg-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .theme-option.active {
            border-color: var(--accent-gold);
        }

        .theme-option:hover {
            border-color: var(--accent-gold);
        }

        .theme-option .preview {
            width: 100%;
            height: 30px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .theme-option.dark .preview {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }

        .theme-option.light .preview {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
        }

        .theme-option .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Pitch Page Styles */
        .pitch-game-tag {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Demo Mode Indicator */
        .demo-mode-banner {
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-red));
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        /* Tour System Styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .tour-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .tour-highlight {
            position: relative;
            z-index: 9999 !important;
            box-shadow: 0 0 0 4px var(--accent-gold), 0 0 20px rgba(255, 215, 0, 0.5);
            border-radius: 12px;
        }
        
        .tour-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px;
            max-width: 340px;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateY(10px);
        }
        
        .tour-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .tour-tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }
        
        .tour-tooltip-arrow.top {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: var(--accent-gold);
        }
        
        .tour-tooltip-arrow.bottom {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: var(--accent-gold);
        }
        
        .tour-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .tour-tooltip-icon {
            font-size: 2rem;
        }
        
        .tour-tooltip-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .tour-tooltip-problem {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--accent-red);
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .tour-tooltip-solution {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid var(--accent-green);
            padding: 10px 12px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .tour-progress {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .tour-progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: background 0.3s;
        }
        
        .tour-progress-dot.active {
            background: var(--accent-gold);
        }
        
        .tour-progress-dot.completed {
            background: var(--accent-green);
        }
        
        .tour-buttons {
            display: flex;
            gap: 10px;
        }
        
        .tour-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .tour-btn-skip {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .tour-btn-skip:hover {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .tour-btn-next {
            background: var(--accent-gold);
            color: #000;
        }
        
        .tour-btn-next:hover {
            background: #ffc107;
            transform: translateY(-1px);
        }
        
        .tour-step-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
        }

        /* Share Hub Styles */
        .share-platform-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .share-platform-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        .share-platform-btn:active {
            transform: translateY(0);
        }
        
        .share-result-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .share-result-tag .score {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        /* Plain Mode - Simplified visual experience */
        body.plain-mode .achievement-card,
        body.plain-mode .streak-fire,
        body.plain-mode .wallet-section,
        body.plain-mode .coins-badge,
        body.plain-mode #demo-section {
            display: none !important;
        }
        
        body.plain-mode .game-card::after {
            display: none; /* Hide streak flames */
        }
        
        /* All Tracking Modal */
        .tracking-game-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .tracking-game-item .game-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }
        
        .tracking-game-item .game-info {
            flex: 1;
        }
        
        .tracking-game-item .game-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .tracking-game-item .game-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .tracking-game-item .edit-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .tracking-game-item .edit-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        /* Sound Customizer Modal */
        .sound-event-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .sound-event-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .sound-event-icon {
            font-size: 1.3rem;
            width: 32px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .sound-event-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .sound-event-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .sound-event-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .sound-event-selector select {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 120px;
        }
        
        .sound-event-selector select:focus {
            outline: none;
            border-color: var(--accent-purple);
        }
        
        .preview-btn {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .preview-btn:hover {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }
        
        @media (max-width: 500px) {
            .sound-event-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .sound-event-selector {
                width: 100%;
            }
            
            .sound-event-selector select {
                flex: 1;
            }
        }

        /* ============ PWA MOBILE-FIRST STYLES ============ */
        
        /* Safe Areas for notch/home indicator */
        .pwa-container {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* Prevent iOS overscroll/bounce */
        html.pwa-mode {
            overflow: hidden;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        html.pwa-mode body {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        html.pwa-mode .container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* NEW: Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: none; /* Hidden by default, shown in PWA mode */
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        
        html.pwa-mode .bottom-nav {
            display: flex;
        }
        
        html.pwa-mode .nav-tabs {
            display: none; /* Hide top tabs in PWA mode */
        }
        
        html.pwa-mode .tab-content {
            padding-bottom: 90px; /* Space for bottom nav */
        }
        
        .bottom-nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .bottom-nav-tab.active {
            color: var(--accent-purple);
        }
        
        .bottom-nav-icon {
            font-size: 1.4rem;
            line-height: 1;
        }
        
        .bottom-nav-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* NEW: Home Dashboard Styles */
        .home-primary-action {
            margin: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 20px;
        }
        
        .home-big-log-btn {
            width: 100%;
            padding: 18px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: transform 0.15s, box-shadow 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .home-big-log-btn:active {
            transform: scale(0.97);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .home-big-log-btn .btn-icon {
            font-size: 1.3rem;
        }
        
        .home-quick-games {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        .home-quick-game-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.2s, background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .home-quick-game-btn:active {
            transform: scale(0.9);
        }
        
        .home-quick-game-btn.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.15);
        }
        
        /* Progress Section */
        .home-progress {
            margin: 0 15px 12px;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .home-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .home-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .home-progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .home-progress-streak {
            color: var(--accent-orange);
            font-weight: 600;
        }
        
        /* Widget Cards */
        .home-widget {
            margin: 0 15px 12px;
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 14px;
            border: 1px solid var(--border);
        }
        
        .home-widget-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .home-widget-icon {
            font-size: 1.1rem;
        }
        
        .home-widget-title {
            font-weight: 700;
            font-size: 0.9rem;
            flex: 1;
        }
        
        .home-widget-badge {
            font-size: 0.7rem;
            background: var(--accent-orange);
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .home-widget-action {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Battle Widget Content */
        .home-battle-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 6px;
        }
        
        .home-battle-scores {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Friends Widget Content */
        .home-friends-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .home-friend {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 50px;
        }
        
        .home-friend-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            background: var(--bg-tertiary);
            object-fit: cover;
        }
        
        .home-friend.played .home-friend-avatar {
            border-color: var(--accent-green);
        }
        
        .home-friend.waiting .home-friend-avatar {
            opacity: 0.5;
        }
        
        .home-friend-status {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        
        .home-friend.played .home-friend-status {
            color: var(--accent-green);
        }
        
        /* Compact Games Grid */
        .home-games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 0 15px 15px;
        }
        
        .home-game-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .home-game-card:active {
            transform: scale(0.95);
        }
        
        .home-game-card.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.1);
        }
        
        .home-game-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }
        
        .home-game-name {
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .home-game-status {
            font-size: 0.65rem;
            margin-top: 3px;
            color: var(--text-muted);
        }
        
        .home-game-card.done .home-game-status {
            color: var(--accent-green);
        }
        
        /* Bottom Sheet Component */
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 500;
            display: flex;
            align-items: flex-end;
            pointer-events: none;
            transition: background 0.3s;
        }
        
        .bottom-sheet-overlay.active {
            background: rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }
        
        .bottom-sheet {
            width: 100%;
            background: var(--bg-primary);
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .bottom-sheet-overlay.active .bottom-sheet {
            transform: translateY(0);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 2px;
            margin: 12px auto;
            cursor: grab;
        }
        
        .bottom-sheet-header {
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            padding: 0 20px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .bottom-sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Clipboard Auto-Detect Prompt */
        .clipboard-prompt {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            z-index: 400;
        }
        
        html.pwa-mode .clipboard-prompt {
            bottom: 110px; /* Account for bottom nav */
        }
        
        .clipboard-prompt.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .clipboard-prompt-icon {
            font-size: 1.3rem;
        }
        
        .clipboard-prompt-text {
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .clipboard-prompt-yes,
        .clipboard-prompt-no {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .clipboard-prompt-yes {
            background: var(--accent-green);
            color: white;
        }
        
        .clipboard-prompt-no {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        /* PWA Install Prompt */
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
            z-index: 300;
            animation: slideUp 0.3s ease;
        }
        
        .pwa-install-prompt-icon {
            font-size: 2rem;
        }
        
        .pwa-install-prompt-content {
            flex: 1;
        }
        
        .pwa-install-prompt-title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .pwa-install-prompt-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .pwa-install-prompt-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .pwa-install-prompt-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Touch feedback for all interactive elements */
        @media (hover: none) and (pointer: coarse) {
            button:active,
            .game-card:active,
            .home-game-card:active,
            .nav-tab:active,
            .bottom-nav-tab:active {
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <button class="menu-btn" onclick="toggleSettingsMenu()" aria-label="Open menu"></button>
                <div>
                    <h1> Game Shelf</h1>
                    <p class="tagline">Your Daily Puzzle Hub</p>
                </div>
                <div class="header-right">
                    <button class="share-quick-btn" onclick="showShareHub()" title="Share Results" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; margin-right: 8px;"></button>
                    <div class="currency-badges">
                        <button class="currency-badge token-badge" onclick="showWalletModal()" title="View Tokens">
                             <span id="wallet-tokens">0</span>
                        </button>
                        <button class="currency-badge coin-badge" onclick="showWalletModal()" title="View Coins">
                             <span id="wallet-coins">0</span>
                        </button>
                    </div>
                    <span class="pro-badge" id="pro-badge" style="display: none;" title="Pro Subscriber">PRO</span>
                    <div class="user-account">
                        <button class="sign-in-btn" id="sign-in-btn" onclick="signInWithGoogle()">
                            <span>G</span> Sign In
                        </button>
                        <button class="user-avatar-btn" id="user-avatar-btn" onclick="showProfileModal()" style="display: none;">
                            <img id="user-avatar" src="" alt="Profile">
                            <div class="sync-indicator" id="sync-indicator"></div>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs (Desktop/Top - hidden in PWA mode) -->
        <div class="nav-tabs">
            <button class="nav-tab" onclick="switchTab('home')" data-tab="home"> Home</button>
            <button class="nav-tab active" onclick="switchTab('games')" data-tab="games"> Games</button>
            <button class="nav-tab" onclick="switchTab('insights')" data-tab="insights"> Insights</button>
            <button class="nav-tab" onclick="switchTab('social')" data-tab="social"> Social</button>
        </div>

        <!-- NEW: Home Dashboard Tab -->
        <div class="tab-content" id="tab-home">
            <!-- Primary Action: Big Log Button -->
            <div class="home-primary-action">
                <button class="home-big-log-btn" onclick="openLogBottomSheet()">
                    <span class="btn-icon"></span>
                    <span>Log Today's Games</span>
                </button>
                <div class="home-quick-games" id="home-quick-games">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="home-progress">
                <div class="home-progress-bar">
                    <div class="home-progress-fill" id="home-progress-fill" style="width: 0%"></div>
                </div>
                <div class="home-progress-stats">
                    <span><strong id="home-games-done">0</strong>/<span id="home-games-goal">5</span> games</span>
                    <span class="home-progress-streak"> <span id="home-best-streak">0</span></span>
                </div>
            </div>

            <!-- Active Battle Widget -->
            <div class="home-widget" id="home-battle-widget" style="display: none;">
                <div class="home-widget-header">
                    <span class="home-widget-icon"></span>
                    <span class="home-widget-title">Active Battle</span>
                    <span class="home-widget-badge" id="home-battle-badge">-</span>
                </div>
                <div class="home-battle-name" id="home-battle-name">-</div>
                <div class="home-battle-scores" id="home-battle-scores">-</div>
                <button class="home-widget-action" onclick="switchTab('social'); showBattleDetails(activeBattleId);">View Battle </button>
            </div>

            <!-- Friends Widget -->
            <div class="home-widget" id="home-friends-widget">
                <div class="home-widget-header">
                    <span class="home-widget-icon"></span>
                    <span class="home-widget-title">Friends Today</span>
                </div>
                <div class="home-friends-row" id="home-friends-row">
                    <div style="color: var(--text-muted); font-size: 0.85rem; padding: 10px;">
                        Sign in to see friends
                    </div>
                </div>
                <button class="home-widget-action" onclick="switchTab('social')">See All Friends </button>
            </div>

            <!-- Compact Games Grid -->
            <div style="padding: 0 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 700; font-size: 0.9rem;">Your Games</span>
                    <button style="background: none; border: none; color: var(--accent-purple); font-size: 0.8rem; cursor: pointer;" onclick="switchTab('games')">See All</button>
                </div>
            </div>
            <div class="home-games-grid" id="home-games-grid">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Games Tab -->
        <div class="tab-content active" id="tab-games">
            <!-- Compact Stats + Goal Hero -->
            <div class="hero-stats">
                <div class="hero-goal" onclick="showGoalModal()">
                    <svg width="60" height="60" class="goal-ring-small">
                        <circle class="bg" cx="30" cy="30" r="25" fill="none" stroke="var(--bg-hover)" stroke-width="6"></circle>
                        <circle class="progress" cx="30" cy="30" r="25" fill="none" stroke="var(--accent-gold)" stroke-width="6"
                            stroke-dasharray="157" stroke-dashoffset="157" stroke-linecap="round"
                            id="goal-progress-circle" style="transform: rotate(-90deg); transform-origin: center;"></circle>
                    </svg>
                    <div class="hero-goal-text">
                        <span class="hero-goal-count" id="goal-current">0</span>
                        <span class="hero-goal-label">/<span id="goal-target">5</span> goal</span>
                    </div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="best-streak">0</div>
                    <div class="hero-stat-label"> Streak</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="total-games">4</div>
                    <div class="hero-stat-label"> Games</div>
                </div>
                <button class="hero-log-btn" onclick="toggleQuickLog()" title="Log results"></button>
            </div>

            <!-- Smart Suggestion -->
            <div class="smart-suggestion" id="smart-suggestion" style="display: none;">
                <div class="suggestion-icon" id="suggestion-icon"></div>
                <div class="suggestion-content">
                    <div class="suggestion-text" id="suggestion-text">Try the Mini Crossword - perfect for mornings!</div>
                </div>
                <button class="suggestion-action" id="suggestion-action" onclick="actOnSuggestion()">Play</button>
                <button class="suggestion-dismiss" onclick="dismissSuggestion()"></button>
            </div>

            <!-- Sponsored Games (Paid Placements) -->
            <div class="section-header sponsored-section" id="sponsored-section" style="display: none;">
                <span class="section-title"> Sponsored</span>
            </div>
            <div class="featured-grid sponsored-grid" id="sponsored-games" style="display: none;"></div>

            <!-- Featured Games (Your Games) -->
            <div class="section-header">
                <span class="section-title"> Featured</span>
            </div>
            <div class="featured-grid" id="featured-games"></div>

            <!-- Other Games -->
            <div class="section-header">
                <span class="section-title"> My Games</span>
                <button class="add-btn" onclick="showAddGameModal()">+ Add Game</button>
            </div>
            <div class="game-grid" id="my-games"></div>

            <!-- Calendar Heatmap (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('calendar')">
                    <span class="section-title"> Activity History</span>
                    <span class="collapsible-chevron" id="calendar-chevron"></span>
                </div>
                <div class="collapsible-content" id="calendar-content" style="display: none;">
                    <div class="calendar-inner">
                        <div class="calendar-nav-row">
                            <button onclick="prevMonth(); event.stopPropagation();"></button>
                            <span class="calendar-month-label" id="calendar-month-label">January 2026</span>
                            <button onclick="nextMonth(); event.stopPropagation();"></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <div class="calendar-day-label">S</div>
                            <div class="calendar-day-label">M</div>
                            <div class="calendar-day-label">T</div>
                            <div class="calendar-day-label">W</div>
                            <div class="calendar-day-label">T</div>
                            <div class="calendar-day-label">F</div>
                            <div class="calendar-day-label">S</div>
                        </div>
                        <div class="calendar-legend">
                            <span>Less</span>
                            <div class="legend-box" style="background: var(--bg-card);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.25);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.5);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.75);"></div>
                            <div class="legend-box" style="background: var(--accent-green);"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('achievements')">
                    <span class="section-title"> Achievements</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="achievements-progress-text" id="achievements-progress-text">0/14</span>
                        <span class="collapsible-chevron" id="achievements-chevron"></span>
                    </div>
                </div>
                <div class="collapsible-content" id="achievements-content" style="display: none;">
                    <div class="achievements-progress">
                        <div class="achievements-progress-bar">
                            <div class="achievements-progress-fill" id="achievements-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="achievements-grid" id="achievements-grid"></div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">Copied!</div>

        <!-- Insights Tab -->
        <div class="tab-content" id="tab-insights">
            <!-- Period Toggle -->
            <div class="insights-period-toggle">
                <button class="insights-period-btn active" onclick="setInsightsPeriod('week')">This Week</button>
                <button class="insights-period-btn" onclick="setInsightsPeriod('month')">This Month</button>
                <button class="insights-period-btn" onclick="setInsightsPeriod('year')">This Year</button>
            </div>

            <!-- Stats Grid -->
            <div class="insights-grid" id="insights-stats-grid">
                <div class="insight-card">
                    <div class="insight-icon"></div>
                    <div class="insight-value" id="insight-games-played">0</div>
                    <div class="insight-label">Games Played</div>
                    <div class="insight-change positive" id="insight-games-change"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon"></div>
                    <div class="insight-value" id="insight-completion">0%</div>
                    <div class="insight-label">Completion Rate</div>
                    <div class="insight-change" id="insight-completion-change"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon"></div>
                    <div class="insight-value" id="insight-current-streak">0</div>
                    <div class="insight-label">Current Streak</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon"></div>
                    <div class="insight-value" id="insight-best-streak">0</div>
                    <div class="insight-label">Best Streak</div>
                </div>
            </div>

            <!-- Best Day to Play -->
            <div class="insight-card full-width" style="margin-bottom: 25px;">
                <div class="section-header" style="margin: 0 0 10px 0;">
                    <span class="section-title"> Best Days</span>
                </div>
                <div class="best-time-grid" id="best-days-grid"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span class="best-time-label">S</span>
                    <span class="best-time-label">M</span>
                    <span class="best-time-label">T</span>
                    <span class="best-time-label">W</span>
                    <span class="best-time-label">T</span>
                    <span class="best-time-label">F</span>
                    <span class="best-time-label">S</span>
                </div>
            </div>

            <!-- Game Rankings -->
            <div class="section-header">
                <span class="section-title"> Most Played</span>
            </div>
            <div class="game-ranking-list" id="game-rankings"></div>

            <!-- Cross-Game Insights -->
            <div class="cross-insights-section" style="margin-top: 25px;">
                <div class="section-header" style="margin: 0 0 15px 0;">
                    <span class="section-title"> Insights</span>
                </div>
                <div id="cross-insights-list"></div>
            </div>

            <!-- Annual Wrapped Preview -->
            <div class="wrapped-section" id="wrapped-section">
                <div class="wrapped-year">2025</div>
                <div class="wrapped-title"> Your Year in Games</div>
                <div class="wrapped-stats-grid">
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-total-games">0</div>
                        <div class="wrapped-stat-label">Games Played</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-total-days">0</div>
                        <div class="wrapped-stat-label">Days Active</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-best-streak">0</div>
                        <div class="wrapped-stat-label">Best Streak</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-unique-games">0</div>
                        <div class="wrapped-stat-label">Unique Games</div>
                    </div>
                </div>
                <div class="wrapped-highlight">
                    <div class="wrapped-highlight-label">Your #1 Game</div>
                    <div class="wrapped-highlight-value" id="wrapped-top-game">
                        <span></span> <span></span>
                    </div>
                </div>
                <button class="wrapped-share-btn" onclick="shareWrapped()"> Share Your Wrapped</button>
            </div>

            <!-- Share Your Shelf Link -->
            <div class="share-link-section">
                <div class="section-header" style="margin: 0;">
                    <span class="section-title"> Share Your Shelf</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                    Share a read-only view of your game shelf with friends
                </p>
                <div class="share-link-input">
                    <input type="text" id="share-link-url" value="gameshelf.app/u/your-shelf" readonly>
                    <button onclick="copyShareLink()">Copy</button>
                </div>
            </div>
        </div>

        <!-- Battle Tab -->
        <div class="tab-content" id="tab-battle">
            <!-- Sign-in prompt for non-authenticated users -->
            <div class="battle-signin-prompt" id="battle-signin-prompt">
                <div class="signin-prompt-icon"></div>
                <h3>Brain Battle</h3>
                <p>Sign in to challenge friends, join tournaments, and compete for Shelf Coins!</p>
                <button class="btn btn-primary" onclick="signInWithGoogle()">
                    <span>G</span> Sign In with Google
                </button>
            </div>

            <!-- Battle content (shown when signed in) -->
            <div class="battle-content" id="battle-content" style="display: none;">
                <!-- Quick Actions Row -->
                <div class="battle-quick-actions">
                    <button class="quick-action-btn primary" onclick="showCreateBattleModal('challenge')">
                         Challenge Friend
                    </button>
                    <button class="quick-action-btn" onclick="showJoinBattleModal()">
                         Join by Code
                    </button>
                    <button class="quick-action-btn" onclick="showPublicTournaments()">
                         Tournaments
                    </button>
                </div>

                <!-- Active Battles -->
                <div class="section-header">
                    <span class="section-title"> Active Brain Battles</span>
                </div>
                <div id="active-battles">
                    <div class="battle-empty">
                        <div class="empty-icon"></div>
                        <p>No active battles</p>
                        <p class="empty-hint">Challenge a friend or join a tournament to get started!</p>
                    </div>
                </div>

                <!-- Your Tournaments -->
                <div class="section-header" style="margin-top: 25px;">
                    <span class="section-title"> Your Tournaments</span>
                </div>
                <div id="your-tournaments">
                    <div class="battle-empty">
                        <p>No tournament entries yet</p>
                    </div>
                </div>

                <!-- Past Battles -->
                <div class="collapsible-section" style="margin-top: 25px;">
                    <div class="collapsible-header" onclick="toggleSection('past-battles')">
                        <span class="section-title"> Battle History</span>
                        <span class="collapsible-arrow"></span>
                    </div>
                    <div class="collapsible-content" id="past-battles" style="display: none;">
                        <div id="battle-history">
                            <div class="battle-empty">
                                <p>No completed battles yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Tab -->
        <div class="tab-content" id="tab-reviews">
            <div class="section-header">
                <span class="section-title"> My Reviews & Notes</span>
            </div>
            <div id="reviews-list"></div>
            <div class="empty-state" id="reviews-empty" style="display:none;">
                <div class="icon"></div>
                <p>No reviews yet.<br>Add games to your shelf and rate them!</p>
            </div>
        </div>

        <!-- Community Tab -->
        <div class="tab-content" id="tab-community">
            <!-- Sign-in prompt for non-authenticated users -->
            <div class="friends-signin-prompt" id="friends-signin-prompt">
                <div class="signin-prompt-icon"></div>
                <h3>Connect with Friends</h3>
                <p>Sign in to see friends' activity, compete on leaderboards, and share your progress!</p>
                <button class="btn btn-primary" onclick="signInWithGoogle()">
                    <span>G</span> Sign In with Google
                </button>
            </div>

            <!-- Friends content (shown when signed in) -->
            <div class="friends-content" id="friends-content" style="display: none;">
                <!-- Invite Friends CTA -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">Invite Your Friends</div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 15px;">Challenge friends to daily puzzle battles</div>
                    <button onclick="shareFriendInvite()" style="background: white; color: #667eea; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s;">
                        Share Invite Link
                    </button>
                </div>

                <!-- Daily Leaderboard -->
                <div class="section-header">
                    <span class="section-title"> Today's Leaderboard</span>
                </div>
                <div class="leaderboard-card" id="daily-leaderboard">
                    <div class="leaderboard-empty">
                        <p>Add friends to see the leaderboard!</p>
                    </div>
                </div>

                <!-- Activity Feed -->
                <div class="section-header" style="margin-top: 25px;">
                    <span class="section-title"> Activity Feed</span>
                </div>
                <div class="activity-feed" id="activity-feed">
                    <div class="activity-empty">
                        <p>No recent activity from friends</p>
                    </div>
                </div>

                <!-- Friends List -->
                <div class="collapsible-section" style="margin-top: 25px;">
                    <div class="collapsible-header" onclick="toggleSection('friends-list')">
                        <span class="section-title"> Friends</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="friends-count" id="friends-count">0</span>
                            <span class="collapsible-chevron" id="friends-list-chevron"></span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="friends-list-content" style="display: none;">
                        <div class="friends-list" id="friends-list"></div>
                        <button class="btn btn-secondary add-friend-btn" onclick="showAddFriendModal()">
                            + Add Friend
                        </button>
                    </div>
                </div>
            </div>

            <!-- Community Links (Collapsible) -->
            <div class="collapsible-section" style="margin-top: 25px;">
                <div class="collapsible-header" onclick="toggleSection('community-links')">
                    <span class="section-title"> Community Links</span>
                    <span class="collapsible-chevron" id="community-links-chevron"></span>
                </div>
                <div class="collapsible-content" id="community-links-content" style="display: none;">
                    <div class="community-grid">
                        <a href="https://discord.gg/wordgames" target="_blank" class="community-card discord">
                            <div class="icon"></div>
                            <div class="info">
                                <h4>Discord</h4>
                                <p>Word game chat</p>
                            </div>
                        </a>
                        <a href="https://reddit.com/r/wordle" target="_blank" class="community-card reddit">
                            <div class="icon"></div>
                            <div class="info">
                                <h4>r/wordle</h4>
                                <p>Daily discussions</p>
                            </div>
                        </a>
                        <a href="https://reddit.com/r/NYTGames" target="_blank" class="community-card reddit">
                            <div class="icon"></div>
                            <div class="info">
                                <h4>r/NYTGames</h4>
                                <p>All NYT puzzles</p>
                            </div>
                        </a>
                        <a href="https://twitter.com/search?q=wordle" target="_blank" class="community-card twitter">
                            <div class="icon"></div>
                            <div class="info">
                                <h4>Twitter/X</h4>
                                <p>Share results</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            v1.22.0  Game Shelf
        </footer>
    </div>

    <!-- Welcome/Registration Modal -->
    <div class="modal-overlay" id="welcome-modal">
        <div class="modal">
            <h2> Welcome to Game Shelf!</h2>
            <p>Select the daily games you play. We'll help you track your progress and streaks!</p>
            
            <div class="game-list" id="registration-list"></div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="completeRegistration()" style="flex:1">Get Started</button>
                <button class="btn btn-secondary" onclick="skipRegistration()">Skip</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal (Smart Tracking Setup) -->
    <div class="modal-overlay" id="onboarding-modal">
        <div class="modal" style="max-width: 480px; padding: 30px;">
            <div id="onboarding-container"></div>
        </div>
    </div>

    <!-- Sound Customizer Modal -->
    <div class="modal-overlay" id="sound-customizer-modal">
        <div class="modal" style="max-width: 550px; max-height: 85vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2> Customize Sounds</h2>
                <button class="close-btn" onclick="closeSoundCustomizer()"></button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem;">
                Choose which sound plays for each action. Click  to preview.
            </p>
            
            <div id="sound-events-list" style="flex: 1; overflow-y: auto; margin: 0 -20px; padding: 0 20px;">
                <!-- Populated by renderSoundCustomizer() -->
            </div>
            
            <div class="btn-group" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="resetSoundDefaults()">Reset Defaults</button>
                <button class="btn btn-primary" onclick="closeSoundCustomizer()" style="flex: 1;">Done</button>
            </div>
        </div>
    </div>

    <!-- Add Game Modal -->
    <div class="modal-overlay" id="add-game-modal">
        <div class="modal">
            <h2> Add a Game</h2>
            <p>Choose from popular games or add a custom one.</p>
            
            <div class="game-list" id="add-game-list"></div>
            
            <div style="text-align: center; margin: 20px 0; color: var(--text-muted);"> or add custom </div>
            
            <div class="form-group">
                <label>Game URL</label>
                <input type="text" id="custom-url" placeholder="https://..." oninput="autoDetectGameInfo()">
                <small id="url-validation-feedback" style="font-size: 0.75rem; margin-top: 4px; display: block;">
                    <span style="color: var(--text-muted);">Paste URL to auto-detect game info</span>
                </small>
            </div>
            <div class="form-group">
                <label>Game Name</label>
                <input type="text" id="custom-name" placeholder="e.g., Wordle">
            </div>
            <div class="form-group">
                <label>Icon (emoji)</label>
                <input type="text" id="custom-icon" placeholder="" maxlength="2">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addSelectedGames()" style="flex:1">Add Games</button>
                <button class="btn btn-secondary" onclick="closeAddGameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="review-modal">
        <div class="modal">
            <h2> Rate & Review</h2>
            <div id="review-game-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <span id="review-game-icon" style="font-size: 2.5rem;"></span>
                <div>
                    <h3 id="review-game-name" style="margin: 0;"></h3>
                </div>
            </div>
            
            <div class="form-group">
                <label>Your Rating</label>
                <div class="star-rating-input" id="rating-input">
                    <span class="star" data-value="1"></span>
                    <span class="star" data-value="2"></span>
                    <span class="star" data-value="3"></span>
                    <span class="star" data-value="4"></span>
                    <span class="star" data-value="5"></span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="review-notes" placeholder="Your thoughts on this game..."></textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveReview()" style="flex:1">Save Review</button>
                <button class="btn btn-secondary" onclick="closeReviewModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <!-- Settings Menu (slide-out) -->
    <div class="settings-overlay" id="settings-overlay" onclick="toggleSettingsMenu()"></div>
    <div class="settings-menu" id="settings-menu">
        <div class="settings-header">
            <h2> Menu</h2>
            <button class="settings-close" onclick="toggleSettingsMenu()"></button>
        </div>
        <div class="settings-body">
            <!-- 0. ACCOUNT -->
            <div class="settings-section">
                <div class="settings-section-title"> Account</div>
                <div id="menu-account-section">
                    <!-- Populated by updateMenuAccountSection() -->
                    <a href="#" class="settings-link" onclick="signInWithGoogle(); return false;">
                        <span class="icon"></span>
                        Sign in with Google
                    </a>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                        Save progress across devices
                    </p>
                </div>
            </div>

            <!-- 1. DISPLAY -->
            <div class="settings-section">
                <div class="settings-section-title"> Display</div>
                <div class="theme-options">
                    <div class="theme-option dark active" onclick="setTheme('dark')" id="theme-dark">
                        <div class="preview"></div>
                        <div class="label"> Dark</div>
                    </div>
                    <div class="theme-option light" onclick="setTheme('light')" id="theme-light">
                        <div class="preview"></div>
                        <div class="label"> Light</div>
                    </div>
                </div>
            </div>

            <!-- 2. SOUND -->
            <div class="settings-section">
                <div class="settings-section-title"> Sound</div>
                <div class="settings-toggle-row" style="padding: 8px 0;">
                    <label class="settings-toggle-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <span class="icon"></span>
                        <span style="flex: 1;">Sound Effects</span>
                        <input type="checkbox" id="sound-toggle" onchange="toggleSound(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                    </label>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0 8px 28px;">
                    <span style="font-size: 0.85rem; color: var(--text-muted);"></span>
                    <input type="range" id="sound-volume" min="0" max="100" value="50" 
                           oninput="setVolume(this.value)" 
                           style="flex: 1; cursor: pointer;">
                    <span style="font-size: 0.85rem; color: var(--text-muted);"></span>
                </div>
                <a href="#" class="settings-link" onclick="showSoundCustomizer(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Customize Sounds
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0 0 0 28px;">
                    Choose sounds for each action
                </p>
            </div>

            <!-- 2.5. NOTIFICATIONS -->
            <div class="settings-section">
                <div class="settings-section-title"> Notifications</div>
                
                <div class="notification-setting-row">
                    <div class="notification-setting-info">
                        <div class="notification-setting-title">Push Notifications</div>
                        <div class="notification-setting-desc">Get notified about streaks, battles, and friends</div>
                    </div>
                    <button id="notification-toggle" class="btn btn-primary" onclick="togglePushNotifications()" style="padding: 8px 16px; font-size: 0.85rem;">
                         Enable
                    </button>
                </div>
                
                <div id="notification-prefs" style="display: none;">
                    <div class="notification-setting-row">
                        <div class="notification-setting-info">
                            <div class="notification-setting-title">Streak Reminders</div>
                            <div class="notification-setting-desc">Daily reminder to protect your streaks</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pref-streak-reminders" checked onchange="saveNotificationPrefs()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-setting-row">
                        <div class="notification-setting-info">
                            <div class="notification-setting-title">Battle Updates</div>
                            <div class="notification-setting-desc">Score changes and battle endings</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pref-battle-updates" checked onchange="saveNotificationPrefs()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-setting-row">
                        <div class="notification-setting-info">
                            <div class="notification-setting-title">Nudges</div>
                            <div class="notification-setting-desc">When friends nudge you to play</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pref-nudges" checked onchange="saveNotificationPrefs()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-setting-row">
                        <div class="notification-setting-info">
                            <div class="notification-setting-title">Friend Activity</div>
                            <div class="notification-setting-desc">When friends beat your scores</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pref-friend-activity" onchange="saveNotificationPrefs()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="notification-setting-row">
                        <div class="notification-setting-info">
                            <div class="notification-setting-title">Weekly Summary</div>
                            <div class="notification-setting-desc">Sunday recap of your week</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pref-weekly-summary" checked onchange="saveNotificationPrefs()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="sendTestNotification()" style="width: 100%; margin-top: 10px;">
                         Send Test Notification
                    </button>
                </div>
            </div>

            <!-- 3. TUTORIAL -->
            <div class="settings-section">
                <div class="settings-section-title"> Tutorial</div>
                <a href="#" class="settings-link" onclick="startTour(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Start Guided Tour
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Walk through features with explanations
                </p>
                <a href="#" class="settings-link" onclick="showWelcome(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Re-run Setup
                </a>
            </div>

            <!-- 3. PLAIN MODE -->
            <div class="settings-section">
                <div class="settings-section-title"> Plain Mode</div>
                <div class="settings-toggle-row" style="padding: 8px 0;">
                    <label class="settings-toggle-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <span class="icon"></span>
                        <span style="flex: 1;">Plain Mode</span>
                        <input type="checkbox" id="plain-mode-toggle" onchange="togglePlainMode(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                    </label>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0 0 0 28px;">
                    Simplified visual experience (Free tier)
                </p>
            </div>

            <!-- 4. LOGGING OPTIONS -->
            <div class="settings-section">
                <div class="settings-section-title"> Logging Options</div>
                <a href="#" class="settings-link" onclick="showTrackingSettings(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Tracking Preferences
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Set where you play games (app vs browser)
                </p>
                <a href="#" class="settings-link" onclick="showExtensionModal(); return false;">
                    <span class="icon"></span>
                    How to Log Games
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Copy & paste, mobile share, or extension
                </p>
            </div>

            <!-- 5. SOCIAL -->
            <div class="settings-section">
                <div class="settings-section-title"> Social</div>
                <a href="#" class="settings-link" onclick="showShareHub(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Share Hub
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Share results to Twitter, Discord, and more
                </p>
            </div>

            <!-- 6. COINS & SHOP -->
            <div class="settings-section">
                <div class="settings-section-title"> Coins & Shop</div>
                <a href="#" class="settings-link" onclick="showWalletModal(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    My Shelf Coins
                </a>
                <a href="#" class="settings-link" onclick="showMerchStore(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Merch Store
                </a>
                <a href="#" class="settings-link" onclick="showBuyCoinsModal(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Buy Coins
                </a>
            </div>

            <!-- 7. ABOUT -->
            <div class="settings-section">
                <div class="settings-section-title"> About</div>
                <a href="#" class="settings-link" onclick="showAbout(); return false;">
                    <span class="icon"></span>
                    About Game Shelf
                </a>
                <a href="https://github.com/game-shelf" target="_blank" class="settings-link">
                    <span class="icon"></span>
                    View on GitHub
                </a>
            </div>

            <!-- 8. DATA -->
            <div class="settings-section">
                <div class="settings-section-title"> Data</div>
                <a href="#" class="settings-link" onclick="ScreenshotImportUI.show(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Import from Screenshot
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Upload game stats screenshots to backfill history
                </p>
                <a href="#" class="settings-link" onclick="exportData(); return false;">
                    <span class="icon"></span>
                    Export Data
                </a>
                <a href="#" class="settings-link" onclick="importData(); return false;">
                    <span class="icon"></span>
                    Import Data
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 4px 0 8px 28px;">
                    Restore from a backup file
                </p>
                <a href="#" class="settings-link" onclick="resetAllData(); return false;" style="color: var(--accent-red);">
                    <span class="icon"></span>
                    Reset All Data
                </a>
            </div>

            <!-- 9. DEMO & PITCH (Dev Only) -->
            <div class="settings-section" id="demo-section">
                <div class="settings-section-title"> Demo & Pitch</div>
                <a href="#" class="settings-link" onclick="showPitchPage(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    View Pitch Page
                </a>
                <a href="#" class="settings-link" onclick="showPyramidPage(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Value Pyramid
                </a>
                <a href="#" class="settings-link" onclick="showMarketPage(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Market Opportunity
                </a>
                <a href="#" class="settings-link" onclick="showDataStrategyPage(); toggleSettingsMenu(); return false;">
                    <span class="icon"></span>
                    Data Strategy
                </a>
                <div class="settings-toggle-row" style="padding: 12px 0;">
                    <label class="settings-toggle-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <span class="icon"></span>
                        <span style="flex: 1;">Demo Mode</span>
                        <input type="checkbox" id="demo-mode-toggle" onchange="toggleDemoMode(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                    </label>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0 0 0 28px;">
                    Load sample data for demonstrations
                </p>
            </div>
        </div>
        <div class="settings-footer">
            <div class="settings-version">Game Shelf v1.0.0</div>
            <div class="settings-copyright"> 2026 Game Shelf</div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <h2> About Game Shelf</h2>
            <p style="color: var(--text-secondary); margin: 15px 0; line-height: 1.6;">
                Game Shelf is your personal daily puzzle hub. Track your games, build streaks, discover new puzzles, and share your progress with friends.
            </p>
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: var(--text-muted);">Version</span>
                    <span style="color: var(--text-primary); font-weight: 600;">1.0.0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: var(--text-muted);">Released</span>
                    <span style="color: var(--text-primary); font-weight: 600;">January 2026</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Developer</span>
                    <span style="color: var(--text-primary); font-weight: 600;">Game Shelf</span>
                </div>
            </div>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 15px 0;">
                <strong>Featured Games:</strong> Rungs, Slate, Quotle, Word Boxing
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="closeAboutModal()" style="flex:1">Close</button>
            </div>
        </div>
    </div>

    <!-- Pitch Page Modal -->
    <div class="modal-overlay" id="pitch-modal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h1 style="font-size: 2rem; margin: 0; color: var(--text-primary);">Game Shelf</h1>
                <p style="color: var(--accent-green); font-size: 1.1rem; margin-top: 5px;">Your Daily Puzzle Hub</p>
            </div>
            
            <!-- The Hook -->
            <div style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <p style="font-size: 1.1rem; color: white; margin: 0; font-style: italic;">
                    "You play 5 daily puzzles. Your friend plays 4.<br>
                    <strong>Who's better?</strong>"
                </p>
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 10px; margin-bottom: 0;">
                    Currently... no way to know.
                </p>
            </div>
            
            <!-- The Problem -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-red); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> The Problem
                </h3>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                    <li>Daily puzzles are <strong>everywhere</strong> (Wordle, Connections, Mini, Strands, LinkedIn...)</li>
                    <li>Each lives in its <strong>own silo</strong> - no unified view</li>
                    <li>No way to <strong>track streaks</strong> across games</li>
                    <li>No way to <strong>compete</strong> with friends</li>
                    <li><strong>Solo experience</strong> in a social world</li>
                </ul>
            </div>
            
            <!-- The Solution -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-green); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> Game Shelf Solves This
                </h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: var(--bg-primary); border-radius: 10px;">
                        <div style="font-size: 2rem;"></div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-top: 5px;">Track Everything</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">All games in one place</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--bg-primary); border-radius: 10px;">
                        <div style="font-size: 2rem;"></div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-top: 5px;">Build Streaks</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Stay motivated daily</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--bg-primary); border-radius: 10px;">
                        <div style="font-size: 2rem;"></div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-top: 5px;">Add Friends</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">See what they play</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: var(--bg-primary); border-radius: 10px;">
                        <div style="font-size: 2rem;"></div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-top: 5px;">Brain Battles</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Compete head-to-head</div>
                    </div>
                </div>
            </div>
            
            <!-- Key Insight -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-blue); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <h3 style="color: var(--accent-blue); margin: 0 0 10px 0;"> The Key Insight</h3>
                <p style="color: var(--text-primary); margin: 0; font-size: 1rem; line-height: 1.6;">
                    Daily puzzles are <strong>inherently solo</strong> experiences.<br>
                    Game Shelf makes them <strong>social and competitive</strong><br>
                    <em>without changing the games themselves.</em>
                </p>
            </div>
            
            <!-- Supported Games -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> 25+ Supported Games
                </h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span class="pitch-game-tag"> Wordle</span>
                    <span class="pitch-game-tag"> Connections</span>
                    <span class="pitch-game-tag"> Mini Crossword</span>
                    <span class="pitch-game-tag"> Strands</span>
                    <span class="pitch-game-tag"> Spelling Bee</span>
                    <span class="pitch-game-tag"> Queens</span>
                    <span class="pitch-game-tag"> Tango</span>
                    <span class="pitch-game-tag"> Pinpoint</span>
                    <span class="pitch-game-tag"> Crossclimb</span>
                    <span class="pitch-game-tag"> Chess Puzzles</span>
                    <span class="pitch-game-tag"> Immaculate Grid</span>
                    <span class="pitch-game-tag"> Geography Games</span>
                    <span class="pitch-game-tag" style="background: var(--accent-purple);">+ more!</span>
                </div>
            </div>
            
            <!-- The Ask -->
            <div style="background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: white; margin: 0 0 15px 0; text-align: center;"> We Want to Know...</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: white;">
                        <strong>1.</strong> Would you use this?
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: white;">
                        <strong>2.</strong> What games do you play daily?
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: white;">
                        <strong>3.</strong> Would you invite friends?
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; color: white;">
                        <strong>4.</strong> What's missing?
                    </div>
                </div>
            </div>
            
            <!-- Navigation to other pitch pages -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="closePitchModal(); showPyramidPage();" style="flex: 1; font-size: 0.8rem; min-width: 100px;">
                     Value Pyramid
                </button>
                <button class="btn btn-secondary" onclick="closePitchModal(); showMarketPage();" style="flex: 1; font-size: 0.8rem; min-width: 100px;">
                     Market Size
                </button>
                <button class="btn btn-secondary" onclick="closePitchModal(); showDataStrategyPage();" style="flex: 1; font-size: 0.8rem; min-width: 100px;">
                     Data Strategy
                </button>
            </div>
            
            <div class="btn-group" style="gap: 10px;">
                <button class="btn btn-secondary" onclick="closePitchModal()" style="flex: 1;">Close</button>
                <button class="btn btn-primary" onclick="closePitchModal(); startTour();" style="flex: 1;"> Start Tour</button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
                Share this page: <a href="?pitch" style="color: var(--accent-blue);" onclick="copyShareUrl('pitch'); return false;">Copy Link</a>
            </p>
        </div>
    </div>

    <!-- Market Size Modal -->
    <div class="modal-overlay" id="market-modal">
        <div class="modal" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h1 style="font-size: 1.8rem; margin: 0; color: var(--text-primary);">The Market Opportunity</h1>
                <p style="color: var(--accent-blue); font-size: 1rem; margin-top: 5px;">"It's just free games..."  Let's look at the numbers.</p>
            </div>
            
            <!-- Headline Stats -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: white;">14.5M</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Daily Wordle Players</div>
                </div>
                <div style="background: linear-gradient(135deg, var(--accent-blue), #2563eb); border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: white;">11.1B</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">NYT Puzzles Played (2024)</div>
                </div>
                <div style="background: linear-gradient(135deg, var(--accent-purple), #7c3aed); border-radius: 12px; padding: 15px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: white;">300+</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Daily Puzzle Games Exist</div>
                </div>
            </div>
            
            <!-- NYT Games Breakdown -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> NYT Games: A Case Study
                </h3>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-secondary);"> Wordle</span>
                        <span style="color: var(--accent-green); font-weight: 700;">5.3B plays/year</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-secondary);"> Connections</span>
                        <span style="color: var(--accent-blue); font-weight: 700;">3.3B plays/year</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-secondary);"> Strands</span>
                        <span style="color: var(--accent-purple); font-weight: 700;">1.3B plays/year</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-secondary);"> Mini + Others</span>
                        <span style="color: var(--accent-gold); font-weight: 700;">1.2B plays/year</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                    <div style="color: var(--text-primary); font-weight: 600;"> NYT Games drives 82.69% of NYT's organic web traffic</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">Over 1 million premium subscribers, $40-70/year each</div>
                </div>
            </div>
            
            <!-- Multi-Game Players -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> The Multi-Game Audience
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Puzzle players don't stop at one game. <strong>The average daily puzzle player does 3-5 games per day.</strong> That's the audience Game Shelf is built for.
                </p>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-gold);">10M+</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Daily NYT Games users</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-gold);">830K</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">LinkedIn Games newsletter</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-gold);">84%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Return next day (LinkedIn)</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-gold);">12 min</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Avg daily play time</div>
                    </div>
                </div>
            </div>
            
            <!-- The "Free Games" Argument -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-orange); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-orange); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> "But they're free games..."
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Every massive platform started with "free" or "simple":
                </p>
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);"> Google</strong>
                        <span style="color: var(--text-muted);">  "Just typing words into a box"</span>
                        <div style="color: var(--accent-green); font-size: 0.85rem; margin-top: 4px;"> $307B revenue (2023)</div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);"> Facebook</strong>
                        <span style="color: var(--text-muted);">  "Just posting relationship status"</span>
                        <div style="color: var(--accent-green); font-size: 0.85rem; margin-top: 4px;"> $135B revenue (2023)</div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);"> Spotify</strong>
                        <span style="color: var(--text-muted);">  "Just playing free music"</span>
                        <div style="color: var(--accent-green); font-size: 0.85rem; margin-top: 4px;"> $14B revenue (2023)</div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);"> NYT Wordle</strong>
                        <span style="color: var(--text-muted);">  "Just a free word game"</span>
                        <div style="color: var(--accent-green); font-size: 0.85rem; margin-top: 4px;"> Acquired for ~$1M, now drives majority of NYT digital</div>
                    </div>
                </div>
            </div>
            
            <!-- Market Fragmentation -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> A Fragmented Market
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    The daily puzzle space is massive but fragmented. No one owns the "hub" layer.
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <span class="pitch-game-tag">NYT Games (7+ games)</span>
                    <span class="pitch-game-tag">LinkedIn (5 games)</span>
                    <span class="pitch-game-tag">Washington Post</span>
                    <span class="pitch-game-tag">LA Times</span>
                    <span class="pitch-game-tag">300+ Wordle clones</span>
                    <span class="pitch-game-tag">Geography games</span>
                    <span class="pitch-game-tag">Sports trivia</span>
                    <span class="pitch-game-tag">Music guessers</span>
                    <span class="pitch-game-tag">Math puzzles</span>
                </div>
                <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--accent-purple);">
                    <div style="color: var(--text-primary); font-weight: 600;"> Game Shelf's Opportunity</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px;">
                        Be the aggregation layer  the place where all puzzles connect, compete, and get tracked.
                    </div>
                </div>
            </div>
            
            <!-- Key Takeaway -->
            <div style="background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: 12px; padding: 20px; text-align: center;">
                <h3 style="color: white; margin: 0 0 10px 0;"> The Opportunity</h3>
                <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1rem; line-height: 1.6;">
                    <strong>14.5M daily Wordle players  3-5 games each  zero unified tracking = massive unserved need.</strong>
                </p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeMarketModal(); showPitchPage();" style="flex: 1;"> Back to Pitch</button>
                <button class="btn btn-primary" onclick="closeMarketModal(); showDataStrategyPage();" style="flex: 1;">Data Strategy </button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
                <a href="?market" style="color: var(--accent-blue);" onclick="copyShareUrl('market'); return false;">Copy Link</a>
            </p>
        </div>
    </div>

    <!-- Data Strategy Modal -->
    <div class="modal-overlay" id="data-modal">
        <div class="modal" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h1 style="font-size: 1.8rem; margin: 0; color: var(--text-primary);">Data Capture Strategy</h1>
                <p style="color: var(--accent-blue); font-size: 1rem; margin-top: 5px;">"How do you get the data?"  We've thought about this.</p>
            </div>
            
            <!-- The Challenge -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-red); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-red); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> The Challenge
                </h3>
                <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                    Daily puzzle games don't have APIs. They're walled gardens. Getting play data requires <strong>creative solutions</strong>  but this is a solved problem with multiple approaches.
                </p>
            </div>
            
            <!-- Strategy 1: Share Text -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="background: var(--accent-green); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</div>
                    <div>
                        <h4 style="color: var(--text-primary); margin: 0;"> Share Text Parsing</h4>
                        <span style="background: var(--accent-green); color: #000; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px;">LIVE NOW</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Every puzzle game has a "Share" button that copies results to clipboard. We parse that text automatically.
                </p>
                <div style="background: var(--bg-primary); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.8rem; color: var(--text-muted);">
                    Wordle 1,234 4/6<br>
                    <br>
                    <br>
                    <br>
                    
                </div>
                <p style="color: var(--accent-green); font-size: 0.85rem; margin: 12px 0 0 0;">
                     Works with 20+ games today &nbsp;|&nbsp;  No installation needed &nbsp;|&nbsp;  Mobile + Desktop
                </p>
            </div>
            
            <!-- Strategy 2: Browser Extension -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="background: var(--accent-blue); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</div>
                    <div>
                        <h4 style="color: var(--text-primary); margin: 0;"> Browser Extension (Auto-Capture)</h4>
                        <span style="background: var(--accent-blue); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px;">BETA</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Our Chrome extension detects when you complete a game and automatically logs results. Zero manual entry.
                </p>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--text-primary); font-weight: 600;">DOM Observation</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Watches for completion states</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--text-primary); font-weight: 600;">Local Storage</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Reads game state data</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--text-primary); font-weight: 600;">Network Interception</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Catches API responses</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 10px; border-radius: 8px;">
                        <div style="color: var(--text-primary); font-weight: 600;">Share Button Hook</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Intercepts share actions</div>
                    </div>
                </div>
            </div>
            
            <!-- Strategy 3: Screenshot OCR -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="background: var(--accent-purple); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</div>
                    <div>
                        <h4 style="color: var(--text-primary); margin: 0;"> Screenshot Import (OCR)</h4>
                        <span style="background: var(--accent-purple); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px;">LIVE NOW</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Upload a screenshot of your NYT Games stats page. We use OCR to extract all your historical data at once.
                </p>
                <p style="color: var(--accent-purple); font-size: 0.85rem; margin: 0;">
                     Backfill months of history &nbsp;|&nbsp;  Perfect for onboarding &nbsp;|&nbsp;  Works from mobile
                </p>
            </div>
            
            <!-- Strategy 4: Mobile Share -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="background: var(--accent-orange); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">4</div>
                    <div>
                        <h4 style="color: var(--text-primary); margin: 0;"> Mobile Share Target (PWA)</h4>
                        <span style="background: var(--accent-orange); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px;">IN PROGRESS</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 15px 0; line-height: 1.6;">
                    Install Game Shelf as a PWA on your phone. When you tap "Share" in any game, Game Shelf appears as a share target.
                </p>
                <p style="color: var(--accent-orange); font-size: 0.85rem; margin: 0;">
                    Share  Game Shelf  Auto-logged. Native app experience, no App Store needed.
                </p>
            </div>
            
            <!-- Future Strategies -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> Future Possibilities
                </h3>
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.2rem;"></span>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 600;">Official Partnerships</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">API access deals with game publishers</div>
                        </div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.2rem;"></span>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 600;">OAuth Integration</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">"Sign in with NYT Games" style connections</div>
                        </div>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.2rem;"></span>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 600;">Own Games Integration</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Featured games (Quotle, Slate, etc.) report natively</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Precedent -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-green); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                    <span></span> This Approach Has Precedent
                </h3>
                <div style="display: grid; gap: 10px;">
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);">Strava</strong>
                        <span style="color: var(--text-muted);">  Started with manual uploads, now has 1000+ device integrations</span>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);">Mint</strong>
                        <span style="color: var(--text-muted);">  Screen-scraped banks before official APIs existed</span>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);">Last.fm</strong>
                        <span style="color: var(--text-muted);">  Music scrobbling from player plugins before Spotify API</span>
                    </div>
                    <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);">RescueTime</strong>
                        <span style="color: var(--text-muted);">  Desktop agent tracks apps without official integrations</span>
                    </div>
                </div>
            </div>
            
            <!-- Key Message -->
            <div style="background: linear-gradient(135deg, var(--accent-blue), #2563eb); border-radius: 12px; padding: 20px; text-align: center;">
                <h3 style="color: white; margin: 0 0 10px 0;"> Bottom Line</h3>
                <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1rem; line-height: 1.6;">
                    <strong>Data capture is a solvable problem.</strong> We have 4 working methods today, with clear paths to more. The real moat is the user network and competition layer.
                </p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDataModal(); showMarketPage();" style="flex: 1;"> Market Size</button>
                <button class="btn btn-primary" onclick="closeDataModal(); showPitchPage();" style="flex: 1;">Back to Pitch</button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
                <a href="?data" style="color: var(--accent-blue);" onclick="copyShareUrl('data'); return false;">Copy Link</a>
            </p>
        </div>
    </div>

    <!-- Value Pyramid Modal -->
    <div class="modal-overlay" id="pyramid-modal">
        <div class="modal" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h1 style="font-size: 1.8rem; margin: 0; color: var(--text-primary);">The Value Pyramid</h1>
                <p style="color: var(--accent-blue); font-size: 1rem; margin-top: 5px;">Different users, different value  all from one platform</p>
            </div>
            
            <!-- Visual Pyramid -->
            <div style="margin-bottom: 25px;">
                <!-- Level 5: Social (Top) -->
                <div style="background: linear-gradient(135deg, #ec4899, #be185d); border-radius: 12px 12px 0 0; padding: 15px 20px; text-align: center; margin: 0 60px;">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;"></div>
                    <div style="color: white; font-weight: 700; font-size: 0.9rem;">SOCIAL HUB</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">Share everywhere</div>
                </div>
                
                <!-- Level 4: Prizes -->
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 15px 20px; text-align: center; margin: 0 45px;">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;"></div>
                    <div style="color: white; font-weight: 700; font-size: 0.9rem;">PRIZES & STAKES</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">Real rewards</div>
                </div>
                
                <!-- Level 3: Battles -->
                <div style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); padding: 15px 20px; text-align: center; margin: 0 30px;">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;"></div>
                    <div style="color: white; font-weight: 700; font-size: 0.9rem;">BRAIN BATTLES</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">Competition</div>
                </div>
                
                <!-- Level 2: Tracking -->
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 15px 20px; text-align: center; margin: 0 15px;">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;"></div>
                    <div style="color: white; font-weight: 700; font-size: 0.9rem;">STREAK TRACKING</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">Stats & Progress</div>
                </div>
                
                <!-- Level 1: Hub (Base) -->
                <div style="background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 0 0 12px 12px; padding: 15px 20px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;"></div>
                    <div style="color: white; font-weight: 700; font-size: 0.9rem;">CENTRAL HUB</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.75rem;">One place for all games</div>
                </div>
            </div>
            
            <!-- Detailed Breakdown -->
            
            <!-- Level 1: Central Hub -->
            <div style="background: var(--bg-secondary); border-left: 4px solid #22c55e; border-radius: 0 12px 12px 0; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <h4 style="color: #22c55e; margin: 0;">Level 1: Central Hub</h4>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">EVERYONE  Widest Appeal</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 10px 0; line-height: 1.6;">
                    <strong>Value:</strong> One place to launch all your daily puzzles. No more bookmarks, no more forgetting which games you play.
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">25+ games</span>
                    <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Quick launch</span>
                    <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Custom shelf</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                         <em>"I just need somewhere to keep track of all my games in one place."</em>
                    </div>
                </div>
            </div>
            
            <!-- Level 2: Streak Tracking -->
            <div style="background: var(--bg-secondary); border-left: 4px solid #3b82f6; border-radius: 0 12px 12px 0; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <h4 style="color: #3b82f6; margin: 0;">Level 2: Streak Tracking</h4>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">ENGAGED PLAYERS  Daily Habit</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 10px 0; line-height: 1.6;">
                    <strong>Value:</strong> Build and maintain streaks across ALL your games. See stats, patterns, and progress over time.
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Streak tracking</span>
                    <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Daily/weekly stats</span>
                    <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">History calendar</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                         <em>"I'm on a 47-day Wordle streak but I have no idea about my other games!"</em>
                    </div>
                </div>
            </div>
            
            <!-- Level 3: Brain Battles -->
            <div style="background: var(--bg-secondary); border-left: 4px solid #8b5cf6; border-radius: 0 12px 12px 0; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <h4 style="color: #8b5cf6; margin: 0;">Level 3: Brain Battles</h4>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">COMPETITIVE  Most Differentiated</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 10px 0; line-height: 1.6;">
                    <strong>Value:</strong> Turn solo puzzles into competitions. 1v1 challenges, group battles, tournaments. Finally answer: "Who's the best puzzler?"
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">1v1 challenges</span>
                    <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Group battles</span>
                    <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Tournaments</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px dashed #8b5cf6; border-radius: 8px;">
                    <div style="color: #8b5cf6; font-size: 0.85rem; font-weight: 600;">
                         Key Insight: This is the most differentiated feature, but needs education. Users don't know this exists!
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                         <em>"Wait, I can actually compete with my coworkers on puzzles? That's amazing!"</em>
                    </div>
                </div>
            </div>
            
            <!-- Level 4: Prizes & Stakes -->
            <div style="background: var(--bg-secondary); border-left: 4px solid #f59e0b; border-radius: 0 12px 12px 0; padding: 15px 20px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <h4 style="color: #f59e0b; margin: 0;">Level 4: Prizes & Stakes</h4>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">HIGH ENGAGEMENT  Monetization</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 10px 0; line-height: 1.6;">
                    <strong>Value:</strong> Add real stakes to battles. Shelf Coins as wagers, redeemable for actual prizes. Makes every puzzle matter.
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Shelf Coins</span>
                    <span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Prize pools</span>
                    <span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Gift redemption</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                         <em>"My office does a $5 buy-in weekly puzzle challenge. This makes it so much easier!"</em>
                    </div>
                </div>
            </div>
            
            <!-- Level 5: Social Hub -->
            <div style="background: var(--bg-secondary); border-left: 4px solid #ec4899; border-radius: 0 12px 12px 0; padding: 15px 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <h4 style="color: #ec4899; margin: 0;">Level 5: Social Hub</h4>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">POWER USERS  Time Saver</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin: 0 0 10px 0; line-height: 1.6;">
                    <strong>Value:</strong> Write once, share everywhere. Post results to Twitter, Discord, Reddit, and more with one click. See friends' activity.
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="background: rgba(236, 72, 153, 0.2); color: #ec4899; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">8+ platforms</span>
                    <span style="background: rgba(236, 72, 153, 0.2); color: #ec4899; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Activity feed</span>
                    <span style="background: rgba(236, 72, 153, 0.2); color: #ec4899; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem;">Friend discovery</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem;">
                         <em>"I post my results to 3 different Discord servers. This saves me so much time!"</em>
                    </div>
                </div>
            </div>
            
            <!-- Key Takeaway -->
            <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-gold); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--accent-gold); margin: 0 0 15px 0; text-align: center;"> The Strategy</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2rem;">1</span>
                        <div style="color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">Acquire with the Hub</strong>  Everyone needs a central place for games. Low barrier, wide appeal.
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2rem;">2</span>
                        <div style="color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">Engage with Streaks</strong>  Build the daily habit. Stats create stickiness.
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2rem;">3</span>
                        <div style="color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">Differentiate with Battles</strong>  No one else does this. Educate users on the possibility.
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2rem;">4</span>
                        <div style="color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">Monetize with Stakes</strong>  Coins and prizes drive revenue.
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 1.2rem;">5</span>
                        <div style="color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">Retain with Social</strong>  Friends, sharing, community keep people coming back.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Segments -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin: 0 0 15px 0;"> User Segments</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-primary);">Casual (Hub only)</span>
                        <span style="color: var(--accent-green); font-weight: 600;">~60% of users</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-primary);">Engaged (+ Streaks)</span>
                        <span style="color: var(--accent-blue); font-weight: 600;">~25% of users</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-primary);">Competitive (+ Battles)</span>
                        <span style="color: var(--accent-purple); font-weight: 600;">~10% of users</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border-radius: 8px;">
                        <span style="color: var(--text-primary);">Power Users (Full pyramid)</span>
                        <span style="color: var(--accent-orange); font-weight: 600;">~5% of users</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closePyramidModal(); showPitchPage();" style="flex: 1;"> Back to Pitch</button>
                <button class="btn btn-primary" onclick="closePyramidModal(); showMarketPage();" style="flex: 1;">Market Size </button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
                <a href="?pyramid" style="color: var(--accent-blue);" onclick="copyShareUrl('pyramid'); return false;">Copy Link</a>
            </p>
        </div>
    </div>

    <!-- Share Hub Modal -->
    <div class="modal-overlay" id="share-hub-modal">
        <div class="modal" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;"></div>
                <h2 style="font-size: 1.5rem; margin: 0; color: var(--text-primary);">Share Hub</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">Write once, share everywhere</p>
            </div>
            
            <!-- Today's Results Summary -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h4 style="color: var(--text-primary); margin: 0;"> Today's Results</h4>
                    <span id="share-hub-date" style="color: var(--text-muted); font-size: 0.85rem;"></span>
                </div>
                <div id="share-hub-results" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <!-- Filled dynamically -->
                </div>
            </div>
            
            <!-- Message Composer -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <label style="color: var(--text-primary); font-weight: 600;"> Your Message</label>
                    <select id="share-template-select" onchange="applyShareTemplate()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 4px 8px; font-size: 0.85rem;">
                        <option value="default">Default</option>
                        <option value="brag">Bragging </option>
                        <option value="humble">Humble </option>
                        <option value="streak">Streak Focus </option>
                        <option value="challenge">Challenge Friends </option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>
                <textarea id="share-message" rows="4" style="width: 100%; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; font-size: 0.95rem; resize: vertical; font-family: inherit;" placeholder="Write your message here..."></textarea>
                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertShareEmoji('')" style="padding: 4px 8px;"></button>
                    <button class="btn btn-small" onclick="insertResultsToMessage()" style="padding: 4px 10px; margin-left: auto;">+ Add Results</button>
                </div>
            </div>
            
            <!-- Include Options -->
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-bottom: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); cursor: pointer;">
                        <input type="checkbox" id="share-include-results" checked style="width: 16px; height: 16px;">
                        Include scores
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); cursor: pointer;">
                        <input type="checkbox" id="share-include-streak" checked style="width: 16px; height: 16px;">
                        Include streaks
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); cursor: pointer;">
                        <input type="checkbox" id="share-include-link" style="width: 16px; height: 16px;">
                        Include Game Shelf link
                    </label>
                </div>
            </div>
            
            <!-- Share Platforms -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin: 0 0 15px 0;"> Share To</h4>
                
                <!-- Primary Platforms -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <button onclick="shareToTwitter()" class="share-platform-btn" style="background: #000; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Twitter/X</div>
                    </button>
                    <button onclick="shareToFacebook()" class="share-platform-btn" style="background: #1877F2; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Facebook</div>
                    </button>
                    <button onclick="shareToLinkedIn()" class="share-platform-btn" style="background: #0A66C2; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">LinkedIn</div>
                    </button>
                    <button onclick="shareToThreads()" class="share-platform-btn" style="background: #000; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Threads</div>
                    </button>
                </div>
                
                <!-- Secondary Platforms -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <button onclick="shareToReddit()" class="share-platform-btn" style="background: #FF4500; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Reddit</div>
                    </button>
                    <button onclick="shareToDiscord()" class="share-platform-btn" style="background: #5865F2; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Discord</div>
                    </button>
                    <button onclick="shareToBlueSky()" class="share-platform-btn" style="background: #0085FF; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">BlueSky</div>
                    </button>
                    <button onclick="shareToMastodon()" class="share-platform-btn" style="background: #6364FF; border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">Mastodon</div>
                    </button>
                </div>
                
                <!-- Utility Options -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button onclick="copyShareMessage()" class="share-platform-btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: var(--text-primary); font-size: 0.75rem; margin-top: 4px;">Copy to Clipboard</div>
                    </button>
                    <button onclick="shareNative()" class="share-platform-btn" style="background: var(--accent-green); border: none; border-radius: 10px; padding: 12px 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 1.5rem;"></div>
                        <div style="color: white; font-size: 0.75rem; margin-top: 4px;">More Options...</div>
                    </button>
                </div>
            </div>
            
            <!-- Recent Shares -->
            <div id="share-history-section" style="background: var(--bg-secondary); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none;">
                <h4 style="color: var(--text-primary); margin: 0 0 10px 0;"> Recent Shares</h4>
                <div id="share-history-list" style="font-size: 0.85rem; color: var(--text-muted);">
                    <!-- Filled dynamically -->
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="closeShareHub()" style="width: 100%;">Close</button>
        </div>
    </div>

    <!-- Extension Modal -->
    <div class="modal-overlay" id="extension-modal">
        <div class="modal" style="max-width: 500px;">
            <h2> Auto-Log Your Games</h2>
            <p style="color: var(--text-secondary); margin: 15px 0;">
                Choose the easiest way to log your puzzle results:
            </p>
            
            <!-- Option 1: Easiest -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <div>
                        <strong style="color: var(--accent-green);">Easiest: Copy & Paste</strong>
                        <span style="background: var(--accent-green); color: #000; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">RECOMMENDED</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                    After finishing a game, tap "Share"  Copy  Come back here
                </p>
                <button class="btn btn-primary" onclick="closeExtensionModal(); toggleQuickLog();" style="width: 100%;">
                     Open Quick Log
                </button>
                <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 8px; text-align: center;">
                    Works with ALL games  No setup needed
                </p>
            </div>
            
            <!-- Option 2: Mobile -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <strong>Mobile: Share Directly</strong>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Add Game Shelf to your home screen, then share game results directly to it!
                </p>
                <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 8px;">
                    iPhone/Android  Tap Share  "Game Shelf"
                </p>
            </div>
            
            <!-- Option 3: Browser Extension -->
            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;"></span>
                    <strong>Advanced: Browser Extension</strong>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">
                    Auto-detects when you finish games. Requires some technical setup.
                </p>
                <details style="cursor: pointer;">
                    <summary style="color: var(--accent-gold); font-size: 0.85rem;">Show extension instructions </summary>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--bg-hover);">
                        <!-- Browser Tabs -->
                        <div class="extension-browser-tabs">
                            <button class="ext-tab active" onclick="showBrowserInstructions('chrome')">Chrome</button>
                            <button class="ext-tab" onclick="showBrowserInstructions('edge')">Edge</button>
                            <button class="ext-tab" onclick="showBrowserInstructions('brave')">Brave</button>
                            <button class="ext-tab" onclick="showBrowserInstructions('safari')">Safari</button>
                        </div>
                        
                        <!-- Chrome Instructions -->
                        <div class="ext-instructions" id="ext-chrome" style="margin-top: 10px; background: transparent; padding: 0;">
                            <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                               class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" download>
                                 Download Extension
                            </a>
                            <ol style="color: var(--text-secondary); font-size: 0.85rem; padding-left: 20px; margin: 0;">
                                <li>Unzip the downloaded file</li>
                                <li>Go to <code>chrome://extensions</code></li>
                                <li>Turn on "Developer mode" (top right)</li>
                                <li>Click "Load unpacked"  select folder</li>
                            </ol>
                        </div>
                        
                        <!-- Edge Instructions -->
                        <div class="ext-instructions" id="ext-edge" style="display: none; margin-top: 10px; background: transparent; padding: 0;">
                            <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                               class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" download>
                                 Download Extension
                            </a>
                            <ol style="color: var(--text-secondary); font-size: 0.85rem; padding-left: 20px; margin: 0;">
                                <li>Unzip the downloaded file</li>
                                <li>Go to <code>edge://extensions</code></li>
                                <li>Turn on "Developer mode" (bottom left)</li>
                                <li>Click "Load unpacked"  select folder</li>
                            </ol>
                        </div>
                        
                        <!-- Brave Instructions -->
                        <div class="ext-instructions" id="ext-brave" style="display: none; margin-top: 10px; background: transparent; padding: 0;">
                            <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                               class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" download>
                                 Download Extension
                            </a>
                            <ol style="color: var(--text-secondary); font-size: 0.85rem; padding-left: 20px; margin: 0;">
                                <li>Unzip the downloaded file</li>
                                <li>Go to <code>brave://extensions</code></li>
                                <li>Turn on "Developer mode" (top right)</li>
                                <li>Click "Load unpacked"  select folder</li>
                            </ol>
                        </div>
                        
                        <!-- Safari Instructions -->
                        <div class="ext-instructions" id="ext-safari" style="display: none; margin-top: 10px; background: transparent; padding: 0;">
                            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px;">
                                <strong style="color: var(--accent-gold);"> Safari Not Supported</strong>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 8px 0 0 0;">
                                    Safari extensions require developer tools that most users don't have installed.
                                </p>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 8px 0 0 0;">
                                    <strong>Alternatives:</strong><br>
                                     Use Copy & Paste method (works great!)<br>
                                     Use Chrome, Edge, or Brave instead
                                </p>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeExtensionModal()" style="flex:1">Done</button>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div class="modal-overlay" id="wallet-modal">
        <div class="modal" style="max-width: 420px;">
            <h2> My Wallet</h2>
            
            <!-- Dual Currency Display -->
            <div class="wallet-dual-display">
                <div class="wallet-currency-card token-card">
                    <div class="currency-icon"></div>
                    <div class="currency-info">
                        <div class="currency-amount" id="wallet-modal-tokens">0</div>
                        <div class="currency-label">Tokens</div>
                    </div>
                    <div class="currency-badge-tag free">FREE</div>
                </div>
                <div class="wallet-currency-card coin-card">
                    <div class="currency-icon"></div>
                    <div class="currency-info">
                        <div class="currency-amount" id="wallet-modal-coins">0</div>
                        <div class="currency-label">Coins</div>
                    </div>
                    <div class="currency-badge-tag premium">PREMIUM</div>
                </div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn btn-primary" onclick="showBuyCoinsModal()">
                     Get Coins
                </button>
                <button class="btn btn-secondary" onclick="showSubscriptionModal()">
                     Go Pro
                </button>
            </div>
            
            <div class="wallet-section">
                <div class="wallet-section-title"> How to Earn Tokens</div>
                <div class="earn-list">
                    <div class="earn-item">
                        <span class="earn-action">Daily login</span>
                        <span class="earn-amount">+50 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">Complete a game</span>
                        <span class="earn-amount">+100 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">7-day streak bonus</span>
                        <span class="earn-amount">+500 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">30-day streak bonus</span>
                        <span class="earn-amount">+2,000 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">Unlock achievement</span>
                        <span class="earn-amount">+250-1000 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">Win Free Battle</span>
                        <span class="earn-amount">+200 </span>
                    </div>
                    <div class="earn-item highlight">
                        <span class="earn-action"> Pro Subscriber</span>
                        <span class="earn-amount">2x all earnings!</span>
                    </div>
                </div>
            </div>
            
            <div class="wallet-section">
                <div class="wallet-section-title"> How to Get Coins</div>
                <div class="earn-list">
                    <div class="earn-item">
                        <span class="earn-action">Purchase directly</span>
                        <span class="earn-amount">$1  1 </span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">Subscribe to Pro</span>
                        <span class="earn-amount">10 /month</span>
                    </div>
                    <div class="earn-item">
                        <span class="earn-action">Win Prize Battles</span>
                        <span class="earn-amount">Prize Pool </span>
                    </div>
                </div>
                <p class="wallet-note"> Coins can be redeemed for real gifts. 18+ only.</p>
            </div>
            
            <div class="wallet-section">
                <div class="wallet-section-title"> Recent Activity</div>
                <div class="transaction-list" id="transaction-list">
                    <div class="transaction-empty">No transactions yet. Play games to earn tokens!</div>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeWalletModal()" style="flex:1">Close</button>
            </div>
        </div>
    </div>

    <!-- Buy Coins Modal -->
    <div class="modal-overlay" id="buy-coins-modal">
        <div class="modal" style="max-width: 400px;">
            <h2> Get Coins</h2>
            
            <!-- Age Verification Warning -->
            <div class="age-verification-notice" id="age-notice">
                <div class="age-notice-icon"></div>
                <p>Coins can be redeemed for real gifts. You must be <strong>18 or older</strong> to purchase.</p>
                <div class="age-verify-buttons">
                    <button class="btn btn-primary" onclick="verifyAge(true)">I am 18+</button>
                    <button class="btn btn-secondary" onclick="verifyAge(false)">I'm under 18</button>
                </div>
            </div>
            
            <!-- Coin Packs (shown after age verification) -->
            <div class="coin-purchase-content" id="coin-purchase-content" style="display: none;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; text-align: center;">
                    1 Coin  $1 value  Redeem for real gifts via Goody
                </p>
                
                <div class="coin-packs-new">
                    <div class="coin-pack-card" onclick="selectCoinPack(0)">
                        <div class="pack-name">Starter</div>
                        <div class="pack-coins-display"> 5</div>
                        <div class="pack-price-display">$4.99</div>
                    </div>
                    <div class="coin-pack-card popular" onclick="selectCoinPack(1)">
                        <div class="pack-popular-tag">POPULAR</div>
                        <div class="pack-name">Plus</div>
                        <div class="pack-coins-display"> 11</div>
                        <div class="pack-price-display">$9.99</div>
                        <div class="pack-bonus">+10% bonus</div>
                    </div>
                    <div class="coin-pack-card best-value" onclick="selectCoinPack(2)">
                        <div class="pack-best-tag">BEST VALUE</div>
                        <div class="pack-name">Value</div>
                        <div class="pack-coins-display"> 28</div>
                        <div class="pack-price-display">$24.99</div>
                        <div class="pack-bonus">+12% bonus</div>
                    </div>
                </div>
                
                <div class="subscription-promo" onclick="showSubscriptionModal(); closeBuyCoinsModal();">
                    <div class="promo-content">
                        <span class="promo-badge"> PRO</span>
                        <span class="promo-text">Get 10 Coins/month + 2x Token earnings for $9.99/mo</span>
                    </div>
                    <span class="promo-arrow"></span>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBuyCoinsModal()" style="flex:1">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Subscription Modal -->
    <div class="modal-overlay" id="subscription-modal">
        <div class="modal" style="max-width: 400px;">
            <h2> Game Shelf Pro</h2>
            
            <div class="subscription-benefits">
                <div class="benefit-item">
                    <span class="benefit-icon"></span>
                    <span class="benefit-text"><strong>10 Coins</strong> every month</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon"></span>
                    <span class="benefit-text"><strong>2x Token</strong> earnings</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon"></span>
                    <span class="benefit-text"><strong>Pro badge</strong> on profile</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon"></span>
                    <span class="benefit-text"><strong>Exclusive</strong> cosmetics</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon"></span>
                    <span class="benefit-text"><strong>Early access</strong> to features</span>
                </div>
            </div>
            
            <div class="subscription-tiers">
                <div class="sub-tier-card" onclick="selectSubscription('monthly')">
                    <div class="sub-tier-name">Monthly</div>
                    <div class="sub-tier-price">$9.99<span>/mo</span></div>
                    <div class="sub-tier-detail">10 Coins every month</div>
                </div>
                <div class="sub-tier-card annual" onclick="selectSubscription('annual')">
                    <div class="sub-save-badge">Save $20</div>
                    <div class="sub-tier-name">Annual</div>
                    <div class="sub-tier-price">$99.99<span>/yr</span></div>
                    <div class="sub-tier-detail">120 Coins per year</div>
                </div>
            </div>
            
            <p class="subscription-note">Cancel anytime. Must be 18+ to subscribe.</p>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeSubscriptionModal()" style="flex:1">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Public Tournaments Modal -->
    
    <!-- Game Tracking Settings Modal -->
    <!-- All Games Tracking Modal -->
    <div class="modal-overlay" id="all-tracking-modal">
        <div class="modal" style="max-width: 480px; max-height: 85vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2> Tracking Preferences</h2>
                <button class="close-btn" onclick="closeAllTrackingModal()"></button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem;">
                Set where you play each game and how results are captured.
            </p>
            <div id="all-tracking-list" style="flex: 1; overflow-y: auto; margin: 0 -20px; padding: 0 20px;">
                <!-- Populated by JS -->
            </div>
            <div class="btn-group" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                <button class="btn btn-primary" onclick="closeAllTrackingModal()" style="flex: 1;">Done</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="game-tracking-modal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h2><span id="tracking-game-icon"></span> <span id="tracking-game-name">Game</span> Settings</h2>
                <button class="close-btn" onclick="closeGameTrackingModal()"></button>
            </div>
            
            <div class="tracking-section">
                <div class="tracking-section-title"> Where do you play this game?</div>
                <p class="tracking-section-desc">This helps us track your stats consistently across devices.</p>
                
                <div class="tracking-source-options" id="tracking-source-options">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="tracking-section">
                <div class="tracking-section-title"> How should we capture results?</div>
                
                <div class="entry-method-options" id="entry-method-options">
                    <!-- Populated by JS based on tracking source -->
                </div>
            </div>
            
            <div class="tracking-section">
                <div class="tracking-section-title"> Cloud Sync</div>
                <label class="tracking-toggle">
                    <input type="checkbox" id="tracking-cloud-sync" disabled>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Sync this game across all devices</span>
                    <span class="pro-feature-tag"> Pro</span>
                </label>
                <p class="tracking-note">Coming soon for Pro subscribers</p>
            </div>
            
            <div class="tracking-section">
                <div class="tracking-section-title"> Daily Goal</div>
                <label class="tracking-toggle">
                    <input type="checkbox" id="tracking-goal-enabled" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Include in daily goal count</span>
                </label>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeGameTrackingModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveGameTrackingSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Public Tournaments Modal -->
    <div class="modal-overlay" id="tournaments-modal">
        <div class="modal" style="max-width: 440px; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2> Public Tournaments</h2>
                <button class="close-btn" onclick="closeTournamentsModal()"></button>
            </div>
            
            <div class="tournament-tabs">
                <button class="tournament-tab active" onclick="filterTournaments('all')">All</button>
                <button class="tournament-tab" onclick="filterTournaments('free')">Free</button>
                <button class="tournament-tab" onclick="filterTournaments('elimination')">Survival</button>
                <button class="tournament-tab" onclick="filterTournaments('points')">Points</button>
            </div>
            
            <div class="tournaments-list-container" style="flex: 1; overflow-y: auto;">
                <div id="tournaments-list">
                    <div class="battle-empty">
                        <div class="empty-icon"></div>
                        <p>Loading tournaments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merch Store Modal -->
    <div class="modal-overlay" id="merch-modal">
        <div class="modal" style="max-width: 460px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                <h2 style="margin-bottom: 0;"> Merch Store</h2>
                <button class="close-btn" onclick="closeMerchModal()"></button>
            </div>
            
            <div class="merch-balance-bar" style="flex-shrink: 0;">
                <span>Your Balance:</span>
                <span class="merch-balance-amount"> <span id="merch-balance">0</span></span>
                <button class="btn btn-small" onclick="closeMerchModal(); showWalletModal();">+ Get Coins</button>
            </div>
            
            <div class="merch-tabs" style="flex-shrink: 0;">
                <button class="merch-tab active" onclick="filterMerch('all')">All</button>
                <button class="merch-tab" onclick="filterMerch('virtual')"> Rewards</button>
                <button class="merch-tab" onclick="filterMerch('physical')"> Gifts</button>
                <button class="merch-tab" onclick="showMerchOrders()"> Orders</button>
            </div>
            
            <div class="merch-catalog-container" style="flex: 1; overflow-y: auto; min-height: 0;">
                <div id="merch-catalog" class="merch-catalog">
                    <!-- Catalog items rendered here -->
                </div>
            </div>
            
            <div class="merch-footer-note" style="flex-shrink: 0;">
                <p>Physical items fulfilled by Goody. You can swap gifts!</p>
            </div>
        </div>
    </div>

    <!-- Create Battle Modal -->
    <div class="modal-overlay" id="create-battle-modal">
        <div class="modal" style="max-width: 420px;">
            <h2 id="create-battle-title"> Create Brain Battle</h2>
            
            <div class="battle-type-selector" id="battle-type-selector">
                <button class="battle-type-btn active" onclick="selectBattleType('challenge')">
                    <span class="type-icon"></span>
                    <span class="type-label">1v1</span>
                </button>
                <button class="battle-type-btn" onclick="selectBattleType('group')">
                    <span class="type-icon"></span>
                    <span class="type-label">Group</span>
                </button>
                <button class="battle-type-btn" onclick="selectBattleType('open')">
                    <span class="type-icon"></span>
                    <span class="type-label">Open</span>
                </button>
            </div>
            
            <div id="battle-type-hint" style="font-size: 0.8rem; color: var(--text-muted); text-align: center; margin: -5px 0 15px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                Challenge a specific friend to compete
            </div>

            <div class="form-group">
                <label>Battle Name</label>
                <input type="text" id="battle-name-input" placeholder="e.g., Family Wordle Wars 2026" maxlength="50">
            </div>

            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="battle-desc-input" placeholder='e.g., "Loser does dishes!"' maxlength="100">
            </div>

            <div class="form-group">
                <label>Select Games</label>
                <div class="game-checkboxes" id="battle-games">
                    <label class="game-checkbox">
                        <input type="checkbox" value="wordle" checked>  Wordle
                    </label>
                    <label class="game-checkbox">
                        <input type="checkbox" value="connections">  Connections
                    </label>
                    <label class="game-checkbox">
                        <input type="checkbox" value="mini">  Mini Crossword
                    </label>
                    <label class="game-checkbox">
                        <input type="checkbox" value="strands">  Strands
                    </label>
                    <label class="game-checkbox">
                        <input type="checkbox" value="spelling-bee">  Spelling Bee
                    </label>
                    <label class="game-checkbox">
                        <input type="checkbox" value="letterboxed">  Letterboxed
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Duration</label>
                <select id="battle-duration">
                    <option value="1">1 Day</option>
                    <option value="3">3 Days</option>
                    <option value="7" selected>1 Week</option>
                    <option value="14">2 Weeks</option>
                    <option value="30">1 Month</option>
                </select>
            </div>

            <div class="form-group">
                <label>Stakes</label>
                <div class="stakes-options">
                    <label class="stakes-option">
                        <input type="radio" name="stakes" value="bragging" checked>
                        <span> Bragging Rights (Free)</span>
                    </label>
                    <label class="stakes-option">
                        <input type="radio" name="stakes" value="coins">
                        <span> Coin Wager</span>
                    </label>
                </div>
                <div class="wager-input" id="wager-input" style="display: none;">
                    <input type="number" id="wager-amount" placeholder="Amount per player" min="50" max="10000">
                    <span class="wager-hint">Min: 50 coins</span>
                </div>
            </div>

            <!-- Friend Selection (for challenges, hidden for open battles) -->
            <div class="form-group" id="friend-select-group">
                <label>Select Opponent</label>
                <div class="friend-select-list" id="battle-friend-list">
                    <div class="empty-state" style="padding: 15px;">
                        <p>No friends yet. Add friends first!</p>
                    </div>
                </div>
            </div>
            
            <!-- Open battle hint -->
            <div id="open-battle-hint" style="display: none; padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    After creating, you'll get a <strong>join code</strong> to share with anyone!
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeCreateBattleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createBattle()">Create Battle</button>
            </div>
        </div>
    </div>

    <!-- Join Battle Modal -->
    <div class="modal-overlay" id="join-battle-modal">
        <div class="modal" style="max-width: 380px;">
            <h2> Join Battle</h2>
            <p style="color: var(--text-secondary); margin: 10px 0 20px;">
                Enter the 6-character battle code to join
            </p>
            
            <div class="form-group">
                <label>Battle Code</label>
                <input type="text" id="join-code-input" placeholder="e.g., ABC123" maxlength="6" 
                    style="text-transform: uppercase; letter-spacing: 4px; font-size: 1.5rem; text-align: center; font-family: monospace;">
            </div>
            
            <div id="join-battle-preview" style="display: none; padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin: 15px 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 2rem;"></span>
                    <div>
                        <div id="join-battle-name" style="font-weight: 700;"></div>
                        <div id="join-battle-info" style="font-size: 0.85rem; color: var(--text-muted);"></div>
                    </div>
                </div>
            </div>
            
            <div id="join-battle-error" style="display: none; color: var(--accent-red); padding: 10px; text-align: center;"></div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeJoinBattleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="joinBattleByCode()" id="join-battle-btn">Join Battle</button>
            </div>
        </div>
    </div>

    <!-- Battle Details Modal -->
    <div class="modal-overlay" id="battle-details-modal">
        <div class="modal" style="max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h2 id="battle-details-title"> Battle Details</h2>
                <button class="close-btn" onclick="closeBattleDetails()"></button>
            </div>
            
            <!-- Battle Status Banner -->
            <div id="battle-status-banner" style="padding: 12px; border-radius: 10px; margin: 15px 0; text-align: center;"></div>
            
            <!-- Battle Info -->
            <div class="battle-details-stats">
                <div class="battle-detail-stat">
                    <span class="stat-icon"></span>
                    <div>
                        <div class="stat-label">Games</div>
                        <div class="stat-value" id="battle-games-list"></div>
                    </div>
                </div>
                <div class="battle-detail-stat">
                    <span class="stat-icon"></span>
                    <div>
                        <div class="stat-label">Time Left</div>
                        <div class="stat-value" id="battle-time-left"></div>
                    </div>
                </div>
                <div class="battle-detail-stat" id="battle-prize-stat" style="display: none;">
                    <span class="stat-icon"></span>
                    <div>
                        <div class="stat-label">Prize Pool</div>
                        <div class="stat-value" id="battle-prize-pool"></div>
                    </div>
                </div>
            </div>
            
            <!-- Share Code (for pending battles) -->
            <div id="battle-share-code-section" style="display: none; margin: 20px 0;">
                <div style="text-align: center; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 8px;">Share this code to invite players:</div>
                    <div style="font-size: 2rem; font-family: monospace; letter-spacing: 6px; font-weight: 700; color: var(--accent-gold);" id="battle-join-code"></div>
                    <button class="btn btn-secondary" onclick="copyBattleCode()" style="margin-top: 10px;">
                         Copy Code
                    </button>
                </div>
            </div>
            
            <!-- Live Leaderboard -->
            <div class="section-header" style="margin-top: 20px;">
                <span class="section-title"> Leaderboard</span>
                <span id="battle-live-indicator" style="display: none; font-size: 0.75rem; color: var(--accent-green);"> LIVE</span>
            </div>
            <div class="battle-details-leaderboard" id="battle-leaderboard">
                <!-- Populated dynamically -->
            </div>
            
            <!-- Today's Scores -->
            <div class="section-header" style="margin-top: 20px;">
                <span class="section-title"> Today's Scores</span>
            </div>
            <div id="battle-today-scores" style="padding: 10px 0;">
                <!-- Populated dynamically -->
            </div>
            
            <!-- Battle Activity -->
            <div class="collapsible-section" style="margin-top: 15px;">
                <div class="collapsible-header" onclick="toggleSection('battle-activity')">
                    <span class="section-title"> Activity</span>
                    <span class="collapsible-arrow"></span>
                </div>
                <div class="collapsible-content" id="battle-activity" style="display: none;">
                    <div id="battle-activity-feed" style="max-height: 200px; overflow-y: auto;">
                        <!-- Activity items -->
                    </div>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBattleDetails()" style="flex: 1;">Close</button>
                <button class="btn btn-primary" id="battle-share-btn" onclick="shareBattleResults()" style="flex: 1;"> Share</button>
            </div>
        </div>
    </div>

    <!-- Battle Winner Celebration Modal -->
    <div class="modal-overlay" id="battle-winner-modal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div id="winner-celebration" style="font-size: 4rem; margin: 20px 0;"></div>
            <h2 id="winner-title">Battle Complete!</h2>
            <div id="winner-message" style="color: var(--text-secondary); margin: 15px 0;"></div>
            
            <div id="winner-podium" style="display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 30px 0;">
                <!-- 2nd place -->
                <div class="podium-spot" id="podium-2" style="text-align: center;">
                    <div class="podium-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 1.5rem;"></div>
                    <div class="podium-name" style="font-size: 0.8rem;"></div>
                    <div class="podium-score" style="font-size: 0.75rem; color: var(--text-muted);"></div>
                    <div style="background: #C0C0C0; height: 60px; width: 70px; border-radius: 8px 8px 0 0; margin-top: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"></div>
                </div>
                <!-- 1st place -->
                <div class="podium-spot" id="podium-1" style="text-align: center;">
                    <div class="podium-avatar" style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #FFD700, #FFA500); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 2rem;"></div>
                    <div class="podium-name" style="font-weight: 700;"></div>
                    <div class="podium-score" style="font-size: 0.85rem; color: var(--text-muted);"></div>
                    <div style="background: #FFD700; height: 90px; width: 80px; border-radius: 8px 8px 0 0; margin-top: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;"></div>
                </div>
                <!-- 3rd place -->
                <div class="podium-spot" id="podium-3" style="text-align: center;">
                    <div class="podium-avatar" style="width: 45px; height: 45px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 1.2rem;"></div>
                    <div class="podium-name" style="font-size: 0.8rem;"></div>
                    <div class="podium-score" style="font-size: 0.7rem; color: var(--text-muted);"></div>
                    <div style="background: #CD7F32; height: 40px; width: 60px; border-radius: 8px 8px 0 0; margin-top: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                </div>
            </div>
            
            <div id="winner-prize" style="display: none; padding: 15px; background: var(--bg-secondary); border-radius: 10px; margin: 15px 0;">
                <div style="color: var(--accent-gold); font-size: 1.2rem;"> Prize Won</div>
                <div id="winner-prize-amount" style="font-size: 2rem; font-weight: 700;"></div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeWinnerModal()">Close</button>
                <button class="btn btn-primary" onclick="shareBattleWin()"> Share Victory</button>
            </div>
        </div>
    </div>

    <!-- Goal Setting Modal -->
    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <h2> Set Daily Goal</h2>
            <p style="color: var(--text-secondary); margin: 15px 0;">
                How many games do you want to play each day?
            </p>
            <div class="goal-options" id="goal-options">
                <div class="goal-option" onclick="selectGoal(3)" data-goal="3">
                    <div class="goal-option-value">3</div>
                    <div class="goal-option-label">Casual</div>
                </div>
                <div class="goal-option selected" onclick="selectGoal(5)" data-goal="5">
                    <div class="goal-option-value">5</div>
                    <div class="goal-option-label">Regular</div>
                </div>
                <div class="goal-option" onclick="selectGoal(8)" data-goal="8">
                    <div class="goal-option-value">8</div>
                    <div class="goal-option-label">Active</div>
                </div>
                <div class="goal-option" onclick="selectGoal(10)" data-goal="10">
                    <div class="goal-option-value">10+</div>
                    <div class="goal-option-label">Pro</div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label style="color: var(--text-muted); font-size: 0.85rem;">Or set a custom goal:</label>
                <input type="number" id="custom-goal" placeholder="Enter number" min="1" max="20" 
                    style="margin-top: 8px; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--bg-hover); border-radius: 8px; color: var(--text-primary); width: 100%;">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveGoal()" style="flex:1">Save Goal</button>
                <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Quick Log Modal -->
    <div class="modal-overlay" id="quick-log-modal">
        <div class="modal">
            <h2> Log Game Results</h2>
            <p style="color: var(--text-secondary); margin: 10px 0;">Paste your share text from any supported game</p>
            <div class="quick-log-content">
                <textarea id="parse-input" placeholder="Paste your game results here...

Examples:
Wordle 1,234 4/6



Connections Puzzle #123
"></textarea>
                <div class="parse-result" id="parse-result" style="display: none; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="parse-result-icon" style="font-size: 1.5rem;"></span>
                        <div>
                            <div id="parse-result-game" style="font-weight: 700;">Wordle</div>
                            <div id="parse-result-score" style="font-size: 0.85rem; color: var(--text-secondary);">4/6</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="parseShareText()" style="flex:1"> Log Result</button>
                <button class="btn btn-secondary" onclick="closeQuickLogModal()">Cancel</button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 15px;">
                 Tip: Install Game Shelf as an app to share directly from games!
            </p>
        </div>
    </div>

    <!-- Share Success Modal -->
    <div class="modal-overlay" id="share-success-modal">
        <div class="modal share-success-modal">
            <div class="share-celebration" id="share-celebration"></div>
            <h2 id="share-modal-title">Nice Score!</h2>
            
            <div class="share-score-display" id="share-score-display">
                <div class="share-score-game" id="share-game-name">Wordle</div>
                <div class="share-score-result" id="share-score-result">4/6</div>
                <div class="share-streak-badge" id="share-streak-badge" style="display:none;">
                     5-day streak
                </div>
            </div>
            
            <div class="share-buttons">
                <button class="share-btn share-btn-primary" onclick="shareScoreNative()">
                     Share Score
                </button>
                <button class="share-btn share-btn-secondary" onclick="copyShareText()">
                     Copy to Clipboard
                </button>
                <button class="share-btn share-btn-skip" onclick="closeShareModal()">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Battle Share Modal -->
    <div class="modal-overlay" id="battle-share-modal">
        <div class="modal share-success-modal">
            <div class="share-celebration"></div>
            <h2>Battle Created!</h2>
            
            <div class="battle-share-card">
                <div class="battle-share-title" id="battle-share-name">Family Wordle Wars</div>
                <div class="battle-share-code" id="battle-share-code">ABC123</div>
                <div class="battle-share-details" id="battle-share-details">
                    7 days  Wordle, Connections
                </div>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 15px;">
                Share this code to invite your opponents!
            </p>
            
            <div class="share-buttons">
                <button class="share-btn share-btn-primary" onclick="shareBattleInvite()">
                     Share Invite Link
                </button>
                <button class="share-btn share-btn-secondary" onclick="copyBattleCode()">
                     Copy Code
                </button>
                <button class="share-btn share-btn-skip" onclick="closeBattleShareModal()">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Battle Victory Modal -->
    <div class="modal-overlay" id="battle-victory-modal">
        <div class="modal share-success-modal">
            <div class="share-celebration"></div>
            <h2>Victory!</h2>
            
            <div class="share-score-display" style="background: linear-gradient(135deg, #f6ad55, #ed8936);">
                <div class="share-score-game" id="victory-battle-name">Family Wordle Wars</div>
                <div class="share-score-result" id="victory-score">145 - 120</div>
                <div class="share-streak-badge" id="victory-prize" style="display:block; background: white; color: #1a1a1a;">
                     Won 200 coins!
                </div>
            </div>
            
            <div class="share-buttons">
                <button class="share-btn share-btn-primary" onclick="shareVictory()">
                     Brag About It!
                </button>
                <button class="share-btn share-btn-secondary" onclick="createRematchBattle()">
                     Challenge Again
                </button>
                <button class="share-btn share-btn-skip" onclick="closeVictoryModal()">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Share Screen (Share Target) -->
    <div class="modal-overlay" id="enhanced-share-modal">
        <div class="modal enhanced-share-screen">
            <div class="enhanced-share-header">
                <div id="enhanced-celebration" style="font-size: 2.5rem;"></div>
                <div id="enhanced-headline" style="font-size: 1.2rem; font-weight: 700; margin: 5px 0;">Great Score!</div>
                <div class="enhanced-score-badge" id="enhanced-score-badge">
                    <div class="enhanced-score-game" id="enhanced-game-name">Wordle</div>
                    <div class="enhanced-score-result" id="enhanced-score-result">3/6</div>
                </div>
            </div>

            <!-- Your Stats Section -->
            <div class="enhanced-section" id="enhanced-your-stats">
                <div class="enhanced-section-title"> Your Stats</div>
                <div class="enhanced-stat-row">
                    <span class="label">Current Streak</span>
                    <span class="value" id="enhanced-streak"> 47 days</span>
                </div>
                <div class="enhanced-stat-row">
                    <span class="label">This Month Avg</span>
                    <span class="value" id="enhanced-avg">3.8</span>
                </div>
                <div class="enhanced-stat-row">
                    <span class="label">Personal Best</span>
                    <span class="value" id="enhanced-best">1/6</span>
                </div>
            </div>

            <!-- Global Percentile Section -->
            <div class="enhanced-percentile-section" id="enhanced-percentile-section">
                <div class="enhanced-percentile" id="enhanced-percentile">
                     Calculating...
                </div>
            </div>

            <!-- Friends Comparison Section -->
            <div class="enhanced-section" id="enhanced-friends-section" style="display: none;">
                <div class="enhanced-section-title"> Today's Leaderboard</div>
                <div id="enhanced-friends-list">
                    <!-- Filled dynamically -->
                </div>
            </div>

            <!-- AI Suggestion Section -->
            <div class="enhanced-suggestion" id="enhanced-suggestion" style="display: none;">
                <div class="enhanced-suggestion-icon" id="suggestion-icon"></div>
                <div class="enhanced-suggestion-text" id="suggestion-text">
                    You beat Sarah! Challenge her to a battle?
                </div>
                <button class="enhanced-suggestion-btn" id="suggestion-btn" onclick="executeSuggestion()">
                     Challenge Sarah
                </button>
            </div>

            <!-- Enhanced Share Preview -->
            <div class="enhanced-section">
                <div class="enhanced-section-title"> Share Enhanced Result</div>
                <div class="enhanced-share-preview" id="enhanced-share-preview">
                    <!-- Preview text -->
                </div>
                <div class="enhanced-share-actions">
                    <button class="share-btn share-btn-primary" onclick="shareEnhancedResult()">
                         Share
                    </button>
                    <button class="share-btn share-btn-secondary" onclick="copyEnhancedResult()">
                         Copy
                    </button>
                </div>
                <button class="share-btn share-btn-secondary" onclick="shareAsImage('score')" style="width: 100%; margin-top: 10px;">
                     Share as Image (Instagram/Stories)
                </button>
            </div>

            <button class="share-btn share-btn-skip" onclick="closeEnhancedShareModal()" style="margin-top: 10px;">
                Done
            </button>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <h2> Your Profile</h2>
            <div class="profile-section">
                <img id="profile-avatar" class="profile-avatar" src="" alt="Profile">
                <div class="profile-name" id="profile-name">Player</div>
                <div class="profile-email" id="profile-email">user@example.com</div>
                
                <div class="sync-status" id="sync-status">
                    <span></span> <span id="sync-status-text">Synced to cloud</span>
                </div>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-games-played">0</div>
                        <div class="profile-stat-label">Games Played</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-best-streak">0</div>
                        <div class="profile-stat-label">Best Streak</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-achievements">0</div>
                        <div class="profile-stat-label">Achievements</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" onclick="shareAsImage('weekly')" style="width: 100%;"> Share Your Week</button>
                <button class="btn btn-secondary" onclick="syncNow()" style="width: 100%;"> Sync Now</button>
                <button class="btn btn-secondary" onclick="signOut()" style="width: 100%; color: var(--accent-red);"> Sign Out</button>
                <button class="btn btn-secondary" onclick="closeProfileModal()" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar (PWA mode) -->
    <nav class="bottom-nav" id="bottom-nav">
        <button class="bottom-nav-tab" onclick="switchTab('home')" data-tab="home">
            <span class="bottom-nav-icon"></span>
            <span class="bottom-nav-label">Home</span>
        </button>
        <button class="bottom-nav-tab active" onclick="switchTab('games')" data-tab="games">
            <span class="bottom-nav-icon"></span>
            <span class="bottom-nav-label">Games</span>
        </button>
        <button class="bottom-nav-tab" onclick="switchTab('social')" data-tab="social">
            <span class="bottom-nav-icon"></span>
            <span class="bottom-nav-label">Social</span>
        </button>
    </nav>

    <!-- Bottom Sheet for Logging -->
    <div class="bottom-sheet-overlay" id="log-bottom-sheet" onclick="closeLogBottomSheet(event)">
        <div class="bottom-sheet">
            <div class="bottom-sheet-handle" id="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header"> Log Game Result</div>
            <div class="bottom-sheet-content">
                <textarea id="bottom-sheet-input" placeholder="Paste your game results here...

Example:
Wordle 1,234 3/6



" style="
                    width: 100%;
                    height: 150px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border);
                    border-radius: 12px;
                    padding: 15px;
                    color: var(--text-primary);
                    font-size: 0.9rem;
                    font-family: inherit;
                    resize: none;
                    margin-bottom: 15px;
                "></textarea>
                <button onclick="submitFromBottomSheet()" style="
                    width: 100%;
                    padding: 16px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border: none;
                    border-radius: 12px;
                    color: white;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                ">Log It!</button>
                <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 15px;">
                    Or tap a game above to open and play
                </p>
            </div>
        </div>
    </div>

    <!-- Clipboard Auto-Detect Prompt -->
    <div class="clipboard-prompt" id="clipboard-prompt">
        <span class="clipboard-prompt-icon" id="clipboard-game-icon"></span>
        <span class="clipboard-prompt-text">Log <span id="clipboard-game-name">Wordle</span> <span id="clipboard-game-score">3/6</span>?</span>
        <button class="clipboard-prompt-yes" onclick="acceptClipboardPrompt()"></button>
        <button class="clipboard-prompt-no" onclick="dismissClipboardPrompt()"></button>
    </div>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt" id="pwa-install-prompt" style="display: none;">
        <button class="pwa-install-prompt-close" onclick="dismissInstallPrompt()"></button>
        <div class="pwa-install-prompt-icon"></div>
        <div class="pwa-install-prompt-content">
            <div class="pwa-install-prompt-title">Install Game Shelf</div>
            <div class="pwa-install-prompt-text">Add to home screen for the best experience</div>
        </div>
        <button class="pwa-install-prompt-btn" onclick="installPWA()">Install</button>
    </div>

    <!-- Share Parser & Partner Framework Modules -->
    <!-- External modules - uncomment when files are available -->
    <!-- <script src="share-parser.js"></script> -->
    <!-- <script src="partner-framework.js"></script> -->
    <!-- <script src="smart-tracking.js"></script> -->
    
    <script>
        // ============ SHARE PARSER INTEGRATION ============
        // Initialize the universal share parser
        const shareParser = typeof ShareParser !== 'undefined' ? new ShareParser() : null;
        
        // Initialize partner manager for dynamic placements
        const partnerManager = typeof PartnerManager !== 'undefined' ? new PartnerManager() : null;
        
        // ============ FIREBASE CONFIG ============
        // Same project as Word Boxing - shared authentication
        const firebaseConfig = {
            apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
            authDomain: "word-boxing.firebaseapp.com",
            databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
            projectId: "word-boxing",
            storageBucket: "word-boxing.firebasestorage.app",
            messagingSenderId: "300155036194",
            appId: "1:300155036194:web:b35463e6f9fbb04d7fe07b"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let isFirebaseReady = false;
        let currentUser = null;
        let syncStatus = 'offline'; // offline, syncing, synced

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            isFirebaseReady = true;
            console.log(' Firebase initialized for Game Shelf');
        } catch (e) {
            console.warn('Firebase not available, using local storage only');
            isFirebaseReady = false;
        }

        // ============ DATA ============
        // Game Shelf Games (always featured)
        const GS_GAMES = [
            { id: 'rungs', name: 'Rungs', icon: '', url: 'https://stewartdavidp-ship-it.github.io/Rungstest/', featured: true, category: 'rb', description: 'Pair words and arrange in order' },
            { id: 'slate', name: 'Slate', icon: '', url: 'https://stewartdavidp-ship-it.github.io/Slate/', featured: true, category: 'rb', description: 'Fill in consonants to reveal words' },
            { id: 'quotle', name: 'Quotle', icon: '', url: 'https://stewartdavidp-ship-it.github.io/Quotle/', featured: true, category: 'rb', description: 'Guess the famous quote' },
            { id: 'wordboxing', name: 'Word Boxing', icon: '', url: 'https://stewartdavidp-ship-it.github.io/WordBoxing/', featured: true, category: 'rb', description: 'Multiplayer word battle' },
        ];

        // Pool of games to rotate daily (interesting lesser-known games)
        const FEATURED_POOL = [
            { id: 'semantle', name: 'Semantle', icon: '', url: 'https://semantle.com/', featured: true, category: 'featured', description: 'Guess by word meaning similarity' },
            { id: 'redactle', name: 'Redactle', icon: '', url: 'https://redactle.net/', featured: true, category: 'featured', description: 'Guess the Wikipedia article' },
            { id: 'tradle', name: 'Tradle', icon: '', url: 'https://oec.world/en/tradle/', featured: true, category: 'featured', description: 'Guess country by exports' },
            { id: 'costcodle', name: 'Costcodle', icon: '', url: 'https://costcodle.com/', featured: true, category: 'featured', description: 'Guess Costco product prices' },
            { id: 'worldle', name: 'Worldle', icon: '', url: 'https://worldle.teuteuf.fr/', featured: true, category: 'featured', description: 'Guess country by outline' },
            { id: 'globle', name: 'Globle', icon: '', url: 'https://globle-game.com/', featured: true, category: 'featured', description: 'Find the mystery country' },
            { id: 'foodguessr', name: 'FoodGuessr', icon: '', url: 'https://www.foodguessr.com/', featured: true, category: 'featured', description: 'Guess food origins' },
            { id: 'quordle', name: 'Quordle', icon: '4', url: 'https://www.merriam-webster.com/games/quordle/', featured: true, category: 'featured', description: 'Solve 4 Wordles at once' },
            { id: 'octordle', name: 'Octordle', icon: '8', url: 'https://octordle.com/', featured: true, category: 'featured', description: 'Solve 8 Wordles at once' },
            { id: 'immaculate-grid', name: 'Immaculate Grid', icon: '', url: 'https://www.immaculategrid.com/', featured: true, category: 'featured', description: 'Baseball trivia grid' },
            { id: 'queens', name: 'Queens', icon: '', url: 'https://www.linkedin.com/games/queens/', featured: true, category: 'featured', description: 'Place queens so none attack each other' },
            { id: 'tango', name: 'Tango', icon: '', url: 'https://www.linkedin.com/games/tango/', featured: true, category: 'featured', description: 'Match pairs with logic clues' },
            { id: 'pinpoint', name: 'Pinpoint', icon: '', url: 'https://www.linkedin.com/games/pinpoint/', featured: true, category: 'featured', description: 'Guess the category from clues' },
            { id: 'crossclimb', name: 'Crossclimb', icon: '', url: 'https://www.linkedin.com/games/crossclimb/', featured: true, category: 'featured', description: 'Climb the ladder with word clues' },
        ];

        // Get daily rotating featured games (seeded by date)
        function getDailyFeaturedGames() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // Shuffle pool using day as seed
            const shuffled = [...FEATURED_POOL];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = (dayOfYear * (i + 1) * 7) % (i + 1);
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            // Return GS games + 4 rotating games
            return [...GS_GAMES, ...shuffled.slice(0, 4)];
        }

        // Dynamic FEATURED_GAMES based on daily rotation
        const FEATURED_GAMES = getDailyFeaturedGames();

        const POPULAR_GAMES = [
            { id: 'wordle', name: 'Wordle', icon: '', url: 'https://www.nytimes.com/games/wordle/index.html', source: 'NY Times', description: 'Guess the 5-letter word in 6 tries', tags: ['word', 'daily'] },
            { id: 'connections', name: 'Connections', icon: '', url: 'https://www.nytimes.com/games/connections', source: 'NY Times', description: 'Group 16 words into 4 categories', tags: ['word', 'categories'] },
            { id: 'strands', name: 'Strands', icon: '', url: 'https://www.nytimes.com/games/strands', source: 'NY Times', description: 'Find themed words in a letter grid', tags: ['word', 'search'] },
            { id: 'spelling-bee', name: 'Spelling Bee', icon: '', url: 'https://www.nytimes.com/puzzles/spelling-bee', source: 'NY Times', description: 'Make words using 7 letters', tags: ['word', 'vocabulary'] },
            { id: 'mini', name: 'Mini Crossword', icon: '', url: 'https://www.nytimes.com/crosswords/game/mini', source: 'NY Times', description: 'Quick daily crossword', tags: ['crossword', 'quick'] },
            { id: 'letterboxed', name: 'Letterboxed', icon: '', url: 'https://www.nytimes.com/puzzles/letter-boxed', source: 'NY Times', description: 'Connect letters on a box', tags: ['word', 'puzzle'] },
            { id: 'tiles', name: 'Tiles', icon: '', url: 'https://www.nytimes.com/puzzles/tiles', source: 'NY Times', description: 'Match tiles to clear the board', tags: ['matching', 'visual'] },
            { id: 'vertex', name: 'Vertex', icon: '', url: 'https://www.nytimes.com/puzzles/vertex', source: 'NY Times', description: 'Connect dots without crossing', tags: ['logic', 'visual'] },
            { id: 'immaculate-grid', name: 'Immaculate Grid', icon: '', url: 'https://www.immaculategrid.com/', source: 'Sports', description: 'Baseball trivia grid', tags: ['sports', 'trivia'] },
            { id: 'costcodle', name: 'Costcodle', icon: '', url: 'https://costcodle.com/', source: 'Fun', description: 'Guess Costco product prices', tags: ['fun', 'guessing'] },
            { id: 'tradle', name: 'Tradle', icon: '', url: 'https://oec.world/en/tradle/', source: 'Geography', description: 'Guess country by exports', tags: ['geography', 'economics'] },
            { id: 'worldle', name: 'Worldle', icon: '', url: 'https://worldle.teuteuf.fr/', source: 'Geography', description: 'Guess country by outline', tags: ['geography'] },
            { id: 'globle', name: 'Globle', icon: '', url: 'https://globle-game.com/', source: 'Geography', description: 'Find the mystery country', tags: ['geography'] },
            { id: 'foodguessr', name: 'FoodGuessr', icon: '', url: 'https://www.foodguessr.com/', source: 'Fun', description: 'Guess food origins', tags: ['food', 'geography'] },
            { id: 'quordle', name: 'Quordle', icon: '4', url: 'https://www.merriam-webster.com/games/quordle/', source: 'Words', description: 'Solve 4 Wordles at once', tags: ['word', 'challenge'] },
            { id: 'octordle', name: 'Octordle', icon: '8', url: 'https://octordle.com/', source: 'Words', description: 'Solve 8 Wordles at once', tags: ['word', 'challenge'] },
            { id: 'semantle', name: 'Semantle', icon: '', url: 'https://semantle.com/', source: 'Words', description: 'Guess by word meaning similarity', tags: ['word', 'AI'] },
            { id: 'redactle', name: 'Redactle', icon: '', url: 'https://redactle.net/', source: 'Knowledge', description: 'Guess the Wikipedia article', tags: ['trivia', 'deduction'] },
            // LinkedIn Games
            { id: 'queens', name: 'Queens', icon: '', url: 'https://www.linkedin.com/games/queens/', source: 'LinkedIn', description: 'Place queens so none attack each other', tags: ['logic', 'chess'] },
            { id: 'tango', name: 'Tango', icon: '', url: 'https://www.linkedin.com/games/tango/', source: 'LinkedIn', description: 'Match pairs with logic clues', tags: ['logic', 'matching'] },
            { id: 'pinpoint', name: 'Pinpoint', icon: '', url: 'https://www.linkedin.com/games/pinpoint/', source: 'LinkedIn', description: 'Guess the category from clues', tags: ['trivia', 'categories'] },
            { id: 'crossclimb', name: 'Crossclimb', icon: '', url: 'https://www.linkedin.com/games/crossclimb/', source: 'LinkedIn', description: 'Climb the ladder with word clues', tags: ['word', 'ladder'] },
            // Chess
            { id: 'chess-puzzle', name: 'Chess Puzzle', icon: '', url: 'https://www.chess.com/puzzles', source: 'Chess.com', description: 'Daily chess puzzle', tags: ['chess', 'strategy'] },
            { id: 'lichess-puzzle', name: 'Lichess Puzzle', icon: '', url: 'https://lichess.org/training/daily', source: 'Lichess', description: 'Daily chess puzzle (free)', tags: ['chess', 'strategy'] },
            // Media & Entertainment
            { id: 'framed', name: 'Framed', icon: '', url: 'https://framed.wtf/', source: 'Movies', description: 'Guess the movie from frames', tags: ['movies', 'trivia'] },
            { id: 'heardle', name: 'Heardle', icon: '', url: 'https://www.spotify.com/heardle/', source: 'Music', description: 'Guess the song from intro', tags: ['music', 'audio'] },
            { id: 'actorle', name: 'Actorle', icon: '', url: 'https://actorle.com/', source: 'Movies', description: 'Guess the actor by filmography', tags: ['movies', 'trivia'] },
            { id: 'moviedle', name: 'Moviedle', icon: '', url: 'https://moviedle.app/', source: 'Movies', description: 'Guess movie from sped-up clip', tags: ['movies', 'visual'] },
            { id: 'bandle', name: 'Bandle', icon: '', url: 'https://bandle.app/', source: 'Music', description: 'Guess the song by instruments', tags: ['music', 'audio'] },
            // More Word Games
            { id: 'waffle', name: 'Waffle', icon: '', url: 'https://wafflegame.net/', source: 'Words', description: 'Rearrange letters in waffle grid', tags: ['word', 'puzzle'] },
            { id: 'nerdle', name: 'Nerdle', icon: '', url: 'https://nerdlegame.com/', source: 'Math', description: 'Wordle but for math equations', tags: ['math', 'logic'] },
            { id: 'sedecordle', name: 'Sedecordle', icon: '', url: 'https://www.sedecordle.com/', source: 'Words', description: 'Solve 16 Wordles at once', tags: ['word', 'extreme'] },
            { id: 'duotrigordle', name: 'Duotrigordle', icon: '32', url: 'https://duotrigordle.com/', source: 'Words', description: 'Solve 32 Wordles at once', tags: ['word', 'extreme'] },
            // Geography
            { id: 'wheretaken', name: 'WhereTaken', icon: '', url: 'https://wheretaken.teuteuf.fr/', source: 'Geography', description: 'Guess photo locations', tags: ['geography', 'photos'] },
            { id: 'timeguessr', name: 'TimeGuessr', icon: '', url: 'https://timeguessr.com/', source: 'History', description: 'Guess when photos were taken', tags: ['history', 'photos'] },
        ];

        // ============ TRACKING SOURCES ============
        // Users declare where they primarily play each game for consistent tracking
        const TRACKING_SOURCES = {
            'nyt-ios': {
                id: 'nyt-ios',
                label: 'NYT App (iOS)',
                icon: '',
                platform: 'mobile',
                entryMethods: ['manual', 'share', 'screenshot'],
                description: 'iPhone or iPad NYT Games app'
            },
            'nyt-android': {
                id: 'nyt-android',
                label: 'NYT App (Android)',
                icon: '',
                platform: 'mobile',
                entryMethods: ['manual', 'share', 'screenshot'],
                description: 'Android NYT Games app'
            },
            'browser-extension': {
                id: 'browser-extension',
                label: 'Browser (Extension)',
                icon: '',
                platform: 'desktop',
                entryMethods: ['extension'],
                description: 'Auto-captured by browser extension'
            },
            'browser-manual': {
                id: 'browser-manual',
                label: 'Browser (Manual)',
                icon: '',
                platform: 'desktop',
                entryMethods: ['manual', 'share'],
                description: 'Web browser without extension'
            },
            'multiple': {
                id: 'multiple',
                label: 'Multiple Places',
                icon: '',
                platform: 'mixed',
                entryMethods: ['manual', 'share', 'screenshot'],
                description: 'I play on different devices'
            }
        };

        const ENTRY_METHODS = {
            'extension': {
                id: 'extension',
                label: 'Auto-capture',
                icon: '',
                description: 'Extension detects when you finish',
                requiresExtension: true
            },
            'share': {
                id: 'share',
                label: 'Paste Share Text',
                icon: '',
                description: 'Paste your share results'
            },
            'manual': {
                id: 'manual',
                label: 'Manual Entry',
                icon: '',
                description: 'Enter your score by hand'
            },
            'screenshot': {
                id: 'screenshot',
                label: 'Screenshot Import',
                icon: '',
                description: 'Import from screenshot',
                comingSoon: true
            }
        };

        // ============ DATA ABSTRACTION LAYER ============
        // Design for cloud sync (Phase 2), implement local (Phase 1)
        // This layer allows swapping localStorage <-> Firebase without app changes
        
        const DataService = {
            // ===== SYNC CONFIGURATION =====
            config: {
                // Phase 1: Local storage for game data, Firebase for account
                // Phase 2: Full cloud sync
                syncMode: 'hybrid', // 'local', 'hybrid', 'cloud'
                cloudEndpoint: null, // Set when Firebase is configured
                offlineQueue: [], // Queue changes when offline
            },
            
            // ===== ACCOUNT DATA (Always attempts cloud sync) =====
            async getAccount() {
                // In Phase 1, we use Firebase Auth user profile
                // Account data includes: profile, friends, subscription
                if (currentUser) {
                    return {
                        id: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        subscription: userData.wallet?.subscription || null
                    };
                }
                return null;
            },
            
            // ===== WALLET (Always cloud-synced when signed in) =====
            async getWallet() {
                return userData.wallet || {
                    tokens: 0,
                    coins: 0,
                    transactions: [],
                    ageVerified: false,
                    subscription: null
                };
            },
            
            async updateWallet(changes) {
                userData.wallet = { ...userData.wallet, ...changes };
                await this.saveLocal();
                // Phase 2: Also push to cloud
                // await this.pushToCloud('wallet', userData.wallet);
                return userData.wallet;
            },
            
            // ===== GAME STATS (Local in Phase 1, Cloud option in Phase 2) =====
            async getGameStats(gameId) {
                return userData.stats?.[gameId] || {
                    lastPlayed: null,
                    streak: 0,
                    totalPlays: 0,
                    bestScore: null,
                    averageScore: null
                };
            },
            
            async saveGameStats(gameId, stats) {
                if (!userData.stats) userData.stats = {};
                userData.stats[gameId] = { ...userData.stats[gameId], ...stats };
                await this.saveLocal();
                
                // Check if cloud sync is enabled for this game
                const settings = this.getGameSettings(gameId);
                if (settings.cloudSync) {
                    // Phase 2: Push to cloud
                    // await this.pushToCloud(`stats/${gameId}`, userData.stats[gameId]);
                }
                
                return userData.stats[gameId];
            },
            
            // ===== GAME SETTINGS (Tracking source, sync preferences) =====
            getGameSettings(gameId) {
                return userData.gameSettings?.[gameId] || {
                    trackingSource: null,
                    entryMethod: 'manual',
                    cloudSync: false,
                    goalEnabled: true,
                    configuredAt: null
                };
            },
            
            async saveGameSettings(gameId, settings) {
                if (!userData.gameSettings) userData.gameSettings = {};
                userData.gameSettings[gameId] = {
                    ...userData.gameSettings[gameId],
                    ...settings,
                    configuredAt: Date.now()
                };
                await this.saveLocal();
                return userData.gameSettings[gameId];
            },
            
            // ===== GAME HISTORY (Local in Phase 1) =====
            async getGameHistory(gameId, limit = 30) {
                const history = userData.history?.[gameId] || {};
                const entries = Object.entries(history)
                    .sort(([a], [b]) => b.localeCompare(a))
                    .slice(0, limit);
                return Object.fromEntries(entries);
            },
            
            async saveGameResult(gameId, date, result) {
                if (!userData.history) userData.history = {};
                if (!userData.history[gameId]) userData.history[gameId] = {};
                userData.history[gameId][date] = result;
                await this.saveLocal();
                return result;
            },
            
            // ===== LOCAL STORAGE OPERATIONS =====
            async saveLocal() {
                try {
                    localStorage.setItem('puzzleShelfData', JSON.stringify(userData));
                    return true;
                } catch (e) {
                    console.error('Failed to save local data:', e);
                    return false;
                }
            },
            
            loadLocal() {
                try {
                    const saved = localStorage.getItem('puzzleShelfData');
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.error('Failed to load local data:', e);
                    return null;
                }
            },
            
            // ===== CLOUD SYNC OPERATIONS (Phase 2 stubs) =====
            async pushToCloud(path, data) {
                // Phase 2 implementation:
                // if (!currentUser) return false;
                // const ref = firebase.firestore().collection('users').doc(currentUser.uid);
                // await ref.set({ [path]: data }, { merge: true });
                // return true;
                console.log('[DataService] Cloud push stub:', path);
                return false;
            },
            
            async pullFromCloud(path) {
                // Phase 2 implementation:
                // if (!currentUser) return null;
                // const doc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
                // return doc.exists ? doc.data()[path] : null;
                console.log('[DataService] Cloud pull stub:', path);
                return null;
            },
            
            async syncAll() {
                // Phase 2: Full bidirectional sync
                // For now, just ensure local data is saved
                await this.saveLocal();
                
                if (currentUser && this.config.syncMode !== 'local') {
                    // Push critical data to cloud
                    // await this.pushToCloud('wallet', userData.wallet);
                    // await this.pushToCloud('gameSettings', userData.gameSettings);
                }
                
                return true;
            },
            
            // ===== MIGRATION HELPERS =====
            async migrateToCloud() {
                // Phase 2: Migrate all local data to cloud
                console.log('[DataService] Migration to cloud not yet implemented');
            },
            
            async mergeCloudData(cloudData) {
                // Phase 2: Merge cloud data with local, handling conflicts
                console.log('[DataService] Cloud merge not yet implemented');
            },
            
            // ===== TRACKING SOURCE HELPERS =====
            getTrackingSourceIcon(gameId) {
                const settings = this.getGameSettings(gameId);
                if (!settings.trackingSource) return null;
                const source = TRACKING_SOURCES[settings.trackingSource];
                return source?.icon || '';
            },
            
            getTrackingSourceLabel(gameId) {
                const settings = this.getGameSettings(gameId);
                if (!settings.trackingSource) return 'Not configured';
                const source = TRACKING_SOURCES[settings.trackingSource];
                return source?.label || 'Unknown';
            },
            
            getEntryMethodIcon(gameId) {
                const settings = this.getGameSettings(gameId);
                const method = ENTRY_METHODS[settings.entryMethod];
                return method?.icon || '';
            }
        };

        // ============ STATE ============
        let userData = {
            registered: false,
            games: [],
            stats: {},
            reviews: {},
            chatMessages: [],
            history: {}, // { 'YYYY-MM-DD': { gamesPlayed: 3, totalGames: 8 } }
            achievements: {}, // { achievementId: unlockedDate }
            dailyGoal: 5, // default daily goal
            wallet: {
                tokens: 0,
                coins: 0,
                transactions: [],
                lastDailyBonus: null,
                streakBonuses: {},
                ageVerified: false,
                subscription: null
            },
            // Per-game settings for tracking consistency
            gameSettings: {
                // Example structure (populated per game):
                // 'wordle': {
                //     trackingSource: 'browser-extension',
                //     entryMethod: 'extension',
                //     cloudSync: false,
                //     notifications: true,
                //     goalEnabled: true,
                //     configuredAt: timestamp
                // }
            }
        };

        let currentReviewGameId = null;
        let currentRating = 0;
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let insightsPeriod = 'week'; // week, month, year

        // Achievements definitions
        const ACHIEVEMENTS = [
            { id: 'first-game', name: 'First Steps', icon: '', desc: 'Play your first game', check: (d) => d.stats.totalCompleted >= 1 },
            { id: 'streak-3', name: 'Hat Trick', icon: '', desc: '3-day streak', check: (d) => getMaxStreak(d) >= 3 },
            { id: 'streak-7', name: 'Week Warrior', icon: '', desc: '7-day streak', check: (d) => getMaxStreak(d) >= 7 },
            { id: 'streak-30', name: 'Monthly Master', icon: '', desc: '30-day streak', check: (d) => getMaxStreak(d) >= 30 },
            { id: 'games-5', name: 'Collector', icon: '', desc: 'Add 5 games to shelf', check: (d) => (FEATURED_GAMES.length + d.games.length) >= 5 },
            { id: 'games-10', name: 'Enthusiast', icon: '', desc: 'Add 10 games to shelf', check: (d) => (FEATURED_GAMES.length + d.games.length) >= 10 },
            { id: 'perfect-day', name: 'Perfect Day', icon: '', desc: 'Play all games in one day', check: (d) => hasPerfectDay(d) },
            { id: 'early-bird', name: 'Early Bird', icon: '', desc: 'Play before 7 AM', check: (d) => d.achievements?.['early-bird'] },
            { id: 'night-owl', name: 'Night Owl', icon: '', desc: 'Play after 11 PM', check: (d) => d.achievements?.['night-owl'] },
            { id: 'reviewer', name: 'Critic', icon: '', desc: 'Write 3 reviews', check: (d) => Object.keys(d.reviews || {}).length >= 3 },
            { id: 'social', name: 'Social Butterfly', icon: '', desc: 'Share your shelf', check: (d) => d.achievements?.['social'] },
            { id: 'centurion', name: 'Centurion', icon: '', desc: 'Complete 100 games total', check: (d) => d.stats.totalCompleted >= 100 },
            { id: 'goal-streak-7', name: 'Goal Crusher', icon: '', desc: 'Hit daily goal 7 days in a row', check: (d) => d.achievements?.['goal-streak-7'] },
            { id: 'cloud-sync', name: 'Cloud Gamer', icon: '', desc: 'Sign in and sync to cloud', check: (d) => d.achievements?.['cloud-sync'] },
        ];

        // ============ AUTHENTICATION ============
        function signInWithGoogle() {
            if (!isFirebaseReady || !auth) {
                showToast('Sign-in not available', 'error');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Signed in:', result.user.displayName);
                    showToast(`Welcome, ${result.user.displayName}!`);
                })
                .catch((error) => {
                    console.error('Sign-in error:', error);
                    showToast('Sign-in failed: ' + error.message);
                });
        }

        function signOut() {
            if (auth) {
                auth.signOut().then(() => {
                    showToast('Signed out');
                    closeProfileModal();
                    updateMenuAccountSection();
                });
            }
        }

        // Plain Mode - defaults to ON for first run (free tier)
        if (localStorage.getItem('gameshelfPlainMode') === null) {
            localStorage.setItem('gameshelfPlainMode', 'true');
        }
        let plainMode = localStorage.getItem('gameshelfPlainMode') === 'true';

        function togglePlainMode(enabled) {
            plainMode = enabled;
            localStorage.setItem('gameshelfPlainMode', enabled);
            applyPlainMode();
            showToast(enabled ? 'Plain Mode enabled' : 'Plain Mode disabled');
        }

        function applyPlainMode() {
            const toggle = document.getElementById('plain-mode-toggle');
            if (toggle) toggle.checked = plainMode;
            
            if (plainMode) {
                document.body.classList.add('plain-mode');
            } else {
                document.body.classList.remove('plain-mode');
            }
        }

        // ============ SOUND MANAGER ============
        // Customizable sound system with library and user preferences
        
        const SoundManager = {
            ctx: null,
            enabled: localStorage.getItem('gameshelfSound') !== 'false',
            volume: parseFloat(localStorage.getItem('gameshelfVolume') || '0.5'),
            
            // Sound Events - all places where sounds can play
            events: {
                achievement: { name: 'Achievement Unlocked', icon: '', description: 'When you earn an achievement' },
                coin: { name: 'Earn Tokens', icon: '', description: 'When you earn tokens or coins' },
                streak: { name: 'Streak Bonus', icon: '', description: 'When your streak increases' },
                gameComplete: { name: 'Game Complete', icon: '', description: 'When you complete a game' },
                levelUp: { name: 'Level Up', icon: '', description: 'When you reach a new level' },
                click: { name: 'Button Click', icon: '', description: 'When clicking buttons' },
                toggle: { name: 'Toggle Switch', icon: '', description: 'When toggling settings' },
                success: { name: 'Success', icon: '', description: 'General success actions' },
                error: { name: 'Error', icon: '', description: 'When something goes wrong' },
                notification: { name: 'Notification', icon: '', description: 'General notifications' },
                welcome: { name: 'Welcome', icon: '', description: 'When opening the app' },
                sync: { name: 'Cloud Sync', icon: '', description: 'When data syncs' }
            },
            
            // Sound Library - available sounds to choose from
            library: {
                // Chimes & Bells
                chime1: { name: 'Gentle Chime', category: 'Chimes', icon: '' },
                chime2: { name: 'Crystal Bell', category: 'Chimes', icon: '' },
                chime3: { name: 'Wind Chime', category: 'Chimes', icon: '' },
                
                // Retro Game Sounds
                coin8bit: { name: '8-bit Coin', category: 'Retro', icon: '' },
                powerup: { name: 'Power Up', category: 'Retro', icon: '' },
                levelup8bit: { name: '8-bit Level Up', category: 'Retro', icon: '' },
                blip: { name: 'Blip', category: 'Retro', icon: '' },
                victory8bit: { name: '8-bit Victory', category: 'Retro', icon: '' },
                
                // Modern UI
                pop: { name: 'Pop', category: 'Modern', icon: '' },
                whoosh: { name: 'Whoosh', category: 'Modern', icon: '' },
                ding: { name: 'Ding', category: 'Modern', icon: '' },
                click1: { name: 'Soft Click', category: 'Modern', icon: '' },
                click2: { name: 'Crisp Click', category: 'Modern', icon: '' },
                
                // Musical
                fanfare: { name: 'Fanfare', category: 'Musical', icon: '' },
                harp: { name: 'Harp Gliss', category: 'Musical', icon: '' },
                marimba: { name: 'Marimba', category: 'Musical', icon: '' },
                xylophone: { name: 'Xylophone', category: 'Musical', icon: '' },
                
                // Notifications
                notify1: { name: 'Gentle Notify', category: 'Notify', icon: '' },
                notify2: { name: 'Alert', category: 'Notify', icon: '' },
                complete: { name: 'Task Complete', category: 'Notify', icon: '' },
                
                // Fun
                sparkle: { name: 'Sparkle', category: 'Fun', icon: '' },
                magic: { name: 'Magic', category: 'Fun', icon: '' },
                bounce: { name: 'Bounce', category: 'Fun', icon: '' },
                
                // Silent
                none: { name: 'Silent', category: 'Other', icon: '' }
            },
            
            // Default sound assignments
            defaults: {
                achievement: 'fanfare',
                coin: 'coin8bit',
                streak: 'powerup',
                gameComplete: 'complete',
                levelUp: 'levelup8bit',
                click: 'click1',
                toggle: 'blip',
                success: 'chime1',
                error: 'notify2',
                notification: 'ding',
                welcome: 'chime2',
                sync: 'whoosh'
            },
            
            // User preferences (loaded from localStorage)
            preferences: {},
            
            init() {
                // Load user preferences
                const saved = localStorage.getItem('gameshelfSoundPrefs');
                this.preferences = saved ? JSON.parse(saved) : { ...this.defaults };
                
                // Initialize audio context on first user interaction
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.ctx;
            },
            
            // Get the sound assigned to an event
            getSoundForEvent(eventId) {
                return this.preferences[eventId] || this.defaults[eventId] || 'chime1';
            },
            
            // Set the sound for an event
            setSoundForEvent(eventId, soundId) {
                this.preferences[eventId] = soundId;
                localStorage.setItem('gameshelfSoundPrefs', JSON.stringify(this.preferences));
            },
            
            // Play a sound by event type
            playEvent(eventId) {
                if (!this.enabled) return;
                const soundId = this.getSoundForEvent(eventId);
                if (soundId === 'none') return;
                this.playSound(soundId);
            },
            
            // Play a specific sound from the library
            playSound(soundId) {
                if (!this.enabled && soundId !== 'preview') return;
                
                try {
                    const ctx = this.init();
                    if (ctx.state === 'suspended') ctx.resume();
                    
                    const masterGain = ctx.createGain();
                    masterGain.gain.value = this.volume;
                    masterGain.connect(ctx.destination);
                    
                    switch(soundId) {
                        // Chimes & Bells
                        case 'chime1':
                            this._playTone(ctx, masterGain, [
                                { freq: 659, time: 0, dur: 0.3, type: 'sine' },
                                { freq: 880, time: 0.1, dur: 0.25, type: 'sine' }
                            ]);
                            break;
                            
                        case 'chime2':
                            this._playTone(ctx, masterGain, [
                                { freq: 1047, time: 0, dur: 0.4, type: 'sine' },
                                { freq: 1319, time: 0.15, dur: 0.3, type: 'sine' },
                                { freq: 1568, time: 0.3, dur: 0.2, type: 'sine' }
                            ]);
                            break;
                            
                        case 'chime3':
                            this._playTone(ctx, masterGain, [
                                { freq: 523, time: 0, dur: 0.5, type: 'sine' },
                                { freq: 698, time: 0.1, dur: 0.4, type: 'sine' },
                                { freq: 880, time: 0.2, dur: 0.3, type: 'sine' },
                                { freq: 1047, time: 0.3, dur: 0.2, type: 'sine' }
                            ]);
                            break;
                        
                        // Retro Game Sounds
                        case 'coin8bit':
                            this._playTone(ctx, masterGain, [
                                { freq: 988, time: 0, dur: 0.08, type: 'square', vol: 0.3 },
                                { freq: 1319, time: 0.08, dur: 0.15, type: 'square', vol: 0.3 }
                            ]);
                            break;
                            
                        case 'powerup':
                            this._playSweep(ctx, masterGain, 200, 800, 0.3, 'square', 0.3);
                            break;
                            
                        case 'levelup8bit':
                            this._playTone(ctx, masterGain, [
                                { freq: 262, time: 0, dur: 0.1, type: 'square', vol: 0.3 },
                                { freq: 330, time: 0.1, dur: 0.1, type: 'square', vol: 0.3 },
                                { freq: 392, time: 0.2, dur: 0.1, type: 'square', vol: 0.3 },
                                { freq: 523, time: 0.3, dur: 0.2, type: 'square', vol: 0.3 }
                            ]);
                            break;
                            
                        case 'blip':
                            this._playTone(ctx, masterGain, [
                                { freq: 600, time: 0, dur: 0.05, type: 'square', vol: 0.2 }
                            ]);
                            break;
                            
                        case 'victory8bit':
                            this._playTone(ctx, masterGain, [
                                { freq: 523, time: 0, dur: 0.12, type: 'square', vol: 0.25 },
                                { freq: 523, time: 0.15, dur: 0.12, type: 'square', vol: 0.25 },
                                { freq: 523, time: 0.3, dur: 0.12, type: 'square', vol: 0.25 },
                                { freq: 698, time: 0.45, dur: 0.4, type: 'square', vol: 0.25 }
                            ]);
                            break;
                        
                        // Modern UI
                        case 'pop':
                            this._playSweep(ctx, masterGain, 400, 600, 0.08, 'sine', 0.4);
                            break;
                            
                        case 'whoosh':
                            this._playNoise(ctx, masterGain, 0.15, 'lowpass', 2000);
                            break;
                            
                        case 'ding':
                            this._playTone(ctx, masterGain, [
                                { freq: 880, time: 0, dur: 0.3, type: 'sine', vol: 0.5 }
                            ]);
                            break;
                            
                        case 'click1':
                            this._playTone(ctx, masterGain, [
                                { freq: 400, time: 0, dur: 0.03, type: 'sine', vol: 0.3 }
                            ]);
                            break;
                            
                        case 'click2':
                            this._playTone(ctx, masterGain, [
                                { freq: 800, time: 0, dur: 0.02, type: 'triangle', vol: 0.4 }
                            ]);
                            break;
                        
                        // Musical
                        case 'fanfare':
                            this._playTone(ctx, masterGain, [
                                { freq: 440, time: 0, dur: 0.15, type: 'sawtooth', vol: 0.2 },
                                { freq: 554, time: 0.12, dur: 0.15, type: 'sawtooth', vol: 0.2 },
                                { freq: 659, time: 0.24, dur: 0.15, type: 'sawtooth', vol: 0.2 },
                                { freq: 880, time: 0.36, dur: 0.4, type: 'sawtooth', vol: 0.25 }
                            ]);
                            break;
                            
                        case 'harp':
                            this._playTone(ctx, masterGain, [
                                { freq: 262, time: 0, dur: 0.4, type: 'sine', vol: 0.3 },
                                { freq: 330, time: 0.05, dur: 0.35, type: 'sine', vol: 0.3 },
                                { freq: 392, time: 0.1, dur: 0.3, type: 'sine', vol: 0.3 },
                                { freq: 523, time: 0.15, dur: 0.25, type: 'sine', vol: 0.3 }
                            ]);
                            break;
                            
                        case 'marimba':
                            this._playTone(ctx, masterGain, [
                                { freq: 440, time: 0, dur: 0.2, type: 'triangle', vol: 0.4 },
                                { freq: 554, time: 0.1, dur: 0.2, type: 'triangle', vol: 0.35 }
                            ]);
                            break;
                            
                        case 'xylophone':
                            this._playTone(ctx, masterGain, [
                                { freq: 1047, time: 0, dur: 0.15, type: 'sine', vol: 0.4 },
                                { freq: 1319, time: 0.08, dur: 0.12, type: 'sine', vol: 0.35 }
                            ]);
                            break;
                        
                        // Notifications
                        case 'notify1':
                            this._playTone(ctx, masterGain, [
                                { freq: 523, time: 0, dur: 0.15, type: 'sine', vol: 0.3 },
                                { freq: 659, time: 0.15, dur: 0.15, type: 'sine', vol: 0.25 }
                            ]);
                            break;
                            
                        case 'notify2':
                            this._playTone(ctx, masterGain, [
                                { freq: 200, time: 0, dur: 0.15, type: 'sawtooth', vol: 0.3 },
                                { freq: 150, time: 0.1, dur: 0.15, type: 'sawtooth', vol: 0.25 }
                            ]);
                            break;
                            
                        case 'complete':
                            this._playTone(ctx, masterGain, [
                                { freq: 523, time: 0, dur: 0.1, type: 'sine', vol: 0.3 },
                                { freq: 659, time: 0.1, dur: 0.1, type: 'sine', vol: 0.3 },
                                { freq: 784, time: 0.2, dur: 0.2, type: 'sine', vol: 0.35 }
                            ]);
                            break;
                        
                        // Fun
                        case 'sparkle':
                            this._playTone(ctx, masterGain, [
                                { freq: 1200, time: 0, dur: 0.1, type: 'sine', vol: 0.2 },
                                { freq: 1500, time: 0.05, dur: 0.1, type: 'sine', vol: 0.15 },
                                { freq: 1800, time: 0.1, dur: 0.1, type: 'sine', vol: 0.1 },
                                { freq: 2100, time: 0.15, dur: 0.1, type: 'sine', vol: 0.05 }
                            ]);
                            break;
                            
                        case 'magic':
                            this._playSweep(ctx, masterGain, 300, 1200, 0.4, 'sine', 0.3);
                            this._playTone(ctx, masterGain, [
                                { freq: 800, time: 0.2, dur: 0.3, type: 'sine', vol: 0.2 },
                                { freq: 1000, time: 0.25, dur: 0.25, type: 'sine', vol: 0.15 }
                            ]);
                            break;
                            
                        case 'bounce':
                            this._playTone(ctx, masterGain, [
                                { freq: 300, time: 0, dur: 0.08, type: 'sine', vol: 0.4 },
                                { freq: 400, time: 0.1, dur: 0.06, type: 'sine', vol: 0.3 },
                                { freq: 500, time: 0.18, dur: 0.04, type: 'sine', vol: 0.2 }
                            ]);
                            break;
                            
                        case 'none':
                        default:
                            // Silent or unknown
                            break;
                    }
                } catch (e) {
                    console.log('Audio error:', e);
                }
            },
            
            // Helper: Play multiple tones
            _playTone(ctx, destination, notes) {
                notes.forEach(note => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = note.type || 'sine';
                    osc.frequency.value = note.freq;
                    gain.gain.setValueAtTime(note.vol || 0.3, ctx.currentTime + note.time);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + note.time + note.dur);
                    osc.connect(gain);
                    gain.connect(destination);
                    osc.start(ctx.currentTime + note.time);
                    osc.stop(ctx.currentTime + note.time + note.dur + 0.1);
                });
            },
            
            // Helper: Play frequency sweep
            _playSweep(ctx, destination, startFreq, endFreq, duration, type, vol) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type || 'sine';
                osc.frequency.setValueAtTime(startFreq, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(endFreq, ctx.currentTime + duration);
                gain.gain.setValueAtTime(vol || 0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(destination);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration + 0.1);
            },
            
            // Helper: Play filtered noise (for whoosh, etc)
            _playNoise(ctx, destination, duration, filterType, filterFreq) {
                const bufferSize = ctx.sampleRate * duration;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = ctx.createBiquadFilter();
                filter.type = filterType;
                filter.frequency.value = filterFreq;
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(destination);
                noise.start();
                noise.stop(ctx.currentTime + duration);
            },
            
            // Set master volume (0-1)
            setVolume(vol) {
                this.volume = Math.max(0, Math.min(1, vol));
                localStorage.setItem('gameshelfVolume', this.volume);
            },
            
            // Toggle enabled
            setEnabled(enabled) {
                this.enabled = enabled;
                localStorage.setItem('gameshelfSound', enabled);
            },
            
            // Get categories for UI
            getCategories() {
                const categories = {};
                Object.entries(this.library).forEach(([id, sound]) => {
                    if (!categories[sound.category]) {
                        categories[sound.category] = [];
                    }
                    categories[sound.category].push({ id, ...sound });
                });
                return categories;
            }
        };

        // Initialize sound manager
        SoundManager.init();
        
        // Legacy support
        let soundEnabled = SoundManager.enabled;
        
        function toggleSound(enabled) {
            soundEnabled = enabled;
            SoundManager.setEnabled(enabled);
            if (enabled) {
                SoundManager.playSound('chime1');
            }
            showToast(enabled ? ' Sound enabled' : ' Sound disabled');
        }

        function applySound() {
            const toggle = document.getElementById('sound-toggle');
            if (toggle) toggle.checked = SoundManager.enabled;
            
            const volumeSlider = document.getElementById('sound-volume');
            if (volumeSlider) volumeSlider.value = SoundManager.volume * 100;
        }

        function playSound(eventType) {
            SoundManager.playEvent(eventType);
        }

        function previewSound(soundId) {
            SoundManager.playSound(soundId);
        }

        function setEventSound(eventId, soundId) {
            SoundManager.setSoundForEvent(eventId, soundId);
            SoundManager.playSound(soundId);
            renderSoundCustomizer();
        }

        function setVolume(value) {
            SoundManager.setVolume(value / 100);
        }

        function showSoundCustomizer() {
            renderSoundCustomizer();
            document.getElementById('sound-customizer-modal').classList.add('active');
        }

        function closeSoundCustomizer() {
            document.getElementById('sound-customizer-modal').classList.remove('active');
        }

        function renderSoundCustomizer() {
            const container = document.getElementById('sound-events-list');
            if (!container) return;
            
            container.innerHTML = Object.entries(SoundManager.events).map(([eventId, event]) => {
                const currentSound = SoundManager.getSoundForEvent(eventId);
                const soundInfo = SoundManager.library[currentSound] || { name: 'Unknown', icon: '?' };
                
                return `
                    <div class="sound-event-row">
                        <div class="sound-event-info">
                            <span class="sound-event-icon">${event.icon}</span>
                            <div>
                                <div class="sound-event-name">${event.name}</div>
                                <div class="sound-event-desc">${event.description}</div>
                            </div>
                        </div>
                        <div class="sound-event-selector">
                            <select onchange="setEventSound('${eventId}', this.value)">
                                ${Object.entries(SoundManager.library).map(([soundId, sound]) => `
                                    <option value="${soundId}" ${currentSound === soundId ? 'selected' : ''}>
                                        ${sound.icon} ${sound.name}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="preview-btn" onclick="previewSound('${currentSound}')" title="Preview"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetSoundDefaults() {
            if (confirm('Reset all sounds to defaults?')) {
                SoundManager.preferences = { ...SoundManager.defaults };
                localStorage.setItem('gameshelfSoundPrefs', JSON.stringify(SoundManager.preferences));
                renderSoundCustomizer();
                showToast(' Sounds reset to defaults');
            }
        }

        function updateMenuAccountSection() {
            const section = document.getElementById('menu-account-section');
            if (!section) return;

            if (currentUser) {
                section.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0;">
                        <img src="${currentUser.photoURL || ''}" style="width: 40px; height: 40px; border-radius: 50%;" onerror="this.style.display='none'">
                        <div style="flex: 1;">
                            <div style="color: var(--text-primary); font-weight: 500;">${currentUser.displayName || 'User'}</div>
                            <div style="color: var(--text-muted); font-size: 0.75rem;">${currentUser.email}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <a href="#" class="settings-link" onclick="syncNow(); return false;" style="flex: 1; text-align: center;">
                            <span class="icon"></span> Sync
                        </a>
                        <a href="#" class="settings-link" onclick="signOut(); toggleSettingsMenu(); return false;" style="flex: 1; text-align: center; color: var(--accent-red);">
                            <span class="icon"></span> Sign Out
                        </a>
                    </div>
                `;
            } else {
                section.innerHTML = `
                    <a href="#" class="settings-link" onclick="signInWithGoogle(); return false;">
                        <span class="icon"></span>
                        Sign in with Google
                    </a>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                        Save progress across devices
                    </p>
                `;
            }
        }

        function syncNow() {
            if (currentUser) {
                saveToCloud(currentUser.uid);
                showToast(' Synced!');
            }
        }

        function handleAuthStateChange(user) {
            currentUser = user;
            
            const signInBtn = document.getElementById('sign-in-btn');
            const avatarBtn = document.getElementById('user-avatar-btn');
            const avatar = document.getElementById('user-avatar');
            const friendsSigninPrompt = document.getElementById('friends-signin-prompt');
            const friendsContent = document.getElementById('friends-content');
            const battleSigninPrompt = document.getElementById('battle-signin-prompt');
            const battleContent = document.getElementById('battle-content');
            
            if (user) {
                // User is signed in
                signInBtn.style.display = 'none';
                avatarBtn.style.display = 'block';
                avatar.src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" text-anchor="middle" font-size="40" fill="%23fff">' + (user.displayName?.[0] || '?') + '</text></svg>';
                
                // Show friends content
                if (friendsSigninPrompt) friendsSigninPrompt.style.display = 'none';
                if (friendsContent) friendsContent.style.display = 'block';
                
                // Show battle content
                if (battleSigninPrompt) battleSigninPrompt.style.display = 'none';
                if (battleContent) battleContent.style.display = 'block';
                
                // Load from cloud, merge with local
                loadFromCloud(user.uid);
                
                // Load friends data
                loadFriendsData(user.uid);
                
                // Load nudges and start listening
                loadTodayNudges().then(() => {
                    listenForNudges();
                    showPendingNudges();
                });
                
                // Check for pending friend/battle join actions
                checkPendingActions();
                
                // Unlock cloud sync achievement
                if (!userData.achievements['cloud-sync']) {
                    userData.achievements['cloud-sync'] = getTodayString();
                    saveData();
                    checkAndUnlockAchievements();
                }
            } else {
                // User is signed out
                signInBtn.style.display = 'flex';
                avatarBtn.style.display = 'none';
                updateSyncIndicator('offline');
                
                // Show signin prompt, hide friends content
                if (friendsSigninPrompt) friendsSigninPrompt.style.display = 'block';
                if (friendsContent) friendsContent.style.display = 'none';
                
                // Show battle signin prompt
                if (battleSigninPrompt) battleSigninPrompt.style.display = 'block';
                if (battleContent) battleContent.style.display = 'none';
            }
            
            // Update menu account section
            updateMenuAccountSection();
        }

        // ============ FRIENDS & LEADERBOARD ============
        let friendsData = [];
        let friendsActivity = [];

        async function loadFriendsData(uid) {
            if (!isFirebaseReady || !db) return;
            
            try {
                // Load friends list from shared friends path (same as Word Boxing)
                const friendsSnapshot = await db.ref('friends/' + uid).once('value');
                const friendsObj = friendsSnapshot.val() || {};
                
                friendsData = Object.values(friendsObj);
                
                // Update friends count
                const countEl = document.getElementById('friends-count');
                if (countEl) countEl.textContent = friendsData.length;
                
                // Load each friend's gameshelf data for leaderboard
                await loadFriendsShelfData(friendsData);
                
                // Render UI
                renderFriendsList();
                renderLeaderboard();
                renderActivityFeed();
                
            } catch (error) {
                console.error('Failed to load friends:', error);
            }
        }

        async function loadFriendsShelfData(friends) {
            if (!isFirebaseReady || !db) return;
            
            const today = getTodayString();
            const activities = [];
            
            for (const friend of friends) {
                try {
                    // Try to get their public gameshelf stats
                    const shelfSnapshot = await db.ref('gameshelf-public/' + friend.odid).once('value');
                    const shelfData = shelfSnapshot.val();
                    
                    if (shelfData) {
                        friend.shelfData = shelfData;
                        
                        // Build activity from their recent plays
                        if (shelfData.lastActivity) {
                            activities.push({
                                odid: friend.odid,
                                displayName: friend.displayName,
                                photoURL: shelfData.photoURL,
                                ...shelfData.lastActivity
                            });
                        }
                    }
                } catch (e) {
                    // Friend may not have public shelf data
                }
            }
            
            // Sort activities by timestamp (newest first)
            friendsActivity = activities.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)).slice(0, 10);
        }

        function renderFriendsList() {
            const listEl = document.getElementById('friends-list');
            if (!listEl) return;
            
            if (friendsData.length === 0) {
                listEl.innerHTML = `
                    <div class="activity-empty">
                        <p>No friends added yet</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">Add friends from Word Boxing or share your friend code!</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = friendsData.map(friend => {
                const todayPlayed = friend.shelfData?.todayCount || 0;
                const statusClass = todayPlayed > 0 ? 'active' : '';
                const statusText = todayPlayed > 0 ? `${todayPlayed} games today` : 'No activity today';
                
                return `
                    <div class="friend-item">
                        <img class="friend-avatar" src="${friend.photoURL || generateAvatarUrl(friend.displayName)}" alt="">
                        <div class="friend-info">
                            <div class="friend-name">${friend.displayName}</div>
                            <div class="friend-status ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard() {
            const leaderboardEl = document.getElementById('daily-leaderboard');
            if (!leaderboardEl) return;
            
            // Build leaderboard data
            const today = getTodayString();
            const leaderboardData = [];
            
            // Add current user
            if (currentUser) {
                let userTodayCount = 0;
                Object.values(userData.stats).forEach(stat => {
                    if (stat && stat.lastPlayed === today) userTodayCount++;
                });
                
                leaderboardData.push({
                    odid: currentUser.uid,
                    displayName: currentUser.displayName || 'You',
                    photoURL: currentUser.photoURL,
                    todayCount: userTodayCount,
                    isCurrentUser: true
                });
            }
            
            // Add friends
            friendsData.forEach(friend => {
                leaderboardData.push({
                    odid: friend.odid,
                    displayName: friend.displayName,
                    photoURL: friend.photoURL || friend.shelfData?.photoURL,
                    todayCount: friend.shelfData?.todayCount || 0,
                    isCurrentUser: false
                });
            });
            
            // Sort by games played today
            leaderboardData.sort((a, b) => b.todayCount - a.todayCount);
            
            if (leaderboardData.length <= 1) {
                leaderboardEl.innerHTML = `
                    <div class="leaderboard-empty">
                        <p>Add friends to compete!</p>
                    </div>
                `;
                return;
            }
            
            leaderboardEl.innerHTML = leaderboardData.slice(0, 10).map((entry, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const rankEmoji = index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : (index + 1);
                
                return `
                    <div class="leaderboard-item ${entry.isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-rank ${rankClass}">${rankEmoji}</div>
                        <img class="leaderboard-avatar" src="${entry.photoURL || generateAvatarUrl(entry.displayName)}" alt="">
                        <div class="leaderboard-name">${entry.isCurrentUser ? 'You' : entry.displayName}</div>
                        <div class="leaderboard-score">${entry.todayCount} <span>games</span></div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityFeed() {
            const feedEl = document.getElementById('activity-feed');
            if (!feedEl) return;
            
            if (friendsActivity.length === 0) {
                feedEl.innerHTML = `
                    <div class="activity-empty">
                        <p>No recent activity from friends</p>
                    </div>
                `;
                return;
            }
            
            feedEl.innerHTML = friendsActivity.map(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const gameIcon = getGameIcon(activity.gameId);
                
                return `
                    <div class="activity-item">
                        <img class="activity-avatar" src="${activity.photoURL || generateAvatarUrl(activity.displayName)}" alt="">
                        <div class="activity-content">
                            <div class="activity-text"><strong>${activity.displayName}</strong> played ${activity.gameName || activity.gameId}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                        <div class="activity-game-icon">${gameIcon}</div>
                    </div>
                `;
            }).join('');
        }

        function generateAvatarUrl(name) {
            const initial = (name || '?')[0].toUpperCase();
            return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" text-anchor="middle" font-size="40" fill="%23fff">${initial}</text></svg>`;
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Recently';
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            return `${days} days ago`;
        }

        function getGameIcon(gameId) {
            const icons = {
                'wordle': '',
                'connections': '',
                'strands': '',
                'spelling-bee': '',
                'mini': '',
                'letterboxed': '',
                'quordle': '4',
                'octordle': '8',
                'worldle': '',
                'globle': '',
                'framed': '',
                'nerdle': ''
            };
            return icons[gameId] || '';
        }

        async function publishActivity(gameId, gameName) {
            if (!isFirebaseReady || !db || !currentUser) return;
            
            try {
                const today = getTodayString();
                let todayCount = 0;
                Object.values(userData.stats).forEach(stat => {
                    if (stat && stat.lastPlayed === today) todayCount++;
                });
                
                // Publish public data for friends to see
                await db.ref('gameshelf-public/' + currentUser.uid).set({
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    todayCount: todayCount,
                    lastActivity: {
                        gameId: gameId,
                        gameName: gameName,
                        timestamp: Date.now()
                    }
                });
            } catch (e) {
                console.error('Failed to publish activity:', e);
            }
        }

        function showAddFriendModal() {
            // Generate a short code from UID
            const shortCode = currentUser ? currentUser.uid.substring(0, 8).toUpperCase() : '--------';
            const fullUid = currentUser ? currentUser.uid : '';
            const shareLink = `${window.location.origin}${window.location.pathname}?addFriend=${fullUid}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareLink)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'add-friend-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <h2> Add Friend</h2>
                    
                    <!-- Tab buttons -->
                    <div class="friend-tabs" style="display: flex; gap: 5px; margin: 15px 0;">
                        <button class="ext-tab active" onclick="showFriendTab('share')">Share Link</button>
                        <button class="ext-tab" onclick="showFriendTab('qr')">QR Code</button>
                        <button class="ext-tab" onclick="showFriendTab('code')">Enter Code</button>
                    </div>
                    
                    <!-- Share Link Tab -->
                    <div class="friend-tab-content" id="friend-tab-share">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Send this link to a friend:</p>
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 0.75rem; color: var(--accent-gold);">
                            ${shareLink}
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="copyFriendLink('${shareLink}')" style="flex:1"> Copy Link</button>
                            <button class="btn btn-secondary" onclick="shareFriendLink('${shareLink}')"> Share</button>
                        </div>
                    </div>
                    
                    <!-- QR Code Tab -->
                    <div class="friend-tab-content" id="friend-tab-qr" style="display: none;">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Scan to add as friend:</p>
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; display: inline-block; margin: 0 auto; width: 100%;">
                            <img src="${qrCodeUrl}" alt="QR Code" style="max-width: 150px;">
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 10px;">
                            Works with any QR scanner app
                        </p>
                    </div>
                    
                    <!-- Enter Code Tab -->
                    <div class="friend-tab-content" id="friend-tab-code" style="display: none;">
                        <div class="friend-code-display">
                            <div class="friend-code-label">Your Friend Code</div>
                            <div class="friend-code">${shortCode}</div>
                            <button class="btn btn-secondary" onclick="copyFriendCode('${shortCode}')" style="margin-top: 10px;"> Copy Code</button>
                        </div>
                        <p style="color: var(--text-secondary); margin: 15px 0;">Or enter a friend's code:</p>
                        <input type="text" class="friend-code-input" id="friend-code-input" placeholder="ABCD1234" maxlength="8">
                        <button class="btn btn-primary" onclick="addFriendByCode()" style="width: 100%; margin-top: 10px;">Add Friend</button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddFriendModal()" style="flex:1">Close</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 15px;">
                         Friends are shared with Word Boxing!
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showFriendTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.friend-tabs .ext-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all tabs
            document.querySelectorAll('.friend-tab-content').forEach(tab => tab.style.display = 'none');
            
            // Show selected tab
            document.getElementById('friend-tab-' + tabName).style.display = 'block';
        }

        function copyFriendLink(link) {
            navigator.clipboard.writeText(link);
            showToast('Friend link copied!');
        }

        function shareFriendLink(link) {
            if (navigator.share) {
                navigator.share({
                    title: 'Add me on Game Shelf!',
                    text: 'Track daily puzzles together on Game Shelf',
                    url: link
                });
            } else {
                copyFriendLink(link);
            }
        }

        // ============ GLOBAL STATS & PERCENTILE SYSTEM ============
        
        // Anonymous global stats for percentile calculation
        // Only aggregate counts, no PII
        const globalStatsCache = {};
        const GLOBAL_STATS_MIN_PLAYS = 50; // Minimum plays before showing percentile
        
        async function recordGlobalStat(gameId, score, success) {
            if (!isFirebaseReady || !db || !currentUser) return;
            
            try {
                const today = getTodayString();
                const statsRef = db.ref(`global-stats/${gameId}/${today}`);
                
                // Increment total plays
                await statsRef.child('totalPlays').transaction(count => (count || 0) + 1);
                
                // Increment score bucket
                // For wordle-style: score is like "3" for 3/6
                // For points-style: bucket by ranges
                const bucket = getScoreBucket(gameId, score, success);
                if (bucket) {
                    await statsRef.child(`distribution/${bucket}`).transaction(count => (count || 0) + 1);
                }
                
                // Update success count
                if (success) {
                    await statsRef.child('successCount').transaction(count => (count || 0) + 1);
                }
                
                console.log(' Recorded global stat:', gameId, bucket);
            } catch (e) {
                console.log('Global stat recording skipped:', e.message);
            }
        }
        
        function getScoreBucket(gameId, score, success) {
            // Wordle-style games (X/6 format)
            const wordleGames = ['wordle', 'connections', 'worldle', 'tradle', 'flagle'];
            if (wordleGames.includes(gameId)) {
                if (!success) return 'X';
                const match = String(score).match(/(\d)/);
                return match ? match[1] : null;
            }
            
            // Time-based games (bucket by seconds)
            const timeGames = ['mini'];
            if (timeGames.includes(gameId)) {
                const timeMatch = String(score).match(/(\d+):(\d+)/);
                if (timeMatch) {
                    const seconds = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
                    if (seconds < 60) return 'under60';
                    if (seconds < 120) return '60-120';
                    if (seconds < 180) return '120-180';
                    if (seconds < 300) return '180-300';
                    return 'over300';
                }
            }
            
            // Points-based games
            const pointsGames = ['spelling-bee'];
            if (pointsGames.includes(gameId)) {
                const pts = parseInt(score) || 0;
                if (pts >= 300) return '300plus';
                if (pts >= 200) return '200-299';
                if (pts >= 100) return '100-199';
                if (pts >= 50) return '50-99';
                return 'under50';
            }
            
            // Default: success/fail
            return success ? 'success' : 'fail';
        }
        
        async function loadGlobalStats(gameId) {
            if (!isFirebaseReady || !db) return null;
            
            const today = getTodayString();
            const cacheKey = `${gameId}_${today}`;
            
            // Check cache (5 min TTL)
            if (globalStatsCache[cacheKey] && 
                Date.now() - globalStatsCache[cacheKey].loadedAt < 300000) {
                return globalStatsCache[cacheKey].data;
            }
            
            try {
                const snapshot = await db.ref(`global-stats/${gameId}/${today}`).once('value');
                const data = snapshot.val();
                
                if (data) {
                    globalStatsCache[cacheKey] = {
                        data,
                        loadedAt: Date.now()
                    };
                }
                
                return data;
            } catch (e) {
                console.log('Failed to load global stats:', e.message);
                return null;
            }
        }
        
        async function calculatePercentile(gameId, userScore, success) {
            const stats = await loadGlobalStats(gameId);
            
            if (!stats || !stats.distribution || stats.totalPlays < GLOBAL_STATS_MIN_PLAYS) {
                return null; // Not enough data
            }
            
            const dist = stats.distribution;
            const total = stats.totalPlays;
            
            const userBucket = getScoreBucket(gameId, userScore, success);
            if (!userBucket) return null;
            
            // Calculate how many did worse
            let worseCount = 0;
            
            // Wordle-style: lower number is better
            const wordleGames = ['wordle', 'connections', 'worldle', 'tradle', 'flagle'];
            if (wordleGames.includes(gameId)) {
                const userNum = userBucket === 'X' ? 7 : parseInt(userBucket);
                for (let i = userNum + 1; i <= 6; i++) {
                    worseCount += dist[i.toString()] || 0;
                }
                worseCount += dist['X'] || 0;
            }
            // Time-based: lower is better
            else if (gameId === 'mini') {
                const timeOrder = ['under60', '60-120', '120-180', '180-300', 'over300'];
                const userIdx = timeOrder.indexOf(userBucket);
                for (let i = userIdx + 1; i < timeOrder.length; i++) {
                    worseCount += dist[timeOrder[i]] || 0;
                }
            }
            // Points-based: higher is better
            else if (gameId === 'spelling-bee') {
                const pointsOrder = ['under50', '50-99', '100-199', '200-299', '300plus'];
                const userIdx = pointsOrder.indexOf(userBucket);
                for (let i = 0; i < userIdx; i++) {
                    worseCount += dist[pointsOrder[i]] || 0;
                }
            }
            // Default binary
            else {
                if (success) {
                    worseCount = dist['fail'] || 0;
                }
            }
            
            // Percentile = % of players you beat
            const percentile = Math.round((worseCount / total) * 100);
            
            // Return "top X%" which is 100 - percentile
            return 100 - percentile;
        }
        
        function formatPercentile(percentile) {
            if (percentile === null || percentile === undefined) return null;
            
            if (percentile <= 1) return { text: "Top 1%!", icon: "", class: "legendary" };
            if (percentile <= 5) return { text: `Top ${percentile}%!`, icon: "", class: "amazing" };
            if (percentile <= 10) return { text: `Top ${percentile}%!`, icon: "", class: "great" };
            if (percentile <= 25) return { text: `Top ${percentile}%`, icon: "", class: "good" };
            if (percentile <= 50) return { text: `Top ${percentile}%`, icon: "", class: "average" };
            
            // Don't show below 50%
            return null;
        }

        // ============ SHARE SYSTEM ============
        
        // Store current share data for use by share functions
        let currentShareData = {
            type: null,
            gameIcon: '',
            gameName: '',
            score: '',
            streak: 0,
            points: 0,
            battleName: '',
            battleCode: '',
            battleGames: [],
            battleDuration: '',
            victoryScore: '',
            prize: 0
        };

        function showShareSuccessModal(gameIcon, gameName, score, streak, points) {
            currentShareData = {
                type: 'score',
                gameIcon,
                gameName,
                score,
                streak,
                points
            };
            
            // Update modal content
            document.getElementById('share-celebration').textContent = gameIcon;
            document.getElementById('share-game-name').textContent = gameName;
            document.getElementById('share-score-result').textContent = score;
            
            // Check if good score for extra celebration
            const isGreat = points >= 25 || (score.includes('/6') && parseInt(score) <= 3);
            document.getElementById('share-modal-title').textContent = isGreat ? ' Great Score!' : 'Nice!';
            
            // Show streak badge if streak > 1
            const streakBadge = document.getElementById('share-streak-badge');
            if (streak > 1) {
                streakBadge.style.display = 'inline-block';
                streakBadge.textContent = ` ${streak}-day streak`;
            } else {
                streakBadge.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('share-success-modal').classList.add('active');
            playSound('achievement');
        }

        function closeShareModal() {
            document.getElementById('share-success-modal').classList.remove('active');
        }

        function generateScoreShareText() {
            const { gameIcon, gameName, score, streak, points } = currentShareData;
            const baseUrl = window.location.origin + window.location.pathname;
            
            let text = `${gameIcon} ${gameName} - ${score}`;
            if (streak > 1) {
                text += `\n ${streak}-day streak`;
            }
            text += `\n\nTrack your daily puzzles  ${baseUrl}`;
            
            return text;
        }

        function shareScoreNative() {
            const text = generateScoreShareText();
            const baseUrl = window.location.origin + window.location.pathname;
            
            if (navigator.share) {
                navigator.share({
                    title: `${currentShareData.gameName} Score`,
                    text: text,
                    url: baseUrl
                }).then(() => {
                    showToast('Shared successfully!');
                    closeShareModal();
                }).catch(() => {
                    copyShareText();
                });
            } else {
                copyShareText();
            }
        }

        function copyShareText() {
            const text = generateScoreShareText();
            navigator.clipboard.writeText(text);
            showToast(' Copied to clipboard!');
        }

        // ============ BATTLE SHARE SYSTEM ============
        
        function showBattleShareModal(battleName, battleCode, games, duration, entryFee) {
            currentShareData = {
                type: 'battle',
                battleName,
                battleCode,
                battleGames: games,
                battleDuration: duration,
                entryFee: entryFee || 0
            };
            
            document.getElementById('battle-share-name').textContent = battleName;
            document.getElementById('battle-share-code').textContent = battleCode;
            
            const gameNames = games.slice(0, 3).map(g => {
                const found = FEATURED_GAMES.find(fg => fg.id === g);
                return found ? found.name : g;
            }).join(', ');
            
            let details = `${duration} days  ${gameNames}`;
            if (entryFee > 0) {
                details += `   ${entryFee} coin wager`;
            }
            document.getElementById('battle-share-details').textContent = details;
            
            document.getElementById('battle-share-modal').classList.add('active');
            playSound('achievement');
        }

        function closeBattleShareModal() {
            document.getElementById('battle-share-modal').classList.remove('active');
        }

        function generateBattleInviteText() {
            const { battleName, battleCode, battleGames, battleDuration, entryFee } = currentShareData;
            const baseUrl = window.location.origin + window.location.pathname;
            const joinUrl = `${baseUrl}?joinBattle=${battleCode}`;
            
            let text = ` You've been challenged!\n\n`;
            text += `"${battleName}"\n`;
            text += `Games: ${battleGames.slice(0, 3).join(', ')}\n`;
            text += `Duration: ${battleDuration} days\n`;
            if (entryFee > 0) {
                text += `Stakes: ${entryFee} coins \n`;
            }
            text += `\nJoin Code: ${battleCode}\n`;
            text += `\nAccept the challenge  ${joinUrl}`;
            
            return text;
        }

        function shareBattleInvite() {
            const text = generateBattleInviteText();
            const { battleCode, battleName } = currentShareData;
            const baseUrl = window.location.origin + window.location.pathname;
            const joinUrl = `${baseUrl}?joinBattle=${battleCode}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Join my Battle: ${battleName}`,
                    text: text,
                    url: joinUrl
                }).then(() => {
                    showToast('Invite shared!');
                    closeBattleShareModal();
                }).catch(() => {
                    copyBattleCode();
                });
            } else {
                copyBattleCode();
            }
        }

        function copyBattleCode() {
            const text = generateBattleInviteText();
            navigator.clipboard.writeText(text);
            showToast(' Battle invite copied!');
        }

        // ============ VICTORY SHARE SYSTEM ============
        
        function showVictoryModal(battleName, myScore, opponentScore, prize, battleId) {
            currentShareData = {
                type: 'victory',
                battleName,
                victoryScore: `${myScore} - ${opponentScore}`,
                prize,
                battleId
            };
            
            document.getElementById('victory-battle-name').textContent = battleName;
            document.getElementById('victory-score').textContent = `${myScore} pts vs ${opponentScore} pts`;
            
            const prizeEl = document.getElementById('victory-prize');
            if (prize > 0) {
                prizeEl.style.display = 'block';
                prizeEl.textContent = ` Won ${prize} coins!`;
            } else {
                prizeEl.style.display = 'block';
                prizeEl.textContent = ` Bragging rights earned!`;
            }
            
            document.getElementById('battle-victory-modal').classList.add('active');
            playSound('levelup');
            
            // Confetti!
            if (typeof confetti !== 'undefined') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function closeVictoryModal() {
            document.getElementById('battle-victory-modal').classList.remove('active');
        }

        function shareVictory() {
            const { battleName, victoryScore, prize } = currentShareData;
            const baseUrl = window.location.origin + window.location.pathname;
            
            let text = ` VICTORY!\n\n`;
            text += `I won "${battleName}"!\n`;
            text += `Final Score: ${victoryScore}\n`;
            if (prize > 0) {
                text += `Prize: ${prize} coins \n`;
            }
            text += `\nThink you can beat me?\n`;
            text += `Challenge me  ${baseUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'I won a Brain Battle!',
                    text: text,
                    url: baseUrl
                }).then(() => {
                    showToast('Victory shared!');
                    closeVictoryModal();
                }).catch(() => {
                    navigator.clipboard.writeText(text);
                    showToast(' Victory copied to clipboard!');
                });
            } else {
                navigator.clipboard.writeText(text);
                showToast(' Victory copied to clipboard!');
            }
        }

        function createRematchBattle() {
            closeVictoryModal();
            // Open create battle modal with same settings
            openCreateBattleModal();
        }

        // ============ FRIEND INVITE SHARE ============
        
        function shareFriendInvite() {
            if (!currentUser) {
                showToast('Sign in to invite friends');
                return;
            }
            
            const friendCode = currentUser.uid.substring(0, 8).toUpperCase();
            const baseUrl = window.location.origin + window.location.pathname;
            const inviteUrl = `${baseUrl}?addFriend=${currentUser.uid}`;
            
            const text = ` Track daily puzzles with me!\n\nJoin me on Game Shelf to compete in Wordle, Connections, and more.\n\nAdd me as a friend  ${inviteUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join me on Game Shelf!',
                    text: text,
                    url: inviteUrl
                }).catch(() => {
                    navigator.clipboard.writeText(text);
                    showToast(' Invite link copied!');
                });
            } else {
                navigator.clipboard.writeText(text);
                showToast(' Invite link copied!');
            }
        }

        // ============ MILESTONE SHARE ============
        
        function shareStreakMilestone(gameId, streak) {
            const game = FEATURED_GAMES.find(g => g.id === gameId) || { name: gameId, icon: '' };
            const baseUrl = window.location.origin + window.location.pathname;
            
            let celebrationEmoji = '';
            let achievement = '';
            if (streak >= 365) {
                celebrationEmoji = '';
                achievement = 'ONE YEAR';
            } else if (streak >= 100) {
                celebrationEmoji = '';
                achievement = '100 DAYS';
            } else if (streak >= 50) {
                celebrationEmoji = '';
                achievement = '50 DAYS';
            } else if (streak >= 30) {
                celebrationEmoji = '';
                achievement = '30 DAYS';
            } else if (streak >= 7) {
                celebrationEmoji = '';
                achievement = 'ONE WEEK';
            }
            
            const text = `${celebrationEmoji} ${achievement} ${celebrationEmoji}\n\n${game.icon} ${streak}-day ${game.name} streak!\n\nNo breaks, no excuses.\n\nTrack your streaks  ${baseUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `${streak}-Day Streak!`,
                    text: text,
                    url: baseUrl
                });
            } else {
                navigator.clipboard.writeText(text);
                showToast(' Milestone copied!');
            }
        }

        // ============ ENHANCED SHARE SCREEN (SHARING HUB) ============
        
        let enhancedShareData = {
            gameId: null,
            gameName: '',
            gameIcon: '',
            score: '',
            numericScore: 0,
            success: true,
            streak: 0,
            personalBest: null,
            monthAvg: null,
            friendComparisons: [],
            suggestion: null,
            rawShareText: ''
        };

        function showEnhancedShareScreen(gameId, gameName, gameIcon, score, numericScore, success, rawText) {
            // Store data for sharing
            enhancedShareData = {
                gameId,
                gameName,
                gameIcon,
                score,
                numericScore,
                success,
                streak: userData.stats[gameId]?.streak || 1,
                rawShareText: rawText,
                percentile: null
            };
            
            // Calculate context
            calculateEnhancedContext(gameId, numericScore);
            
            // Update UI
            const badge = document.getElementById('enhanced-score-badge');
            
            // Determine celebration level
            let celebration = '';
            let headline = 'Nice!';
            badge.className = 'enhanced-score-badge';
            
            if (numericScore >= 25) {
                celebration = '';
                headline = 'Amazing!';
                badge.classList.add('amazing');
            } else if (numericScore >= 20) {
                celebration = '';
                headline = 'Great Score!';
                badge.classList.add('great');
            }
            
            document.getElementById('enhanced-celebration').textContent = celebration;
            document.getElementById('enhanced-headline').textContent = headline;
            document.getElementById('enhanced-game-name').textContent = `${gameIcon} ${gameName}`;
            document.getElementById('enhanced-score-result').textContent = score;
            
            // Your stats
            document.getElementById('enhanced-streak').textContent = ` ${enhancedShareData.streak} day${enhancedShareData.streak !== 1 ? 's' : ''}`;
            document.getElementById('enhanced-avg').textContent = enhancedShareData.monthAvg ? enhancedShareData.monthAvg.toFixed(1) : '-';
            document.getElementById('enhanced-best').textContent = enhancedShareData.personalBest || '-';
            
            // Percentile - load async and update
            const percentileEl = document.getElementById('enhanced-percentile');
            if (percentileEl) {
                percentileEl.textContent = 'Calculating...';
                percentileEl.style.display = 'block';
            }
            
            calculatePercentile(gameId, score, success).then(percentile => {
                enhancedShareData.percentile = percentile;
                const formatted = formatPercentile(percentile);
                
                if (percentileEl) {
                    if (formatted) {
                        percentileEl.innerHTML = `<span style="margin-right: 5px;">${formatted.icon}</span>${formatted.text} globally`;
                        percentileEl.className = `enhanced-percentile ${formatted.class}`;
                        
                        // Update headline if great score
                        if (percentile <= 10) {
                            document.getElementById('enhanced-headline').textContent = 'Outstanding!';
                            document.getElementById('enhanced-celebration').textContent = formatted.icon;
                        }
                    } else {
                        percentileEl.style.display = 'none';
                    }
                }
                
                // Update share preview with percentile
                updateEnhancedSharePreview();
            }).catch(() => {
                if (percentileEl) percentileEl.style.display = 'none';
            });
            
            // Friends comparison
            renderEnhancedFriendsComparison();
            
            // AI suggestion
            generateEnhancedSuggestion();
            
            // Share preview
            updateEnhancedSharePreview();
            
            // Show modal
            document.getElementById('enhanced-share-modal').classList.add('active');
            playSound('achievement');
        }

        function closeEnhancedShareModal() {
            document.getElementById('enhanced-share-modal').classList.remove('active');
        }

        function calculateEnhancedContext(gameId, currentScore) {
            const stats = userData.stats[gameId];
            if (!stats) return;
            
            // Calculate month average
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const contestScores = stats.contestScores || {};
            
            const monthScores = Object.entries(contestScores)
                .filter(([date, _]) => date >= monthStart)
                .map(([_, score]) => score);
            
            if (monthScores.length > 0) {
                enhancedShareData.monthAvg = monthScores.reduce((a, b) => a + b, 0) / monthScores.length;
            }
            
            // Find personal best (for wordle-style games, lower is better)
            const allScores = Object.values(contestScores);
            if (allScores.length > 0) {
                const best = Math.max(...allScores);
                enhancedShareData.personalBest = `${best} pts`;
            }
            
            // Compare to friends
            const friendComps = [];
            friendsData.forEach(friend => {
                const friendScore = friend.todayGames?.[gameId];
                if (friendScore !== undefined) {
                    friendComps.push({
                        name: friend.displayName,
                        photoURL: friend.photoURL,
                        score: friendScore,
                        youWin: currentScore > friendScore
                    });
                }
            });
            
            // Sort: your wins first, then by score
            friendComps.sort((a, b) => {
                if (a.youWin !== b.youWin) return a.youWin ? -1 : 1;
                return b.score - a.score;
            });
            
            enhancedShareData.friendComparisons = friendComps;
        }

        function renderEnhancedFriendsComparison() {
            const section = document.getElementById('enhanced-friends-section');
            const list = document.getElementById('enhanced-friends-list');
            
            const comps = enhancedShareData.friendComparisons || [];
            const gameId = enhancedShareData.gameId;
            
            // Get friends who haven't played today
            const friendsNotPlayed = friendsData.filter(f => {
                const hasPlayed = comps.some(c => c.odid === f.odid || c.odataId === f.odataId);
                return !hasPlayed && f.todayGames && !f.todayGames[gameId];
            });
            
            if (comps.length === 0 && friendsNotPlayed.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            let html = '';
            
            // Build leaderboard including yourself if there are comparisons
            if (comps.length > 0) {
                const allPlayers = [
                    {
                        name: 'You',
                        odid: currentUser?.uid,
                        photoURL: currentUser?.photoURL,
                        score: enhancedShareData.numericScore,
                        isYou: true
                    },
                    ...comps.map(c => ({ ...c, isYou: false }))
                ];
                
                // Sort by score descending
                allPlayers.sort((a, b) => b.score - a.score);
                
                html += allPlayers.map((player, idx) => {
                    const rank = idx + 1;
                    const medal = rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : `${rank}.`;
                    const avatarUrl = player.photoURL || generateAvatarUrl(player.name);
                    
                    return `
                        <div class="enhanced-friend-row ${player.isYou ? 'you' : ''}">
                            <div class="enhanced-friend-name">
                                <span>${medal}</span>
                                <img src="${avatarUrl}" class="enhanced-friend-avatar" onerror="this.src='${generateAvatarUrl(player.name)}'">
                                <span>${escapeHtml(player.name)}${player.isYou ? ' ' : ''}</span>
                            </div>
                            <span class="value ${player.isYou ? '' : (player.score < enhancedShareData.numericScore ? 'lose' : 'win')}">${player.score} pts</span>
                        </div>
                    `;
                }).join('');
            }
            
            // Add friends who haven't played with nudge buttons
            if (friendsNotPlayed.length > 0) {
                html += `<div class="enhanced-section-divider"> Haven't played yet</div>`;
                
                html += friendsNotPlayed.slice(0, 5).map(friend => {
                    const avatarUrl = friend.photoURL || generateAvatarUrl(friend.displayName);
                    const friendId = friend.odid || friend.odataId;
                    const nudgeId = `nudge-${friendId}-${gameId}`.replace(/[^a-zA-Z0-9-]/g, '');
                    
                    return `
                        <div class="enhanced-friend-row not-played">
                            <div class="enhanced-friend-name">
                                <span></span>
                                <img src="${avatarUrl}" class="enhanced-friend-avatar" onerror="this.src='${generateAvatarUrl(friend.displayName)}'">
                                <span>${escapeHtml(friend.displayName)}</span>
                            </div>
                            <div id="${nudgeId}" class="nudge-container"></div>
                        </div>
                    `;
                }).join('');
            }
            
            list.innerHTML = html;
            
            // Render nudge buttons after DOM is updated
            setTimeout(() => {
                friendsNotPlayed.slice(0, 5).forEach(friend => {
                    const friendId = friend.odid || friend.odataId;
                    const nudgeId = `nudge-${friendId}-${gameId}`.replace(/[^a-zA-Z0-9-]/g, '');
                    const container = document.getElementById(nudgeId);
                    if (container) {
                        renderNudgeButton(friendId, friend.displayName, gameId, container);
                    }
                });
            }, 50);
        }

        function generateEnhancedSuggestion() {
            const suggestionDiv = document.getElementById('enhanced-suggestion');
            const iconEl = document.getElementById('suggestion-icon');
            const textEl = document.getElementById('suggestion-text');
            const btnEl = document.getElementById('suggestion-btn');
            
            const comps = enhancedShareData.friendComparisons;
            const streak = enhancedShareData.streak;
            
            // Priority 1: You beat someone - suggest battle
            const beaten = comps.filter(c => c.youWin);
            if (beaten.length > 0) {
                const rival = beaten[0];
                suggestionDiv.style.display = 'block';
                iconEl.textContent = '';
                textEl.textContent = `You beat ${rival.name}! Challenge them to a week-long battle?`;
                btnEl.textContent = ` Challenge ${rival.name}`;
                btnEl.onclick = () => startBattleWithFriend(rival.name);
                enhancedShareData.suggestion = { type: 'battle', target: rival.name };
                return;
            }
            
            // Priority 2: Streak milestone approaching
            if (streak === 6 || streak === 29 || streak === 49 || streak === 99) {
                suggestionDiv.style.display = 'block';
                iconEl.textContent = '';
                textEl.textContent = `One more day to hit ${streak + 1}! Don't break your streak!`;
                btnEl.textContent = ' Set Reminder';
                btnEl.onclick = () => showToast('Reminders coming soon!');
                enhancedShareData.suggestion = { type: 'streak' };
                return;
            }
            
            // Priority 3: No friends playing - invite them
            if (comps.length === 0 && friendsData.length === 0) {
                suggestionDiv.style.display = 'block';
                iconEl.textContent = '';
                textEl.textContent = `More fun with friends! Invite someone to compete.`;
                btnEl.textContent = ' Invite Friends';
                btnEl.onclick = () => shareFriendInvite();
                enhancedShareData.suggestion = { type: 'invite' };
                return;
            }
            
            // Priority 4: Friends haven't played - nudge them
            if (comps.length === 0 && friendsData.length > 0) {
                suggestionDiv.style.display = 'block';
                iconEl.textContent = '';
                textEl.textContent = `None of your friends have played ${enhancedShareData.gameName} today. Send a nudge?`;
                btnEl.textContent = ' Nudge Friends';
                btnEl.onclick = () => showToast('Nudge feature coming soon!');
                enhancedShareData.suggestion = { type: 'nudge' };
                return;
            }
            
            // No suggestion
            suggestionDiv.style.display = 'none';
        }

        function startBattleWithFriend(friendName) {
            closeEnhancedShareModal();
            // Find friend ID
            const friend = friendsData.find(f => f.displayName === friendName);
            if (friend) {
                // Pre-select this friend and open battle modal
                selectedBattleFriends = [friend.odataId || friend.odid];
                currentBattleType = 'challenge';
                openCreateBattleModal();
                // Pre-select the game
                setTimeout(() => {
                    const checkbox = document.querySelector(`#battle-games input[value="${enhancedShareData.gameId}"]`);
                    if (checkbox) checkbox.checked = true;
                }, 100);
            } else {
                openCreateBattleModal();
            }
        }

        function executeSuggestion() {
            const btn = document.getElementById('suggestion-btn');
            if (btn && btn.onclick) {
                btn.onclick();
            }
        }

        function updateEnhancedSharePreview() {
            const preview = document.getElementById('enhanced-share-preview');
            const text = generateEnhancedShareText();
            preview.textContent = text;
            enhancedShareData.enhancedText = text;
        }

        function generateEnhancedShareText() {
            const { gameIcon, gameName, score, streak, numericScore, friendComparisons, percentile } = enhancedShareData;
            const baseUrl = window.location.origin + window.location.pathname;
            
            let text = `${gameIcon} ${gameName} - ${score}`;
            
            // Add global percentile if available and good
            const formattedPercentile = formatPercentile(percentile);
            if (formattedPercentile && percentile <= 25) {
                text += `\n${formattedPercentile.icon} ${formattedPercentile.text} globally`;
            }
            
            // Add streak if notable
            if (streak > 1) {
                text += `\n ${streak}-day streak`;
            }
            
            // Add friend comparison if you won
            const beaten = (friendComparisons || []).filter(c => c.youWin);
            if (beaten.length > 0) {
                if (beaten.length === 1) {
                    text += `\n Beat ${beaten[0].name}!`;
                } else {
                    text += `\n Beat ${beaten.length} friends!`;
                }
            }
            
            text += `\n\nTrack your puzzles  ${baseUrl}`;
            
            return text;
        }

        function shareEnhancedResult() {
            const text = enhancedShareData.enhancedText || generateEnhancedShareText();
            const baseUrl = window.location.origin + window.location.pathname;
            
            if (navigator.share) {
                navigator.share({
                    title: `${enhancedShareData.gameName} Score`,
                    text: text,
                    url: baseUrl
                }).then(() => {
                    showToast('Shared!');
                    closeEnhancedShareModal();
                }).catch(() => {
                    copyEnhancedResult();
                });
            } else {
                copyEnhancedResult();
            }
        }

        function copyEnhancedResult() {
            const text = enhancedShareData.enhancedText || generateEnhancedShareText();
            navigator.clipboard.writeText(text);
            showToast(' Copied to clipboard!');
        }

        // ============ SHARE CARD IMAGE GENERATION ============
        
        const SHARE_CARD_COLORS = {
            bgGradient1: '#667eea',
            bgGradient2: '#764ba2',
            cardBg: '#1a1a2e',
            textPrimary: '#ffffff',
            textSecondary: 'rgba(255,255,255,0.8)',
            textMuted: 'rgba(255,255,255,0.6)',
            accentGold: '#ffd700',
            accentGreen: '#48bb78',
            accentOrange: '#ed8936'
        };

        async function generateShareCard(type, data) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Square format (works well on most platforms)
            canvas.width = 1080;
            canvas.height = 1080;
            
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, SHARE_CARD_COLORS.bgGradient1);
            gradient.addColorStop(1, SHARE_CARD_COLORS.bgGradient2);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Card background
            ctx.fillStyle = SHARE_CARD_COLORS.cardBg;
            roundRect(ctx, 60, 60, canvas.width - 120, canvas.height - 120, 40, true);
            
            // Draw content based on type
            switch(type) {
                case 'score':
                    await drawScoreCard(ctx, canvas, data);
                    break;
                case 'victory':
                    await drawVictoryCard(ctx, canvas, data);
                    break;
                case 'streak':
                    await drawStreakCard(ctx, canvas, data);
                    break;
                case 'weekly':
                    await drawWeeklyCard(ctx, canvas, data);
                    break;
            }
            
            // Watermark
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '28px system-ui, -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('gameshelf.app', canvas.width / 2, canvas.height - 90);
            
            // Game Shelf branding
            ctx.font = 'bold 32px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillText(' GAME SHELF', canvas.width / 2, 120);
            
            return canvas.toDataURL('image/png');
        }

        function roundRect(ctx, x, y, width, height, radius, fill) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            if (fill) ctx.fill();
        }

        async function drawScoreCard(ctx, canvas, data) {
            const { gameIcon, gameName, score, streak, percentile } = data;
            const centerX = canvas.width / 2;
            
            // Game icon (large)
            ctx.font = '120px serif';
            ctx.textAlign = 'center';
            ctx.fillText(gameIcon || '', centerX, 280);
            
            // Game name
            ctx.font = 'bold 56px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText(gameName || 'Game', centerX, 370);
            
            // Score (big and bold)
            ctx.font = 'bold 140px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText(score || '?', centerX, 530);
            
            // Divider line
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(200, 580);
            ctx.lineTo(canvas.width - 200, 580);
            ctx.stroke();
            
            // Stats section
            let yPos = 670;
            
            // Percentile (if available)
            const formattedPercentile = formatPercentile(percentile);
            if (formattedPercentile) {
                ctx.font = 'bold 42px system-ui, -apple-system, sans-serif';
                ctx.fillStyle = SHARE_CARD_COLORS.accentGold;
                ctx.fillText(`${formattedPercentile.icon} ${formattedPercentile.text} globally`, centerX, yPos);
                yPos += 70;
            }
            
            // Streak
            if (streak && streak > 1) {
                ctx.font = '40px system-ui, -apple-system, sans-serif';
                ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
                ctx.fillText(` ${streak}-day streak`, centerX, yPos);
                yPos += 70;
            }
            
            // Date
            const today = new Date().toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            ctx.font = '32px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textMuted;
            ctx.fillText(today, centerX, yPos);
        }

        async function drawVictoryCard(ctx, canvas, data) {
            const { battleName, winnerName, loserName, winnerScore, loserScore, prize } = data;
            const centerX = canvas.width / 2;
            
            // Trophy
            ctx.font = '140px serif';
            ctx.textAlign = 'center';
            ctx.fillText('', centerX, 300);
            
            // VICTORY text
            ctx.font = 'bold 72px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.accentGold;
            ctx.fillText('VICTORY!', centerX, 400);
            
            // Battle name
            ctx.font = '36px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText(`"${battleName}"`, centerX, 470);
            
            // VS section
            ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            
            // Winner (left)
            ctx.textAlign = 'right';
            ctx.fillText(winnerName || 'Winner', centerX - 60, 580);
            ctx.font = 'bold 64px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.accentGreen;
            ctx.fillText(String(winnerScore || 0), centerX - 60, 650);
            
            // VS
            ctx.font = '36px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textMuted;
            ctx.textAlign = 'center';
            ctx.fillText('vs', centerX, 620);
            
            // Loser (right)
            ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.textAlign = 'left';
            ctx.fillText(loserName || 'Opponent', centerX + 60, 580);
            ctx.font = 'bold 64px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText(String(loserScore || 0), centerX + 60, 650);
            
            // Prize
            if (prize && prize > 0) {
                ctx.textAlign = 'center';
                ctx.font = 'bold 40px system-ui, -apple-system, sans-serif';
                ctx.fillStyle = SHARE_CARD_COLORS.accentGold;
                ctx.fillText(` Won ${prize} coins!`, centerX, 760);
            }
            
            // CTA
            ctx.font = '32px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textMuted;
            ctx.fillText('Think you can beat me?', centerX, 850);
        }

        async function drawStreakCard(ctx, canvas, data) {
            const { gameIcon, gameName, streak } = data;
            const centerX = canvas.width / 2;
            
            // Flame emoji pattern
            ctx.font = '60px serif';
            ctx.textAlign = 'center';
            ctx.fillText('', centerX, 220);
            
            // Streak number (massive)
            ctx.font = 'bold 200px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.accentOrange;
            ctx.fillText(String(streak), centerX, 450);
            
            // "DAYS" text
            ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText('DAY STREAK', centerX, 520);
            
            // Game info
            ctx.font = '60px serif';
            ctx.fillText(gameIcon || '', centerX, 620);
            ctx.font = '40px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText(gameName || 'Puzzle Game', centerX, 680);
            
            // Motivational text
            let message = 'No breaks. No excuses.';
            if (streak >= 365) message = "One full year! Legendary!";
            else if (streak >= 100) message = "Triple digits! Incredible!";
            else if (streak >= 50) message = "Halfway to 100!";
            else if (streak >= 30) message = "A whole month strong!";
            else if (streak >= 7) message = "One week down!";
            
            ctx.font = '36px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textMuted;
            ctx.fillText(message, centerX, 780);
        }

        async function drawWeeklyCard(ctx, canvas, data) {
            const { displayName, weekStats } = data;
            const centerX = canvas.width / 2;
            
            // Header
            ctx.font = '48px serif';
            ctx.textAlign = 'center';
            ctx.fillText('', centerX, 220);
            
            ctx.font = 'bold 52px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText(`${displayName}'s Week`, centerX, 300);
            
            // Date range
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const dateRange = `${weekAgo.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            ctx.font = '32px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textMuted;
            ctx.fillText(dateRange, centerX, 350);
            
            // Stats grid
            const stats = weekStats || { games: 0, streaks: 0, battles: 0, bestScore: '-' };
            const statsY = 480;
            const statSpacing = 100;
            
            ctx.font = 'bold 56px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.textAlign = 'center';
            
            // Games played
            ctx.fillText(String(stats.games), centerX - 180, statsY);
            ctx.font = '28px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText('Games', centerX - 180, statsY + 40);
            
            // Active streaks
            ctx.font = 'bold 56px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText(String(stats.streaks), centerX, statsY);
            ctx.font = '28px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText('Streaks', centerX, statsY + 40);
            
            // Battles won
            ctx.font = 'bold 56px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textPrimary;
            ctx.fillText(String(stats.battles), centerX + 180, statsY);
            ctx.font = '28px system-ui, -apple-system, sans-serif';
            ctx.fillStyle = SHARE_CARD_COLORS.textSecondary;
            ctx.fillText('Battles', centerX + 180, statsY + 40);
            
            // Best score highlight
            if (stats.bestScore && stats.bestScore !== '-') {
                ctx.font = '36px system-ui, -apple-system, sans-serif';
                ctx.fillStyle = SHARE_CARD_COLORS.accentGold;
                ctx.fillText(` Best: ${stats.bestScore}`, centerX, 650);
            }
            
            // Weekly rank if available
            if (stats.weeklyRank) {
                ctx.font = 'bold 40px system-ui, -apple-system, sans-serif';
                ctx.fillStyle = SHARE_CARD_COLORS.accentGreen;
                ctx.fillText(`Top ${stats.weeklyRank}% this week!`, centerX, 750);
            }
        }

        async function shareAsImage(type) {
            showToast('Generating share card...');
            
            let data = {};
            
            switch(type) {
                case 'score':
                    data = {
                        gameIcon: enhancedShareData.gameIcon,
                        gameName: enhancedShareData.gameName,
                        score: enhancedShareData.score,
                        streak: enhancedShareData.streak,
                        percentile: enhancedShareData.percentile
                    };
                    break;
                case 'streak':
                    data = {
                        gameIcon: enhancedShareData.gameIcon,
                        gameName: enhancedShareData.gameName,
                        streak: enhancedShareData.streak
                    };
                    break;
                case 'victory':
                    data = currentShareData; // From victory modal
                    break;
                case 'weekly':
                    data = {
                        displayName: currentUser?.displayName || 'Player',
                        weekStats: calculateWeekStats()
                    };
                    break;
            }
            
            try {
                const imageDataUrl = await generateShareCard(type, data);
                const blob = await (await fetch(imageDataUrl)).blob();
                const file = new File([blob], `gameshelf-${type}.png`, { type: 'image/png' });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'My Game Shelf Score',
                        text: 'Check out my score!'
                    });
                    showToast('Shared!');
                } else {
                    // Fallback: download the image
                    const link = document.createElement('a');
                    link.href = imageDataUrl;
                    link.download = `gameshelf-${type}.png`;
                    link.click();
                    showToast('Image downloaded! Share from your gallery.');
                }
            } catch (e) {
                console.error('Share card error:', e);
                showToast('Could not generate image');
            }
        }

        function calculateWeekStats() {
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            
            let games = 0;
            let streaks = 0;
            let bestScore = '-';
            let bestScoreVal = 0;
            
            // Count games and streaks
            Object.entries(userData.stats || {}).forEach(([gameId, stats]) => {
                if (typeof stats !== 'object') return;
                
                // Count streak
                if (stats.streak && stats.streak > 0) {
                    streaks++;
                }
                
                // Count games this week
                const contestScores = stats.contestScores || {};
                Object.entries(contestScores).forEach(([date, score]) => {
                    if (date >= weekAgoStr) {
                        games++;
                        if (score > bestScoreVal) {
                            bestScoreVal = score;
                            const game = FEATURED_GAMES.find(g => g.id === gameId);
                            bestScore = `${game?.name || gameId} ${score}pts`;
                        }
                    }
                });
            });
            
            // Count battle wins
            const battles = userBattles.filter(b => 
                b.status === 'completed' && 
                b.winner?.odid === currentUser?.uid
            ).length;
            
            return { games, streaks, battles, bestScore };
        }

        // ============ PUSH NOTIFICATIONS ============
        
        let pushSubscription = null;
        let swRegistration = null;
        
        // Default notification preferences
        const DEFAULT_NOTIFICATION_PREFS = {
            enabled: false,
            streakReminders: true,
            streakReminderTime: '18:00', // 6 PM
            battleUpdates: true,
            friendActivity: false,
            nudges: true,
            weeklySummary: true
        };
        
        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('[Push] Not supported in this browser');
                return false;
            }
            
            try {
                // Register service worker
                swRegistration = await navigator.serviceWorker.register('/sw.js');
                console.log('[Push] Service Worker registered');
                
                // Check for existing subscription
                pushSubscription = await swRegistration.pushManager.getSubscription();
                
                if (pushSubscription) {
                    console.log('[Push] Existing subscription found');
                    updateNotificationUI(true);
                }
                
                return true;
            } catch (error) {
                console.error('[Push] Registration failed:', error);
                return false;
            }
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Notifications not supported');
                return false;
            }
            
            // Check current permission
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission === 'denied') {
                showToast('Notifications blocked. Enable in browser settings.');
                return false;
            }
            
            // Request permission
            const permission = await Notification.requestPermission();
            return permission === 'granted';
        }
        
        async function subscribeToPush() {
            if (!swRegistration) {
                const initialized = await initPushNotifications();
                if (!initialized) {
                    showToast('Push notifications not available');
                    return null;
                }
            }
            
            // Request permission first
            const permitted = await requestNotificationPermission();
            if (!permitted) {
                return null;
            }
            
            try {
                // Subscribe to push
                // Note: In production, use your own VAPID keys
                const applicationServerKey = urlBase64ToUint8Array(
                    'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U'
                );
                
                pushSubscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey
                });
                
                console.log('[Push] Subscribed:', pushSubscription);
                
                // Save subscription to Firebase
                await savePushSubscription(pushSubscription);
                
                // Update preferences
                if (!userData.notificationPrefs) {
                    userData.notificationPrefs = { ...DEFAULT_NOTIFICATION_PREFS };
                }
                userData.notificationPrefs.enabled = true;
                saveData();
                
                updateNotificationUI(true);
                showToast(' Notifications enabled!');
                
                return pushSubscription;
            } catch (error) {
                console.error('[Push] Subscription failed:', error);
                showToast('Could not enable notifications');
                return null;
            }
        }
        
        async function unsubscribeFromPush() {
            if (!pushSubscription) {
                return;
            }
            
            try {
                await pushSubscription.unsubscribe();
                pushSubscription = null;
                
                // Remove from Firebase
                if (currentUser) {
                    await db.ref(`push-subscriptions/${currentUser.uid}`).remove();
                }
                
                // Update preferences
                if (userData.notificationPrefs) {
                    userData.notificationPrefs.enabled = false;
                }
                saveData();
                
                updateNotificationUI(false);
                showToast('Notifications disabled');
            } catch (error) {
                console.error('[Push] Unsubscribe failed:', error);
            }
        }
        
        async function savePushSubscription(subscription) {
            if (!currentUser || !db) return;
            
            try {
                await db.ref(`push-subscriptions/${currentUser.uid}`).set({
                    subscription: JSON.stringify(subscription),
                    createdAt: Date.now(),
                    userAgent: navigator.userAgent,
                    preferences: userData.notificationPrefs || DEFAULT_NOTIFICATION_PREFS
                });
            } catch (e) {
                console.error('Failed to save push subscription:', e);
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        function updateNotificationUI(enabled) {
            const toggleBtn = document.getElementById('notification-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = enabled ? ' Notifications On' : ' Enable Notifications';
                toggleBtn.className = enabled ? 'btn btn-secondary' : 'btn btn-primary';
            }
        }
        
        // Show push notification opt-in after valuable moment
        function showPushOptIn(reason) {
            // Don't show if already enabled or denied
            if (Notification.permission === 'granted' || Notification.permission === 'denied') {
                return;
            }
            
            // Don't show if user dismissed recently
            const lastDismissed = localStorage.getItem('pushOptInDismissed');
            if (lastDismissed && Date.now() - parseInt(lastDismissed) < 24 * 60 * 60 * 1000) {
                return;
            }
            
            let message = '';
            switch (reason) {
                case 'streak':
                    message = 'Want reminders to protect your streaks?';
                    break;
                case 'battle':
                    message = 'Get notified about battle updates?';
                    break;
                case 'friend':
                    message = 'Know when friends beat your scores?';
                    break;
                default:
                    message = 'Enable notifications to stay in the game!';
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'push-opt-in-modal';
            modal.innerHTML = `
                <div class="modal" style="text-align: center; max-width: 340px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h3 style="margin-bottom: 15px;">${message}</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;">
                        We'll only send helpful reminders - never spam.
                    </p>
                    <div class="btn-group" style="flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="acceptPushOptIn()" style="width: 100%;">
                            Yes, enable notifications
                        </button>
                        <button class="btn btn-secondary" onclick="dismissPushOptIn()" style="width: 100%;">
                            Not now
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function acceptPushOptIn() {
            closePushOptInModal();
            await subscribeToPush();
        }
        
        function dismissPushOptIn() {
            localStorage.setItem('pushOptInDismissed', Date.now().toString());
            closePushOptInModal();
        }
        
        function closePushOptInModal() {
            const modal = document.getElementById('push-opt-in-modal');
            if (modal) modal.remove();
        }
        
        // Test notification (for settings)
        async function sendTestNotification() {
            if (Notification.permission !== 'granted') {
                showToast('Notifications not enabled');
                return;
            }
            
            const notification = new Notification(' Game Shelf', {
                body: 'Notifications are working! You\'ll be notified about streaks, battles, and friends.',
                icon: '/icon-192.png',
                badge: '/badge-72.png'
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }
        
        // Save notification preferences
        async function saveNotificationPrefs() {
            const prefs = {
                enabled: userData.notificationPrefs?.enabled || false,
                streakReminders: document.getElementById('pref-streak-reminders')?.checked ?? true,
                battleUpdates: document.getElementById('pref-battle-updates')?.checked ?? true,
                friendActivity: document.getElementById('pref-friend-activity')?.checked ?? false,
                nudges: document.getElementById('pref-nudges')?.checked ?? true,
                weeklySummary: document.getElementById('pref-weekly-summary')?.checked ?? true
            };
            
            userData.notificationPrefs = prefs;
            saveData();
            
            // Update on server
            if (currentUser && pushSubscription) {
                await db.ref(`push-subscriptions/${currentUser.uid}/preferences`).set(prefs);
            }
            
            showToast('Notification preferences saved');
        }

        async function togglePushNotifications() {
            const toggleBtn = document.getElementById('notification-toggle');
            const prefsDiv = document.getElementById('notification-prefs');
            
            if (pushSubscription) {
                // Currently enabled, disable
                await unsubscribeFromPush();
                toggleBtn.textContent = ' Enable';
                toggleBtn.className = 'btn btn-primary';
                if (prefsDiv) prefsDiv.style.display = 'none';
            } else {
                // Currently disabled, enable
                const subscription = await subscribeToPush();
                if (subscription) {
                    toggleBtn.textContent = ' Disable';
                    toggleBtn.className = 'btn btn-secondary';
                    if (prefsDiv) prefsDiv.style.display = 'block';
                    loadNotificationPrefsUI();
                }
            }
        }

        function loadNotificationPrefsUI() {
            const prefs = userData.notificationPrefs || DEFAULT_NOTIFICATION_PREFS;
            
            const streakEl = document.getElementById('pref-streak-reminders');
            const battleEl = document.getElementById('pref-battle-updates');
            const nudgesEl = document.getElementById('pref-nudges');
            const friendEl = document.getElementById('pref-friend-activity');
            const weeklyEl = document.getElementById('pref-weekly-summary');
            
            if (streakEl) streakEl.checked = prefs.streakReminders !== false;
            if (battleEl) battleEl.checked = prefs.battleUpdates !== false;
            if (nudgesEl) nudgesEl.checked = prefs.nudges !== false;
            if (friendEl) friendEl.checked = prefs.friendActivity === true;
            if (weeklyEl) weeklyEl.checked = prefs.weeklySummary !== false;
        }

        function initNotificationUI() {
            const toggleBtn = document.getElementById('notification-toggle');
            const prefsDiv = document.getElementById('notification-prefs');
            
            if (pushSubscription || userData.notificationPrefs?.enabled) {
                if (toggleBtn) {
                    toggleBtn.textContent = ' Disable';
                    toggleBtn.className = 'btn btn-secondary';
                }
                if (prefsDiv) {
                    prefsDiv.style.display = 'block';
                    loadNotificationPrefsUI();
                }
            }
        }

        // ============ NUDGE SYSTEM ============
        
        const NUDGE_LIMITS = {
            perFriendPerDay: 1,
            perGamePerDay: 3,
            totalPerDay: 10,
            cooldownHours: 4
        };
        
        // Track nudges sent today (in memory, synced to Firebase)
        let todayNudges = {
            sent: [],
            received: []
        };
        
        async function loadTodayNudges() {
            if (!currentUser || !db) return;
            
            const today = getTodayString();
            
            try {
                // Load sent nudges
                const sentSnap = await db.ref(`nudges/${currentUser.uid}/sent/${today}`).once('value');
                todayNudges.sent = sentSnap.val() ? Object.values(sentSnap.val()) : [];
                
                // Load received nudges
                const receivedSnap = await db.ref(`nudges/${currentUser.uid}/received/${today}`).once('value');
                todayNudges.received = receivedSnap.val() ? Object.values(receivedSnap.val()) : [];
            } catch (e) {
                console.log('Failed to load nudges:', e);
            }
        }
        
        function canSendNudge(toUserId, gameId) {
            const today = getTodayString();
            
            // Check per-friend limit
            const nudgesToFriend = todayNudges.sent.filter(n => n.to === toUserId);
            if (nudgesToFriend.length >= NUDGE_LIMITS.perFriendPerDay) {
                return { allowed: false, reason: 'Already nudged this friend today' };
            }
            
            // Check per-game limit
            const nudgesForGame = todayNudges.sent.filter(n => n.gameId === gameId);
            if (nudgesForGame.length >= NUDGE_LIMITS.perGamePerDay) {
                return { allowed: false, reason: 'Too many nudges for this game today' };
            }
            
            // Check total daily limit
            if (todayNudges.sent.length >= NUDGE_LIMITS.totalPerDay) {
                return { allowed: false, reason: 'Daily nudge limit reached' };
            }
            
            // Check cooldown
            const recentNudge = todayNudges.sent.find(n => 
                n.to === toUserId && 
                Date.now() - n.sentAt < NUDGE_LIMITS.cooldownHours * 60 * 60 * 1000
            );
            if (recentNudge) {
                return { allowed: false, reason: 'Wait a bit before nudging again' };
            }
            
            return { allowed: true };
        }
        
        async function sendNudge(toUserId, toDisplayName, gameId) {
            if (!currentUser || !db) {
                showToast('Please sign in first');
                return false;
            }
            
            // Check limits
            const check = canSendNudge(toUserId, gameId);
            if (!check.allowed) {
                showToast(check.reason);
                return false;
            }
            
            const today = getTodayString();
            const game = FEATURED_GAMES.find(g => g.id === gameId);
            const gameName = game?.name || gameId;
            
            const nudge = {
                from: currentUser.uid,
                fromName: currentUser.displayName,
                to: toUserId,
                toName: toDisplayName,
                gameId,
                gameName,
                date: today,
                sentAt: Date.now(),
                status: 'pending'
            };
            
            try {
                // Save nudge to sender's sent list
                await db.ref(`nudges/${currentUser.uid}/sent/${today}`).push(nudge);
                
                // Save to recipient's received list
                await db.ref(`nudges/${toUserId}/received/${today}`).push(nudge);
                
                // Add to local tracking
                todayNudges.sent.push(nudge);
                
                // TODO: In production, trigger a Cloud Function to send push notification
                // For now, we'll just update the UI
                
                showToast(` Nudged ${toDisplayName}!`);
                playSound('pop');
                
                return true;
            } catch (e) {
                console.error('Failed to send nudge:', e);
                showToast('Failed to send nudge');
                return false;
            }
        }
        
        // Check if user was nudged when they log a game
        async function checkNudgeResponse(gameId) {
            if (!currentUser || !db) return;
            
            const today = getTodayString();
            
            // Find pending nudges for this game
            const pendingNudges = todayNudges.received.filter(n => 
                n.gameId === gameId && 
                n.status === 'pending'
            );
            
            for (const nudge of pendingNudges) {
                // Mark as responded
                nudge.status = 'responded';
                nudge.respondedAt = Date.now();
                
                // Update in Firebase
                try {
                    // Update in recipient's received
                    const receivedRef = db.ref(`nudges/${currentUser.uid}/received/${today}`);
                    const receivedSnap = await receivedRef.once('value');
                    receivedSnap.forEach(child => {
                        if (child.val().from === nudge.from && child.val().gameId === gameId) {
                            child.ref.update({ status: 'responded', respondedAt: Date.now() });
                        }
                    });
                    
                    // Update in sender's sent
                    const sentRef = db.ref(`nudges/${nudge.from}/sent/${today}`);
                    const sentSnap = await sentRef.once('value');
                    sentSnap.forEach(child => {
                        if (child.val().to === currentUser.uid && child.val().gameId === gameId) {
                            child.ref.update({ status: 'responded', respondedAt: Date.now() });
                        }
                    });
                    
                    // Notify the nudger (activity feed will show this)
                    await db.ref(`nudge-responses/${nudge.from}`).push({
                        from: currentUser.uid,
                        fromName: currentUser.displayName,
                        gameId,
                        respondedAt: Date.now()
                    });
                    
                } catch (e) {
                    console.log('Failed to update nudge response:', e);
                }
            }
        }
        
        // Render nudge button for friends who haven't played
        function renderNudgeButton(friendId, friendName, gameId, containerEl) {
            // Check if we can nudge
            const check = canSendNudge(friendId, gameId);
            
            // Check if already nudged
            const alreadyNudged = todayNudges.sent.some(n => 
                n.to === friendId && n.gameId === gameId
            );
            
            if (alreadyNudged) {
                containerEl.innerHTML = `<span style="color: var(--text-muted); font-size: 0.8rem;">Nudged </span>`;
                return;
            }
            
            if (!check.allowed) {
                containerEl.innerHTML = `<span style="color: var(--text-muted); font-size: 0.8rem;"></span>`;
                return;
            }
            
            containerEl.innerHTML = `
                <button class="nudge-btn" onclick="sendNudge('${friendId}', '${escapeHtml(friendName)}', '${gameId}')" 
                        style="background: none; border: 1px solid var(--border); padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; color: var(--text-secondary);">
                     Nudge
                </button>
            `;
        }
        
        // Show pending nudges received
        function showPendingNudges() {
            const pending = todayNudges.received.filter(n => n.status === 'pending');
            
            if (pending.length === 0) return;
            
            // Show toast for most recent
            const latest = pending[pending.length - 1];
            showToast(` ${latest.fromName} wants you to play ${latest.gameName}!`);
        }
        
        // Listen for new nudges (real-time)
        function listenForNudges() {
            if (!currentUser || !db) return;
            
            const today = getTodayString();
            
            db.ref(`nudges/${currentUser.uid}/received/${today}`).on('child_added', (snapshot) => {
                const nudge = snapshot.val();
                
                // Check if this is new (not already in our local list)
                const exists = todayNudges.received.some(n => 
                    n.from === nudge.from && 
                    n.gameId === nudge.gameId &&
                    n.sentAt === nudge.sentAt
                );
                
                if (!exists) {
                    todayNudges.received.push(nudge);
                    
                    // Show notification
                    if (nudge.status === 'pending') {
                        showToast(` ${nudge.fromName} wants you to play ${nudge.gameName}!`);
                        playSound('pop');
                    }
                }
            });
        }

        function closeAddFriendModal() {
            const modal = document.getElementById('add-friend-modal');
            if (modal) modal.remove();
        }

        function copyFriendCode(code) {
            navigator.clipboard.writeText(code);
            showToast('Friend code copied!');
        }

        async function addFriendByCode() {
            const codeInput = document.getElementById('friend-code-input');
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 8) {
                showToast('Please enter a valid 8-character code');
                return;
            }
            
            showToast('Looking up friend...');
            // Note: In a full implementation, you'd need a lookup table
            // mapping short codes to full UIDs
            closeAddFriendModal();
        }

        // ============ CLOUD SYNC ============
        async function loadFromCloud(uid) {
            if (!isFirebaseReady || !db) return;
            
            updateSyncIndicator('syncing');
            
            try {
                const snapshot = await db.ref('gameshelf/' + uid).once('value');
                const cloudData = snapshot.val();
                
                if (cloudData) {
                    // Merge cloud data with local data (cloud wins for conflicts)
                    userData = mergeUserData(userData, cloudData);
                    saveData(); // Save merged data locally
                    
                    // Re-render everything
                    renderAll();
                    showToast(' Synced from cloud');
                } else {
                    // No cloud data, push local data to cloud
                    await saveToCloud();
                }
                
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Cloud load error:', error);
                updateSyncIndicator('offline');
            }
        }

        async function saveToCloud() {
            if (!isFirebaseReady || !db || !currentUser) return;
            
            updateSyncIndicator('syncing');
            
            try {
                await db.ref('gameshelf/' + currentUser.uid).set({
                    ...userData,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    displayName: currentUser.displayName,
                    email: currentUser.email
                });
                
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Cloud save error:', error);
                updateSyncIndicator('offline');
            }
        }

        function mergeUserData(local, cloud) {
            // Smart merge: combine arrays, take higher values for stats
            const merged = { ...local };
            
            // Merge games (combine unique games)
            const localGameIds = new Set(local.games?.map(g => g.id) || []);
            const cloudGames = cloud.games || [];
            cloudGames.forEach(g => {
                if (!localGameIds.has(g.id)) {
                    merged.games.push(g);
                }
            });
            
            // Merge stats (take higher values)
            merged.stats = { ...local.stats };
            Object.entries(cloud.stats || {}).forEach(([key, cloudStat]) => {
                if (typeof cloudStat === 'object') {
                    const localStat = local.stats?.[key] || {};
                    merged.stats[key] = {
                        streak: Math.max(cloudStat.streak || 0, localStat.streak || 0),
                        totalPlays: Math.max(cloudStat.totalPlays || 0, localStat.totalPlays || 0),
                        lastPlayed: cloudStat.lastPlayed > localStat.lastPlayed ? cloudStat.lastPlayed : localStat.lastPlayed
                    };
                } else {
                    merged.stats[key] = Math.max(cloudStat || 0, local.stats?.[key] || 0);
                }
            });
            
            // Merge achievements (combine)
            merged.achievements = { ...local.achievements, ...cloud.achievements };
            
            // Merge history (combine days)
            merged.history = { ...local.history, ...cloud.history };
            
            // Merge reviews (cloud wins)
            merged.reviews = { ...local.reviews, ...cloud.reviews };
            
            // Take cloud dailyGoal if set
            if (cloud.dailyGoal) merged.dailyGoal = cloud.dailyGoal;
            
            // Registration status
            merged.registered = local.registered || cloud.registered;
            
            return merged;
        }

        function updateSyncIndicator(status) {
            syncStatus = status;
            const indicator = document.getElementById('sync-indicator');
            const statusEl = document.getElementById('sync-status');
            const statusText = document.getElementById('sync-status-text');
            
            if (indicator) {
                indicator.className = 'sync-indicator ' + status;
            }
            
            if (statusEl && statusText) {
                statusEl.className = 'sync-status ' + status;
                switch (status) {
                    case 'synced':
                        statusText.textContent = 'Synced to cloud';
                        break;
                    case 'syncing':
                        statusText.textContent = 'Syncing...';
                        break;
                    case 'offline':
                        statusText.textContent = 'Local only';
                        break;
                }
            }
        }

        async function syncNow() {
            if (!currentUser) {
                showToast('Sign in to sync');
                return;
            }
            
            await saveToCloud();
            showToast(' Synced!');
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profile-avatar').src = currentUser.photoURL || '';
            document.getElementById('profile-name').textContent = currentUser.displayName || 'Player';
            document.getElementById('profile-email').textContent = currentUser.email || '';
            
            // Stats
            document.getElementById('profile-games-played').textContent = userData.stats?.totalCompleted || 0;
            
            let bestStreak = 0;
            Object.values(userData.stats || {}).forEach(stat => {
                if (typeof stat === 'object' && stat.streak > bestStreak) {
                    bestStreak = stat.streak;
                }
            });
            document.getElementById('profile-best-streak').textContent = bestStreak;
            document.getElementById('profile-achievements').textContent = Object.keys(userData.achievements || {}).length;
            
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function renderAll() {
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            updateSharePreview();
            renderCalendar();
            renderAchievements();
            updateDailyGoal();
            renderInsights();
        }

        // ============ INIT ============
        function init() {
            // PWA Initialization - run first (wrapped in try-catch to not block if SW fails)
            try {
                detectPWAMode();
            } catch (e) {
                console.warn('[PWA] detectPWAMode failed:', e);
            }
            
            // Don't block on service worker - it will fail if sw.js doesn't exist
            registerServiceWorker().catch(e => console.warn('[PWA] SW registration skipped:', e));
            
            try {
                handleURLParams();
            } catch (e) {
                console.warn('[PWA] handleURLParams failed:', e);
            }
            
            loadData();
            loadTheme();
            applyPlainMode(); // Initialize Plain Mode
            applySound(); // Initialize Sound settings
            
            // Inject onboarding styles if available
            if (typeof OnboardingStyles !== 'undefined') {
                if (!document.getElementById('onboarding-styles')) {
                    document.head.insertAdjacentHTML('beforeend', OnboardingStyles);
                }
            }
            
            // Set up Firebase auth listener
            if (isFirebaseReady && auth) {
                auth.onAuthStateChanged(handleAuthStateChange);
            }
            
            if (!userData.registered) {
                showWelcome();
            } else {
                // Check if onboarding needed (after registration)
                checkAndShowOnboarding();
            }
            
            // Initialize wallet system
            initWallet();
            
            // Handle return from Stripe checkout
            handlePaymentReturn();
            
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            updateSharePreview();
            setupStarRating();
            renderCalendar();
            renderAchievements();
            checkTimeAchievements();
            updateDailyGoal();
            renderInsights();
            generateShareLink();
            
            // Handle Share Target API (when app receives shared content)
            handleIncomingShare();
            
            // Start clipboard monitoring (PWA enhanced)
            startClipboardMonitoring();
            
            // Initial clipboard check for PWA
            if (isPWAMode) {
                setTimeout(checkClipboardForGameResult, 1000);
            }
            
            // Check for pending friend add (from before sign-in)
            checkPendingFriend();
            
            // Initialize push notifications
            initPushNotifications().then(() => {
                initNotificationUI();
            });
            
            // Suggest smart goal
            suggestSmartGoal();
            
            // Generate smart game suggestion
            setTimeout(generateSmartSuggestion, 1000);
            
            // Update home dashboard if in PWA mode
            if (isPWAMode) {
                setTimeout(updateHomeDashboard, 500);
            }
        }

        // ============ CLIPBOARD MONITORING ============
        // Note: lastClipboardText defined in PWA section above
        let clipboardCheckInterval = null;
        
        function startClipboardMonitoring() {
            // Check clipboard and return-from-game when tab is focused
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    checkClipboard();
                    checkReturnFromGame();
                    // Also run PWA clipboard detection
                    if (isPWAMode) {
                        checkClipboardForGameResult();
                    }
                }
            });
            
            // Also check on window focus
            window.addEventListener('focus', () => {
                checkClipboard();
                checkReturnFromGame();
            });
            
            // Check periodically (less frequently to save resources)
            clipboardCheckInterval = setInterval(() => {
                if (document.hasFocus()) {
                    checkClipboard();
                }
            }, 3000);
            
            // Check streak risks on load
            setTimeout(checkStreakRisks, 2000);
        }
        
        // ============ RETURN FROM GAME DETECTION ============
        function checkReturnFromGame() {
            // Only show if returned within 30 minutes of clicking a game
            if (!lastPlayedGame || !lastPlayedTime) return;
            
            const timeSinceClick = Date.now() - lastPlayedTime;
            const thirtyMinutes = 30 * 60 * 1000;
            
            if (timeSinceClick > thirtyMinutes) {
                lastPlayedGame = null;
                return;
            }
            
            // Don't show if already showing a prompt
            if (document.getElementById('return-prompt') || document.getElementById('clipboard-prompt')) {
                return;
            }
            
            showReturnPrompt(lastPlayedGame);
        }
        
        function showReturnPrompt(game) {
            // Check if tracking needs setup for this game
            const settings = DataService.getGameSettings(game.id);
            const needsTrackingSetup = !settings.trackingSource;
            
            // Detect platform for smart defaults
            const detection = typeof PlatformDetector !== 'undefined' ? PlatformDetector.detect() : null;
            const isIOS = detection?.isIOS || false;
            const isAndroid = detection?.isAndroid || false;
            const isDesktop = detection?.isDesktop || false;
            
            const prompt = document.createElement('div');
            prompt.id = 'return-prompt';
            prompt.innerHTML = `
                <style>
                    #return-prompt {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                        border: 2px solid var(--accent-purple);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                        z-index: 10000;
                        animation: slideUp 0.3s ease;
                        max-width: 90%;
                        width: 360px;
                    }
                    #return-prompt .prompt-header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 15px;
                    }
                    #return-prompt .prompt-icon { font-size: 2.5rem; }
                    #return-prompt .prompt-title { font-weight: 700; color: var(--accent-purple); font-size: 1.1rem; }
                    #return-prompt .prompt-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
                    
                    #return-prompt .tracking-setup {
                        background: var(--bg-secondary);
                        border-radius: 12px;
                        padding: 12px;
                        margin-bottom: 15px;
                    }
                    #return-prompt .tracking-label {
                        font-size: 0.8rem;
                        color: var(--text-muted);
                        margin-bottom: 8px;
                    }
                    #return-prompt .tracking-options {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                    }
                    #return-prompt .tracking-btn {
                        flex: 1;
                        min-width: 70px;
                        padding: 10px 8px;
                        background: var(--bg-card);
                        border: 2px solid transparent;
                        border-radius: 8px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                    }
                    #return-prompt .tracking-btn:hover {
                        border-color: var(--accent-gold);
                    }
                    #return-prompt .tracking-btn.selected {
                        border-color: var(--accent-gold);
                        background: var(--bg-hover);
                    }
                    #return-prompt .tracking-btn-icon { font-size: 1.3rem; display: block; }
                    #return-prompt .tracking-btn-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }
                    
                    #return-prompt .prompt-actions { 
                        display: flex; 
                        gap: 10px; 
                    }
                    #return-prompt button.btn-primary { 
                        flex: 1;
                        padding: 12px 16px; 
                        border-radius: 10px; 
                        border: none; 
                        cursor: pointer; 
                        font-weight: 700; 
                        font-size: 0.95rem;
                        background: var(--accent-purple); 
                        color: #fff; 
                    }
                    #return-prompt button.btn-secondary { 
                        padding: 12px 16px; 
                        border-radius: 10px; 
                        border: none; 
                        cursor: pointer; 
                        font-weight: 600;
                        background: var(--bg-hover); 
                        color: var(--text-secondary); 
                    }
                    #return-prompt .close-btn {
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: none;
                        border: none;
                        color: var(--text-muted);
                        cursor: pointer;
                        font-size: 1.2rem;
                        padding: 5px;
                    }
                </style>
                <button class="close-btn" onclick="dismissReturnPrompt()"></button>
                <div class="prompt-header">
                    <div class="prompt-icon">${game.icon}</div>
                    <div>
                        <div class="prompt-title">Back from ${game.name}?</div>
                        <div class="prompt-subtitle">Log your result to track your streak!</div>
                    </div>
                </div>
                
                ${needsTrackingSetup ? `
                <div class="tracking-setup">
                    <div class="tracking-label">Where did you play? (helps with future launches)</div>
                    <div class="tracking-options">
                        ${isDesktop ? `
                        <button class="tracking-btn" data-source="browser-extension" onclick="selectTrackingSource(this, '${game.id}')">
                            <span class="tracking-btn-icon"></span>
                            <span class="tracking-btn-label">Browser</span>
                        </button>
                        ` : ''}
                        ${isIOS || (!isDesktop && !isAndroid) ? `
                        <button class="tracking-btn ${isIOS ? 'selected' : ''}" data-source="nyt-ios" onclick="selectTrackingSource(this, '${game.id}')">
                            <span class="tracking-btn-icon"></span>
                            <span class="tracking-btn-label">iOS App</span>
                        </button>
                        ` : ''}
                        ${isAndroid || (!isDesktop && !isIOS) ? `
                        <button class="tracking-btn ${isAndroid ? 'selected' : ''}" data-source="nyt-android" onclick="selectTrackingSource(this, '${game.id}')">
                            <span class="tracking-btn-icon"></span>
                            <span class="tracking-btn-label">Android</span>
                        </button>
                        ` : ''}
                        <button class="tracking-btn" data-source="multiple" onclick="selectTrackingSource(this, '${game.id}')">
                            <span class="tracking-btn-icon"></span>
                            <span class="tracking-btn-label">Both</span>
                        </button>
                    </div>
                </div>
                ` : ''}
                
                <div class="prompt-actions">
                    <button class="btn-primary" onclick="openQuickLogFromReturn()"> Log Result</button>
                    <button class="btn-secondary" onclick="markPlayedAndDismiss('${game.id}')"> Just Mark Played</button>
                </div>
            `;
            
            document.body.appendChild(prompt);
            
            // Clear the tracked game
            lastPlayedGame = null;
            
            // Auto-dismiss after 30 seconds (longer since there are options now)
            setTimeout(() => {
                dismissReturnPrompt();
            }, 30000);
        }
        
        function selectTrackingSource(btn, gameId) {
            // Remove selected from siblings
            btn.parentElement.querySelectorAll('.tracking-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Save the selection
            const source = btn.dataset.source;
            quickSetTrackingSource(gameId, source);
        }
        
        function markPlayedAndDismiss(gameId) {
            // Just mark as played without logging detailed result
            const today = getTodayString();
            
            if (!userData.stats[gameId]) {
                userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
            }
            
            const stats = userData.stats[gameId];
            const yesterday = getYesterdayString();
            
            if (stats.lastPlayed !== today) {
                if (stats.lastPlayed === yesterday) {
                    stats.streak++;
                } else {
                    stats.streak = 1;
                }
                stats.lastPlayed = today;
                stats.totalPlays = (stats.totalPlays || 0) + 1;
                
                if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                userData.stats.totalCompleted++;
            }
            
            saveData();
            renderFeaturedGames();
            renderMyGames();
            updateStats();
            updateDailyGoal();
            
            dismissReturnPrompt();
            showToast(' Marked as played!');
        }
        
        function openQuickLogFromReturn() {
            dismissReturnPrompt();
            toggleQuickLog();
        }
        
        function dismissReturnPrompt() {
            const prompt = document.getElementById('return-prompt');
            if (prompt) {
                prompt.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => prompt.remove(), 300);
            }
        }
        
        // ============ STREAK RISK ALERTS ============
        function checkStreakRisks() {
            const today = getTodayString();
            const yesterday = getYesterdayString();
            const atRiskGames = [];
            
            // Check featured games
            FEATURED_GAMES.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    atRiskGames.push({ ...game, streak: stats.streak });
                }
            });
            
            // Check user's games
            userData.games.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    atRiskGames.push({ ...game, streak: stats.streak });
                }
            });
            
            if (atRiskGames.length > 0) {
                showStreakRiskBanner(atRiskGames);
            }
        }
        
        function showStreakRiskBanner(games) {
            // Don't show if already shown today
            const shownToday = sessionStorage.getItem('streakBannerShown') === getTodayString();
            if (shownToday) return;
            
            const banner = document.createElement('div');
            banner.id = 'streak-risk-banner';
            banner.innerHTML = `
                <style>
                    #streak-risk-banner {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                        color: white;
                        padding: 12px 20px;
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 15px;
                        animation: slideDown 0.3s ease;
                        flex-wrap: wrap;
                    }
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                    #streak-risk-banner .banner-text { font-weight: 600; }
                    #streak-risk-banner .banner-games { display: flex; gap: 8px; }
                    #streak-risk-banner .banner-game {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 0.85rem;
                        cursor: pointer;
                    }
                    #streak-risk-banner .banner-game:hover {
                        background: rgba(255,255,255,0.3);
                    }
                    #streak-risk-banner .banner-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 1.2rem;
                        cursor: pointer;
                        opacity: 0.7;
                        padding: 5px;
                    }
                    #streak-risk-banner .banner-close:hover { opacity: 1; }
                </style>
                <span class="banner-text"> Streak${games.length > 1 ? 's' : ''} at risk!</span>
                <div class="banner-games">
                    ${games.slice(0, 3).map(g => `
                        <span class="banner-game" onclick="playGame('${g.id}', '${g.url}', false, '${g.name}')">
                            ${g.icon} ${g.name} (${g.streak} days)
                        </span>
                    `).join('')}
                    ${games.length > 3 ? `<span class="banner-game">+${games.length - 3} more</span>` : ''}
                </div>
                <button class="banner-close" onclick="dismissStreakBanner()"></button>
            `;
            
            document.body.appendChild(banner);
            
            // Shift content down
            document.querySelector('.container').style.marginTop = '60px';
            
            sessionStorage.setItem('streakBannerShown', getTodayString());
        }
        
        function dismissStreakBanner() {
            const banner = document.getElementById('streak-risk-banner');
            if (banner) {
                banner.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => {
                    banner.remove();
                    document.querySelector('.container').style.marginTop = '0';
                }, 300);
            }
        }
        
        async function checkClipboard() {
            try {
                // Need permission - this will prompt user first time
                const text = await navigator.clipboard.readText();
                
                if (text && text !== lastClipboardText) {
                    lastClipboardText = text;
                    
                    // Check if it matches a game pattern
                    for (const game of GAME_PATTERNS) {
                        if (game.pattern.test(text)) {
                            showClipboardPrompt(text, game);
                            break;
                        }
                    }
                }
            } catch (e) {
                // Permission denied or not supported - that's okay
            }
        }
        
        function showClipboardPrompt(text, game) {
            // Don't show if already logged today for this game
            const today = getTodayString();
            if (userData.stats[game.id]?.lastPlayed === today) {
                return;
            }
            
            // Don't show if prompt already visible
            if (document.getElementById('clipboard-prompt')) {
                return;
            }
            
            const extracted = game.extract(text.match(game.pattern), text);
            
            const prompt = document.createElement('div');
            prompt.id = 'clipboard-prompt';
            prompt.innerHTML = `
                <style>
                    #clipboard-prompt {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                        border: 2px solid var(--accent-gold);
                        border-radius: 16px;
                        padding: 15px 20px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        animation: slideUp 0.3s ease;
                        max-width: 90%;
                    }
                    @keyframes slideUp {
                        from { transform: translateX(-50%) translateY(100%); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                    #clipboard-prompt .prompt-icon { font-size: 2rem; }
                    #clipboard-prompt .prompt-content { flex: 1; }
                    #clipboard-prompt .prompt-title { font-weight: 700; color: var(--accent-gold); }
                    #clipboard-prompt .prompt-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
                    #clipboard-prompt .prompt-actions { display: flex; gap: 8px; }
                    #clipboard-prompt button { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
                    #clipboard-prompt .btn-log { background: var(--accent-gold); color: #000; }
                    #clipboard-prompt .btn-dismiss { background: var(--bg-hover); color: var(--text-secondary); }
                </style>
                <div class="prompt-icon">${game.icon}</div>
                <div class="prompt-content">
                    <div class="prompt-title">${game.name} detected!</div>
                    <div class="prompt-subtitle">${extracted.score}</div>
                </div>
                <div class="prompt-actions">
                    <button class="btn-log" onclick="logFromClipboard()"> Log</button>
                    <button class="btn-dismiss" onclick="dismissClipboardPrompt()"></button>
                </div>
            `;
            
            document.body.appendChild(prompt);
            
            // Store text for logging
            prompt.dataset.text = text;
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                dismissClipboardPrompt();
            }, 10000);
        }
        
        function logFromClipboard() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt && prompt.dataset.text) {
                const input = document.getElementById('parse-input');
                if (input) input.value = prompt.dataset.text;
                parseShareText();
            }
            dismissClipboardPrompt();
        }
        
        function dismissClipboardPrompt() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt) {
                prompt.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => prompt.remove(), 300);
            }
        }

        // ============ SMART SUGGESTIONS ============
        function checkPendingFriend() {
            const pendingFriend = sessionStorage.getItem('pendingFriend');
            if (pendingFriend && currentUser) {
                sessionStorage.removeItem('pendingFriend');
                handleFriendLink(pendingFriend);
            }
        }
        
        function suggestSmartGoal() {
            // Only suggest if user hasn't set a custom goal
            if (userData.dailyGoal && userData.dailyGoal !== 5) return;
            
            // Calculate average games per day from history
            const history = userData.history || {};
            const historyDays = Object.keys(history);
            if (historyDays.length < 7) return; // Need at least a week of data
            
            const dayCounts = {};
            historyDays.forEach(day => {
                const games = history[day] || [];
                dayCounts[day] = games.length;
            });
            
            const counts = Object.values(dayCounts);
            const avg = counts.reduce((a, b) => a + b, 0) / counts.length;
            
            // Suggest a goal slightly above average
            const suggestedGoal = Math.ceil(avg) + 1;
            
            if (suggestedGoal !== userData.dailyGoal && suggestedGoal >= 3 && suggestedGoal <= 10) {
                // Store suggestion for goal modal
                userData.suggestedGoal = suggestedGoal;
            }
        }

        // ============ SMART GAME SUGGESTIONS ============
        let currentSuggestion = null;
        
        function generateSmartSuggestion() {
            const today = getTodayString();
            const yesterday = getYesterdayString();
            const hour = new Date().getHours();
            const suggestions = [];
            
            // 1. Streak at risk suggestions (highest priority)
            const allGames = [...FEATURED_GAMES, ...userData.games];
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    suggestions.push({
                        priority: 10,
                        icon: '',
                        text: `Don't lose your ${stats.streak}-day ${game.name} streak!`,
                        action: 'Play Now',
                        game: game
                    });
                }
            });
            
            // 2. Time-based suggestions
            if (hour >= 6 && hour < 10) {
                // Morning - suggest quick games
                const mini = POPULAR_GAMES.find(g => g.id === 'mini');
                if (mini && userData.stats['mini']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: '',
                        text: 'Good morning! The Mini is perfect for a quick start.',
                        action: 'Play Mini',
                        game: mini
                    });
                }
            } else if (hour >= 10 && hour < 14) {
                // Late morning/lunch - suggest Wordle
                const wordle = POPULAR_GAMES.find(g => g.id === 'wordle');
                if (wordle && userData.stats['wordle']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: '',
                        text: "Have you done today's Wordle yet?",
                        action: 'Play Wordle',
                        game: wordle
                    });
                }
            } else if (hour >= 17 && hour < 21) {
                // Evening - suggest longer games
                const connections = POPULAR_GAMES.find(g => g.id === 'connections');
                if (connections && userData.stats['connections']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: '',
                        text: 'Evening puzzle time! Try Connections.',
                        action: 'Play',
                        game: connections
                    });
                }
            }
            
            // 3. Goal progress suggestion
            const goalCount = getCurrentGoalCount();
            const goal = userData.dailyGoal || 5;
            if (goalCount < goal) {
                const remaining = goal - goalCount;
                const unplayedGame = allGames.find(g => userData.stats[g.id]?.lastPlayed !== today);
                if (unplayedGame && remaining <= 2) {
                    suggestions.push({
                        priority: 4,
                        icon: '',
                        text: `Just ${remaining} more game${remaining > 1 ? 's' : ''} to hit your daily goal!`,
                        action: 'Play',
                        game: unplayedGame
                    });
                }
            }
            
            // 4. Encourage trying new games
            if (suggestions.length === 0 && userData.games.length < 3) {
                suggestions.push({
                    priority: 1,
                    icon: '',
                    text: 'Discover new puzzles in the Discover tab!',
                    action: 'Explore',
                    game: null,
                    customAction: () => switchTab('discover')
                });
            }
            
            // Sort by priority and pick the best one
            suggestions.sort((a, b) => b.priority - a.priority);
            
            if (suggestions.length > 0) {
                currentSuggestion = suggestions[0];
                showSmartSuggestion(currentSuggestion);
            }
        }
        
        function getCurrentGoalCount() {
            const today = getTodayString();
            let count = 0;
            Object.values(userData.stats).forEach(stat => {
                if (stat && stat.lastPlayed === today) count++;
            });
            return count;
        }
        
        function showSmartSuggestion(suggestion) {
            const container = document.getElementById('smart-suggestion');
            if (!container) return;
            
            // Don't show if dismissed today
            const dismissedToday = sessionStorage.getItem('suggestionDismissed') === getTodayString();
            if (dismissedToday) return;
            
            document.getElementById('suggestion-icon').textContent = suggestion.icon;
            document.getElementById('suggestion-text').textContent = suggestion.text;
            document.getElementById('suggestion-action').textContent = suggestion.action;
            
            container.style.display = 'flex';
        }
        
        function actOnSuggestion() {
            if (!currentSuggestion) return;
            
            if (currentSuggestion.customAction) {
                currentSuggestion.customAction();
            } else if (currentSuggestion.game) {
                playGame(
                    currentSuggestion.game.id, 
                    currentSuggestion.game.url, 
                    currentSuggestion.game.featured || false,
                    currentSuggestion.game.name
                );
            }
            
            dismissSuggestion();
        }
        
        function dismissSuggestion() {
            const container = document.getElementById('smart-suggestion');
            if (container) {
                container.style.display = 'none';
            }
            sessionStorage.setItem('suggestionDismissed', getTodayString());
        }

        // ============ SHARE TARGET HANDLER ============
        function handleIncomingShare() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedText = urlParams.get('text');
            const sharedTitle = urlParams.get('title');
            const sharedUrl = urlParams.get('url');
            const syncData = urlParams.get('sync');
            const addFriendId = urlParams.get('addFriend');
            const joinBattleCode = urlParams.get('joinBattle');
            
            // Handle friend link
            if (addFriendId) {
                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => {
                    handleFriendLink(addFriendId);
                }, 1000); // Wait for auth
                return;
            }
            
            // Handle battle join link
            if (joinBattleCode) {
                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => {
                    handleBattleJoinLink(joinBattleCode);
                }, 1000); // Wait for auth
                return;
            }
            
            // Handle extension sync data
            if (syncData) {
                try {
                    const games = JSON.parse(decodeURIComponent(syncData));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    setTimeout(() => {
                        processExtensionSync(games);
                    }, 500);
                    return;
                } catch (e) {
                    console.error('Failed to parse sync data:', e);
                }
            }
            
            // Combine all shared data
            let fullText = '';
            if (sharedTitle) fullText += sharedTitle + '\n';
            if (sharedText) fullText += sharedText + '\n';
            if (sharedUrl) fullText += sharedUrl;
            
            if (fullText.trim()) {
                // Clean URL (remove params)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Auto-process the shared text
                setTimeout(() => {
                    processSharedText(fullText.trim());
                }, 500);
            }
        }

        async function handleFriendLink(friendUid) {
            if (!currentUser) {
                showToast('Sign in to add friends!');
                // Store for after sign in
                sessionStorage.setItem('pendingFriend', friendUid);
                return;
            }
            
            if (friendUid === currentUser.uid) {
                showToast("That's your own link!");
                return;
            }
            
            // Fetch friend's public data
            try {
                const snapshot = await db.ref('gameshelf-public/' + friendUid).once('value');
                const friendData = snapshot.val();
                
                if (!friendData) {
                    showToast('Friend not found');
                    return;
                }
                
                // Show confirmation modal
                showFriendConfirmModal(friendUid, friendData);
            } catch (e) {
                console.error('Failed to fetch friend:', e);
                showToast('Could not find friend');
            }
        }

        // ============ BATTLE JOIN LINK HANDLING ============
        
        async function handleBattleJoinLink(joinCode) {
            if (!currentUser) {
                showToast('Sign in to join battles!');
                // Store for after sign in
                sessionStorage.setItem('pendingBattleJoin', joinCode);
                return;
            }
            
            // Find battle by join code
            try {
                const snapshot = await db.ref('battles')
                    .orderByChild('joinCode')
                    .equalTo(joinCode.toUpperCase())
                    .limitToFirst(1)
                    .once('value');
                
                if (!snapshot.exists()) {
                    showToast('Battle not found. Code may have expired.');
                    return;
                }
                
                let battle = null;
                let battleId = null;
                snapshot.forEach(child => {
                    battleId = child.key;
                    battle = child.val();
                });
                
                if (!battle) {
                    showToast('Battle not found');
                    return;
                }
                
                // Show join confirmation modal
                showBattleJoinModal(battleId, battle);
                
            } catch (e) {
                console.error('Failed to find battle:', e);
                showToast('Could not find battle');
            }
        }

        function showBattleJoinModal(battleId, battle) {
            // Check if already joined
            if (battle.participants && battle.participants[currentUser.uid]) {
                showToast('You already joined this battle!');
                switchTab('social');
                return;
            }
            
            // Check if battle is joinable
            if (battle.status !== 'pending' && battle.status !== 'active') {
                showToast('This battle is no longer accepting players');
                return;
            }
            
            const gameNames = battle.games.slice(0, 3).map(g => {
                const found = FEATURED_GAMES.find(fg => fg.id === g);
                return found ? found.name : g;
            }).join(', ');
            
            const daysLeft = Math.ceil((battle.endDate - Date.now()) / (24 * 60 * 60 * 1000));
            const participantCount = Object.keys(battle.participants || {}).length;
            const creatorName = battle.participants?.[battle.createdBy]?.displayName || 'Someone';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'battle-join-modal';
            modal.innerHTML = `
                <div class="modal share-success-modal">
                    <div class="share-celebration"></div>
                    <h2>Battle Invitation!</h2>
                    
                    <div class="battle-share-card">
                        <div class="battle-share-title">${escapeHtml(battle.name)}</div>
                        <div style="margin: 15px 0; font-size: 0.9rem;">
                            <div> ${gameNames}</div>
                            <div> ${daysLeft} days left</div>
                            <div> ${participantCount} player${participantCount !== 1 ? 's' : ''} joined</div>
                            ${battle.entryFee > 0 ? `<div style="margin-top: 8px;"> ${battle.entryFee} coin wager</div>` : ''}
                        </div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">
                            Created by ${escapeHtml(creatorName)}
                        </div>
                    </div>
                    
                    ${battle.entryFee > 0 ? `
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                            Your balance: ${userData.wallet.coins} coins
                            ${userData.wallet.coins < battle.entryFee ? '<br><span style="color: var(--accent-red);"> Insufficient coins</span>' : ''}
                        </p>
                    ` : ''}
                    
                    <div class="share-buttons">
                        <button class="share-btn share-btn-primary" onclick="confirmJoinBattle('${battleId}')" 
                                ${battle.entryFee > 0 && userData.wallet.coins < battle.entryFee ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
                             Join Battle${battle.entryFee > 0 ? ` (${battle.entryFee} coins)` : ''}
                        </button>
                        <button class="share-btn share-btn-skip" onclick="closeBattleJoinModal()">
                            Maybe Later
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeBattleJoinModal() {
            const modal = document.getElementById('battle-join-modal');
            if (modal) modal.remove();
        }

        async function confirmJoinBattle(battleId) {
            if (!currentUser) {
                showToast('Please sign in first');
                return;
            }
            
            try {
                // Get fresh battle data
                const snapshot = await db.ref(`battles/${battleId}`).once('value');
                const battle = snapshot.val();
                
                if (!battle) {
                    showToast('Battle not found');
                    closeBattleJoinModal();
                    return;
                }
                
                // Double check not already joined
                if (battle.participants && battle.participants[currentUser.uid]) {
                    showToast('Already joined!');
                    closeBattleJoinModal();
                    switchTab('social');
                    return;
                }
                
                // Check wager
                if (battle.entryFee > 0) {
                    if (userData.wallet.coins < battle.entryFee) {
                        showToast('Not enough coins');
                        return;
                    }
                    // Deduct coins
                    spendCoins(battle.entryFee, ` Joined: ${battle.name}`);
                }
                
                // Add as participant
                const now = Date.now();
                await db.ref(`battles/${battleId}/participants/${currentUser.uid}`).set({
                    odataId: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    score: 0,
                    joined: true,
                    joinedAt: now,
                    dailyScores: {}
                });
                
                // Update invite status if exists
                if (battle.invites && battle.invites[currentUser.uid]) {
                    await db.ref(`battles/${battleId}/invites/${currentUser.uid}`).update({
                        status: 'accepted',
                        respondedAt: now
                    });
                }
                
                // Check if battle should start (2+ participants)
                const participantCount = Object.keys(battle.participants || {}).length + 1;
                if (battle.status === 'pending' && participantCount >= 2) {
                    await db.ref(`battles/${battleId}`).update({
                        status: 'active',
                        startedAt: now
                    });
                }
                
                closeBattleJoinModal();
                showToast(' You joined the battle!');
                playSound('achievement');
                
                // Switch to social tab to see the battle
                switchTab('social');
                
                // Reload battles
                loadUserBattles();
                
            } catch (e) {
                console.error('Failed to join battle:', e);
                showToast('Failed to join battle');
            }
        }

        // Check for pending actions after sign-in
        function checkPendingActions() {
            const pendingFriend = sessionStorage.getItem('pendingFriend');
            if (pendingFriend) {
                sessionStorage.removeItem('pendingFriend');
                setTimeout(() => handleFriendLink(pendingFriend), 500);
            }
            
            const pendingBattle = sessionStorage.getItem('pendingBattleJoin');
            if (pendingBattle) {
                sessionStorage.removeItem('pendingBattleJoin');
                setTimeout(() => handleBattleJoinLink(pendingBattle), 500);
            }
        }

        function showFriendConfirmModal(friendUid, friendData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'friend-confirm-modal';
            modal.innerHTML = `
                <div class="modal" style="text-align: center;">
                    <h2> Add Friend?</h2>
                    <div style="margin: 20px 0;">
                        <img src="${friendData.photoURL || generateAvatarUrl(friendData.displayName)}" 
                             style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">
                            ${friendData.displayName}
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">
                            ${friendData.todayCount || 0} games played today
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="confirmAddFriend('${friendUid}', '${friendData.displayName}')" style="flex:1">
                             Add Friend
                        </button>
                        <button class="btn btn-secondary" onclick="closeFriendConfirmModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeFriendConfirmModal() {
            const modal = document.getElementById('friend-confirm-modal');
            if (modal) modal.remove();
        }

        async function confirmAddFriend(friendUid, displayName) {
            if (!currentUser || !isFirebaseReady) {
                showToast('Please sign in first');
                return;
            }
            
            try {
                // Add to friends list
                await db.ref('friends/' + currentUser.uid + '/' + friendUid).set({
                    odid: friendUid,
                    displayName: displayName,
                    addedAt: Date.now()
                });
                
                closeFriendConfirmModal();
                showToast(' Friend added!');
                
                // Reload friends
                loadFriendsData(currentUser.uid);
                
            } catch (e) {
                console.error('Failed to add friend:', e);
                showToast('Could not add friend');
            }
        }

        function processExtensionSync(games) {
            if (!Array.isArray(games) || games.length === 0) return;
            
            let syncedCount = 0;
            
            games.forEach(game => {
                const gameId = game.id;
                const gameDate = game.date || getTodayString();
                
                if (!userData.stats[gameId]) {
                    userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
                
                // Only update if not already logged for this date
                if (userData.stats[gameId].lastPlayed !== gameDate) {
                    const prevDate = userData.stats[gameId].lastPlayed;
                    
                    // Calculate if this continues a streak
                    const gameDay = new Date(gameDate);
                    const prevDay = prevDate ? new Date(prevDate) : null;
                    const dayDiff = prevDay ? Math.floor((gameDay - prevDay) / 86400000) : 999;
                    
                    if (dayDiff === 1) {
                        userData.stats[gameId].streak++;
                    } else {
                        userData.stats[gameId].streak = 1;
                    }
                    
                    userData.stats[gameId].lastPlayed = gameDate;
                    userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                    
                    if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                    userData.stats.totalCompleted++;
                    
                    // Publish activity
                    publishActivity(gameId, game.name || gameId);
                    
                    syncedCount++;
                }
            });
            
            if (syncedCount > 0) {
                saveData();
                recordHistory();
                
                // Update UI
                renderFeaturedGames();
                renderMyGames();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                renderLeaderboard();
                checkAndUnlockAchievements();
                
                showToast(` Synced ${syncedCount} game${syncedCount > 1 ? 's' : ''} from extension!`);
            } else {
                showToast('All games already logged!');
            }
        }

        function processSharedText(text) {
            // Put the text in the parse input
            const input = document.getElementById('parse-input');
            if (input) {
                input.value = text;
            }
            
            // Try to parse it with ShareParser first
            let matched = false;
            let gameId, gameName, gameIcon, displayScore, success, contestPoints, rawData;
            
            if (shareParser) {
                const parsed = shareParser.parse(text);
                if (parsed) {
                    gameId = parsed.gameId;
                    gameName = parsed.gameName;
                    gameIcon = parsed.icon;
                    displayScore = parsed.displayScore;
                    success = parsed.success;
                    contestPoints = parsed.contestPoints;
                    rawData = parsed.raw;
                    matched = true;
                }
            }
            
            // Fallback to GAME_PATTERNS
            if (!matched) {
                for (const game of GAME_PATTERNS) {
                    const match = text.match(game.pattern);
                    if (match) {
                        const extracted = game.extract(match, text);
                        gameId = game.id;
                        gameName = game.name;
                        gameIcon = game.icon;
                        displayScore = extracted.score;
                        success = extracted.success;
                        contestPoints = extractNumericScore(gameId, extracted);
                        rawData = extracted;
                        matched = true;
                        break;
                    }
                }
            }
            
            if (matched) {
                // Mark the game as played
                const today = getTodayString();
                
                if (!userData.stats[gameId]) {
                    userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
                
                // Store contest scores
                if (!userData.stats[gameId].contestScores) {
                    userData.stats[gameId].contestScores = {};
                }
                userData.stats[gameId].contestScores[today] = contestPoints;
                
                if (userData.stats[gameId].lastPlayed !== today) {
                    const yesterday = getYesterdayString();
                    if (userData.stats[gameId].lastPlayed === yesterday) {
                        userData.stats[gameId].streak++;
                    } else {
                        userData.stats[gameId].streak = 1;
                    }
                    userData.stats[gameId].lastPlayed = today;
                    userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                    
                    if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                    userData.stats.totalCompleted++;
                    
                    // Award tokens
                    earnTokens(TOKEN_REWARDS.gameComplete, ` Completed ${gameName}`);
                    checkStreakBonus(gameId);
                }
                
                saveData();
                recordHistory();
                publishActivity(gameId, gameName);
                
                // Record anonymous global stat for percentile
                recordGlobalStat(gameId, displayScore, success);
                
                // Check if this responds to a nudge
                checkNudgeResponse(gameId);
                
                // Maybe show push notification opt-in (after valuable moment)
                const streak = userData.stats[gameId]?.streak || 0;
                if (streak >= 3 && !pushSubscription && Notification.permission === 'default') {
                    setTimeout(() => showPushOptIn('streak'), 2000);
                }
                
                // Update battle scores
                try {
                    updateBattleScores(gameId, contestPoints);
                } catch (e) {
                    console.log('Battle score update skipped:', e);
                }
                
                // Update UI
                renderFeaturedGames();
                renderMyGames();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                checkAndUnlockAchievements();
                unlockTimeAchievement();
                
                // Show ENHANCED share screen (the sharing hub experience)
                showEnhancedShareScreen(gameId, gameName, gameIcon, displayScore, contestPoints, success, text);
                
                matched = true;
            }
            
            if (!matched) {
                showToast('Could not detect game. Try pasting manually.');
                // Switch to games tab and scroll to parser
                switchTab('games');
            }
        }

        function showShareSuccessModal(game, result) {
            // Create a quick success overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.id = 'share-success-modal';
            overlay.innerHTML = `
                <div class="modal" style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">${game.icon}</div>
                    <h2 style="color: var(--accent-green);"> Logged!</h2>
                    <p style="font-size: 1.3rem; margin: 15px 0; color: var(--text-primary);">${game.name}</p>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${result.score}</p>
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: center; gap: 30px;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent-gold);">${userData.stats[game.id]?.streak || 1}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">STREAK</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent-gold);">${userData.stats[game.id]?.totalPlays || 1}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">TOTAL</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('share-success-modal').remove()" style="width: 100%;">Done</button>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                const modal = document.getElementById('share-success-modal');
                if (modal) modal.remove();
            }, 5000);
        }

        function loadData() {
            const saved = localStorage.getItem('gameShelfData');
            if (saved) {
                userData = JSON.parse(saved);
                // Migrate old data
                if (!userData.reviews) userData.reviews = {};
                if (!userData.chatMessages) userData.chatMessages = [];
                if (!userData.history) userData.history = {};
                if (!userData.achievements) userData.achievements = {};
                if (!userData.dailyGoal) userData.dailyGoal = 5;
                if (!userData.wallet) {
                    userData.wallet = {
                        balance: 0,
                        transactions: [],
                        lastDailyBonus: null,
                        streakBonuses: {}
                    };
                }
            }
        }

        let cloudSyncTimeout = null;
        
        function saveData() {
            localStorage.setItem('gameShelfData', JSON.stringify(userData));
            
            // Debounced cloud sync (wait 2 seconds after last change)
            if (currentUser && isFirebaseReady) {
                clearTimeout(cloudSyncTimeout);
                cloudSyncTimeout = setTimeout(() => {
                    saveToCloud();
                }, 2000);
            }
        }

        // ============ SETTINGS MENU ============
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-light').classList.add('active');
                document.getElementById('theme-dark').classList.remove('active');
            } else {
                document.body.classList.remove('light-mode');
                document.getElementById('theme-dark').classList.add('active');
                document.getElementById('theme-light').classList.remove('active');
            }
            localStorage.setItem('gameShelfTheme', theme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('gameShelfTheme') || 'dark';
            setTheme(savedTheme);
        }

        function showAbout() {
            toggleSettingsMenu();
            document.getElementById('about-modal').classList.add('active');
        }

        function closeAboutModal() {
            document.getElementById('about-modal').classList.remove('active');
        }

        // ============ PITCH PAGE ============
        function showPitchPage() {
            document.getElementById('pitch-modal').classList.add('active');
        }

        function closePitchModal() {
            document.getElementById('pitch-modal').classList.remove('active');
        }

        function copyShareUrl(page) {
            const baseUrl = window.location.origin + window.location.pathname;
            let url = baseUrl;
            
            if (page === 'pitch') {
                url = baseUrl + '?pitch';
            } else if (page === 'demo') {
                url = baseUrl + '?demo';
            } else if (page === 'tour') {
                url = baseUrl + '?tour';
            } else if (page === 'market') {
                url = baseUrl + '?market';
            } else if (page === 'data') {
                url = baseUrl + '?data';
            } else if (page === 'pyramid') {
                url = baseUrl + '?pyramid';
            }
            
            navigator.clipboard.writeText(url).then(() => {
                showToast(' Link copied!');
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this link:', url);
            });
        }

        // ============ MARKET PAGE ============
        function showMarketPage() {
            document.getElementById('market-modal').classList.add('active');
        }

        function closeMarketModal() {
            document.getElementById('market-modal').classList.remove('active');
        }

        // ============ DATA STRATEGY PAGE ============
        function showDataStrategyPage() {
            document.getElementById('data-modal').classList.add('active');
        }

        function closeDataModal() {
            document.getElementById('data-modal').classList.remove('active');
        }

        // ============ VALUE PYRAMID PAGE ============
        function showPyramidPage() {
            document.getElementById('pyramid-modal').classList.add('active');
        }

        function closePyramidModal() {
            document.getElementById('pyramid-modal').classList.remove('active');
        }

        // ============ SHARE HUB ============
        let shareHistory = [];

        function showShareHub() {
            // Populate today's results
            populateShareHubResults();
            
            // Set default message
            applyShareTemplate();
            
            // Update date
            const today = new Date();
            document.getElementById('share-hub-date').textContent = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            // Load share history
            loadShareHistory();
            
            document.getElementById('share-hub-modal').classList.add('active');
        }

        function closeShareHub() {
            document.getElementById('share-hub-modal').classList.remove('active');
        }

        function populateShareHubResults() {
            const container = document.getElementById('share-hub-results');
            const today = getTodayString();
            const todayData = userData.history?.[today] || {};
            
            const results = [];
            
            // Check featured games
            FEATURED_GAMES.forEach(game => {
                if (todayData[game.id]?.completed) {
                    results.push({
                        name: game.name,
                        icon: game.icon,
                        score: todayData[game.id].score || ''
                    });
                }
            });
            
            // Check popular games
            POPULAR_GAMES.forEach(game => {
                if (todayData[game.id]?.completed) {
                    results.push({
                        name: game.name,
                        icon: game.icon,
                        score: todayData[game.id].score || ''
                    });
                }
            });
            
            // Check user's custom games
            (userData.games || []).forEach(game => {
                if (todayData[game.id]?.completed) {
                    results.push({
                        name: game.name,
                        icon: game.icon || '',
                        score: todayData[game.id].score || ''
                    });
                }
            });
            
            if (results.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted);">No games completed today yet</span>';
            } else {
                container.innerHTML = results.map(r => `
                    <span class="share-result-tag">${r.icon} ${r.name}: <span class="score">${r.score}</span></span>
                `).join('');
            }
        }

        function applyShareTemplate() {
            const template = document.getElementById('share-template-select').value;
            const today = getTodayString();
            const todayData = userData.history?.[today] || {};
            
            // Count games played today
            let gamesPlayed = 0;
            let gamesList = [];
            
            [...FEATURED_GAMES, ...POPULAR_GAMES, ...(userData.games || [])].forEach(game => {
                if (todayData[game.id]?.completed) {
                    gamesPlayed++;
                    gamesList.push(`${game.icon} ${todayData[game.id].score || ''}`);
                }
            });
            
            // Get streak info
            const streakInfo = Object.entries(userData.streaks || {})
                .filter(([_, s]) => s.current > 0)
                .sort((a, b) => b[1].current - a[1].current)
                .slice(0, 3);
            
            let message = '';
            
            switch(template) {
                case 'brag':
                    message = ` Crushed it today!\n\n${gamesList.join('\n')}\n\n${gamesPlayed} games completed. Who else is keeping up? `;
                    break;
                case 'humble':
                    message = `Just another day of puzzles \n\n${gamesList.join('\n')}\n\nSome wins, some struggles. That's the game!`;
                    break;
                case 'streak':
                    const streakText = streakInfo.map(([id, s]) => {
                        const game = [...FEATURED_GAMES, ...POPULAR_GAMES].find(g => g.id === id);
                        return `${game?.icon || ''} ${s.current} day streak`;
                    }).join('\n');
                    message = ` Streak check!\n\n${streakText || 'Building my streaks...'}\n\nKeeping the daily puzzle habit going strong!`;
                    break;
                case 'challenge':
                    message = ` Daily puzzle challenge!\n\n${gamesList.join('\n')}\n\nThink you can beat my scores? Let's see what you got!`;
                    break;
                case 'minimal':
                    message = gamesList.join(' | ');
                    break;
                default:
                    message = ` Daily Puzzles Complete!\n\n${gamesList.join('\n')}\n\n${gamesPlayed > 0 ? `${gamesPlayed} game${gamesPlayed > 1 ? 's' : ''} down for today!` : 'Time to play some puzzles!'}`;
            }
            
            document.getElementById('share-message').value = message;
        }

        function insertShareEmoji(emoji) {
            const textarea = document.getElementById('share-message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
        }

        function insertResultsToMessage() {
            const today = getTodayString();
            const todayData = userData.history?.[today] || {};
            
            let results = [];
            [...FEATURED_GAMES, ...POPULAR_GAMES, ...(userData.games || [])].forEach(game => {
                if (todayData[game.id]?.completed) {
                    results.push(`${game.icon} ${game.name}: ${todayData[game.id].score || ''}`);
                }
            });
            
            if (results.length > 0) {
                insertShareEmoji('\n' + results.join('\n') + '\n');
            } else {
                showToast('No games completed today yet');
            }
        }

        function getShareMessage() {
            let message = document.getElementById('share-message').value;
            
            if (document.getElementById('share-include-link').checked) {
                message += '\n\n Track your puzzles: ' + window.location.origin + window.location.pathname;
            }
            
            return message;
        }

        function shareToTwitter() {
            const message = getShareMessage();
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=420');
            recordShare('Twitter/X');
        }

        function shareToFacebook() {
            const message = getShareMessage();
            // Facebook doesn't allow pre-filled text, but we can share a link
            const url = `https://www.facebook.com/sharer/sharer.php?quote=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=420');
            recordShare('Facebook');
            showToast(' Tip: Paste your message after Facebook opens');
        }

        function shareToLinkedIn() {
            const message = getShareMessage();
            const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`;
            window.open(url, '_blank', 'width=550,height=420');
            copyShareMessage(true);
            recordShare('LinkedIn');
            showToast(' Message copied! Paste in LinkedIn');
        }

        function shareToThreads() {
            const message = getShareMessage();
            // Threads uses the Instagram share URL
            const url = `https://www.threads.net/intent/post?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=420');
            recordShare('Threads');
        }

        function shareToReddit() {
            const message = getShareMessage();
            const title = ' Daily Puzzle Results';
            const url = `https://www.reddit.com/submit?title=${encodeURIComponent(title)}&text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=600');
            recordShare('Reddit');
        }

        function shareToDiscord() {
            // Discord doesn't have a web share intent, so copy to clipboard
            copyShareMessage(true);
            showToast(' Copied! Paste in your Discord channel');
            recordShare('Discord');
        }

        function shareToBlueSky() {
            const message = getShareMessage();
            const url = `https://bsky.app/intent/compose?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=420');
            recordShare('BlueSky');
        }

        function shareToMastodon() {
            const message = getShareMessage();
            // Mastodon requires knowing the instance, so we use a share page
            const url = `https://mastodonshare.com/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank', 'width=550,height=500');
            recordShare('Mastodon');
        }

        function copyShareMessage(silent = false) {
            const message = getShareMessage();
            navigator.clipboard.writeText(message).then(() => {
                if (!silent) {
                    showToast(' Copied to clipboard!');
                    recordShare('Clipboard');
                }
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = message;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                if (!silent) {
                    showToast(' Copied to clipboard!');
                    recordShare('Clipboard');
                }
            });
        }

        function shareNative() {
            const message = getShareMessage();
            
            if (navigator.share) {
                navigator.share({
                    title: ' Daily Puzzle Results',
                    text: message,
                    url: window.location.href
                }).then(() => {
                    recordShare('Native Share');
                }).catch((err) => {
                    if (err.name !== 'AbortError') {
                        copyShareMessage();
                    }
                });
            } else {
                copyShareMessage();
            }
        }

        function recordShare(platform) {
            const record = {
                platform,
                timestamp: Date.now(),
                date: getTodayString()
            };
            
            shareHistory.unshift(record);
            shareHistory = shareHistory.slice(0, 10); // Keep last 10
            
            try {
                localStorage.setItem('gameshelf-share-history', JSON.stringify(shareHistory));
            } catch (e) {}
            
            loadShareHistory();
        }

        function loadShareHistory() {
            try {
                shareHistory = JSON.parse(localStorage.getItem('gameshelf-share-history') || '[]');
            } catch (e) {
                shareHistory = [];
            }
            
            const section = document.getElementById('share-history-section');
            const list = document.getElementById('share-history-list');
            
            if (shareHistory.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = shareHistory.slice(0, 5).map(s => {
                const time = formatTimeAgo(s.timestamp);
                return `<div style="padding: 4px 0; border-bottom: 1px solid var(--border-color);">
                    ${s.platform}  ${time}
                </div>`;
            }).join('');
        }

        // ============ DEMO MODE ============
        let isDemoMode = false;
        let originalData = null;
        let originalBattles = null;

        const DEMO_DATA = {
            friends: [
                { odataId: 'demo_sarah', odataUid: 'demo_sarah', displayName: 'Sarah M.', photoURL: null, currentStreak: 45, longestStreak: 67, gamesPlayed: 523 },
                { odataId: 'demo_mike', odataUid: 'demo_mike', displayName: 'Mike K.', photoURL: null, currentStreak: 23, longestStreak: 34, gamesPlayed: 287 },
                { odataId: 'demo_alex', odataUid: 'demo_alex', displayName: 'Alex T.', photoURL: null, currentStreak: 12, longestStreak: 89, gamesPlayed: 412 },
                { odataId: 'demo_jordan', odataUid: 'demo_jordan', displayName: 'Jordan P.', photoURL: null, currentStreak: 67, longestStreak: 67, gamesPlayed: 156 }
            ],
            activities: [
                { odataId: 'demo_sarah', displayName: 'Sarah M.', gameId: 'wordle', gameName: 'Wordle', score: '4/6', timestamp: Date.now() - 1800000 },
                { odataId: 'demo_mike', displayName: 'Mike K.', gameId: 'connections', gameName: 'Connections', score: '', timestamp: Date.now() - 3600000 },
                { odataId: 'demo_alex', displayName: 'Alex T.', gameId: 'mini', gameName: 'Mini Crossword', score: '0:42', timestamp: Date.now() - 7200000 },
                { odataId: 'demo_jordan', displayName: 'Jordan P.', gameId: 'queens', gameName: 'Queens', score: ' Solved', timestamp: Date.now() - 10800000 },
                { odataId: 'demo_sarah', displayName: 'Sarah M.', gameId: 'strands', gameName: 'Strands', score: ' No hints', timestamp: Date.now() - 14400000 },
                { odataId: 'demo_mike', displayName: 'Mike K.', gameId: 'spelling-bee', gameName: 'Spelling Bee', score: 'Genius', timestamp: Date.now() - 18000000 }
            ],
            battles: [
                {
                    id: 'demo_battle_1',
                    name: 'Weekly Word Warriors',
                    description: 'Best puzzler takes it all!',
                    type: 'group',
                    status: 'active',
                    createdBy: 'demo_sarah',
                    startDate: Date.now() - 86400000 * 3,
                    endDate: Date.now() + 86400000 * 4,
                    games: ['wordle', 'connections', 'mini'],
                    entryFee: 50,
                    participants: {
                        'demo_you': { odataId: 'demo_you', odataUid: 'demo_you', displayName: 'You', score: 156 },
                        'demo_sarah': { odataId: 'demo_sarah', odataUid: 'demo_sarah', displayName: 'Sarah M.', score: 178 },
                        'demo_mike': { odataId: 'demo_mike', odataUid: 'demo_mike', displayName: 'Mike K.', score: 134 },
                        'demo_alex': { odataId: 'demo_alex', odataUid: 'demo_alex', displayName: 'Alex T.', score: 112 }
                    }
                },
                {
                    id: 'demo_battle_2',
                    name: '1v1: The Rematch',
                    description: 'Settling the score!',
                    type: 'challenge',
                    status: 'active',
                    createdBy: 'demo_jordan',
                    startDate: Date.now() - 86400000,
                    endDate: Date.now() + 86400000 * 2,
                    games: ['wordle', 'strands'],
                    entryFee: 25,
                    participants: {
                        'demo_you': { odataId: 'demo_you', odataUid: 'demo_you', displayName: 'You', score: 45 },
                        'demo_jordan': { odataId: 'demo_jordan', odataUid: 'demo_jordan', displayName: 'Jordan P.', score: 42 }
                    }
                }
            ],
            tournaments: [
                {
                    id: 'demo_tournament_1',
                    name: 'January Showdown',
                    subtitle: 'Last Person Standing',
                    type: 'tournament',
                    status: 'active',
                    startDate: Date.now() - 86400000 * 5,
                    endDate: Date.now() + 86400000 * 9,
                    games: ['wordle'],
                    entryFee: 100,
                    participants: {
                        'demo_you': { odataId: 'demo_you', displayName: 'You', alive: true },
                        'demo_sarah': { odataId: 'demo_sarah', displayName: 'Sarah M.', alive: true },
                        'demo_mike': { odataId: 'demo_mike', displayName: 'Mike K.', alive: false },
                        'demo_alex': { odataId: 'demo_alex', displayName: 'Alex T.', alive: true },
                        'demo_jordan': { odataId: 'demo_jordan', displayName: 'Jordan P.', alive: true },
                        'demo_user5': { odataId: 'demo_user5', displayName: 'Chris R.', alive: false },
                        'demo_user6': { odataId: 'demo_user6', displayName: 'Dana L.', alive: true },
                        'demo_user7': { odataId: 'demo_user7', displayName: 'Pat Q.', alive: false }
                    }
                }
            ],
            yourStats: {
                currentStreak: 34,
                longestStreak: 52,
                totalGamesPlayed: 387,
                coins: 1250,
                achievements: ['early-bird', 'streak-7', 'streak-30', 'social-butterfly']
            },
            recentGames: [
                { gameId: 'wordle', date: getTodayString(), score: '3/6', details: { guesses: 3 } },
                { gameId: 'connections', date: getTodayString(), score: '', details: { mistakes: 0 } },
                { gameId: 'mini', date: getTodayString(), score: '1:23', details: { time: 83 } },
                { gameId: 'queens', date: getTodayString(), score: '', details: { solved: true } }
            ]
        };

        function toggleDemoMode(enabled) {
            isDemoMode = enabled;
            
            if (enabled) {
                // Save original data
                originalData = JSON.parse(localStorage.getItem('gameshelf-data') || '{}');
                originalBattles = [...userBattles];
                
                // Inject demo data
                loadDemoData();
                
                // Show demo mode banner
                showDemoModeBanner();
                
                showToast(' Demo Mode enabled');
            } else {
                // Restore original data
                if (originalData) {
                    localStorage.setItem('gameshelf-data', JSON.stringify(originalData));
                }
                if (originalBattles) {
                    userBattles = originalBattles;
                }
                
                // Clear demo friends
                if (typeof friendsData !== 'undefined') {
                    friendsData = friendsData.filter(f => !f.odataId?.startsWith('demo_'));
                }
                
                // Remove demo banner
                hideDemoModeBanner();
                
                // Refresh display
                loadData();
                render();
                renderBattles();
                
                showToast('Demo Mode disabled');
            }
        }

        function loadDemoData() {
            // Create demo user profile
            const demoProfile = {
                games: ['wordle', 'connections', 'mini', 'strands', 'queens', 'tango'],
                history: {},
                streaks: {},
                coins: DEMO_DATA.yourStats.coins,
                achievements: DEMO_DATA.yourStats.achievements
            };

            // Populate history with recent plays
            const today = getTodayString();
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                demoProfile.history[dateStr] = {
                    wordle: { completed: true, score: `${3 + Math.floor(Math.random() * 3)}/6`, guesses: 3 + Math.floor(Math.random() * 3) },
                    connections: { completed: true, score: '', mistakes: Math.floor(Math.random() * 2) },
                    mini: { completed: true, score: `${Math.floor(Math.random() * 2)}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`, time: 60 + Math.floor(Math.random() * 120) }
                };
            }

            // Set streaks
            demoProfile.streaks = {
                wordle: { current: 34, longest: 52 },
                connections: { current: 28, longest: 45 },
                mini: { current: 34, longest: 34 }
            };

            // Save demo data
            localStorage.setItem('gameshelf-data', JSON.stringify(demoProfile));
            
            // Add demo friends to friendsData
            if (typeof friendsData !== 'undefined') {
                friendsData = [...DEMO_DATA.friends];
            } else {
                window.friendsData = [...DEMO_DATA.friends];
            }
            
            // Add demo battles to userBattles
            userBattles = [...DEMO_DATA.battles, ...DEMO_DATA.tournaments];
            
            // Simulate a logged-in user for demo
            if (!currentUser) {
                window.currentUser = { uid: 'demo_you', displayName: 'Demo User' };
            }
            
            // Refresh the UI
            loadData();
            render();
            renderBattles();
            renderFriendsActivity();
        }

        function renderFriendsActivity() {
            // Render demo activity in the community tab
            const activityEl = document.getElementById('friends-activity');
            if (!activityEl || !isDemoMode) return;
            
            const activityHTML = DEMO_DATA.activities.map(a => {
                const timeAgo = formatTimeAgo(a.timestamp);
                const initial = (a.displayName || 'U')[0];
                return `
                    <div class="activity-item">
                        <div class="activity-avatar">${initial}</div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${a.displayName}</strong> completed <strong>${a.gameName}</strong>
                            </div>
                            <div class="activity-meta">${a.score}  ${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            activityEl.innerHTML = activityHTML || '<p style="color: var(--text-muted); text-align: center;">No recent activity</p>';
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        function showDemoModeBanner() {
            if (document.getElementById('demo-mode-banner')) return;
            
            const banner = document.createElement('div');
            banner.id = 'demo-mode-banner';
            banner.className = 'demo-mode-banner';
            banner.innerHTML = ' DEMO MODE - Sample data shown  <a href="#" onclick="toggleDemoMode(false); document.getElementById(\'demo-mode-toggle\').checked = false; return false;" style="color: white; text-decoration: underline;">Exit Demo</a>';
            document.body.appendChild(banner);
            
            // Add padding to bottom nav
            document.querySelector('.bottom-nav').style.paddingBottom = '40px';
        }

        function hideDemoModeBanner() {
            const banner = document.getElementById('demo-mode-banner');
            if (banner) banner.remove();
            
            // Remove padding from bottom nav
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) bottomNav.style.paddingBottom = '';
        }

        // ============ EXTENSION MODAL ============
        function showExtensionModal() {
            toggleSettingsMenu();
            document.getElementById('extension-modal').classList.add('active');
            showBrowserInstructions('chrome'); // Default to Chrome
        }

        function closeExtensionModal() {
            document.getElementById('extension-modal').classList.remove('active');
        }

        function showBrowserInstructions(browser) {
            // Update tabs
            document.querySelectorAll('.ext-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all instructions
            document.querySelectorAll('.ext-instructions').forEach(inst => inst.style.display = 'none');
            
            // Show selected browser instructions
            const instructions = document.getElementById('ext-' + browser);
            if (instructions) {
                instructions.style.display = 'block';
            }
        }

        // ============ TAB NAVIGATION ============
        function switchTab(tabId) {
            // Map old tab names to new structure
            const tabMapping = {
                'battle': 'social',
                'community': 'social'
            };
            const actualTabId = tabMapping[tabId] || tabId;
            
            // Update top nav tabs - try both old and new selectors
            document.querySelectorAll('.nav-tabs .nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Try new data-tab selector first
            let topTab = document.querySelector(`.nav-tabs .nav-tab[data-tab="${actualTabId}"]`);
            // Fallback to old onclick selector
            if (!topTab) {
                topTab = document.querySelector(`.nav-tabs [onclick="switchTab('${tabId}')"]`);
            }
            if (topTab) topTab.classList.add('active');
            
            // Update bottom nav tabs (if they exist)
            document.querySelectorAll('.bottom-nav-tab').forEach(tab => tab.classList.remove('active'));
            const bottomTab = document.querySelector(`.bottom-nav-tab[data-tab="${actualTabId}"]`);
            if (bottomTab) bottomTab.classList.add('active');
            
            // Update content - handle social tab showing multiple old tabs
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (actualTabId === 'social') {
                // Social tab shows battle content, with community elements merged
                const battleTab = document.getElementById('tab-battle');
                if (battleTab) battleTab.classList.add('active');
            } else {
                const targetTab = document.getElementById(`tab-${actualTabId}`);
                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    // Fallback - try the original tabId
                    const fallbackTab = document.getElementById(`tab-${tabId}`);
                    if (fallbackTab) fallbackTab.classList.add('active');
                }
            }
            
            // Initialize tab-specific content
            if (actualTabId === 'social' || tabId === 'battle') {
                if (typeof initBattleTab === 'function') initBattleTab();
            }
            if (actualTabId === 'home') {
                if (typeof updateHomeDashboard === 'function') updateHomeDashboard();
            }
        }

        // ============ PWA FUNCTIONALITY ============
        
        let deferredInstallPrompt = null;
        let isPWAMode = false;
        let lastClipboardText = '';
        let pendingClipboardParse = null;
        let activeBattleId = null;
        
        // Detect if running as installed PWA
        function detectPWAMode() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOSPWA = window.navigator.standalone === true;
            const isAndroidTWA = document.referrer.includes('android-app://');
            
            isPWAMode = isStandalone || isIOSPWA || isAndroidTWA;
            
            if (isPWAMode) {
                document.documentElement.classList.add('pwa-mode');
                console.log('[PWA] Running in standalone mode');
                
                // Default to Home tab in PWA mode - defer to avoid blocking
                setTimeout(() => {
                    try {
                        switchTab('home');
                    } catch (e) {
                        console.warn('[PWA] Could not switch to home tab:', e);
                    }
                }, 100);
            }
            
            return isPWAMode;
        }
        
        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('[PWA] Service Worker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showUpdateAvailable();
                            }
                        });
                    });
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            }
        }
        
        function showUpdateAvailable() {
            if (confirm('A new version of Game Shelf is available. Reload to update?')) {
                window.location.reload();
            }
        }
        
        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            
            // Show install prompt after user has used app a bit
            setTimeout(() => {
                if (deferredInstallPrompt && !isPWAMode) {
                    showInstallPrompt();
                }
            }, 30000); // 30 seconds
        });
        
        function showInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt && deferredInstallPrompt) {
                prompt.style.display = 'flex';
            }
        }
        
        function dismissInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'none';
            }
            localStorage.setItem('installPromptDismissed', Date.now());
        }
        
        async function installPWA() {
            if (!deferredInstallPrompt) return;
            
            deferredInstallPrompt.prompt();
            const { outcome } = await deferredInstallPrompt.userChoice;
            
            console.log('[PWA] Install prompt outcome:', outcome);
            deferredInstallPrompt = null;
            dismissInstallPrompt();
            
            if (outcome === 'accepted') {
                playSound('achievement');
            }
        }
        
        // ============ BOTTOM SHEET ============
        
        function openLogBottomSheet() {
            const sheet = document.getElementById('log-bottom-sheet');
            if (sheet) {
                sheet.classList.add('active');
                document.getElementById('bottom-sheet-input').focus();
                setupBottomSheetGestures();
            }
        }
        
        function closeLogBottomSheet(event) {
            if (event && event.target.id !== 'log-bottom-sheet') return;
            
            const sheet = document.getElementById('log-bottom-sheet');
            if (sheet) {
                sheet.classList.remove('active');
            }
        }
        
        function submitFromBottomSheet() {
            const input = document.getElementById('bottom-sheet-input');
            if (!input || !input.value.trim()) {
                showToast('Please paste game results');
                return;
            }
            
            // Copy to main parse input and process
            const mainInput = document.getElementById('parse-input');
            if (mainInput) {
                mainInput.value = input.value;
            }
            
            closeLogBottomSheet({ target: { id: 'log-bottom-sheet' } });
            parseShareText();
            
            // Clear bottom sheet input
            input.value = '';
        }
        
        function setupBottomSheetGestures() {
            const handle = document.getElementById('bottom-sheet-handle');
            const sheet = document.querySelector('#log-bottom-sheet .bottom-sheet');
            if (!handle || !sheet) return;
            
            let startY = 0;
            let currentY = 0;
            
            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                sheet.style.transition = 'none';
            });
            
            handle.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                if (diff > 0) {
                    sheet.style.transform = `translateY(${diff}px)`;
                }
            });
            
            handle.addEventListener('touchend', () => {
                sheet.style.transition = '';
                const diff = currentY - startY;
                if (diff > 100) {
                    closeLogBottomSheet({ target: { id: 'log-bottom-sheet' } });
                }
                sheet.style.transform = '';
            });
        }
        
        // ============ CLIPBOARD AUTO-DETECTION ============
        
        async function checkClipboardForGameResult() {
            // Don't check if feature is disabled
            if (localStorage.getItem('clipboardDetectDisabled') === 'true') return;
            
            try {
                // Check permission
                const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                if (permission.state === 'denied') return;
                
                const text = await navigator.clipboard.readText();
                if (!text || text === lastClipboardText) return;
                
                lastClipboardText = text;
                
                // Try to parse as game result
                if (typeof shareParser !== 'undefined') {
                    const parsed = shareParser.parse(text);
                    if (parsed && parsed.success !== false) {
                        // Check if already logged today
                        const today = getTodayString();
                        if (userData.stats[parsed.gameId]?.lastPlayed === today) return;
                        
                        pendingClipboardParse = { text, parsed };
                        showClipboardPrompt(parsed);
                    }
                }
            } catch (e) {
                // Clipboard access denied or failed - that's OK
                console.log('[PWA] Clipboard check skipped:', e.message);
            }
        }
        
        function showClipboardPrompt(parsed) {
            const prompt = document.getElementById('clipboard-prompt');
            if (!prompt) return;
            
            document.getElementById('clipboard-game-icon').textContent = parsed.icon || '';
            document.getElementById('clipboard-game-name').textContent = parsed.gameName || 'Game';
            document.getElementById('clipboard-game-score').textContent = parsed.displayScore || '';
            
            prompt.classList.add('visible');
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                dismissClipboardPrompt();
            }, 10000);
        }
        
        function acceptClipboardPrompt() {
            if (pendingClipboardParse) {
                const mainInput = document.getElementById('parse-input');
                if (mainInput) {
                    mainInput.value = pendingClipboardParse.text;
                }
                parseShareText();
            }
            dismissClipboardPrompt();
        }
        
        function dismissClipboardPrompt() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt) {
                prompt.classList.remove('visible');
            }
            pendingClipboardParse = null;
        }
        
        // Check clipboard on visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(checkClipboardForGameResult, 500);
            }
        });
        
        // ============ HOME DASHBOARD ============
        
        function updateHomeDashboard() {
            updateHomeProgress();
            updateHomeQuickGames();
            updateHomeBattleWidget();
            updateHomeFriendsWidget();
            updateHomeGamesGrid();
        }
        
        function updateHomeProgress() {
            const today = getTodayString();
            const todayGames = Object.entries(userData.stats || {}).filter(([id, s]) => 
                typeof s === 'object' && s.lastPlayed === today
            );
            const goal = userData.dailyGoal || 5;
            const done = todayGames.length;
            const bestStreak = getBestStreak();
            
            const progressFill = document.getElementById('home-progress-fill');
            const gamesDone = document.getElementById('home-games-done');
            const gamesGoal = document.getElementById('home-games-goal');
            const streakEl = document.getElementById('home-best-streak');
            
            if (progressFill) progressFill.style.width = `${Math.min(100, (done / goal) * 100)}%`;
            if (gamesDone) gamesDone.textContent = done;
            if (gamesGoal) gamesGoal.textContent = goal;
            if (streakEl) streakEl.textContent = bestStreak;
        }
        
        function updateHomeQuickGames() {
            const container = document.getElementById('home-quick-games');
            if (!container) return;
            
            const today = getTodayString();
            const topGames = userData.games.slice(0, 4);
            
            if (topGames.length === 0) {
                // Show default popular games
                const defaults = FEATURED_GAMES.slice(0, 4);
                container.innerHTML = defaults.map(game => `
                    <button class="home-quick-game-btn" onclick="window.open('${game.url}', '_blank')" title="${game.name}">
                        ${game.icon}
                    </button>
                `).join('');
                return;
            }
            
            container.innerHTML = topGames.map(game => {
                const stats = userData.stats[game.id];
                const playedToday = stats?.lastPlayed === today;
                return `
                    <button class="home-quick-game-btn ${playedToday ? 'done' : ''}" 
                            onclick="window.open('${game.url}', '_blank')" 
                            title="${game.name}">
                        ${game.icon}
                    </button>
                `;
            }).join('');
        }
        
        function updateHomeBattleWidget() {
            const widget = document.getElementById('home-battle-widget');
            if (!widget) return;
            
            // Find active battle
            const activeBattle = (typeof userBattles !== 'undefined' ? userBattles : [])
                .find(b => b.status === 'active');
            
            if (activeBattle) {
                widget.style.display = 'block';
                activeBattleId = activeBattle.id;
                
                const nameEl = document.getElementById('home-battle-name');
                const badgeEl = document.getElementById('home-battle-badge');
                const scoresEl = document.getElementById('home-battle-scores');
                
                if (nameEl) nameEl.textContent = activeBattle.name || 'Battle';
                
                // Calculate days remaining
                if (badgeEl && activeBattle.endDate) {
                    const endDate = new Date(activeBattle.endDate);
                    const now = new Date();
                    const daysLeft = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
                    badgeEl.textContent = daysLeft === 0 ? 'Ends today' : `${daysLeft}d left`;
                }
                
                // Show top scores
                if (scoresEl && activeBattle.scores) {
                    const scores = Object.entries(activeBattle.scores)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    scoresEl.textContent = scores
                        .map(([name, score]) => `${name}: ${score}`)
                        .join('  ');
                }
            } else {
                widget.style.display = 'none';
                activeBattleId = null;
            }
        }
        
        function updateHomeFriendsWidget() {
            const container = document.getElementById('home-friends-row');
            if (!container) return;
            
            const friends = typeof friendsData !== 'undefined' ? friendsData : [];
            
            if (!currentUser || friends.length === 0) {
                container.innerHTML = `
                    <div style="color: var(--text-muted); font-size: 0.85rem; padding: 10px;">
                        ${currentUser ? 'Add friends to see their progress' : 'Sign in to see friends'}
                    </div>
                `;
                return;
            }
            
            const today = getTodayString();
            
            container.innerHTML = friends.slice(0, 6).map(friend => {
                const played = friend.todayGames && Object.keys(friend.todayGames).length > 0;
                const initial = (friend.displayName || 'U')[0].toUpperCase();
                const avatarStyle = friend.photoURL 
                    ? `background-image: url('${friend.photoURL}'); background-size: cover;`
                    : '';
                
                return `
                    <div class="home-friend ${played ? 'played' : 'waiting'}">
                        <div class="home-friend-avatar" style="${avatarStyle}">
                            ${friend.photoURL ? '' : initial}
                        </div>
                        <span class="home-friend-status">${played ? '' : ''}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateHomeGamesGrid() {
            const grid = document.getElementById('home-games-grid');
            if (!grid) return;
            
            const today = getTodayString();
            const games = userData.games.length > 0 ? userData.games.slice(0, 6) : FEATURED_GAMES.slice(0, 6);
            
            grid.innerHTML = games.map(game => {
                const stats = userData.stats[game.id];
                const playedToday = stats?.lastPlayed === today;
                const streak = stats?.streak || 0;
                
                let statusText = 'Play';
                if (playedToday) {
                    statusText = ' Done';
                } else if (streak > 0) {
                    statusText = ` ${streak}`;
                }
                
                return `
                    <div class="home-game-card ${playedToday ? 'done' : ''}" 
                         onclick="window.open('${game.url}', '_blank')">
                        <div class="home-game-icon">${game.icon}</div>
                        <div class="home-game-name">${game.name}</div>
                        <div class="home-game-status">${statusText}</div>
                    </div>
                `;
            }).join('');
        }
        
        function getBestStreak() {
            let best = 0;
            Object.values(userData.stats || {}).forEach(stat => {
                if (typeof stat === 'object' && stat.streak > best) {
                    best = stat.streak;
                }
            });
            return best;
        }
        
        // ============ URL PARAMS HANDLING ============
        
        function handleURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            // Handle PWA shortcuts
            if (params.get('action') === 'log') {
                setTimeout(() => {
                    if (isPWAMode) {
                        openLogBottomSheet();
                    } else {
                        toggleQuickLog();
                    }
                }, 500);
            }
            
            if (params.get('tab')) {
                switchTab(params.get('tab'));
            }
            
            // Handle share target (when user shares TO the app)
            if (params.get('share-target') === 'true') {
                handleShareTarget();
            }
        }
        
        async function handleShareTarget() {
            // For POST share targets, we need to read from formData
            // This is handled by the service worker, but text shares come via URL
            const params = new URLSearchParams(window.location.search);
            const sharedText = params.get('text') || params.get('title') || '';
            
            if (sharedText) {
                const mainInput = document.getElementById('parse-input');
                if (mainInput) {
                    mainInput.value = sharedText;
                }
                
                setTimeout(() => {
                    if (isPWAMode) {
                        document.getElementById('bottom-sheet-input').value = sharedText;
                        openLogBottomSheet();
                    } else {
                        toggleQuickLog();
                    }
                    parseShareText();
                }, 500);
            }
        }

        // ============ REGISTRATION ============
        function showWelcome() {
            const list = document.getElementById('registration-list');
            list.innerHTML = POPULAR_GAMES.slice(0, 10).map(game => `
                <div class="game-list-item" onclick="toggleRegistrationGame('${game.id}')" data-id="${game.id}">
                    <span class="icon">${game.icon}</span>
                    <div class="info">
                        <div class="name">${game.name}</div>
                        <div class="source">${game.source}</div>
                    </div>
                    <div class="checkbox"></div>
                </div>
            `).join('');
            
            document.getElementById('welcome-modal').classList.add('active');
        }

        function toggleRegistrationGame(id) {
            const item = document.querySelector(`#registration-list .game-list-item[data-id="${id}"]`);
            item.classList.toggle('selected');
        }

        function completeRegistration() {
            const selected = document.querySelectorAll('#registration-list .game-list-item.selected');
            const selectedIds = Array.from(selected).map(el => el.dataset.id);
            
            selectedIds.forEach(id => {
                const game = POPULAR_GAMES.find(g => g.id === id);
                if (game && !userData.games.find(g => g.id === id)) {
                    userData.games.push({ ...game });
                    userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
            });
            
            userData.registered = true;
            saveData();
            
            document.getElementById('welcome-modal').classList.remove('active');
            renderMyGames();
            renderDiscoverList();
            updateStats();
        }

        function skipRegistration() {
            userData.registered = true;
            saveData();
            document.getElementById('welcome-modal').classList.remove('active');
            
            // After registration, check for onboarding
            setTimeout(checkAndShowOnboarding, 500);
        }

        // ============ ONBOARDING (Smart Tracking Setup) ============
        function checkAndShowOnboarding() {
            if (typeof OnboardingFlow === 'undefined') return;
            
            if (OnboardingFlow.isNeeded()) {
                showOnboardingModal();
            }
        }
        
        function showOnboardingModal() {
            if (typeof OnboardingFlow === 'undefined') return;
            
            const modal = document.getElementById('onboarding-modal');
            const container = document.getElementById('onboarding-container');
            
            if (modal && container) {
                modal.classList.add('active');
                OnboardingFlow.start(container);
            }
        }
        
        function closeOnboardingModal() {
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Listen for onboarding completion
        window.addEventListener('onboarding-complete', (e) => {
            closeOnboardingModal();
            
            // Update UI based on preferences
            const global = TrackingPreferences.getGlobal();
            console.log('Onboarding complete, preferences:', global);
            
            showToast(' Setup complete!');
        });
        
        // Show onboarding from settings
        function showTrackingSettings() {
            showAllTrackingModal();
        }
        
        function showAllTrackingModal() {
            const container = document.getElementById('all-tracking-list');
            
            // Get unique game IDs from featured + user's games
            const gameIds = new Set([
                ...FEATURED_GAMES.map(g => g.id), 
                ...userData.games.map(g => g.id)
            ]);
            const allGameIds = [...gameIds];
            
            // Sort alphabetically by name
            allGameIds.sort((a, b) => {
                const nameA = getGameName(a);
                const nameB = getGameName(b);
                return nameA.localeCompare(nameB);
            });
            
            if (allGameIds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <p>No games tracked yet.</p>
                        <p style="font-size: 0.85rem;">Add games to your shelf to configure tracking.</p>
                    </div>
                `;
            } else {
                container.innerHTML = allGameIds.map(gameId => {
                    const game = findGameById(gameId);
                    const settings = getGameTrackingSettings(gameId);
                    const sourceIcon = DataService.getTrackingSourceIcon(gameId);
                    
                    let statusText = 'Not configured';
                    if (settings && settings.trackingSource) {
                        const source = TRACKING_SOURCES[settings.trackingSource];
                        statusText = source ? source.label : settings.trackingSource;
                    }
                    
                    return `
                        <div class="tracking-game-item">
                            <div class="game-icon">${game.icon}</div>
                            <div class="game-info">
                                <div class="game-name">${game.name}</div>
                                <div class="game-status">${sourceIcon} ${statusText}</div>
                            </div>
                            <button class="edit-btn" onclick="editGameTracking('${gameId}')">Edit</button>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('all-tracking-modal').classList.add('active');
        }
        
        function closeAllTrackingModal() {
            document.getElementById('all-tracking-modal').classList.remove('active');
        }
        
        function editGameTracking(gameId) {
            closeAllTrackingModal();
            showGameTrackingModal(gameId);
        }
        
        // Helper to find a game by ID from all sources
        function findGameById(gameId) {
            return FEATURED_GAMES.find(g => g.id === gameId) ||
                   POPULAR_GAMES.find(g => g.id === gameId) ||
                   userData.games.find(g => g.id === gameId) ||
                   { id: gameId, name: gameId, icon: '' };
        }
        
        function getGameName(gameId) {
            const game = findGameById(gameId);
            return game ? game.name : gameId;
        }

        // ============ RENDERING ============
        function renderSponsoredGames() {
            const container = document.getElementById('sponsored-games');
            const section = document.getElementById('sponsored-section');
            
            // Only render if partnerManager is available and has sponsored games
            if (!partnerManager) {
                section.style.display = 'none';
                container.style.display = 'none';
                return;
            }
            
            const sponsoredGames = partnerManager.getSponsoredGames();
            
            if (sponsoredGames.length === 0) {
                section.style.display = 'none';
                container.style.display = 'none';
                return;
            }
            
            section.style.display = 'flex';
            container.style.display = 'grid';
            
            container.innerHTML = sponsoredGames.map(game => {
                const stats = userData.stats[game.id] || { lastPlayed: null, streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                
                // Track impression
                partnerManager.trackImpression(game.id);
                
                return `
                    <div class="featured-card ${playedToday ? 'played-today' : ''}" onclick="playGame('${game.id}', '${game.url}', false, true)">
                        <span class="sponsored-badge">Sponsored</span>
                        ${playedToday ? '<span class="check-badge"></span>' : ''}
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        <div class="streak ${stats.streak > 0 ? 'active' : ''}">
                            ${stats.streak > 0 ? ' ' + stats.streak + ' day streak' : game.description || 'Try it out!'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderFeaturedGames() {
            // Render sponsored first
            renderSponsoredGames();
            
            const container = document.getElementById('featured-games');
            
            // Use PartnerManager if available, fallback to FEATURED_GAMES
            const featuredGames = partnerManager 
                ? partnerManager.getFeaturedGames() 
                : FEATURED_GAMES;
            
            container.innerHTML = featuredGames.map(game => {
                const stats = userData.stats[game.id] || { lastPlayed: null, streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                const review = userData.reviews[game.id];
                const needsSetup = needsTrackingSetup(game.id);
                const trackingIcon = DataService.getTrackingSourceIcon(game.id);
                const trackingLabel = DataService.getTrackingSourceLabel(game.id);
                
                // Determine badge type based on source/category
                let badgeClass = 'featured-badge';
                let badgeText = 'Featured';
                if (game.placementType === 'api_partner') {
                    badgeClass = 'partner-badge';
                    badgeText = 'Partner';
                } else if (game.category === 'rb') {
                    badgeClass = 'featured-badge';
                    badgeText = 'GS';
                }
                
                return `
                    <div class="featured-card ${playedToday ? 'played-today' : ''}" onclick="playGame('${game.id}', '${game.url}', true)">
                        <span class="${badgeClass}">${badgeText}</span>
                        <button class="settings-btn" onclick="event.stopPropagation(); showGameTrackingModal('${game.id}')" title="Tracking settings"></button>
                        ${playedToday ? '<span class="check-badge"></span>' : 
                            (needsSetup ? '<span class="setup-badge" title="Configure tracking">!</span>' : 
                            `<span class="tracking-source-badge" title="${trackingLabel}">${trackingIcon}</span>`)}
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        <div class="streak ${stats.streak > 0 ? 'active' : ''}">
                            ${stats.streak > 0 ? ' ' + stats.streak + ' day streak' : 'Start your streak!'}
                        </div>
                        ${review && review.rating ? `<div class="rating">${''.repeat(review.rating)}${''.repeat(5-review.rating)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderMyGames() {
            const container = document.getElementById('my-games');
            
            if (userData.games.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon"></div>
                        <p>No games added yet.<br>Click "Add Game" to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userData.games.map(game => {
                const stats = userData.stats[game.id] || { lastPlayed: null, streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                const review = userData.reviews[game.id];
                const needsSetup = needsTrackingSetup(game.id);
                const trackingIcon = DataService.getTrackingSourceIcon(game.id);
                const trackingLabel = DataService.getTrackingSourceLabel(game.id);
                
                return `
                    <div class="game-card ${playedToday ? 'played-today' : ''}" onclick="playGame('${game.id}', '${game.url}')">
                        <button class="remove-btn" onclick="event.stopPropagation(); removeGame('${game.id}')" title="Remove game"></button>
                        <button class="settings-btn" onclick="event.stopPropagation(); showGameTrackingModal('${game.id}')" title="Tracking settings"></button>
                        ${playedToday ? '<span class="check-badge"></span>' : 
                            (needsSetup ? '<span class="setup-badge" title="Configure tracking">!</span>' : 
                            `<span class="tracking-source-badge" title="${trackingLabel}">${trackingIcon}</span>`)}
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        <div class="streak ${stats.streak > 0 ? 'active' : ''}">
                            ${stats.streak > 0 ? ' ' + stats.streak : 'No streak'}
                        </div>
                        ${review && review.rating ? `<div class="rating">${'<span class="star filled"></span>'.repeat(review.rating)}${'<span class="star"></span>'.repeat(5-review.rating)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderDiscoverList() {
            const existingIds = [...userData.games.map(g => g.id), ...FEATURED_GAMES.map(g => g.id)];
            const available = POPULAR_GAMES.filter(g => !existingIds.includes(g.id));
            
            const container = document.getElementById('discover-list');
            if (!container) return; // Element may not exist
            
            if (available.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon"></div>
                        <p>You've added all the games!<br>Check the Community tab for more.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = available.map(game => `
                <div class="discover-card" onclick="addGameFromDiscover('${game.id}')">
                    <div class="header">
                        <span class="icon">${game.icon}</span>
                        <div>
                            <div class="name">${game.name}</div>
                            <div class="source">${game.source}</div>
                        </div>
                    </div>
                    <div class="description">${game.description}</div>
                    <div class="tags">
                        ${game.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderReviews() {
            const allGames = [...FEATURED_GAMES, ...userData.games];
            const gamesWithStats = allGames.filter(g => userData.stats[g.id] && userData.stats[g.id].totalPlays > 0);
            
            const container = document.getElementById('reviews-list');
            const emptyState = document.getElementById('reviews-empty');
            
            if (!container) return; // Element may not exist
            
            if (gamesWithStats.length === 0) {
                container.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            container.innerHTML = gamesWithStats.map(game => {
                const stats = userData.stats[game.id] || {};
                const review = userData.reviews[game.id] || {};
                
                return `
                    <div class="review-card">
                        <div class="review-header">
                            <span class="icon">${game.icon}</span>
                            <div class="info">
                                <h4>${game.name}</h4>
                                <div class="stars">${review.rating ? ''.repeat(review.rating) + ''.repeat(5-review.rating) : '<span style="color: var(--text-muted)">Not rated</span>'}</div>
                            </div>
                            <div style="margin-left: auto; text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                                <div> ${stats.streak || 0} streak</div>
                                <div> ${stats.totalPlays || 0} plays</div>
                            </div>
                        </div>
                        <div class="review-notes" onclick="openReviewModal('${game.id}')">${review.notes || ''}</div>
                        <div class="review-actions">
                            <button class="btn btn-secondary btn-small" onclick="openReviewModal('${game.id}')"> ${review.rating ? 'Edit' : 'Add'} Review</button>
                            <button class="btn btn-secondary btn-small" onclick="playGame('${game.id}', '${game.url}', ${game.featured || false})"> Play</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ GAME ACTIONS ============
        // Track last played game for return detection
        let lastPlayedGame = null;
        let lastPlayedTime = null;

        // ============ SMART LAUNCHER ============
        // Handles launching games in browser or app based on user preferences
        
        // Known app URL schemes for popular games
        const APP_URL_SCHEMES = {
            // NYT Games app
            'wordle': { ios: 'nytimes://games/wordle', android: 'intent://games/wordle#Intent;package=com.nytimes.crossword;end' },
            'connections': { ios: 'nytimes://games/connections', android: 'intent://games/connections#Intent;package=com.nytimes.crossword;end' },
            'strands': { ios: 'nytimes://games/strands', android: 'intent://games/strands#Intent;package=com.nytimes.crossword;end' },
            'spelling-bee': { ios: 'nytimes://games/spelling-bee', android: 'intent://games/spelling-bee#Intent;package=com.nytimes.crossword;end' },
            'mini': { ios: 'nytimes://games/mini', android: 'intent://games/mini#Intent;package=com.nytimes.crossword;end' },
            'letterboxed': { ios: 'nytimes://games/letterboxed', android: 'intent://games/letterboxed#Intent;package=com.nytimes.crossword;end' },
            'tiles': { ios: 'nytimes://games/tiles', android: 'intent://games/tiles#Intent;package=com.nytimes.crossword;end' },
            'vertex': { ios: 'nytimes://games/vertex', android: 'intent://games/vertex#Intent;package=com.nytimes.crossword;end' },
            // LinkedIn Games (no known app scheme - browser only)
            'queens': null,
            'tango': null,
            'pinpoint': null,
            'crossclimb': null,
        };

        const TrackingPreferences = {
            // Get tracking preferences for a specific game
            getForGame(gameId) {
                const settings = userData.gameSettings?.[gameId] || {};
                return {
                    trackingSource: settings.trackingSource || null,
                    entryMethod: settings.entryMethod || null,
                    launchInApp: ['nyt-ios', 'nyt-android'].includes(settings.trackingSource)
                };
            },
            
            // Set tracking preferences for a game
            setForGame(gameId, prefs) {
                if (!userData.gameSettings) userData.gameSettings = {};
                userData.gameSettings[gameId] = {
                    ...userData.gameSettings[gameId],
                    ...prefs
                };
                saveData();
            },
            
            // Get global preferences
            getGlobal() {
                return {
                    defaultSource: localStorage.getItem('gameshelf_defaultSource') || null,
                    preferApp: localStorage.getItem('gameshelf_preferApp') === 'true'
                };
            }
        };

        const SmartLauncher = {
            // Detect platform (iOS, Android, or desktop)
            getPlatform() {
                const ua = navigator.userAgent.toLowerCase();
                if (/iphone|ipad|ipod/.test(ua)) return 'ios';
                if (/android/.test(ua)) return 'android';
                return 'desktop';
            },
            
            // Launch a game with smart app/browser handling
            launch(gameId, webUrl, userPrefs) {
                const platform = this.getPlatform();
                const appScheme = APP_URL_SCHEMES[gameId];
                const wantsApp = userPrefs?.launchInApp;
                
                // If user wants app and we have a scheme for this platform
                if (wantsApp && appScheme) {
                    const appUrl = platform === 'ios' ? appScheme.ios : 
                                   platform === 'android' ? appScheme.android : null;
                    
                    if (appUrl) {
                        // Try to launch app, fall back to browser
                        this.tryAppLaunch(appUrl, webUrl);
                        return;
                    }
                }
                
                // Default: open in browser
                window.open(webUrl, '_blank');
            },
            
            // Try to launch app, fall back to browser after timeout
            tryAppLaunch(appUrl, fallbackUrl) {
                const platform = this.getPlatform();
                
                // On iOS, we can try the custom URL scheme
                if (platform === 'ios') {
                    // Create a hidden iframe to try the app URL
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = appUrl;
                    document.body.appendChild(iframe);
                    
                    // Set a timeout to open browser if app doesn't launch
                    const fallbackTimeout = setTimeout(() => {
                        document.body.removeChild(iframe);
                        window.open(fallbackUrl, '_blank');
                    }, 1500);
                    
                    // If page becomes hidden (app opened), clear timeout
                    document.addEventListener('visibilitychange', function handler() {
                        if (document.hidden) {
                            clearTimeout(fallbackTimeout);
                            document.removeEventListener('visibilitychange', handler);
                        }
                    });
                    
                    return;
                }
                
                // On Android, use intent URL
                if (platform === 'android' && appUrl.startsWith('intent://')) {
                    window.location.href = appUrl;
                    return;
                }
                
                // Fallback for desktop or unknown
                window.open(fallbackUrl, '_blank');
            }
        };

        function playGame(id, url, featured = false, sponsored = false) {
            // Track partner/sponsored clicks
            if (partnerManager) {
                partnerManager.trackClick(id);
            }
            
            // Track for return detection
            const game = FEATURED_GAMES.find(g => g.id === id) || 
                         POPULAR_GAMES.find(g => g.id === id) || 
                         userData.games.find(g => g.id === id) ||
                         (partnerManager ? partnerManager.partners[id] : null);
            lastPlayedGame = {
                id: id,
                name: game?.name || id,
                icon: game?.icon || '',
                url: url
            };
            lastPlayedTime = Date.now();
            
            // Use SmartLauncher for intelligent app/browser launching
            const userPrefs = TrackingPreferences.getForGame(id);
            SmartLauncher.launch(id, url, userPrefs);
            
            // NOTE: Tracking setup is now handled in the return-from-game prompt
            // This avoids showing multiple prompts
            
            // Initialize stats if needed
            if (!userData.stats[id]) {
                userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
            }
            
            const stats = userData.stats[id];
            const today = getTodayString();
            const yesterday = getYesterdayString();
            
            // Update streak logic
            if (stats.lastPlayed !== today) {
                if (stats.lastPlayed === yesterday) {
                    stats.streak++;
                } else if (stats.lastPlayed !== today) {
                    stats.streak = 1;
                }
                stats.totalPlays++;
                stats.lastPlayed = today;
                
                // Track total completed
                if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                userData.stats.totalCompleted++;
                
                // Award coins for game completion
                earnTokens(TOKEN_REWARDS.gameComplete, ` Completed ${game?.name || 'game'}`);
                
                // Check for streak bonuses
                checkStreakBonus(id);
                
                // Update battle scores (base completion points)
                try {
                    updateBattleScores(id, 10); // Base points for playing
                    checkTournamentCompletion(id); // Track tournament daily progress
                } catch (e) {
                    console.log('Battle score update skipped');
                }
                
                // Publish activity to friends (wrapped in try-catch)
                try {
                    publishActivity(id, game?.name || id);
                } catch (e) {
                    console.error('Failed to publish activity:', e);
                }
            }
            
            saveData();
            recordHistory();
            
            // Re-render and update
            try {
                renderFeaturedGames();
                renderMyGames();
                renderReviews();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                renderLeaderboard();
                
                // Check achievements
                checkAndUnlockAchievements();
                unlockTimeAchievement();
            } catch (e) {
                console.error('Failed to update UI:', e);
            }
        }
        
        // Show tracking setup prompt for new games
        function showTrackingSetupPrompt(gameId, game) {
            const gameName = game?.name || 'this game';
            const gameIcon = game?.icon || '';
            
            // Create prompt modal
            const promptModal = document.createElement('div');
            promptModal.className = 'modal-overlay active';
            promptModal.id = 'tracking-setup-prompt';
            promptModal.innerHTML = `
                <div class="modal" style="max-width: 360px; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">${gameIcon}</div>
                    <h2 style="margin-bottom: 10px;">Set Up Tracking?</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Tell us where you play <strong>${gameName}</strong> for consistent tracking across devices.
                    </p>
                    
                    <div class="quick-source-options">
                        <button class="quick-source-btn" onclick="quickSetTrackingSource('${gameId}', 'browser-extension')">
                            <span class="qsb-icon"></span>
                            <span class="qsb-label">Browser</span>
                        </button>
                        <button class="quick-source-btn" onclick="quickSetTrackingSource('${gameId}', 'nyt-ios')">
                            <span class="qsb-icon"></span>
                            <span class="qsb-label">iOS App</span>
                        </button>
                        <button class="quick-source-btn" onclick="quickSetTrackingSource('${gameId}', 'nyt-android')">
                            <span class="qsb-icon"></span>
                            <span class="qsb-label">Android</span>
                        </button>
                        <button class="quick-source-btn" onclick="quickSetTrackingSource('${gameId}', 'multiple')">
                            <span class="qsb-icon"></span>
                            <span class="qsb-label">Multiple</span>
                        </button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeTrackingSetupPrompt()" style="flex: 1;">Skip</button>
                        <button class="btn btn-primary" onclick="closeTrackingSetupPrompt(); showGameTrackingModal('${gameId}');" style="flex: 1;">More Options</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(promptModal);
        }
        
        function closeTrackingSetupPrompt() {
            const prompt = document.getElementById('tracking-setup-prompt');
            if (prompt) prompt.remove();
        }
        
        function quickSetTrackingSource(gameId, sourceId) {
            const source = TRACKING_SOURCES[sourceId];
            const defaultMethod = source?.entryMethods.find(m => !ENTRY_METHODS[m]?.comingSoon) || 'manual';
            
            // Save to DataService (existing system)
            DataService.saveGameSettings(gameId, {
                trackingSource: sourceId,
                entryMethod: defaultMethod,
                goalEnabled: true,
                cloudSync: false
            });
            
            // Also save to TrackingPreferences (for SmartLauncher)
            TrackingPreferences.setForGame(gameId, {
                trackingSource: sourceId,
                entryMethod: defaultMethod,
                launchInApp: ['nyt-ios', 'nyt-android'].includes(sourceId)
            });
            
            closeTrackingSetupPrompt();
            renderFeaturedGames();
            renderMyGames();
            showToast(` Tracking set to ${source?.label || sourceId}`);
        }

        function removeGame(id) {
            if (!confirm('Remove this game from your shelf?')) return;
            
            userData.games = userData.games.filter(g => g.id !== id);
            delete userData.stats[id];
            delete userData.reviews[id];
            saveData();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            updateStats();
        }

        function addGameFromDiscover(id) {
            const game = POPULAR_GAMES.find(g => g.id === id);
            if (game && !userData.games.find(g => g.id === id)) {
                userData.games.push({ ...game });
                userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                saveData();
                renderMyGames();
                renderDiscoverList();
                updateStats();
                
                // Show confirmation
                alert(`${game.icon} ${game.name} added to your shelf!`);
            }
        }

        // ============ ADD GAME ============
        function showAddGameModal() {
            const existingIds = [...userData.games.map(g => g.id), ...FEATURED_GAMES.map(g => g.id)];
            const available = POPULAR_GAMES.filter(g => !existingIds.includes(g.id));
            
            const list = document.getElementById('add-game-list');
            
            if (available.length > 0) {
                list.innerHTML = available.map(game => `
                    <div class="game-list-item" onclick="toggleAddGame('${game.id}')" data-id="${game.id}">
                        <span class="icon">${game.icon}</span>
                        <div class="info">
                            <div class="name">${game.name}</div>
                            <div class="source">${game.source}</div>
                        </div>
                        <div class="checkbox"></div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p style="text-align:center; color: var(--text-muted);">All popular games added! Use the form below to add custom games.</p>';
            }
            
            // Clear custom inputs
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-url').value = '';
            document.getElementById('custom-icon').value = '';
            
            document.getElementById('add-game-modal').classList.add('active');
        }

        function closeAddGameModal() {
            document.getElementById('add-game-modal').classList.remove('active');
        }

        // Auto-detect game info from URL
        const URL_PATTERNS = {
            'nytimes.com/games/wordle': { name: 'Wordle', icon: '' },
            'nytimes.com/games/connections': { name: 'Connections', icon: '' },
            'nytimes.com/games/strands': { name: 'Strands', icon: '' },
            'nytimes.com/puzzles/spelling-bee': { name: 'Spelling Bee', icon: '' },
            'nytimes.com/crosswords/game/mini': { name: 'Mini Crossword', icon: '' },
            'nytimes.com/puzzles/letter-boxed': { name: 'Letter Boxed', icon: '' },
            'worldle.teuteuf.fr': { name: 'Worldle', icon: '' },
            'globle-game.com': { name: 'Globle', icon: '' },
            'quordle': { name: 'Quordle', icon: '4' },
            'octordle': { name: 'Octordle', icon: '8' },
            'semantle': { name: 'Semantle', icon: '' },
            'redactle': { name: 'Redactle', icon: '' },
            'immaculategrid': { name: 'Immaculate Grid', icon: '' },
            'costcodle': { name: 'Costcodle', icon: '' },
            'tradle': { name: 'Tradle', icon: '' },
            'foodguessr': { name: 'FoodGuessr', icon: '' },
            'framed.wtf': { name: 'Framed', icon: '' },
            'nerdle': { name: 'Nerdle', icon: '' },
        };

        // Known game site domains for validation
        const KNOWN_GAME_DOMAINS = [
            'nytimes.com', 'nyt.com',
            'linkedin.com',
            'wordle', 'connections', 'strands',
            'semantle.com', 'redactle.net',
            'worldle', 'globle',
            'tradle', 'costcodle',
            'quordle', 'octordle',
            'immaculategrid.com',
            'chess.com', 'lichess.org',
            'sporcle.com',
            'jklm.fun',
            'puzzle', 'game', 'play', 'daily',
            '.io', 'itch.io',
            'merriam-webster.com',
            'britannica.com',
            'github.io' // For custom hosted games
        ];

        function validateGameUrl(url) {
            // Check if URL is valid format
            try {
                const parsed = new URL(url);
                if (!['http:', 'https:'].includes(parsed.protocol)) {
                    return { valid: false, error: 'URL must start with http:// or https://' };
                }
                
                // Check if domain looks like a game site
                const hostname = parsed.hostname.toLowerCase();
                const isKnownGameSite = KNOWN_GAME_DOMAINS.some(domain => 
                    hostname.includes(domain.toLowerCase())
                );
                
                if (isKnownGameSite) {
                    return { valid: true, confidence: 'high' };
                }
                
                // Allow any valid URL but warn it's unrecognized
                return { valid: true, confidence: 'low', warning: 'Unrecognized game site - please verify the URL is correct' };
                
            } catch (e) {
                return { valid: false, error: 'Please enter a valid URL (e.g., https://example.com)' };
            }
        }

        function autoDetectGameInfo() {
            const urlInput = document.getElementById('custom-url');
            const nameInput = document.getElementById('custom-name');
            const iconInput = document.getElementById('custom-icon');
            const feedback = document.getElementById('url-validation-feedback');
            
            const url = urlInput.value.trim();
            const urlLower = url.toLowerCase();
            
            // Show validation feedback
            if (url) {
                const validation = validateGameUrl(url.startsWith('http') ? url : 'https://' + url);
                if (!validation.valid) {
                    feedback.innerHTML = `<span style="color: var(--accent-red);"> ${validation.error}</span>`;
                } else if (validation.confidence === 'high') {
                    feedback.innerHTML = `<span style="color: var(--accent-green);"> Recognized game site</span>`;
                } else {
                    feedback.innerHTML = `<span style="color: var(--accent-orange);"> Unrecognized site - will still add</span>`;
                }
            } else {
                feedback.innerHTML = `<span style="color: var(--text-muted);">Paste URL to auto-detect game info</span>`;
            }
            
            // Try to match known patterns
            for (const [pattern, info] of Object.entries(URL_PATTERNS)) {
                if (urlLower.includes(pattern)) {
                    if (!nameInput.value) nameInput.value = info.name;
                    if (!iconInput.value) iconInput.value = info.icon;
                    return;
                }
            }
            
            // Try to extract game name from URL
            if (!nameInput.value && url) {
                try {
                    const urlObj = new URL(url.startsWith('http') ? url : 'https://' + url);
                    let name = urlObj.hostname.replace('www.', '').split('.')[0];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    nameInput.value = name;
                } catch (e) {
                    // Invalid URL, ignore
                }
            }
        }

        function toggleAddGame(id) {
            const item = document.querySelector(`#add-game-list .game-list-item[data-id="${id}"]`);
            item.classList.toggle('selected');
        }

        function addSelectedGames() {
            // Add selected popular games
            const selected = document.querySelectorAll('#add-game-list .game-list-item.selected');
            const selectedIds = Array.from(selected).map(el => el.dataset.id);
            
            selectedIds.forEach(id => {
                const game = POPULAR_GAMES.find(g => g.id === id);
                if (game && !userData.games.find(g => g.id === id)) {
                    userData.games.push({ ...game });
                    userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
            });
            
            // Add custom game if filled in
            const customName = document.getElementById('custom-name').value.trim();
            const customUrl = document.getElementById('custom-url').value.trim();
            const customIcon = document.getElementById('custom-icon').value.trim() || '';
            
            if (customName && customUrl) {
                // Validate URL
                const validation = validateGameUrl(customUrl);
                
                if (!validation.valid) {
                    showToast(' ' + validation.error);
                    return;
                }
                
                if (validation.warning) {
                    // Show warning but allow adding
                    showToast(' ' + validation.warning);
                }
                
                const customId = 'custom-' + Date.now();
                userData.games.push({
                    id: customId,
                    name: customName,
                    url: customUrl,
                    icon: customIcon,
                    source: 'Custom',
                    description: 'Custom game',
                    tags: ['custom']
                });
                userData.stats[customId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
            }
            
            saveData();
            closeAddGameModal();
            renderMyGames();
            renderDiscoverList();
            updateStats();
        }

        // ============ REVIEWS ============
        function setupStarRating() {
            const stars = document.querySelectorAll('#rating-input .star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.value);
                    updateStarDisplay();
                });
                star.addEventListener('mouseenter', () => {
                    highlightStars(parseInt(star.dataset.value));
                });
            });
            
            document.getElementById('rating-input').addEventListener('mouseleave', () => {
                updateStarDisplay();
            });
        }

        function highlightStars(count) {
            const stars = document.querySelectorAll('#rating-input .star');
            stars.forEach((star, i) => {
                star.classList.toggle('filled', i < count);
            });
        }

        function updateStarDisplay() {
            highlightStars(currentRating);
        }

        function openReviewModal(gameId) {
            currentReviewGameId = gameId;
            
            const game = [...FEATURED_GAMES, ...userData.games].find(g => g.id === gameId);
            const review = userData.reviews[gameId] || {};
            
            document.getElementById('review-game-icon').textContent = game.icon;
            document.getElementById('review-game-name').textContent = game.name;
            document.getElementById('review-notes').value = review.notes || '';
            
            currentRating = review.rating || 0;
            updateStarDisplay();
            
            document.getElementById('review-modal').classList.add('active');
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.remove('active');
            currentReviewGameId = null;
            currentRating = 0;
        }

        function saveReview() {
            if (!currentReviewGameId) return;
            
            userData.reviews[currentReviewGameId] = {
                rating: currentRating,
                notes: document.getElementById('review-notes').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            saveData();
            closeReviewModal();
            renderFeaturedGames();
            renderMyGames();
            renderReviews();
        }

        // ============ SETTINGS ============
        function resetAllData() {
            if (!confirm('This will delete all your games and stats. Are you sure?')) return;
            
            localStorage.removeItem('gameShelfData');
            localStorage.removeItem('gameShelfTheme');
            userData = { registered: false, games: [], stats: {}, reviews: {}, chatMessages: [], history: {}, achievements: {}, dailyGoal: 5 };
            
            toggleSettingsMenu();
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            renderCalendar();
            renderAchievements();
            updateDailyGoal();
            renderInsights();
            showWelcome();
        }

        function exportData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gameshelf-backup-${getTodayString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(' Data exported!');
        }

        function importData() {
            // Create file input if it doesn't exist
            let fileInput = document.getElementById('import-file-input');
            if (!fileInput) {
                fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = 'import-file-input';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                fileInput.addEventListener('change', handleImportFile);
                document.body.appendChild(fileInput);
            }
            fileInput.click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate it looks like gameshelf data
                    if (!importedData || typeof importedData !== 'object') {
                        throw new Error('Invalid data format');
                    }
                    
                    // Show confirmation with stats
                    const stats = {
                        games: importedData.games?.length || 0,
                        history: Object.keys(importedData.history || {}).length,
                        achievements: Object.keys(importedData.achievements || {}).length,
                        reviews: Object.keys(importedData.reviews || {}).length
                    };
                    
                    const confirmMsg = `Import this backup?\n\n` +
                        ` ${stats.games} games\n` +
                        ` ${stats.history} days of history\n` +
                        ` ${stats.achievements} achievements\n` +
                        ` ${stats.reviews} reviews\n\n` +
                        `Choose how to import:\n` +
                        ` OK = Merge with existing data\n` +
                        ` Cancel = Abort import`;
                    
                    if (confirm(confirmMsg)) {
                        // Merge imported data with existing
                        mergeImportedData(importedData);
                        showToast(' Data imported successfully!');
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    showToast(' Invalid backup file');
                }
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function mergeImportedData(importedData) {
            // Merge games (avoid duplicates)
            if (importedData.games) {
                const existingIds = new Set(userData.games.map(g => g.id));
                importedData.games.forEach(game => {
                    if (!existingIds.has(game.id)) {
                        userData.games.push(game);
                    }
                });
            }
            
            // Merge history (combine daily records)
            if (importedData.history) {
                Object.entries(importedData.history).forEach(([date, dayData]) => {
                    if (!userData.history[date]) {
                        userData.history[date] = dayData;
                    } else {
                        // Merge games for this day
                        Object.entries(dayData).forEach(([gameId, gameData]) => {
                            if (!userData.history[date][gameId]) {
                                userData.history[date][gameId] = gameData;
                            }
                        });
                    }
                });
            }
            
            // Merge stats (take higher values)
            if (importedData.stats) {
                Object.entries(importedData.stats).forEach(([gameId, stats]) => {
                    if (!userData.stats[gameId]) {
                        userData.stats[gameId] = stats;
                    } else {
                        // Take higher streak, more total plays
                        userData.stats[gameId].streak = Math.max(
                            userData.stats[gameId].streak || 0,
                            stats.streak || 0
                        );
                        userData.stats[gameId].totalPlays = Math.max(
                            userData.stats[gameId].totalPlays || 0,
                            stats.totalPlays || 0
                        );
                        // Keep most recent lastPlayed
                        if (stats.lastPlayed && (!userData.stats[gameId].lastPlayed || 
                            stats.lastPlayed > userData.stats[gameId].lastPlayed)) {
                            userData.stats[gameId].lastPlayed = stats.lastPlayed;
                        }
                    }
                });
            }
            
            // Merge achievements (union)
            if (importedData.achievements) {
                Object.entries(importedData.achievements).forEach(([id, date]) => {
                    if (!userData.achievements[id]) {
                        userData.achievements[id] = date;
                    }
                });
            }
            
            // Merge reviews (keep existing, add new)
            if (importedData.reviews) {
                Object.entries(importedData.reviews).forEach(([gameId, review]) => {
                    if (!userData.reviews[gameId]) {
                        userData.reviews[gameId] = review;
                    }
                });
            }
            
            // Merge streaks data
            if (importedData.streaks) {
                Object.entries(importedData.streaks).forEach(([gameId, streakData]) => {
                    if (!userData.streaks) userData.streaks = {};
                    if (!userData.streaks[gameId]) {
                        userData.streaks[gameId] = streakData;
                    }
                });
            }
            
            // Merge wallet (add tokens/coins, don't replace)
            if (importedData.wallet) {
                if (!userData.wallet) {
                    userData.wallet = importedData.wallet;
                } else {
                    // Could optionally merge, but safer to keep current wallet
                    // to prevent exploits
                }
            }
            
            // Merge gameSettings
            if (importedData.gameSettings) {
                if (!userData.gameSettings) userData.gameSettings = {};
                Object.entries(importedData.gameSettings).forEach(([gameId, settings]) => {
                    if (!userData.gameSettings[gameId]) {
                        userData.gameSettings[gameId] = settings;
                    }
                });
            }
            
            // Save merged data
            saveData();
            
            // Re-render everything
            renderMyGames();
            renderFeaturedGames();
            renderInsights();
            renderAchievements();
            renderReviews();
            updateStats();
        }

        // ============ CALENDAR HEATMAP ============
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-label');
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            monthLabel.textContent = `${months[calendarMonth]} ${calendarYear}`;
            
            // Clear existing days (keep labels)
            const existingDays = grid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());
            
            // Get first day of month and total days
            const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
            const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
            const today = new Date();
            const todayStr = getTodayString();
            
            // Add empty cells for days before first of month
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = getHistoryForDate(dateStr);
                const level = getActivityLevel(dayData);
                const isToday = dateStr === todayStr;
                
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day level-${level}${isToday ? ' today' : ''}`;
                dayEl.textContent = day;
                
                // Tooltip
                if (dayData.gamesPlayed > 0) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'calendar-tooltip';
                    tooltip.textContent = `${dayData.gamesPlayed}/${dayData.totalGames} games`;
                    dayEl.appendChild(tooltip);
                }
                
                grid.appendChild(dayEl);
            }
        }

        function getHistoryForDate(dateStr) {
            // Check if we have history data
            if (userData.history && userData.history[dateStr]) {
                return userData.history[dateStr];
            }
            
            // Fallback: calculate from stats
            const allStats = { ...userData.stats };
            let gamesPlayed = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === dateStr) gamesPlayed++;
            });
            
            return {
                gamesPlayed,
                totalGames: FEATURED_GAMES.length + userData.games.length
            };
        }

        function getActivityLevel(dayData) {
            if (!dayData || dayData.gamesPlayed === 0) return 0;
            const ratio = dayData.gamesPlayed / Math.max(dayData.totalGames, 1);
            if (ratio >= 0.9) return 4;
            if (ratio >= 0.6) return 3;
            if (ratio >= 0.3) return 2;
            return 1;
        }

        function prevMonth() {
            calendarMonth--;
            if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            const now = new Date();
            const targetDate = new Date(calendarYear, calendarMonth + 1, 1);
            if (targetDate <= now) {
                calendarMonth++;
                if (calendarMonth > 11) {
                    calendarMonth = 0;
                    calendarYear++;
                }
                renderCalendar();
            }
        }

        function recordHistory() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            let gamesPlayed = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) gamesPlayed++;
            });
            
            userData.history[today] = {
                gamesPlayed,
                totalGames: FEATURED_GAMES.length + userData.games.length
            };
            
            saveData();
        }

        // ============ WALLET / COINS SYSTEM ============
        // ============ DUAL CURRENCY SYSTEM ============
        // Tokens  = Free currency, earned through play
        // Coins  = Premium currency, purchased only (18+ verified)
        
        const TOKEN_REWARDS = {
            dailyLogin: 50,
            gameComplete: 100,
            streak7: 500,
            streak30: 2000,
            achievementBasic: 250,
            achievementMedium: 500,
            achievementHard: 1000,
            newUserBonus: 5000,
            battleWinFree: 200
        };
        
        // Coin packs - 1 Coin  $1 real value
        const COIN_PACKS = [
            { id: 'starter', coins: 5, price: 4.99, bonus: 0, label: 'Starter', stripePriceId: 'price_coins_starter' },
            { id: 'plus', coins: 11, price: 9.99, bonus: 10, label: 'Plus', popular: true, stripePriceId: 'price_coins_plus' },
            { id: 'value', coins: 28, price: 24.99, bonus: 12, label: 'Best Value', stripePriceId: 'price_coins_value' }
        ];
        
        // Subscription tiers
        const SUBSCRIPTION_TIERS = {
            monthly: {
                id: 'pro_monthly',
                name: 'Game Shelf Pro',
                price: 9.99,
                period: 'month',
                coins: 10,
                stripePriceId: 'price_pro_monthly',
                perks: [
                    '10 Coins every month',
                    '2x Token earnings',
                    'Pro badge on profile',
                    'Exclusive cosmetics',
                    'Early access to features'
                ]
            },
            annual: {
                id: 'pro_annual',
                name: 'Game Shelf Pro (Annual)',
                price: 99.99,
                period: 'year',
                coins: 120,
                savings: 20,
                stripePriceId: 'price_pro_annual',
                perks: [
                    '120 Coins per year (10/month)',
                    '2x Token earnings',
                    'Pro badge on profile',
                    'Exclusive cosmetics',
                    'Early access to features',
                    'Save $20 vs monthly'
                ]
            }
        };

        // Stripe Configuration
        const STRIPE_CONFIG = {
            // Replace with your Stripe publishable key
            publishableKey: 'pk_test_XXXXXXXXXXXXXXXXXXXXXXXX',
            // API endpoint for creating checkout sessions
            apiEndpoint: 'https://api.gameshelf.app/v1/payments',
            // Success/cancel URLs
            successUrl: window.location.origin + '?payment=success&session_id={CHECKOUT_SESSION_ID}',
            cancelUrl: window.location.origin + '?payment=cancelled'
        };

        // Stripe instance (loaded dynamically)
        let stripe = null;

        // Load Stripe.js dynamically
        function loadStripe() {
            return new Promise((resolve, reject) => {
                if (stripe) {
                    resolve(stripe);
                    return;
                }
                
                if (window.Stripe) {
                    stripe = window.Stripe(STRIPE_CONFIG.publishableKey);
                    resolve(stripe);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://js.stripe.com/v3/';
                script.onload = () => {
                    stripe = window.Stripe(STRIPE_CONFIG.publishableKey);
                    resolve(stripe);
                };
                script.onerror = () => reject(new Error('Failed to load Stripe'));
                document.head.appendChild(script);
            });
        }

        function initWallet() {
            // Initialize wallet if not exists
            if (!userData.wallet) {
                userData.wallet = {
                    tokens: 0,
                    coins: 0,
                    transactions: [],
                    lastDailyBonus: null,
                    streakBonuses: {},
                    ageVerified: false,
                    subscription: null
                };
            }
            
            // Migration: if old balance exists, convert to tokens
            if (userData.wallet.balance !== undefined) {
                userData.wallet.tokens = userData.wallet.balance || 0;
                delete userData.wallet.balance;
            }
            
            // Ensure new fields exist
            if (userData.wallet.tokens === undefined) userData.wallet.tokens = 0;
            if (userData.wallet.coins === undefined) userData.wallet.coins = 0;
            if (userData.wallet.ageVerified === undefined) userData.wallet.ageVerified = false;
            if (userData.wallet.subscription === undefined) userData.wallet.subscription = null;
            
            // Give new user bonus if first time
            if (userData.registered && userData.wallet.tokens === 0 && userData.wallet.transactions.length === 0) {
                earnTokens(TOKEN_REWARDS.newUserBonus, ' Welcome bonus!');
            }
            
            // Check daily login bonus
            checkDailyLoginBonus();
            
            // Check subscription benefits
            checkSubscriptionBenefits();
            
            // Update display
            updateWalletDisplay();
        }

        function checkDailyLoginBonus() {
            const today = getTodayString();
            if (userData.wallet.lastDailyBonus !== today) {
                const multiplier = userData.wallet.subscription ? 2 : 1;
                earnTokens(TOKEN_REWARDS.dailyLogin * multiplier, userData.wallet.subscription ? ' Daily login (2x Pro bonus!)' : ' Daily login bonus');
                userData.wallet.lastDailyBonus = today;
                saveData();
            }
        }
        
        function checkSubscriptionBenefits() {
            const sub = userData.wallet.subscription;
            if (!sub) return;
            
            // Check if subscription is still active
            if (sub.expiresAt && sub.expiresAt < Date.now()) {
                userData.wallet.subscription = null;
                showToast('Your Pro subscription has expired');
                saveData();
                return;
            }
            
            // Check monthly coin distribution
            const today = getTodayString();
            const monthKey = today.substring(0, 7); // YYYY-MM
            if (sub.lastCoinDistribution !== monthKey) {
                earnCoins(10, ' Monthly Pro subscription coins');
                sub.lastCoinDistribution = monthKey;
                saveData();
            }
        }

        function earnTokens(amount, reason) {
            const multiplier = userData.wallet.subscription ? 2 : 1;
            const finalAmount = reason.includes('Pro bonus') ? amount : amount * multiplier;
            
            userData.wallet.tokens += finalAmount;
            
            // Play coin sound
            playSound('coin');
            
            // Add transaction
            userData.wallet.transactions.unshift({
                type: 'earn',
                currency: 'tokens',
                amount: finalAmount,
                reason: reason + (multiplier > 1 && !reason.includes('Pro') ? ' (2x Pro)' : ''),
                timestamp: Date.now()
            });
            
            // Keep only last 50 transactions
            if (userData.wallet.transactions.length > 50) {
                userData.wallet.transactions = userData.wallet.transactions.slice(0, 50);
            }
            
            saveData();
            updateWalletDisplay();
            
            return finalAmount;
        }

        function spendTokens(amount, reason) {
            if (userData.wallet.tokens < amount) {
                showToast('Not enough tokens!');
                return false;
            }
            
            userData.wallet.tokens -= amount;
            
            userData.wallet.transactions.unshift({
                type: 'spend',
                currency: 'tokens',
                amount: amount,
                reason: reason,
                timestamp: Date.now()
            });
            
            if (userData.wallet.transactions.length > 50) {
                userData.wallet.transactions = userData.wallet.transactions.slice(0, 50);
            }
            
            saveData();
            updateWalletDisplay();
            
            return true;
        }

        function earnCoins(amount, reason) {
            userData.wallet.coins += amount;
            
            userData.wallet.transactions.unshift({
                type: 'earn',
                currency: 'coins',
                amount: amount,
                reason: reason,
                timestamp: Date.now()
            });
            
            if (userData.wallet.transactions.length > 50) {
                userData.wallet.transactions = userData.wallet.transactions.slice(0, 50);
            }
            
            saveData();
            updateWalletDisplay();
            
            return amount;
        }

        function spendCoins(amount, reason) {
            if (userData.wallet.coins < amount) {
                showToast('Not enough coins!');
                return false;
            }
            
            userData.wallet.coins -= amount;
            
            userData.wallet.transactions.unshift({
                type: 'spend',
                currency: 'coins',
                amount: amount,
                reason: reason,
                timestamp: Date.now()
            });
            
            if (userData.wallet.transactions.length > 50) {
                userData.wallet.transactions = userData.wallet.transactions.slice(0, 50);
            }
            
            saveData();
            updateWalletDisplay();
            
            return true;
        }

        function updateWalletDisplay() {
            // Update header display (show both currencies)
            const tokenEl = document.getElementById('wallet-tokens');
            const coinEl = document.getElementById('wallet-coins');
            const oldBalanceEl = document.getElementById('wallet-balance');
            
            const tokens = userData.wallet?.tokens || 0;
            const coins = userData.wallet?.coins || 0;
            
            if (tokenEl) tokenEl.textContent = formatCurrencyAmount(tokens);
            if (coinEl) coinEl.textContent = formatCurrencyAmount(coins);
            
            // Legacy support
            if (oldBalanceEl) oldBalanceEl.textContent = formatCurrencyAmount(tokens);
            
            // Update modal displays if open
            const modalTokens = document.getElementById('wallet-modal-tokens');
            const modalCoins = document.getElementById('wallet-modal-coins');
            if (modalTokens) modalTokens.textContent = tokens.toLocaleString();
            if (modalCoins) modalCoins.textContent = coins.toLocaleString();
            
            // Update Pro badge
            const proBadge = document.getElementById('pro-badge');
            if (proBadge) {
                proBadge.style.display = userData.wallet?.subscription ? 'inline-flex' : 'none';
            }
        }

        function formatCurrencyAmount(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 10000) {
                return (amount / 1000).toFixed(1) + 'K';
            } else if (amount >= 1000) {
                return amount.toLocaleString();
            }
            return amount.toString();
        }

        function showCoinPopup(amount, reason) {
            // Remove existing popup
            const existing = document.querySelector('.coin-popup');
            if (existing) existing.remove();
            
            const popup = document.createElement('div');
            popup.className = 'coin-popup';
            popup.innerHTML = `+${amount} `;
            document.body.appendChild(popup);
            
            // Pulse the wallet button
            const walletBtn = document.querySelector('.coin-badge');
            if (walletBtn) {
                walletBtn.classList.add('earning');
                setTimeout(() => walletBtn.classList.remove('earning'), 500);
            }
            
            // Remove popup after animation
            setTimeout(() => popup.remove(), 2000);
        }

        function checkStreakBonus(gameId) {
            const stats = userData.stats[gameId];
            if (!stats) return;
            
            const streak = stats.streak;
            const today = getTodayString();
            
            // Define milestone streaks
            const milestones = [7, 30, 50, 100, 365];
            
            // Check 7-day streak bonus
            if (streak === 7) {
                const key = `${gameId}-7`;
                if (userData.wallet.streakBonuses[key] !== today) {
                    earnTokens(TOKEN_REWARDS.streak7, ` 7-day streak bonus!`);
                    userData.wallet.streakBonuses[key] = today;
                    // Offer to share milestone
                    setTimeout(() => showStreakMilestoneModal(gameId, streak), 1500);
                }
            }
            
            // Check 30-day streak bonus
            if (streak === 30) {
                const key = `${gameId}-30`;
                if (!userData.wallet.streakBonuses[key]) {
                    earnTokens(TOKEN_REWARDS.streak30, ` 30-day streak bonus!`);
                    userData.wallet.streakBonuses[key] = today;
                    // Offer to share milestone
                    setTimeout(() => showStreakMilestoneModal(gameId, streak), 1500);
                }
            }
            
            // Check 50-day streak milestone
            if (streak === 50) {
                const key = `${gameId}-50`;
                if (!userData.wallet.streakBonuses?.[key]) {
                    earnCoins(100, ` 50-day streak bonus!`);
                    if (!userData.wallet.streakBonuses) userData.wallet.streakBonuses = {};
                    userData.wallet.streakBonuses[key] = today;
                    setTimeout(() => showStreakMilestoneModal(gameId, streak), 1500);
                }
            }
            
            // Check 100-day streak milestone
            if (streak === 100) {
                const key = `${gameId}-100`;
                if (!userData.wallet.streakBonuses?.[key]) {
                    earnCoins(500, ` 100-day streak bonus!`);
                    if (!userData.wallet.streakBonuses) userData.wallet.streakBonuses = {};
                    userData.wallet.streakBonuses[key] = today;
                    setTimeout(() => showStreakMilestoneModal(gameId, streak), 1500);
                }
            }
        }

        function showStreakMilestoneModal(gameId, streak) {
            const game = FEATURED_GAMES.find(g => g.id === gameId) || { name: gameId, icon: '' };
            
            let celebrationEmoji = '';
            let message = 'Keep it going!';
            if (streak >= 365) {
                celebrationEmoji = '';
                message = "One full year! You're legendary!";
            } else if (streak >= 100) {
                celebrationEmoji = '';
                message = "Triple digits! Incredible dedication!";
            } else if (streak >= 50) {
                celebrationEmoji = '';
                message = "Halfway to 100! Amazing!";
            } else if (streak >= 30) {
                celebrationEmoji = '';
                message = "A whole month! Unstoppable!";
            } else if (streak >= 7) {
                celebrationEmoji = '';
                message = "One week down!";
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'streak-milestone-modal';
            modal.innerHTML = `
                <div class="modal share-success-modal">
                    <div class="share-celebration">${celebrationEmoji}</div>
                    <h2>${streak}-Day Streak!</h2>
                    
                    <div class="share-score-display" style="background: linear-gradient(135deg, #f6ad55, #ed8936);">
                        <div class="share-score-game">${game.icon} ${game.name}</div>
                        <div class="share-score-result">${streak} days in a row</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">${message}</div>
                    </div>
                    
                    <div class="share-buttons">
                        <button class="share-btn share-btn-primary" onclick="shareStreakMilestone('${gameId}', ${streak}); closeStreakMilestoneModal();">
                             Share Milestone
                        </button>
                        <button class="share-btn share-btn-secondary" onclick="shareStreakAsImage('${gameId}', '${escapeHtml(game.name)}', '${game.icon}', ${streak}); closeStreakMilestoneModal();">
                             Share as Image
                        </button>
                        <button class="share-btn share-btn-skip" onclick="closeStreakMilestoneModal()">
                            Keep Playing
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            playSound('levelup');
            
            // Confetti for big milestones
            if (streak >= 30 && typeof confetti !== 'undefined') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function closeStreakMilestoneModal() {
            const modal = document.getElementById('streak-milestone-modal');
            if (modal) modal.remove();
        }

        async function shareStreakAsImage(gameId, gameName, gameIcon, streak) {
            // Set data for share card generation
            enhancedShareData.gameId = gameId;
            enhancedShareData.gameName = gameName;
            enhancedShareData.gameIcon = gameIcon;
            enhancedShareData.streak = streak;
            
            await shareAsImage('streak');
        }

        function showWalletModal() {
            // Update balance displays
            const modalTokens = document.getElementById('wallet-modal-tokens');
            const modalCoins = document.getElementById('wallet-modal-coins');
            
            if (modalTokens) {
                modalTokens.textContent = (userData.wallet?.tokens || 0).toLocaleString();
            }
            if (modalCoins) {
                modalCoins.textContent = (userData.wallet?.coins || 0).toLocaleString();
            }
            
            // Render transaction history
            renderTransactionHistory();
            
            document.getElementById('wallet-modal').classList.add('active');
        }

        function closeWalletModal() {
            document.getElementById('wallet-modal').classList.remove('active');
        }

        // Coin purchase system
        function showBuyCoinsModal() {
            const modal = document.getElementById('buy-coins-modal');
            const ageNotice = document.getElementById('age-notice');
            const purchaseContent = document.getElementById('coin-purchase-content');
            
            modal.classList.add('active');
            
            // Check if already verified
            if (userData.wallet?.ageVerified) {
                ageNotice.style.display = 'none';
                purchaseContent.style.display = 'block';
            } else {
                ageNotice.style.display = 'block';
                purchaseContent.style.display = 'none';
            }
        }

        function closeBuyCoinsModal() {
            document.getElementById('buy-coins-modal').classList.remove('active');
        }
        
        function verifyAge(isAdult) {
            const ageNotice = document.getElementById('age-notice');
            const purchaseContent = document.getElementById('coin-purchase-content');
            
            if (isAdult) {
                userData.wallet.ageVerified = true;
                saveData();
                ageNotice.style.display = 'none';
                purchaseContent.style.display = 'block';
            } else {
                closeBuyCoinsModal();
                showToast('Coin purchases require you to be 18+');
            }
        }

        function selectCoinPack(index) {
            const pack = COIN_PACKS[index];
            if (!pack) return;
            
            // Start Stripe checkout
            startStripeCheckout('coin_pack', pack);
        }

        async function processCoinPurchase(pack) {
            // This is now handled by Stripe webhook after successful payment
            // Called from handlePaymentSuccess when returning from Stripe
            
            // Add coins to wallet
            earnCoins(pack.coins, ` Purchased ${pack.coins} Coins (${pack.label})`);
            
            closeBuyCoinsModal();
            showToast(` Added ${pack.coins} Coins!`);
            playSound('coin');
            
            // Log purchase
            console.log('Purchase completed:', {
                pack: pack.id,
                coins: pack.coins,
                price: pack.price,
                timestamp: Date.now()
            });
        }
        
        // ============ STRIPE INTEGRATION ============
        
        // Note: STRIPE_CONFIG is declared earlier in the file
        
        let stripePromise = null;
        
        function getStripe() {
            if (!stripePromise) {
                stripePromise = loadStripeJS().then(() => {
                    return Stripe(STRIPE_CONFIG.publishableKey);
                });
            }
            return stripePromise;
        }
        
        function loadStripeJS() {
            return new Promise((resolve, reject) => {
                if (window.Stripe) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://js.stripe.com/v3/';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load Stripe'));
                document.head.appendChild(script);
            });
        }
        
        async function startStripeCheckout(type, item) {
            showToast('Connecting to payment...');
            
            try {
                const stripe = await getStripe();
                
                // Determine price ID
                let priceId;
                let mode = 'payment'; // one-time payment
                
                if (type === 'coin_pack') {
                    priceId = STRIPE_CONFIG.prices[`coin_${item.id}`];
                } else if (type === 'subscription') {
                    priceId = STRIPE_CONFIG.prices[`pro_${item.tier || item.id}`];
                    mode = 'subscription';
                }
                
                if (!priceId || priceId.includes('XXXXXXXX')) {
                    // Demo mode - simulate purchase
                    console.log('Demo mode: Stripe not configured');
                    await simulatePurchase(type, item);
                    return;
                }
                
                // Create checkout session via API
                const response = await fetch(STRIPE_CONFIG.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: priceId,
                        mode: mode,
                        userId: userData.odid || 'anonymous',
                        itemType: type,
                        itemId: item.id,
                        successUrl: window.location.origin + window.location.pathname + '?payment=success&type=' + type + '&item=' + item.id,
                        cancelUrl: window.location.origin + window.location.pathname + '?payment=cancelled'
                    })
                });
                
                const session = await response.json();
                
                if (session.error) {
                    throw new Error(session.error);
                }
                
                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: session.sessionId
                });
                
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
            } catch (error) {
                console.error('Stripe checkout error:', error);
                showToast('Payment connection failed. Using demo mode.');
                await simulatePurchase(type, item);
            }
        }
        
        async function simulatePurchase(type, item) {
            // Demo mode - simulate successful purchase
            const confirmed = confirm(
                ` DEMO MODE\n\n` +
                `In production, this would redirect to Stripe.\n\n` +
                `Simulate purchase of ${type === 'coin_pack' ? item.coins + ' Coins' : item.name}?`
            );
            
            if (confirmed) {
                showToast('Processing demo purchase...');
                await new Promise(r => setTimeout(r, 1000));
                
                if (type === 'coin_pack') {
                    processCoinPurchase(item);
                } else {
                    processSubscriptionSuccess(item);
                }
            }
        }
        
        // Handle return from Stripe checkout
        function handlePaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const payment = urlParams.get('payment');
            const type = urlParams.get('type');
            const itemId = urlParams.get('item');
            
            if (payment === 'success') {
                // Clean URL
                window.history.replaceState({}, '', window.location.pathname);
                
                // Process the successful payment
                handlePaymentSuccess(type, itemId);
            } else if (payment === 'cancelled') {
                window.history.replaceState({}, '', window.location.pathname);
                showToast('Payment cancelled');
            }
        }
        
        function handlePaymentSuccess(type, itemId) {
            showToast(' Payment successful!');
            playSound('coin');
            
            if (type === 'coin_pack') {
                const pack = COIN_PACKS.find(p => p.id === itemId);
                if (pack) {
                    earnCoins(pack.coins, ` Purchased ${pack.coins} Coins`);
                    closeBuyCoinsModal();
                }
            } else if (type === 'subscription') {
                const tier = itemId;
                const subscription = SUBSCRIPTION_TIERS[tier];
                if (subscription) {
                    processSubscriptionSuccess(subscription, tier);
                }
            }
            
            updateWalletDisplay();
        }
        
        // Subscription functions
        function showSubscriptionModal() {
            if (!userData.wallet?.ageVerified) {
                // Need to verify age first
                const confirmed = confirm('Subscriptions require you to be 18+.\n\nAre you 18 or older?');
                if (confirmed) {
                    userData.wallet.ageVerified = true;
                    saveData();
                } else {
                    showToast('Subscriptions require you to be 18+');
                    return;
                }
            }
            document.getElementById('subscription-modal').classList.add('active');
        }
        
        function closeSubscriptionModal() {
            document.getElementById('subscription-modal').classList.remove('active');
        }
        
        function selectSubscription(tier) {
            const subscription = SUBSCRIPTION_TIERS[tier];
            if (!subscription) return;
            
            // Start Stripe checkout for subscription
            startStripeCheckout('subscription', { ...subscription, tier });
        }
        
        function processSubscriptionSuccess(subscription, tier) {
            // Calculate expiration
            const now = Date.now();
            const expiresAt = tier === 'annual' 
                ? now + (365 * 24 * 60 * 60 * 1000)
                : now + (30 * 24 * 60 * 60 * 1000);
            
            // Set subscription
            userData.wallet.subscription = {
                tier: tier,
                name: subscription.name,
                startedAt: now,
                expiresAt: expiresAt,
                stripeSubscriptionId: null, // Set by webhook in production
                lastCoinDistribution: null
            };
            
            // Award first month's coins
            earnCoins(10, ' Pro subscription welcome coins');
            userData.wallet.subscription.lastCoinDistribution = getTodayString().substring(0, 7);
            
            saveData();
            closeSubscriptionModal();
            updateWalletDisplay();
            showToast(` Welcome to Game Shelf Pro!`);
            playSound('achievement');
        }
        
        async function processSubscription(subscription, tier) {
            // Legacy function - now uses Stripe
            selectSubscription(tier);
        }
        
        // Customer portal for managing subscription
        async function openCustomerPortal() {
            try {
                const response = await fetch('/api/create-portal-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userData.odid,
                        returnUrl: window.location.href
                    })
                });
                
                const { url } = await response.json();
                if (url) {
                    window.location.href = url;
                }
            } catch (error) {
                console.error('Portal error:', error);
                showToast('Unable to open billing portal');
            }
        }

        // ============ GAME TRACKING SETTINGS ============
        let currentTrackingGameId = null;
        let selectedTrackingSource = null;
        let selectedEntryMethod = null;
        
        function showGameTrackingModal(gameId) {
            currentTrackingGameId = gameId;
            
            // Find game info
            const allGames = [...FEATURED_GAMES, ...POPULAR_GAMES, ...(userData.games || [])];
            const game = allGames.find(g => g.id === gameId);
            
            if (!game) return;
            
            // Set header
            document.getElementById('tracking-game-icon').textContent = game.icon || '';
            document.getElementById('tracking-game-name').textContent = game.name;
            
            // Get existing settings
            const settings = userData.gameSettings?.[gameId] || {};
            selectedTrackingSource = settings.trackingSource || null;
            selectedEntryMethod = settings.entryMethod || null;
            
            // Render tracking source options
            renderTrackingSourceOptions();
            
            // Render entry method options
            renderEntryMethodOptions();
            
            // Set toggles
            const cloudSyncCheckbox = document.getElementById('tracking-cloud-sync');
            const goalCheckbox = document.getElementById('tracking-goal-enabled');
            
            if (cloudSyncCheckbox) cloudSyncCheckbox.checked = settings.cloudSync || false;
            if (goalCheckbox) goalCheckbox.checked = settings.goalEnabled !== false; // Default true
            
            document.getElementById('game-tracking-modal').classList.add('active');
        }
        
        function closeGameTrackingModal() {
            document.getElementById('game-tracking-modal').classList.remove('active');
            currentTrackingGameId = null;
        }
        
        function renderTrackingSourceOptions() {
            const container = document.getElementById('tracking-source-options');
            if (!container) return;
            
            container.innerHTML = Object.values(TRACKING_SOURCES).map(source => `
                <div class="tracking-option ${selectedTrackingSource === source.id ? 'selected' : ''}" 
                     onclick="selectTrackingSource('${source.id}')">
                    <div class="tracking-option-radio"></div>
                    <div class="tracking-option-icon">${source.icon}</div>
                    <div class="tracking-option-content">
                        <div class="tracking-option-label">${source.label}</div>
                        <div class="tracking-option-desc">${source.description}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function selectTrackingSource(sourceId) {
            selectedTrackingSource = sourceId;
            
            // Auto-select first available entry method for this source
            const source = TRACKING_SOURCES[sourceId];
            if (source && source.entryMethods.length > 0) {
                const validMethod = source.entryMethods.find(m => !ENTRY_METHODS[m]?.comingSoon);
                selectedEntryMethod = validMethod || source.entryMethods[0];
            }
            
            renderTrackingSourceOptions();
            renderEntryMethodOptions();
        }
        
        function renderEntryMethodOptions() {
            const container = document.getElementById('entry-method-options');
            if (!container) return;
            
            // Get available methods based on selected source
            const source = TRACKING_SOURCES[selectedTrackingSource];
            const availableMethods = source ? source.entryMethods : ['manual', 'share'];
            
            container.innerHTML = availableMethods.map(methodId => {
                const method = ENTRY_METHODS[methodId];
                if (!method) return '';
                
                const isDisabled = method.comingSoon;
                const isSelected = selectedEntryMethod === methodId;
                
                return `
                    <div class="tracking-option ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                         onclick="${isDisabled ? '' : `selectEntryMethod('${methodId}')`}">
                        <div class="tracking-option-radio"></div>
                        <div class="tracking-option-icon">${method.icon}</div>
                        <div class="tracking-option-content">
                            <div class="tracking-option-label">${method.label}</div>
                            <div class="tracking-option-desc">${method.description}</div>
                        </div>
                        ${method.comingSoon ? '<span class="coming-soon-tag">SOON</span>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        function selectEntryMethod(methodId) {
            selectedEntryMethod = methodId;
            renderEntryMethodOptions();
        }
        
        function saveGameTrackingSettings() {
            if (!currentTrackingGameId) return;
            
            // Ensure gameSettings exists
            if (!userData.gameSettings) {
                userData.gameSettings = {};
            }
            
            // Save settings
            userData.gameSettings[currentTrackingGameId] = {
                trackingSource: selectedTrackingSource,
                entryMethod: selectedEntryMethod,
                cloudSync: document.getElementById('tracking-cloud-sync')?.checked || false,
                goalEnabled: document.getElementById('tracking-goal-enabled')?.checked !== false,
                configuredAt: Date.now()
            };
            
            saveData();
            closeGameTrackingModal();
            showToast(' Tracking settings saved!');
        }
        
        function getGameTrackingSettings(gameId) {
            return userData.gameSettings?.[gameId] || {
                trackingSource: null,
                entryMethod: 'manual',
                cloudSync: false,
                goalEnabled: true
            };
        }
        
        function needsTrackingSetup(gameId) {
            const settings = userData.gameSettings?.[gameId];
            return !settings || !settings.trackingSource;
        }

        function renderTransactionHistory() {
            const container = document.getElementById('transaction-list');
            if (!container) return;
            
            const transactions = userData.wallet?.transactions || [];
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="transaction-empty">No transactions yet. Play games to earn tokens!</div>';
                return;
            }
            
            container.innerHTML = transactions.slice(0, 20).map(t => {
                const currencyIcon = t.currency === 'coins' ? '' : '';
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-reason">${t.reason}</div>
                            <div class="transaction-date">${formatTransactionDate(t.timestamp || t.date)}</div>
                        </div>
                        <div class="transaction-amount ${t.type === 'earn' ? 'positive' : 'negative'}">
                            ${t.type === 'earn' ? '+' : '-'}${t.amount} ${currencyIcon}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTransactionDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // ============ BRAIN BATTLE SYSTEM ============
        let currentBattleType = 'challenge';
        let selectedBattleFriends = [];
        let userBattles = [];
        let pendingInvites = [];
        let battleListeners = {};

        function initBattleTab() {
            const signinPrompt = document.getElementById('battle-signin-prompt');
            const battleContent = document.getElementById('battle-content');
            
            if (currentUser) {
                signinPrompt.style.display = 'none';
                battleContent.style.display = 'block';
                loadUserBattles();
                loadPendingInvites();
                setupBattleListeners();
            } else {
                signinPrompt.style.display = 'block';
                battleContent.style.display = 'none';
            }
        }

        async function loadUserBattles() {
            if (!currentUser || !isFirebaseReady) return;
            
            try {
                // Load battles where user is a participant
                const battlesRef = firebase.database().ref('battles');
                const snapshot = await battlesRef.once('value');
                
                userBattles = [];
                snapshot.forEach(child => {
                    const battle = { id: child.key, ...child.val() };
                    // Include if user is participant or creator
                    if (battle.participants?.[currentUser.uid] || battle.createdBy === currentUser.uid) {
                        userBattles.push(battle);
                    }
                });
                
                // Check for battles that need completion
                userBattles.forEach(battle => {
                    if (battle.status === 'active' && battle.endDate < Date.now()) {
                        completeBattle(battle.id);
                    }
                });
                
                renderBattles();
            } catch (e) {
                console.log('Error loading battles:', e);
                renderBattles();
            }
        }

        async function loadPendingInvites() {
            if (!currentUser || !isFirebaseReady) return;
            
            try {
                const battlesRef = firebase.database().ref('battles');
                const snapshot = await battlesRef.once('value');
                
                pendingInvites = [];
                snapshot.forEach(child => {
                    const battle = { id: child.key, ...child.val() };
                    // Check if user has pending invite
                    if (battle.invites?.[currentUser.uid]?.status === 'pending') {
                        pendingInvites.push(battle);
                    }
                });
                
                renderPendingInvites();
            } catch (e) {
                console.log('Error loading invites:', e);
            }
        }

        function setupBattleListeners() {
            if (!currentUser || !isFirebaseReady) return;
            
            // Listen for new invites
            const battlesRef = firebase.database().ref('battles');
            battlesRef.on('child_changed', (snapshot) => {
                const battle = { id: snapshot.key, ...snapshot.val() };
                
                // Check if this affects us
                if (battle.invites?.[currentUser.uid]?.status === 'pending') {
                    // New invite!
                    if (!pendingInvites.find(b => b.id === battle.id)) {
                        pendingInvites.push(battle);
                        renderPendingInvites();
                        showToast(` New battle invite: ${battle.name}`);
                    }
                }
                
                // Update our battles list
                const idx = userBattles.findIndex(b => b.id === battle.id);
                if (idx >= 0) {
                    userBattles[idx] = battle;
                    renderBattles();
                }
            });
        }

        function renderPendingInvites() {
            // Add invite cards at top of active battles section
            if (pendingInvites.length === 0) return;
            
            const activeBattlesEl = document.getElementById('active-battles');
            const inviteHTML = pendingInvites.map(battle => {
                const creator = battle.participants?.[battle.createdBy];
                return `
                    <div class="battle-card invite-card">
                        <div class="battle-card-header" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                            
                            <span class="battle-badge" style="background: #9c27b0;">INVITE</span>
                        </div>
                        <div class="battle-card-content">
                            <div class="battle-card-title">${battle.name}</div>
                            <div class="battle-card-desc">From: ${creator?.displayName || 'Unknown'}</div>
                            <div class="battle-stats">
                                <div class="battle-stat"> ${battle.games?.join(', ') || 'Games'}</div>
                                <div class="battle-stat"> ${Math.ceil((battle.endDate - battle.startDate) / 86400000)} days</div>
                                ${battle.entryFee > 0 ? `<div class="battle-stat"> ${battle.entryFee} entry</div>` : ''}
                            </div>
                            <div class="btn-group" style="margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="declineBattleInvite('${battle.id}')" style="flex:1">Decline</button>
                                <button class="btn btn-primary" onclick="acceptBattleInvite('${battle.id}')" style="flex:1">Accept</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Prepend to active battles
            const existingContent = activeBattlesEl.innerHTML;
            if (!existingContent.includes('invite-card')) {
                activeBattlesEl.innerHTML = inviteHTML + existingContent;
            }
        }

        async function acceptBattleInvite(battleId) {
            if (!currentUser) return;
            
            try {
                const battle = pendingInvites.find(b => b.id === battleId);
                if (!battle) return;
                
                // Check if user has enough coins for entry fee
                if (battle.entryFee > 0) {
                    if (userData.wallet.coins < battle.entryFee) {
                        showToast('Not enough coins for entry fee!');
                        return;
                    }
                    spendCoins(battle.entryFee, ` Joined battle: ${battle.name}`);
                }
                
                // Update battle in Firebase
                const updates = {};
                updates[`battles/${battleId}/participants/${currentUser.uid}`] = {
                    odataId: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    score: 0,
                    joined: true,
                    joinedAt: Date.now()
                };
                updates[`battles/${battleId}/invites/${currentUser.uid}/status`] = 'accepted';
                
                // If all invites accepted, activate the battle
                const allAccepted = Object.values(battle.invites || {}).every(
                    inv => inv.status === 'accepted' || inv.status === 'declined'
                );
                if (allAccepted || Object.keys(battle.invites || {}).length === 1) {
                    updates[`battles/${battleId}/status`] = 'active';
                }
                
                await firebase.database().ref().update(updates);
                
                // Remove from pending
                pendingInvites = pendingInvites.filter(b => b.id !== battleId);
                
                showToast(' Battle joined! Game on!');
                loadUserBattles();
                
            } catch (e) {
                console.error('Error accepting invite:', e);
                showToast('Failed to accept. Try again.');
            }
        }

        async function declineBattleInvite(battleId) {
            if (!currentUser) return;
            
            try {
                await firebase.database().ref(`battles/${battleId}/invites/${currentUser.uid}/status`).set('declined');
                
                pendingInvites = pendingInvites.filter(b => b.id !== battleId);
                renderPendingInvites();
                loadUserBattles();
                
                showToast('Battle invite declined');
                
            } catch (e) {
                console.error('Error declining invite:', e);
            }
        }

        function renderBattles() {
            const activeBattlesEl = document.getElementById('active-battles');
            const tournamentsEl = document.getElementById('your-tournaments');
            const historyEl = document.getElementById('battle-history');
            
            const now = Date.now();
            const activeBattles = userBattles.filter(b => b.status === 'active' && b.type !== 'tournament');
            const pendingBattles = userBattles.filter(b => b.status === 'pending' && b.createdBy === currentUser?.uid);
            const tournaments = userBattles.filter(b => b.type === 'tournament' && b.status === 'active');
            const pastBattles = userBattles.filter(b => b.status === 'completed');
            
            // Render active + pending battles
            let battlesHTML = '';
            
            // First render pending invites
            if (pendingInvites.length > 0) {
                battlesHTML += pendingInvites.map(battle => {
                    const creator = battle.participants?.[battle.createdBy];
                    return `
                        <div class="battle-card invite-card">
                            <div class="battle-card-header" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                                
                                <span class="battle-badge" style="background: #9c27b0;">INVITE</span>
                            </div>
                            <div class="battle-card-content">
                                <div class="battle-card-title">${battle.name}</div>
                                <div class="battle-card-desc">From: ${creator?.displayName || 'Unknown'}</div>
                                <div class="battle-stats">
                                    <div class="battle-stat"> ${battle.games?.join(', ') || 'Games'}</div>
                                    ${battle.entryFee > 0 ? `<div class="battle-stat"> ${battle.entryFee} entry</div>` : ''}
                                </div>
                                <div class="btn-group" style="margin-top: 15px;">
                                    <button class="btn btn-secondary" onclick="declineBattleInvite('${battle.id}')" style="flex:1">Decline</button>
                                    <button class="btn btn-primary" onclick="acceptBattleInvite('${battle.id}')" style="flex:1">Accept</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Pending battles (waiting for opponent)
            if (pendingBattles.length > 0) {
                battlesHTML += pendingBattles.map(battle => renderBattleCard(battle, false, true)).join('');
            }
            
            // Active battles
            if (activeBattles.length > 0) {
                battlesHTML += activeBattles.map(battle => renderBattleCard(battle)).join('');
            }
            
            if (battlesHTML === '') {
                activeBattlesEl.innerHTML = `
                    <div class="battle-empty">
                        <div class="empty-icon"></div>
                        <p>No active battles</p>
                        <p class="empty-hint">Challenge a friend or join a tournament to get started!</p>
                    </div>
                `;
            } else {
                activeBattlesEl.innerHTML = battlesHTML;
            }
            
            // Render tournaments
            if (tournaments.length === 0) {
                tournamentsEl.innerHTML = `<div class="battle-empty"><p>No tournament entries yet</p></div>`;
            } else {
                tournamentsEl.innerHTML = tournaments.map(t => renderTournamentCard(t)).join('');
            }
            
            // Render history
            if (pastBattles.length === 0) {
                historyEl.innerHTML = `<div class="battle-empty"><p>No completed battles yet</p></div>`;
            } else {
                historyEl.innerHTML = pastBattles.slice(0, 10).map(b => renderBattleCard(b, true)).join('');
            }
        }

        function renderBattleCard(battle, isPast = false, isPending = false) {
            const participants = Object.entries(battle.participants || {})
                .map(([odataId, data]) => ({ odataId, ...data }))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const daysLeft = Math.ceil((battle.endDate - Date.now()) / 86400000);
            const prizePool = battle.entryFee ? battle.entryFee * participants.length : 0;
            const isCreator = battle.createdBy === currentUser?.uid;
            
            let statusBadge = '<span class="battle-badge live">LIVE</span>';
            let statusIcon = '';
            if (isPast) {
                statusBadge = '<span class="battle-badge">ENDED</span>';
                statusIcon = '';
            } else if (isPending) {
                statusBadge = '<span class="battle-badge" style="background: #ff9800;">PENDING</span>';
                statusIcon = '';
            }
            
            return `
                <div class="battle-card" onclick="showBattleDetails('${battle.id}')">
                    <div class="battle-card-header ${battle.type}">
                        ${battle.type === 'challenge' ? '' : ''}
                        ${statusBadge}
                    </div>
                    <div class="battle-card-content">
                        <div class="battle-card-title">${battle.name || 'Brain Battle'}</div>
                        ${battle.description ? `<div class="battle-card-desc">"${battle.description}"</div>` : ''}
                        ${isPending && isCreator && battle.joinCode ? `
                            <div class="battle-join-code-display" style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">Share this code:</div>
                                <div style="font-family: monospace; font-size: 1.4rem; letter-spacing: 4px; color: var(--accent-gold); font-weight: 700;">${battle.joinCode}</div>
                            </div>
                        ` : ''}
                        ${isPending && !isCreator ? `<div class="battle-card-desc" style="color: var(--accent-gold);">Waiting for you to accept...</div>` : ''}
                        ${isPending && isCreator ? `<div class="battle-card-desc" style="color: var(--text-muted);">Waiting for opponent to join...</div>` : ''}
                        <div class="battle-stats">
                            <div class="battle-stat">${statusIcon} ${isPast ? 'Ended' : (isPending ? 'Not started' : daysLeft + ' days left')}</div>
                            ${prizePool > 0 ? `<div class="battle-stat"> ${prizePool} coins</div>` : ''}
                            <div class="battle-stat"> ${participants.length} player${participants.length !== 1 ? 's' : ''}</div>
                            <div class="battle-stat"> ${battle.games?.length || 0} game${(battle.games?.length || 0) !== 1 ? 's' : ''}</div>
                        </div>
                        ${!isPending && participants.length > 0 ? `
                        <div class="battle-leaderboard">
                            ${participants.slice(0, 3).map((p, i) => `
                                <div class="battle-leaderboard-row">
                                    <div class="battle-rank">${['', '', ''][i]}</div>
                                    <div class="battle-participant-avatar" style="background: ${getAvatarColor(p.displayName)}">${(p.displayName || 'U')[0]}</div>
                                    <div class="battle-participant-name">
                                        ${p.displayName || 'Unknown'}
                                        ${p.odataId === currentUser?.uid ? '<span class="you-badge">YOU</span>' : ''}
                                    </div>
                                    <div class="battle-participant-score">${p.score || 0}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTournamentCard(tournament) {
            const myData = tournament.participants?.[currentUser?.uid];
            const isAlive = myData?.alive !== false;
            const totalParticipants = Object.keys(tournament.participants || {}).length;
            const aliveCount = Object.values(tournament.participants || {}).filter(p => p.alive !== false).length;
            const dayNumber = Math.floor((Date.now() - tournament.startDate) / 86400000) + 1;
            const totalDays = Math.ceil((tournament.endDate - tournament.startDate) / 86400000);
            const progress = (dayNumber / totalDays) * 100;
            
            return `
                <div class="tournament-card">
                    <div class="tournament-header">
                        <div class="tournament-icon"></div>
                        <div>
                            <div class="tournament-title">${tournament.name}</div>
                            <div class="tournament-subtitle">${tournament.subtitle || 'Last Person Standing'}</div>
                        </div>
                    </div>
                    <div class="tournament-stats">
                        <div class="tournament-stat">
                            <div class="tournament-stat-value"> ${((tournament.entryFee || 0) * totalParticipants / 1000).toFixed(0)}K</div>
                            <div class="tournament-stat-label">Prize Pool</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">${aliveCount}</div>
                            <div class="tournament-stat-label">Alive</div>
                        </div>
                        <div class="tournament-stat">
                            <div class="tournament-stat-value">Day ${dayNumber}</div>
                            <div class="tournament-stat-label">of ${totalDays}</div>
                        </div>
                    </div>
                    <div class="tournament-progress">
                        <div class="tournament-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="status-alive ${isAlive ? '' : 'status-eliminated'}">
                            ${isAlive ? ' YOU\'RE ALIVE' : ' ELIMINATED'}
                        </span>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">
                            ${isAlive ? ' Complete today\'s games' : ''}
                        </span>
                    </div>
                </div>
            `;
        }

        // Score a game completion for all active battles
        async function updateBattleScores(gameId, rawScore, scoreData = null) {
            if (!currentUser || !isFirebaseReady) return;
            
            const today = getTodayString();
            
            for (const battle of userBattles) {
                if (battle.status !== 'active') continue;
                if (!battle.games?.includes(gameId)) continue;
                if (!battle.participants?.[currentUser.uid]) continue;
                
                // Check if already scored today for this game
                const dailyKey = `${today}_${gameId}`;
                const participant = battle.participants[currentUser.uid];
                if (participant.dailyScores?.[dailyKey]) continue;
                
                // Use extractNumericScore for consistent battle points
                let points = extractNumericScore(gameId, scoreData || { score: rawScore, success: true });
                
                // Ensure minimum points for completion
                if (points < 5) points = 5;
                
                try {
                    const newScore = (participant.score || 0) + points;
                    const updates = {};
                    updates[`battles/${battle.id}/participants/${currentUser.uid}/score`] = newScore;
                    updates[`battles/${battle.id}/participants/${currentUser.uid}/dailyScores/${dailyKey}`] = points;
                    updates[`battles/${battle.id}/participants/${currentUser.uid}/lastActivity`] = Date.now();
                    
                    await firebase.database().ref().update(updates);
                    
                    console.log(`Battle ${battle.name}: +${points} points for ${gameId}`);
                    showToast(` +${points} pts in "${battle.name}"!`);
                } catch (e) {
                    console.error('Error updating battle score:', e);
                }
            }
            
            // Refresh battles display
            loadUserBattles();
        }

        // Complete a battle and distribute prizes
        async function completeBattle(battleId) {
            if (!currentUser || !isFirebaseReady) return;
            
            try {
                const battleRef = firebase.database().ref(`battles/${battleId}`);
                const snapshot = await battleRef.once('value');
                const battle = snapshot.val();
                
                if (!battle || battle.status === 'completed') return;
                
                // Determine winner(s)
                const participants = Object.entries(battle.participants || {})
                    .map(([odataId, data]) => ({ odataId, ...data }))
                    .sort((a, b) => (b.score || 0) - (a.score || 0));
                
                if (participants.length === 0) return;
                
                const winner = participants[0];
                const prizePool = (battle.entryFee || 0) * participants.length;
                
                // Update battle status
                await battleRef.update({
                    status: 'completed',
                    completedAt: Date.now(),
                    winner: {
                        odataId: winner.odataId,
                        displayName: winner.displayName,
                        score: winner.score
                    },
                    prizePool: prizePool
                });
                
                // Award prize to winner
                if (prizePool > 0 && winner.odataId === currentUser.uid) {
                    earnCoins(prizePool, ` Won "${battle.name}"!`);
                    showToast(` You won ${prizePool} coins in "${battle.name}"!`);
                } else if (winner.odataId === currentUser.uid) {
                    showToast(` You won "${battle.name}"!`);
                }
                
                // Notify other participants (they'll see when they load)
                
            } catch (e) {
                console.error('Error completing battle:', e);
            }
        }

        // Current battle being viewed for real-time updates
        let currentBattleView = null;
        let battleListener = null;

        function showBattleDetails(battleId) {
            const battle = userBattles.find(b => b.id === battleId);
            if (!battle) return;
            
            currentBattleView = battleId;
            
            // Setup real-time listener
            setupBattleDetailListener(battleId);
            
            // Populate modal
            updateBattleDetailsModal(battle);
            
            // Show modal
            document.getElementById('battle-details-modal').classList.add('active');
        }
        
        function updateBattleDetailsModal(battle) {
            const participants = Object.entries(battle.participants || {})
                .map(([odataId, data]) => ({ odataId, ...data }))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const daysLeft = Math.ceil((battle.endDate - Date.now()) / 86400000);
            const prizePool = battle.entryFee ? battle.entryFee * participants.length : 0;
            const isCompleted = battle.status === 'completed';
            const isPending = battle.status === 'pending';
            const today = getTodayString();
            
            // Title
            document.getElementById('battle-details-title').textContent = ` ${battle.name}`;
            
            // Status banner
            const banner = document.getElementById('battle-status-banner');
            if (isCompleted) {
                const winner = participants[0];
                const isWinner = winner?.odataId === currentUser?.uid;
                banner.style.background = isWinner ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'var(--bg-secondary)';
                banner.style.color = isWinner ? '#000' : 'var(--text-primary)';
                banner.innerHTML = isWinner 
                    ? ' YOU WON!' 
                    : ` Winner: ${winner?.displayName || 'Unknown'}`;
            } else if (isPending) {
                banner.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                banner.style.color = '#fff';
                banner.innerHTML = ' Waiting for players to join...';
            } else {
                banner.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                banner.style.color = '#fff';
                banner.innerHTML = ` LIVE  ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left`;
            }
            
            // Games list
            document.getElementById('battle-games-list').textContent = battle.games?.map(g => {
                const gameNames = { wordle: 'Wordle', connections: 'Connections', mini: 'Mini', strands: 'Strands' };
                return gameNames[g] || g;
            }).join(', ') || '-';
            
            // Time left
            document.getElementById('battle-time-left').textContent = isCompleted 
                ? 'Ended ' + new Date(battle.completedAt || battle.endDate).toLocaleDateString()
                : isPending ? 'Not started' : `${daysLeft} days`;
            
            // Prize pool
            if (prizePool > 0) {
                document.getElementById('battle-prize-stat').style.display = 'flex';
                document.getElementById('battle-prize-pool').textContent = ` ${prizePool}`;
            } else {
                document.getElementById('battle-prize-stat').style.display = 'none';
            }
            
            // Share code section (for pending battles created by current user)
            const shareCodeSection = document.getElementById('battle-share-code-section');
            if (isPending && battle.createdBy === currentUser?.uid && battle.joinCode) {
                shareCodeSection.style.display = 'block';
                document.getElementById('battle-join-code').textContent = battle.joinCode;
            } else {
                shareCodeSection.style.display = 'none';
            }
            
            // Live indicator
            document.getElementById('battle-live-indicator').style.display = isCompleted ? 'none' : 'inline';
            
            // Leaderboard
            const leaderboardEl = document.getElementById('battle-leaderboard');
            leaderboardEl.innerHTML = participants.map((p, i) => `
                <div class="detail-leaderboard-row ${p.odataId === currentUser?.uid ? 'current-user' : ''} ${i === 0 && isCompleted ? 'winner' : ''}">
                    <div class="detail-rank">${i < 3 ? ['', '', ''][i] : (i + 1)}</div>
                    <div class="detail-avatar" style="background: ${getAvatarColor(p.displayName)}">${(p.displayName || 'U')[0]}</div>
                    <div class="detail-name">
                        ${p.displayName || 'Unknown'}
                        ${p.odataId === currentUser?.uid ? '<span class="you-badge">YOU</span>' : ''}
                        ${i === 0 && isCompleted ? '<span class="winner-badge"></span>' : ''}
                    </div>
                    <div class="detail-score">${p.score || 0} pts</div>
                </div>
            `).join('') || '<div style="color: var(--text-muted); text-align: center; padding: 15px;">No participants yet</div>';
            
            // Today's scores
            const todayScoresEl = document.getElementById('battle-today-scores');
            const todayScores = [];
            participants.forEach(p => {
                if (p.dailyScores) {
                    Object.entries(p.dailyScores).forEach(([key, score]) => {
                        if (key.startsWith(today)) {
                            const gameId = key.split('_')[1];
                            todayScores.push({
                                name: p.displayName,
                                game: gameId,
                                score: score,
                                isMe: p.odataId === currentUser?.uid
                            });
                        }
                    });
                }
            });
            
            if (todayScores.length > 0) {
                todayScoresEl.innerHTML = todayScores.map(s => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--bg-hover);">
                        <span>${s.isMe ? ' You' : s.name}</span>
                        <span style="color: var(--text-muted);">${s.game}</span>
                        <span style="color: var(--accent-green);">+${s.score} pts</span>
                    </div>
                `).join('');
            } else {
                todayScoresEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 15px;">No scores yet today</div>';
            }
            
            // Activity feed
            const activityEl = document.getElementById('battle-activity-feed');
            const activities = [];
            participants.forEach(p => {
                if (p.dailyScores) {
                    Object.entries(p.dailyScores).forEach(([key, score]) => {
                        const [date, gameId] = key.split('_');
                        activities.push({
                            name: p.displayName,
                            game: gameId,
                            score: score,
                            date: date,
                            isMe: p.odataId === currentUser?.uid
                        });
                    });
                }
            });
            activities.sort((a, b) => b.date.localeCompare(a.date));
            
            if (activities.length > 0) {
                activityEl.innerHTML = activities.slice(0, 20).map(a => `
                    <div style="padding: 8px 0; border-bottom: 1px solid var(--bg-hover); font-size: 0.85rem;">
                        <span style="color: ${a.isMe ? 'var(--accent-green)' : 'var(--text-primary)'};">${a.isMe ? 'You' : a.name}</span>
                        scored <span style="color: var(--accent-gold);">+${a.score}</span> in ${a.game}
                        <span style="color: var(--text-muted); float: right;">${a.date}</span>
                    </div>
                `).join('');
            } else {
                activityEl.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 15px;">No activity yet</div>';
            }
        }
        
        function setupBattleDetailListener(battleId) {
            // Remove existing listener
            if (battleListener) {
                firebase.database().ref(`battles/${battleId}`).off('value', battleListener);
            }
            
            // Setup new listener for real-time updates
            battleListener = firebase.database().ref(`battles/${battleId}`).on('value', (snapshot) => {
                if (snapshot.exists() && currentBattleView === battleId) {
                    const battle = { id: snapshot.key, ...snapshot.val() };
                    // Update the local cache too
                    const idx = userBattles.findIndex(b => b.id === battleId);
                    if (idx >= 0) {
                        userBattles[idx] = battle;
                    }
                    updateBattleDetailsModal(battle);
                }
            });
        }
        
        function getAvatarColor(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            const hash = (name || 'U').charCodeAt(0);
            return colors[hash % colors.length];
        }

        function closeBattleDetails() {
            // Remove real-time listener
            if (battleListener && currentBattleView) {
                firebase.database().ref(`battles/${currentBattleView}`).off('value', battleListener);
                battleListener = null;
            }
            currentBattleView = null;
            document.getElementById('battle-details-modal').classList.remove('active');
        }
        
        function copyBattleCode() {
            const code = document.getElementById('battle-join-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast(' Code copied!');
            }).catch(() => {
                showToast('Copy: ' + code);
            });
        }
        
        function shareBattleResults() {
            const battle = userBattles.find(b => b.id === currentBattleView);
            if (!battle) return;
            
            const participants = Object.entries(battle.participants || {})
                .map(([odataId, data]) => ({ odataId, ...data }))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const myRank = participants.findIndex(p => p.odataId === currentUser?.uid) + 1;
            const myScore = participants.find(p => p.odataId === currentUser?.uid)?.score || 0;
            
            const shareText = ` Brain Battle: ${battle.name}\n\n` +
                `My rank: ${['', '', ''][myRank - 1] || '#' + myRank}\n` +
                `My score: ${myScore} pts\n` +
                `Players: ${participants.length}\n\n` +
                ` gameshelf.app`;
            
            if (navigator.share) {
                navigator.share({ title: 'Brain Battle Results', text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                showToast(' Results copied!');
            }
        }
        
        // ============ JOIN BATTLE BY CODE ============
        
        function showJoinBattleModal() {
            document.getElementById('join-code-input').value = '';
            document.getElementById('join-battle-preview').style.display = 'none';
            document.getElementById('join-battle-error').style.display = 'none';
            document.getElementById('join-battle-modal').classList.add('active');
            
            // Focus input
            setTimeout(() => document.getElementById('join-code-input').focus(), 100);
            
            // Setup code input listener
            document.getElementById('join-code-input').oninput = debounce(lookupBattleByCode, 500);
        }
        
        function closeJoinBattleModal() {
            document.getElementById('join-battle-modal').classList.remove('active');
        }
        
        async function lookupBattleByCode() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            const previewEl = document.getElementById('join-battle-preview');
            const errorEl = document.getElementById('join-battle-error');
            
            if (code.length < 6) {
                previewEl.style.display = 'none';
                errorEl.style.display = 'none';
                return;
            }
            
            try {
                // Look up battle by join code
                const snapshot = await firebase.database().ref('battles')
                    .orderByChild('joinCode')
                    .equalTo(code)
                    .limitToFirst(1)
                    .once('value');
                
                if (snapshot.exists()) {
                    let battle = null;
                    snapshot.forEach(child => {
                        battle = { id: child.key, ...child.val() };
                    });
                    
                    if (battle) {
                        // Check if already joined
                        if (battle.participants?.[currentUser?.uid]) {
                            errorEl.textContent = 'You already joined this battle!';
                            errorEl.style.display = 'block';
                            previewEl.style.display = 'none';
                            return;
                        }
                        
                        // Show preview
                        const participantCount = Object.keys(battle.participants || {}).length;
                        document.getElementById('join-battle-name').textContent = battle.name;
                        document.getElementById('join-battle-info').textContent = 
                            `${battle.games?.join(', ')}  ${participantCount} player${participantCount !== 1 ? 's' : ''}  ${battle.entryFee ? battle.entryFee + ' coins entry' : 'Free'}`;
                        
                        previewEl.style.display = 'block';
                        previewEl.dataset.battleId = battle.id;
                        errorEl.style.display = 'none';
                    }
                } else {
                    errorEl.textContent = 'Battle not found. Check the code and try again.';
                    errorEl.style.display = 'block';
                    previewEl.style.display = 'none';
                }
            } catch (e) {
                console.error('Error looking up battle:', e);
                errorEl.textContent = 'Error looking up battle. Try again.';
                errorEl.style.display = 'block';
            }
        }
        
        async function joinBattleByCode() {
            const previewEl = document.getElementById('join-battle-preview');
            const battleId = previewEl.dataset.battleId;
            
            if (!battleId || previewEl.style.display === 'none') {
                showToast('Enter a valid battle code first');
                return;
            }
            
            try {
                const battleRef = firebase.database().ref(`battles/${battleId}`);
                const snapshot = await battleRef.once('value');
                
                if (!snapshot.exists()) {
                    showToast('Battle not found');
                    return;
                }
                
                const battle = snapshot.val();
                
                // Check entry fee
                if (battle.entryFee > 0) {
                    if (userData.wallet.coins < battle.entryFee) {
                        showToast('Not enough coins for entry fee!');
                        return;
                    }
                    spendCoins(battle.entryFee, ` Joined battle: ${battle.name}`);
                }
                
                // Add participant
                const now = Date.now();
                await battleRef.child(`participants/${currentUser.uid}`).set({
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    score: 0,
                    joined: true,
                    joinedAt: now,
                    dailyScores: {}
                });
                
                // If enough participants, start the battle
                const participantCount = Object.keys(battle.participants || {}).length + 1;
                if (battle.status === 'pending' && participantCount >= 2) {
                    await battleRef.update({
                        status: 'active',
                        startedAt: now
                    });
                }
                
                showToast(' Joined battle!');
                playSound('achievement');
                closeJoinBattleModal();
                loadUserBattles();
                
            } catch (e) {
                console.error('Error joining battle:', e);
                showToast('Failed to join battle. Try again.');
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ============ BATTLE WINNER MODAL ============
        
        function showWinnerModal(battle) {
            const participants = Object.entries(battle.participants || {})
                .map(([odataId, data]) => ({ odataId, ...data }))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const winner = participants[0];
            const second = participants[1];
            const third = participants[2];
            const isWinner = winner?.odataId === currentUser?.uid;
            const prizePool = battle.entryFee ? battle.entryFee * participants.length : 0;
            
            // Set celebration
            document.getElementById('winner-celebration').textContent = isWinner ? '' : '';
            document.getElementById('winner-title').textContent = isWinner ? 'You Won!' : 'Battle Complete!';
            document.getElementById('winner-message').textContent = isWinner 
                ? `Congratulations! You dominated ${battle.name}!`
                : `${winner?.displayName || 'Someone'} won ${battle.name}`;
            
            // Podium
            if (winner) {
                const podium1 = document.getElementById('podium-1');
                podium1.querySelector('.podium-avatar').textContent = (winner.displayName || 'W')[0];
                podium1.querySelector('.podium-name').textContent = winner.displayName || 'Winner';
                podium1.querySelector('.podium-score').textContent = winner.score + ' pts';
            }
            if (second) {
                const podium2 = document.getElementById('podium-2');
                podium2.querySelector('.podium-avatar').textContent = (second.displayName || 'S')[0];
                podium2.querySelector('.podium-name').textContent = second.displayName || '2nd';
                podium2.querySelector('.podium-score').textContent = second.score + ' pts';
                podium2.style.display = 'block';
            } else {
                document.getElementById('podium-2').style.display = 'none';
            }
            if (third) {
                const podium3 = document.getElementById('podium-3');
                podium3.querySelector('.podium-avatar').textContent = (third.displayName || 'T')[0];
                podium3.querySelector('.podium-name').textContent = third.displayName || '3rd';
                podium3.querySelector('.podium-score').textContent = third.score + ' pts';
                podium3.style.display = 'block';
            } else {
                document.getElementById('podium-3').style.display = 'none';
            }
            
            // Prize
            if (prizePool > 0 && isWinner) {
                document.getElementById('winner-prize').style.display = 'block';
                document.getElementById('winner-prize-amount').textContent = ' ' + prizePool;
            } else {
                document.getElementById('winner-prize').style.display = 'none';
            }
            
            document.getElementById('battle-winner-modal').classList.add('active');
            
            if (isWinner) {
                playSound('achievement');
            }
        }
        
        function closeWinnerModal() {
            document.getElementById('battle-winner-modal').classList.remove('active');
        }
        
        function shareBattleWin() {
            const battle = userBattles.find(b => b.status === 'completed');
            if (!battle) return;
            
            const shareText = ` I won the Brain Battle "${battle.name}"!\n\n Challenge me: gameshelf.app`;
            
            if (navigator.share) {
                navigator.share({ title: 'Brain Battle Victory!', text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                showToast(' Victory message copied!');
            }
            closeWinnerModal();
        }

        function showCreateBattleModal(type = 'challenge') {
            currentBattleType = type;
            selectedBattleFriends = [];
            
            // Reset form
            document.getElementById('battle-name-input').value = '';
            document.getElementById('battle-desc-input').value = '';
            document.getElementById('wager-amount').value = '';
            document.getElementById('wager-input').style.display = 'none';
            document.querySelector('input[name="stakes"][value="bragging"]').checked = true;
            
            selectBattleType(type);
            renderBattleFriendList();
            
            // Setup stakes toggle
            document.querySelectorAll('input[name="stakes"]').forEach(radio => {
                radio.onchange = (e) => {
                    document.getElementById('wager-input').style.display = 
                        e.target.value === 'coins' ? 'flex' : 'none';
                };
            });
            
            document.getElementById('create-battle-modal').classList.add('active');
        }

        function closeCreateBattleModal() {
            document.getElementById('create-battle-modal').classList.remove('active');
            selectedBattleFriends = [];
        }

        function selectBattleType(type) {
            currentBattleType = type;
            const buttons = document.querySelectorAll('.battle-type-btn');
            const friendGroup = document.getElementById('friend-select-group');
            const openHint = document.getElementById('open-battle-hint');
            const typeHint = document.getElementById('battle-type-hint');
            
            // Update button states
            buttons.forEach((btn, idx) => {
                const types = ['challenge', 'group', 'open'];
                btn.classList.toggle('active', types[idx] === type);
            });
            
            // Show/hide friend selection based on type
            if (type === 'open') {
                friendGroup.style.display = 'none';
                openHint.style.display = 'block';
                typeHint.textContent = 'Anyone with the code can join - share it anywhere!';
            } else {
                friendGroup.style.display = 'block';
                openHint.style.display = 'none';
                if (type === 'challenge') {
                    typeHint.textContent = 'Challenge a specific friend to compete';
                } else {
                    typeHint.textContent = 'Compete with multiple friends at once';
                }
            }
            
            selectedBattleFriends = [];
            renderBattleFriendList();
        }

        function renderBattleFriendList() {
            const container = document.getElementById('battle-friend-list');
            
            const friends = (typeof friendsData !== 'undefined' ? friendsData : []) || [];
            
            if (!friends || friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 15px; text-align: center;">
                        <p style="color: var(--text-muted);">No friends yet</p>
                        <button class="btn btn-small" onclick="closeCreateBattleModal(); switchTab('community');">Add Friends</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = friends.map(friend => {
                const initial = (friend.displayName || 'U')[0];
                const odataId = friend.odataId || friend.odataId;
                const defaultAvatar = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22>' + initial + '</text></svg>';
                return `
                <div class="friend-select-item ${selectedBattleFriends.includes(odataId) ? 'selected' : ''}" 
                     onclick="toggleBattleFriend('${odataId}')">
                    <img src="${friend.photoURL || defaultAvatar}" alt="${friend.displayName}">
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                    </div>
                    <div style="color: var(--accent-gold);">${selectedBattleFriends.includes(odataId) ? '' : ''}</div>
                </div>
            `;
            }).join('');
        }

        function toggleBattleFriend(odataId) {
            const index = selectedBattleFriends.indexOf(odataId);
            
            if (currentBattleType === 'challenge') {
                selectedBattleFriends = index >= 0 ? [] : [odataId];
            } else {
                if (index >= 0) {
                    selectedBattleFriends.splice(index, 1);
                } else {
                    selectedBattleFriends.push(odataId);
                }
            }
            
            renderBattleFriendList();
        }

        async function createBattle() {
            if (!currentUser) {
                showToast('Please sign in first');
                return;
            }
            
            const name = document.getElementById('battle-name-input').value.trim();
            const description = document.getElementById('battle-desc-input').value.trim();
            const duration = parseInt(document.getElementById('battle-duration').value);
            const stakesType = document.querySelector('input[name="stakes"]:checked').value;
            const wagerAmount = stakesType === 'coins' ? parseInt(document.getElementById('wager-amount').value) || 0 : 0;
            
            const selectedGames = [];
            document.querySelectorAll('#battle-games input:checked').forEach(cb => {
                selectedGames.push(cb.value);
            });
            
            if (!name) {
                showToast('Please enter a battle name');
                return;
            }
            
            if (selectedGames.length === 0) {
                showToast('Please select at least one game');
                return;
            }
            
            if (selectedBattleFriends.length === 0 && currentBattleType !== 'open') {
                showToast('Please select at least one opponent');
                return;
            }
            
            if (wagerAmount > 0 && wagerAmount < 50) {
                showToast('Minimum wager is 50 coins');
                return;
            }
            
            if (wagerAmount > 0 && userData.wallet.coins < wagerAmount) {
                showToast('Not enough coins for this wager');
                return;
            }
            
            // Generate unique join code
            const joinCode = generateBattleCode();
            
            const now = Date.now();
            const battle = {
                name: name,
                description: description,
                type: currentBattleType,
                games: selectedGames,
                startDate: now,
                endDate: now + (duration * 24 * 60 * 60 * 1000),
                entryFee: wagerAmount,
                stakesType: stakesType,
                status: 'pending',
                joinCode: joinCode,
                createdBy: currentUser.uid,
                createdAt: now,
                participants: {
                    [currentUser.uid]: {
                        odataId: currentUser.uid,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        score: 0,
                        joined: true,
                        joinedAt: now,
                        dailyScores: {}
                    }
                },
                invites: {}
            };
            
            selectedBattleFriends.forEach(friendId => {
                battle.invites[friendId] = {
                    status: 'pending',
                    sentAt: now
                };
            });
            
            try {
                const battleRef = firebase.database().ref('battles').push();
                battle.id = battleRef.key;
                await battleRef.set(battle);
                
                if (wagerAmount > 0) {
                    spendCoins(wagerAmount, ` Battle entry: ${name}`);
                }
                
                // Add to local battles list
                userBattles.push({ id: battleRef.key, ...battle });
                
                // Close create modal first
                closeCreateBattleModal();
                
                // Show the battle share modal with invite link
                showBattleShareModal(name, joinCode, selectedGames, duration, wagerAmount);
                
            } catch (e) {
                console.error('Error creating battle:', e);
                showToast('Failed to create battle. Try again.');
            }
        }
        
        // Generate a 6-character alphanumeric battle code
        function generateBattleCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing chars: 0, O, 1, I
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ============ PUBLIC TOURNAMENTS (PHASE 4) ============
        let publicTournaments = [];
        let myTournaments = [];

        function showPublicTournaments() {
            loadPublicTournaments();
            document.getElementById('tournaments-modal').classList.add('active');
        }

        function closeTournamentsModal() {
            document.getElementById('tournaments-modal').classList.remove('active');
        }

        async function loadPublicTournaments() {
            if (!isFirebaseReady) {
                renderTournamentsList([]);
                return;
            }
            
            try {
                const tournamentsRef = firebase.database().ref('tournaments');
                const snapshot = await tournamentsRef.orderByChild('status').equalTo('active').once('value');
                
                publicTournaments = [];
                snapshot.forEach(child => {
                    const tournament = { id: child.key, ...child.val() };
                    // Only show tournaments that haven't started or are in progress
                    if (tournament.startDate > Date.now() || tournament.status === 'active') {
                        publicTournaments.push(tournament);
                    }
                });
                
                // Sort by start date (upcoming first)
                publicTournaments.sort((a, b) => a.startDate - b.startDate);
                
                renderTournamentsList(publicTournaments);
            } catch (e) {
                console.log('Error loading tournaments:', e);
                // Show sample tournaments for demo
                renderTournamentsList(getSampleTournaments());
            }
        }

        function getSampleTournaments() {
            const now = Date.now();
            return [
                {
                    id: 'demo1',
                    name: 'Wordle Survivor - January',
                    subtitle: 'Last Person Standing',
                    type: 'elimination',
                    game: 'wordle',
                    entryFee: 100,
                    startDate: now + 2 * 86400000, // Starts in 2 days
                    endDate: now + 33 * 86400000, // 31 days
                    maxParticipants: 1000,
                    participantCount: 547,
                    prizeStructure: { first: 60, second: 25, third: 15 },
                    status: 'registering'
                },
                {
                    id: 'demo2',
                    name: 'Connections Championship',
                    subtitle: '7-Day Survival',
                    type: 'elimination',
                    game: 'connections',
                    entryFee: 250,
                    startDate: now + 5 * 86400000,
                    endDate: now + 12 * 86400000,
                    maxParticipants: 500,
                    participantCount: 234,
                    prizeStructure: { first: 50, second: 30, third: 20 },
                    status: 'registering'
                },
                {
                    id: 'demo3',
                    name: 'NYT Games Grand Slam',
                    subtitle: 'Multi-Game Tournament',
                    type: 'points',
                    game: 'multi',
                    games: ['wordle', 'connections', 'strands', 'mini'],
                    entryFee: 500,
                    startDate: now + 86400000,
                    endDate: now + 8 * 86400000,
                    maxParticipants: 200,
                    participantCount: 89,
                    prizeStructure: { first: 50, second: 25, third: 15, fourth: 10 },
                    status: 'registering'
                },
                {
                    id: 'demo4',
                    name: 'Free Daily Challenge',
                    subtitle: 'No Entry Fee',
                    type: 'points',
                    game: 'wordle',
                    entryFee: 0,
                    startDate: now - 86400000,
                    endDate: now + 6 * 86400000,
                    maxParticipants: 10000,
                    participantCount: 3421,
                    prizeStructure: { first: 100, second: 50, third: 25 },
                    coinPrizes: true, // Prizes in coins, not from pool
                    status: 'active'
                }
            ];
        }

        function renderTournamentsList(tournaments) {
            const container = document.getElementById('tournaments-list');
            
            if (tournaments.length === 0) {
                container.innerHTML = `
                    <div class="battle-empty">
                        <div class="empty-icon"></div>
                        <p>No tournaments available</p>
                        <p class="empty-hint">Check back soon!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tournaments.map(t => {
                const isRegistering = t.status === 'registering' || t.startDate > Date.now();
                const startsIn = Math.ceil((t.startDate - Date.now()) / 86400000);
                const spotsLeft = t.maxParticipants - (t.participantCount || 0);
                const prizePool = t.coinPrizes ? (t.prizeStructure.first + t.prizeStructure.second + t.prizeStructure.third) : 
                                  (t.entryFee * (t.participantCount || 0));
                const alreadyJoined = myTournaments.includes(t.id);
                
                const gameIcon = {
                    'wordle': '',
                    'connections': '',
                    'strands': '',
                    'mini': '',
                    'multi': ''
                }[t.game] || '';
                
                return `
                    <div class="tournament-list-card ${alreadyJoined ? 'joined' : ''}">
                        <div class="tournament-list-header">
                            <div class="tournament-list-icon">${t.type === 'elimination' ? '' : ''}</div>
                            <div class="tournament-list-info">
                                <div class="tournament-list-name">${t.name}</div>
                                <div class="tournament-list-subtitle">${t.subtitle}</div>
                            </div>
                            <div class="tournament-list-game">${gameIcon}</div>
                        </div>
                        <div class="tournament-list-stats">
                            <div class="tl-stat">
                                <span class="tl-stat-value">${isRegistering ? (startsIn > 0 ? startsIn + 'd' : 'Today') : 'Live'}</span>
                                <span class="tl-stat-label">${isRegistering ? 'Starts' : 'Status'}</span>
                            </div>
                            <div class="tl-stat">
                                <span class="tl-stat-value">${t.entryFee > 0 ? '' + t.entryFee : 'FREE'}</span>
                                <span class="tl-stat-label">Entry</span>
                            </div>
                            <div class="tl-stat">
                                <span class="tl-stat-value">${t.participantCount || 0}</span>
                                <span class="tl-stat-label">Players</span>
                            </div>
                            <div class="tl-stat">
                                <span class="tl-stat-value">${prizePool >= 1000 ? (prizePool/1000).toFixed(0) + 'K' : prizePool}</span>
                                <span class="tl-stat-label">Prize Pool</span>
                            </div>
                        </div>
                        <div class="tournament-list-footer">
                            ${spotsLeft < 50 ? `<span class="spots-warning"> ${spotsLeft} spots left!</span>` : ''}
                            ${alreadyJoined ? 
                                `<button class="btn btn-secondary" disabled> Joined</button>` :
                                `<button class="btn btn-primary" onclick="showTournamentDetails('${t.id}')">View Details</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showTournamentDetails(tournamentId) {
            const tournament = publicTournaments.find(t => t.id === tournamentId);
            if (!tournament) return;
            
            const isRegistering = tournament.status === 'registering' || tournament.startDate > Date.now();
            const startsIn = Math.ceil((tournament.startDate - Date.now()) / 86400000);
            const daysLeft = Math.ceil((tournament.endDate - Date.now()) / 86400000);
            const totalDays = Math.ceil((tournament.endDate - tournament.startDate) / 86400000);
            const prizePool = tournament.coinPrizes ? 
                (tournament.prizeStructure.first + tournament.prizeStructure.second + tournament.prizeStructure.third) :
                (tournament.entryFee * (tournament.participantCount || 0));
            const alreadyJoined = myTournaments.includes(tournament.id);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'tournament-details-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 420px;">
                    <h2>${tournament.type === 'elimination' ? '' : ''} ${tournament.name}</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">${tournament.subtitle}</p>
                    
                    <div class="tournament-detail-banner ${tournament.type}">
                        <div class="tdb-prize">
                            <span class="tdb-prize-label">Prize Pool</span>
                            <span class="tdb-prize-value"> ${prizePool >= 1000 ? (prizePool/1000).toFixed(1) + 'K' : prizePool}</span>
                        </div>
                    </div>
                    
                    <div class="battle-details-stats">
                        <div class="detail-stat">
                            <span class="detail-label">Type</span>
                            <span class="detail-value">${tournament.type === 'elimination' ? 'Last Person Standing' : 'Points Race'}</span>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-label">Game${tournament.games?.length > 1 ? 's' : ''}</span>
                            <span class="detail-value">${tournament.games?.join(', ') || tournament.game}</span>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-label">${isRegistering ? 'Starts In' : 'Time Left'}</span>
                            <span class="detail-value">${isRegistering ? (startsIn > 0 ? startsIn + ' days' : 'Today!') : daysLeft + ' days'}</span>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">${totalDays} days</span>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-label">Entry Fee</span>
                            <span class="detail-value">${tournament.entryFee > 0 ? ' ' + tournament.entryFee : 'FREE'}</span>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-label">Players</span>
                            <span class="detail-value">${tournament.participantCount || 0} / ${tournament.maxParticipants}</span>
                        </div>
                    </div>
                    
                    <div class="section-title" style="margin-top: 20px;"> Prize Distribution</div>
                    <div class="prize-distribution">
                        <div class="prize-row">
                            <span class="prize-place"> 1st Place</span>
                            <span class="prize-amount">${tournament.prizeStructure.first}%${tournament.coinPrizes ? '' : ' of pool'}</span>
                        </div>
                        <div class="prize-row">
                            <span class="prize-place"> 2nd Place</span>
                            <span class="prize-amount">${tournament.prizeStructure.second}%</span>
                        </div>
                        <div class="prize-row">
                            <span class="prize-place"> 3rd Place</span>
                            <span class="prize-amount">${tournament.prizeStructure.third}%</span>
                        </div>
                        ${tournament.prizeStructure.fourth ? `
                        <div class="prize-row">
                            <span class="prize-place">4th Place</span>
                            <span class="prize-amount">${tournament.prizeStructure.fourth}%</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${tournament.type === 'elimination' ? `
                    <div class="section-title" style="margin-top: 20px;"> Rules</div>
                    <div class="tournament-rules">
                        <p> Complete the daily ${tournament.game} puzzle before midnight</p>
                        <p> Miss a day = eliminated from tournament</p>
                        <p> Last person standing wins!</p>
                        <p> Time zone: Your local device time</p>
                    </div>
                    ` : `
                    <div class="section-title" style="margin-top: 20px;"> Rules</div>
                    <div class="tournament-rules">
                        <p> Earn points for each daily puzzle completed</p>
                        <p> Better scores = more points</p>
                        <p> Highest total points at end wins!</p>
                    </div>
                    `}
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeTournamentDetails()" style="flex:1">Back</button>
                        ${alreadyJoined ? 
                            `<button class="btn btn-primary" disabled style="flex:1"> Already Joined</button>` :
                            `<button class="btn btn-primary" onclick="joinTournament('${tournament.id}')" style="flex:1">
                                ${tournament.entryFee > 0 ? ' ' + tournament.entryFee + ' - ' : ''}Join Tournament
                            </button>`
                        }
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeTournamentDetails() {
            const modal = document.getElementById('tournament-details-modal');
            if (modal) modal.remove();
        }

        async function joinTournament(tournamentId) {
            if (!currentUser) {
                showToast('Please sign in first');
                closeTournamentDetails();
                return;
            }
            
            const tournament = publicTournaments.find(t => t.id === tournamentId);
            if (!tournament) return;
            
            // Check if already joined
            if (myTournaments.includes(tournamentId)) {
                showToast('Already joined this tournament!');
                return;
            }
            
            // Check entry fee
            if (tournament.entryFee > 0) {
                if (userData.wallet.coins < tournament.entryFee) {
                    showToast('Not enough coins! Need ' + tournament.entryFee);
                    return;
                }
            }
            
            try {
                // For demo tournaments, just track locally
                if (tournamentId.startsWith('demo')) {
                    if (tournament.entryFee > 0) {
                        spendCoins(tournament.entryFee, ` Joined: ${tournament.name}`);
                    }
                    myTournaments.push(tournamentId);
                    
                    // Add to userBattles for display
                    userBattles.push({
                        id: tournamentId,
                        name: tournament.name,
                        subtitle: tournament.subtitle,
                        type: 'tournament',
                        game: tournament.game,
                        games: tournament.games || [tournament.game],
                        tournamentType: tournament.type,
                        startDate: tournament.startDate,
                        endDate: tournament.endDate,
                        entryFee: tournament.entryFee,
                        status: tournament.startDate > Date.now() ? 'pending' : 'active',
                        participants: {
                            [currentUser.uid]: {
                                odataId: currentUser.uid,
                                displayName: currentUser.displayName,
                                score: 0,
                                alive: true,
                                joinedAt: Date.now(),
                                dailyCompletions: {}
                            }
                        },
                        participantCount: (tournament.participantCount || 0) + 1
                    });
                    
                    showToast(` Joined "${tournament.name}"!`);
                    closeTournamentDetails();
                    closeTournamentsModal();
                    renderBattles();
                    return;
                }
                
                // For real tournaments, update Firebase
                const updates = {};
                updates[`tournaments/${tournamentId}/participants/${currentUser.uid}`] = {
                    odataId: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    score: 0,
                    alive: true,
                    joinedAt: Date.now(),
                    dailyCompletions: {}
                };
                updates[`tournaments/${tournamentId}/participantCount`] = (tournament.participantCount || 0) + 1;
                
                await firebase.database().ref().update(updates);
                
                if (tournament.entryFee > 0) {
                    spendCoins(tournament.entryFee, ` Joined: ${tournament.name}`);
                }
                
                myTournaments.push(tournamentId);
                showToast(` Joined "${tournament.name}"!`);
                closeTournamentDetails();
                closeTournamentsModal();
                loadUserBattles();
                
            } catch (e) {
                console.error('Error joining tournament:', e);
                showToast('Failed to join. Try again.');
            }
        }

        // Check tournament daily completions
        async function checkTournamentCompletion(gameId) {
            if (!currentUser) return;
            
            const today = getTodayString();
            
            for (const battle of userBattles) {
                if (battle.type !== 'tournament') continue;
                if (battle.status !== 'active') continue;
                
                const myData = battle.participants?.[currentUser.uid];
                if (!myData || myData.alive === false) continue;
                
                // Check if this game is part of the tournament
                const tournamentGames = battle.games || [battle.game];
                if (!tournamentGames.includes(gameId)) continue;
                
                // Mark as completed for today
                if (!myData.dailyCompletions) myData.dailyCompletions = {};
                if (!myData.dailyCompletions[today]) myData.dailyCompletions[today] = [];
                
                if (!myData.dailyCompletions[today].includes(gameId)) {
                    myData.dailyCompletions[today].push(gameId);
                    
                    // Update Firebase if real tournament
                    if (!battle.id.startsWith('demo') && isFirebaseReady) {
                        try {
                            await firebase.database().ref(
                                `tournaments/${battle.id}/participants/${currentUser.uid}/dailyCompletions/${today}`
                            ).set(myData.dailyCompletions[today]);
                        } catch (e) {
                            console.log('Failed to update tournament completion:', e);
                        }
                    }
                }
            }
        }

        // Check for tournament eliminations (run daily)
        async function checkTournamentEliminations() {
            if (!currentUser) return;
            
            const yesterday = getYesterdayString();
            
            for (const battle of userBattles) {
                if (battle.type !== 'tournament') continue;
                if (battle.tournamentType !== 'elimination') continue;
                if (battle.status !== 'active') continue;
                if (battle.startDate > Date.now()) continue; // Not started yet
                
                const myData = battle.participants?.[currentUser.uid];
                if (!myData || myData.alive === false) continue;
                
                // Check if completed yesterday's required games
                const tournamentGames = battle.games || [battle.game];
                const yesterdayCompletions = myData.dailyCompletions?.[yesterday] || [];
                
                // For elimination tournaments, must complete ALL games
                const missedGames = tournamentGames.filter(g => !yesterdayCompletions.includes(g));
                
                if (missedGames.length > 0 && battle.startDate < Date.now() - 86400000) {
                    // Eliminated!
                    myData.alive = false;
                    myData.eliminatedAt = Date.now();
                    myData.eliminatedReason = `Missed: ${missedGames.join(', ')}`;
                    
                    showToast(` Eliminated from "${battle.name}" - missed ${missedGames.join(', ')}`);
                    
                    // Update Firebase
                    if (!battle.id.startsWith('demo') && isFirebaseReady) {
                        try {
                            await firebase.database().ref(
                                `tournaments/${battle.id}/participants/${currentUser.uid}`
                            ).update({
                                alive: false,
                                eliminatedAt: Date.now(),
                                eliminatedReason: myData.eliminatedReason
                            });
                        } catch (e) {
                            console.log('Failed to update elimination:', e);
                        }
                    }
                }
            }
            
            renderBattles();
        }

        // Initialize tournament checks on load
        function initTournaments() {
            // Load user's tournament participations
            if (currentUser && isFirebaseReady) {
                loadMyTournaments();
            }
            
            // Check for eliminations
            checkTournamentEliminations();
        }

        async function loadMyTournaments() {
            if (!currentUser || !isFirebaseReady) return;
            
            try {
                const tournamentsRef = firebase.database().ref('tournaments');
                const snapshot = await tournamentsRef.once('value');
                
                myTournaments = [];
                snapshot.forEach(child => {
                    const tournament = child.val();
                    if (tournament.participants?.[currentUser.uid]) {
                        myTournaments.push(child.key);
                        
                        // Add to userBattles if not already there
                        if (!userBattles.find(b => b.id === child.key)) {
                            userBattles.push({
                                id: child.key,
                                ...tournament,
                                type: 'tournament'
                            });
                        }
                    }
                });
                
                renderBattles();
            } catch (e) {
                console.log('Error loading my tournaments:', e);
            }
        }

        function filterTournaments(filter) {
            // Update tabs
            document.querySelectorAll('.tournament-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            let filtered = publicTournaments;
            
            switch(filter) {
                case 'free':
                    filtered = publicTournaments.filter(t => t.entryFee === 0);
                    break;
                case 'elimination':
                    filtered = publicTournaments.filter(t => t.type === 'elimination');
                    break;
                case 'points':
                    filtered = publicTournaments.filter(t => t.type === 'points');
                    break;
                default:
                    filtered = publicTournaments;
            }
            
            renderTournamentsList(filtered);
        }

        // ============ MERCH STORE (PHASE 5) ============
        let merchCatalog = [];
        let merchOrders = [];
        let currentMerchFilter = 'all';

        const MOCK_MERCH_CATALOG = [
            // ===== VIRTUAL REWARDS (earned through battles/tournaments) =====
            {
                id: 'frame-bronze',
                name: 'Bronze Profile Frame',
                category: 'virtual',
                subcategory: 'frames',
                image: '',
                description: 'A sleek bronze frame for your profile',
                reward: true,
                earnedBy: 'Win any Brain Battle'
            },
            {
                id: 'frame-silver',
                name: 'Silver Profile Frame',
                category: 'virtual',
                subcategory: 'frames',
                image: '',
                description: 'A polished silver frame for your profile',
                reward: true,
                earnedBy: 'Win 5 Brain Battles'
            },
            {
                id: 'frame-gold',
                name: 'Gold Profile Frame',
                category: 'virtual',
                subcategory: 'frames',
                image: '',
                description: 'A prestigious gold frame for your profile',
                reward: true,
                earnedBy: 'Win a tournament'
            },
            {
                id: 'frame-rainbow',
                name: 'Rainbow Animated Frame',
                category: 'virtual',
                subcategory: 'frames',
                image: '',
                description: 'An animated rainbow frame that shimmers',
                reward: true,
                earnedBy: 'Win 3 tournaments',
                animated: true
            },
            {
                id: 'badge-champion',
                name: 'Champion Badge',
                category: 'virtual',
                subcategory: 'badges',
                image: '',
                description: 'Shows on your profile - "Brain Battle Champion"',
                reward: true,
                earnedBy: 'Place top 3 in a tournament'
            },
            {
                id: 'badge-streak',
                name: 'Streak Master Badge',
                category: 'virtual',
                subcategory: 'badges',
                image: '',
                description: 'Shows your dedication to daily puzzles',
                reward: true,
                earnedBy: 'Reach a 30-day streak'
            },
            {
                id: 'title-warrior',
                name: '"Brain Warrior" Title',
                category: 'virtual',
                subcategory: 'titles',
                image: '',
                description: 'Title displayed under your name',
                reward: true,
                earnedBy: 'Win 10 Brain Battles'
            },
            {
                id: 'title-legend',
                name: '"Brain Battle Legend" Title',
                category: 'virtual',
                subcategory: 'titles',
                image: '',
                description: 'Rare title displayed under your name',
                reward: true,
                earnedBy: 'Win 5 tournaments'
            },
            // ===== GOODY GIFT OF CHOICE TIERS (1 Coin = $1) =====
            {
                id: 'goody-tier-15',
                name: '$15 Gift of Choice',
                category: 'physical',
                subcategory: 'goody-tier',
                tier: 'bronze',
                price: 15,
                image: '',
                description: 'Pick from 50+ gifts: snacks, treats, small accessories',
                goodyValue: 15,
                goodyTier: true,
                shipping: true,
                productCount: '50+'
            },
            {
                id: 'goody-tier-30',
                name: '$30 Gift of Choice',
                category: 'physical',
                subcategory: 'goody-tier',
                tier: 'silver',
                price: 30,
                image: '',
                description: 'Pick from 100+ gifts: coffee, candles, drinkware & more',
                goodyValue: 30,
                goodyTier: true,
                shipping: true,
                productCount: '100+',
                popular: true
            },
            {
                id: 'goody-tier-50',
                name: '$50 Gift of Choice',
                category: 'physical',
                subcategory: 'goody-tier',
                tier: 'gold',
                price: 50,
                image: '',
                description: 'Pick from 150+ gifts: premium food, wellness, home goods',
                goodyValue: 50,
                goodyTier: true,
                shipping: true,
                productCount: '150+'
            },
            {
                id: 'goody-tier-75',
                name: '$75 Gift of Choice',
                category: 'physical',
                subcategory: 'goody-tier',
                tier: 'platinum',
                price: 75,
                image: '',
                description: 'Pick from 200+ gifts: tech, apparel, luxury items',
                goodyValue: 75,
                goodyTier: true,
                shipping: true,
                productCount: '200+'
            },
            {
                id: 'goody-tier-100',
                name: '$100+ Gift of Choice',
                category: 'physical',
                subcategory: 'goody-tier',
                tier: 'diamond',
                price: 100,
                image: '',
                description: 'Pick from 250+ premium gifts: top-tier brands & experiences',
                goodyValue: 100,
                goodyTier: true,
                shipping: true,
                productCount: '250+'
            }
        ];

        // Curated preview items for each Goody tier (examples of what's available)
        const GOODY_TIER_PREVIEWS = {
            'goody-tier-15': {
                categories: [
                    { icon: '', name: 'Sweets', examples: ['Sugarfina Candy', 'Compartes Chocolate'] },
                    { icon: '', name: 'Coffee & Tea', examples: ['Single Origin Beans', 'Tea Sampler'] },
                    { icon: '', name: 'Snacks', examples: ['Gourmet Popcorn', 'Trail Mix'] },
                    { icon: '', name: 'Wellness', examples: ['Lip Balm Set', 'Hand Cream'] }
                ],
                featuredItems: [
                    { icon: '', name: 'Milk Bar Cookies', brand: 'Milk Bar' },
                    { icon: '', name: 'Truffle Box', brand: 'Compartes' },
                    { icon: '', name: 'Drink Mix Set', brand: 'Liquid IV' },
                    { icon: '', name: 'Nut Butter Sampler', brand: 'Justin\'s' },
                    { icon: '', name: 'Tea Collection', brand: 'Tea Forte' },
                    { icon: '', name: 'Candy Bento Box', brand: 'Sugarfina' }
                ]
            },
            'goody-tier-30': {
                categories: [
                    { icon: '', name: 'Coffee', examples: ['Blue Bottle', 'Stumptown', 'La Colombe'] },
                    { icon: '', name: 'Candles', examples: ['Voluspa', 'Homesick', 'Paddywax'] },
                    { icon: '', name: 'Drinks', examples: ['PRESS Seltzer', 'Athletic Brewing'] },
                    { icon: '', name: 'Spa', examples: ['Bath Bombs', 'Face Masks'] }
                ],
                featuredItems: [
                    { icon: '', name: 'Coffee Subscription Box', brand: 'Blue Bottle' },
                    { icon: '', name: 'Luxury Candle', brand: 'Voluspa' },
                    { icon: '', name: 'Chocolate Collection', brand: 'Compartes' },
                    { icon: '', name: 'Body Care Set', brand: 'Necessaire' },
                    { icon: '', name: 'Movie Night Kit', brand: 'Mouth' },
                    { icon: '', name: 'Mini Plant', brand: 'The Sill' }
                ]
            },
            'goody-tier-50': {
                categories: [
                    { icon: '', name: 'Wine & Spirits', examples: ['Winc Selection', 'Craft Cocktails'] },
                    { icon: '', name: 'Wellness', examples: ['Herbivore', 'Dr. Barbara Sturm'] },
                    { icon: '', name: 'Home', examples: ['Throw Blankets', 'Diffusers'] },
                    { icon: '', name: 'Tech', examples: ['Phone Accessories', 'Chargers'] }
                ],
                featuredItems: [
                    { icon: '', name: 'Wine Duo', brand: 'Winc' },
                    { icon: '', name: 'Skincare Set', brand: 'Herbivore' },
                    { icon: '', name: 'Throw Blanket', brand: 'Barefoot Dreams' },
                    { icon: '', name: 'Wireless Charger', brand: 'Courant' },
                    { icon: '', name: 'Desktop Plant', brand: 'Bloomscape' },
                    { icon: '', name: 'Dessert Box', brand: 'Milk Bar' }
                ]
            },
            'goody-tier-75': {
                categories: [
                    { icon: '', name: 'Apparel', examples: ['Cozy Loungewear', 'Premium Socks'] },
                    { icon: '', name: 'Tech', examples: ['Earbuds', 'Portable Speakers'] },
                    { icon: '', name: 'Luxury Spa', examples: ['Premium Skincare', 'Bath Sets'] },
                    { icon: '', name: 'Home Decor', examples: ['Candle Sets', 'Planters'] }
                ],
                featuredItems: [
                    { icon: '', name: 'Wireless Earbuds', brand: 'JBL' },
                    { icon: '', name: 'Loungewear Set', brand: 'Eberjey' },
                    { icon: '', name: 'Luxury Face Set', brand: 'Dr. Barbara Sturm' },
                    { icon: '', name: 'Candle Collection', brand: 'Diptyque' },
                    { icon: '', name: 'Weekender Bag', brand: 'Away' },
                    { icon: '', name: 'Champagne Gift', brand: 'Veuve Clicquot' }
                ]
            },
            'goody-tier-100': {
                categories: [
                    { icon: '', name: 'Premium', examples: ['Designer Items', 'Luxury Goods'] },
                    { icon: '', name: 'Electronics', examples: ['Quality Headphones', 'Smart Devices'] },
                    { icon: '', name: 'Spirits', examples: ['Premium Whiskey', 'Fine Wine'] },
                    { icon: '', name: 'Travel', examples: ['Luggage', 'Travel Kits'] }
                ],
                featuredItems: [
                    { icon: '', name: 'Noise-Canceling Headphones', brand: 'Sony' },
                    { icon: '', name: 'Premium Whiskey Set', brand: 'Macallan' },
                    { icon: '', name: 'Carry-On Luggage', brand: 'Away' },
                    { icon: '', name: 'Luxury Spa Package', brand: 'La Mer' },
                    { icon: '', name: 'Smart Watch Band', brand: 'Apple' },
                    { icon: '', name: 'Ultimate Chocolate Box', brand: 'Vosges' }
                ]
            }
        };

        function showMerchStore() {
            merchCatalog = MOCK_MERCH_CATALOG;
            loadMerchOrders();
            document.getElementById('merch-balance').textContent = (userData.wallet?.coins || 0).toLocaleString();
            document.getElementById('merch-modal').classList.add('active');
            renderMerchCatalog();
        }

        function closeMerchModal() {
            document.getElementById('merch-modal').classList.remove('active');
        }

        function loadMerchOrders() {
            // Load from userData
            merchOrders = userData.merchOrders || [];
        }

        function saveMerchOrders() {
            userData.merchOrders = merchOrders;
            saveData();
        }

        function filterMerch(category) {
            currentMerchFilter = category;
            
            document.querySelectorAll('.merch-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            renderMerchCatalog();
        }

        function renderMerchCatalog() {
            const container = document.getElementById('merch-catalog');
            
            // Split into virtual rewards and physical gifts
            const virtualItems = merchCatalog.filter(item => item.category === 'virtual');
            const physicalItems = merchCatalog.filter(item => item.category === 'physical');
            
            // Apply filter
            let showVirtual = currentMerchFilter === 'all' || currentMerchFilter === 'virtual';
            let showPhysical = currentMerchFilter === 'all' || currentMerchFilter === 'physical';
            
            // Check which items user already owns
            const ownedItems = userData.ownedMerch || [];
            
            // Tier color map
            const tierColors = {
                'bronze': '#cd7f32',
                'silver': '#c0c0c0',
                'gold': '#ffd700',
                'platinum': '#e5e4e2',
                'diamond': '#b9f2ff'
            };
            
            let html = '';
            
            // Virtual Rewards Section
            if (showVirtual && virtualItems.length > 0) {
                html += `
                    <div class="merch-section-header">
                        <span> Rewards</span>
                        <span class="merch-section-subtitle">Earned through battles & achievements</span>
                    </div>
                `;
                html += virtualItems.map(item => {
                    const owned = ownedItems.includes(item.id);
                    return `
                        <div class="merch-card reward-card ${owned ? 'owned' : ''}">
                            <div class="merch-image">${item.image}</div>
                            <div class="merch-info">
                                <div class="merch-name">${item.name}</div>
                                <div class="merch-desc">${item.description}</div>
                                <div class="merch-footer">
                                    ${owned ? 
                                        `<span class="merch-owned"> Unlocked</span>` :
                                        `<span class="merch-earn-hint"> ${item.earnedBy}</span>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Physical Gifts Section (Goody Gift Tiers)
            if (showPhysical && physicalItems.length > 0) {
                html += `
                    <div class="merch-section-header" ${showVirtual ? 'style="margin-top: 25px;"' : ''}>
                        <span> Gift Shop</span>
                        <span class="merch-section-subtitle">Real gifts shipped to your door via <strong>Goody</strong></span>
                    </div>
                `;
                html += physicalItems.map(item => {
                    const owned = ownedItems.includes(item.id);
                    const canAfford = userData.wallet.coins >= item.price;
                    const isGoodyTier = item.goodyTier;
                    const tierColor = tierColors[item.tier] || '#888';
                    
                    return `
                        <div class="merch-card ${owned ? 'owned' : ''} ${!canAfford && !owned ? 'unaffordable' : ''} ${isGoodyTier ? 'goody-tier-card' : ''}">
                            ${isGoodyTier ? `<div class="tier-badge" style="background: ${tierColor}; color: #000;">${item.productCount} gifts</div>` : ''}
                            <div class="merch-image">${item.image}</div>
                            <div class="merch-info">
                                <div class="merch-name">${item.name}${item.popular ? ' <span class="popular-badge">Popular</span>' : ''}</div>
                                <div class="merch-desc">${item.description}</div>
                                ${isGoodyTier ? `<div class="goody-brand">Powered by <strong>Goody</strong></div>` : ''}
                                <div class="merch-footer">
                                    <span class="merch-price ${canAfford ? '' : 'too-expensive'}"> ${item.price.toLocaleString()}</span>
                                    <button class="btn btn-small ${canAfford ? 'btn-primary' : 'btn-secondary'}" 
                                            onclick="${isGoodyTier ? `showGiftTierDetails('${item.id}')` : `showMerchDetails('${item.id}')`}"
                                            ${!canAfford ? 'disabled' : ''}>
                                        ${isGoodyTier ? 'Browse' : 'View'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            container.innerHTML = html;
        }

        function showMerchDetails(itemId) {
            const item = merchCatalog.find(m => m.id === itemId);
            if (!item) return;
            
            // Virtual items shouldn't show details modal - they're earned
            if (item.category === 'virtual') return;
            
            const canAfford = userData.wallet.coins >= item.price;
            const owned = (userData.ownedMerch || []).includes(item.id);
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'merch-details-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 380px;">
                    <div class="merch-detail-image">${item.image}</div>
                    <h2>${item.name}</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">${item.description}</p>
                    
                    <div class="merch-detail-info">
                        <div class="mdi-row">
                            <span class="mdi-label">Type</span>
                            <span class="mdi-value"> Physical Gift (Shipped)</span>
                        </div>
                        <div class="mdi-row">
                            <span class="mdi-label">Price</span>
                            <span class="mdi-value merch-price"> ${item.price.toLocaleString()}</span>
                        </div>
                        ${item.goodyValue ? `
                        <div class="mdi-row">
                            <span class="mdi-label">Retail Value</span>
                            <span class="mdi-value">~$${item.goodyValue}</span>
                        </div>
                        ` : ''}
                        <div class="mdi-row">
                            <span class="mdi-label">Your Balance</span>
                            <span class="mdi-value ${canAfford ? 'can-afford' : 'cannot-afford'}"> ${userData.wallet.coins.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="shipping-note">
                        <p> This item will be shipped via our partner Goody. You'll receive an email to select your gift and enter your shipping address.</p>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeMerchDetails()" style="flex:1">Cancel</button>
                        ${owned ? 
                            `<button class="btn btn-secondary" disabled style="flex:1"> Already Redeemed</button>` :
                            `<button class="btn btn-primary" onclick="redeemMerch('${item.id}')" style="flex:1" ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? `Redeem for ${item.price.toLocaleString()}` : 'Not Enough Coins'}
                            </button>`
                        }
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeMerchDetails() {
            const modal = document.getElementById('merch-details-modal');
            if (modal) modal.remove();
        }

        function showGiftTierDetails(tierId) {
            const item = merchCatalog.find(m => m.id === tierId);
            if (!item) return;
            
            const preview = GOODY_TIER_PREVIEWS[tierId];
            if (!preview) {
                // Fallback to regular merch details if no preview data
                showMerchDetails(tierId);
                return;
            }
            
            const canAfford = userData.wallet.coins >= item.price;
            
            // Tier color styling
            const tierColors = {
                'bronze': { bg: 'rgba(205, 127, 50, 0.15)', border: '#cd7f32' },
                'silver': { bg: 'rgba(192, 192, 192, 0.15)', border: '#c0c0c0' },
                'gold': { bg: 'rgba(255, 215, 0, 0.15)', border: '#ffd700' },
                'platinum': { bg: 'rgba(229, 228, 226, 0.15)', border: '#e5e4e2' },
                'diamond': { bg: 'rgba(185, 242, 255, 0.15)', border: '#b9f2ff' }
            };
            const tierStyle = tierColors[item.tier] || { bg: 'rgba(255,255,255,0.1)', border: '#888' };
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'gift-tier-modal';
            modal.innerHTML = `
                <div class="modal gift-tier-modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeGiftTierModal()"></button>
                    
                    <div class="tier-header" style="background: ${tierStyle.bg}; border: 2px solid ${tierStyle.border}; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">${item.image}</div>
                        <h2 style="margin: 0 0 5px 0;">${item.name}</h2>
                        <div style="color: var(--text-muted);">${item.productCount} gifts to choose from</div>
                    </div>
                    
                    <div class="tier-categories">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;"> CATEGORIES AVAILABLE</h3>
                        <div class="category-grid">
                            ${preview.categories.map(cat => `
                                <div class="category-pill">
                                    <span class="cat-icon">${cat.icon}</span>
                                    <span class="cat-name">${cat.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="tier-featured">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin: 20px 0 12px 0;"> FEATURED GIFTS</h3>
                        <div class="gifts-grid">
                            ${preview.featuredItems.map(fi => `
                                <div class="featured-item">
                                    <span class="fi-icon">${fi.icon}</span>
                                    <div class="fi-info">
                                        <div class="fi-name">${fi.name}</div>
                                        <div class="fi-brand">${fi.brand}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="more-items-note">+ many more from 350+ brands</div>
                    </div>
                    
                    <div class="how-it-works" style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin: 20px 0;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;"> HOW IT WORKS</h3>
                        <div class="hiw-steps">
                            <div class="hiw-step">
                                <span class="step-num">1</span>
                                <span>Redeem your coins</span>
                            </div>
                            <div class="hiw-step">
                                <span class="step-num">2</span>
                                <span>Receive email with gift link</span>
                            </div>
                            <div class="hiw-step">
                                <span class="step-num">3</span>
                                <span>Browse & pick your gift on Goody</span>
                            </div>
                            <div class="hiw-step">
                                <span class="step-num">4</span>
                                <span>Enter address & it ships free!</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tier-footer">
                        <div class="tier-pricing">
                            <div class="tp-row">
                                <span class="tp-label">Cost</span>
                                <span class="tp-value"> ${item.price.toLocaleString()}</span>
                            </div>
                            <div class="tp-row">
                                <span class="tp-label">Gift Value</span>
                                <span class="tp-value">~$${item.goodyValue}</span>
                            </div>
                            <div class="tp-row ${canAfford ? 'can-afford' : 'cannot-afford'}">
                                <span class="tp-label">Your Balance</span>
                                <span class="tp-value"> ${userData.wallet.coins.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-large" onclick="redeemGiftTier('${item.id}')" style="width: 100%; margin-top: 15px;" ${!canAfford ? 'disabled' : ''}>
                            ${canAfford ? ` Redeem Gift of Choice` : `Need ${(item.price - userData.wallet.coins).toLocaleString()} more coins`}
                        </button>
                        ${!canAfford ? `
                            <button class="btn btn-secondary" onclick="closeGiftTierModal(); showBuyCoinsModal();" style="width: 100%; margin-top: 10px;">
                                 Get More Coins
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeGiftTierModal() {
            const modal = document.getElementById('gift-tier-modal');
            if (modal) modal.remove();
        }

        async function redeemGiftTier(tierId) {
            const item = merchCatalog.find(m => m.id === tierId);
            if (!item) return;
            
            if (userData.wallet.coins < item.price) {
                showToast('Not enough coins!');
                return;
            }
            
            // Deduct coins
            spendCoins(item.price, ` Redeemed: ${item.name}`);
            
            // Create order for Goody fulfillment
            const order = {
                id: 'order_' + Date.now(),
                itemId: item.id,
                itemName: item.name,
                itemImage: item.image,
                price: item.price,
                goodyValue: item.goodyValue,
                isGiftOfChoice: true,
                productCount: item.productCount,
                status: 'pending_email',
                createdAt: Date.now(),
                goodyLink: null // Would be populated by Goody API in production
            };
            
            merchOrders.push(order);
            saveMerchOrders();
            
            closeGiftTierModal();
            showGiftTierConfirmation(order);
        }

        function showGiftTierConfirmation(order) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'gift-tier-confirmation-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px; text-align: center;">
                    <div class="confirmation-icon" style="font-size: 4rem; margin-bottom: 15px;"></div>
                    <h2>Gift Redeemed!</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Your ${order.itemName} credit is ready!
                    </p>
                    
                    <div class="gift-choice-summary" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;"></div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">~$${order.goodyValue} Gift of Choice</div>
                        <div style="color: var(--accent-green); font-size: 0.9rem;">${order.productCount} gifts to choose from</div>
                    </div>
                    
                    <div class="email-note" style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 10px; padding: 15px; text-align: left; margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 8px;"> Check Your Email</div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                            You'll receive a link from Goody where you can browse their full catalog and pick your perfect gift. Free shipping included!
                        </p>
                    </div>
                    
                    <div class="what-next" style="text-align: left; font-size: 0.85rem; color: var(--text-muted);">
                        <strong>What happens next:</strong>
                        <ol style="margin: 8px 0 0 20px; padding: 0;">
                            <li>Open the Goody link in your email</li>
                            <li>Browse ${order.productCount} amazing gifts</li>
                            <li>Pick your favorite (or swap for something else!)</li>
                            <li>Enter your address and it ships free</li>
                        </ol>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeGiftTierConfirmation()" style="width: 100%; margin-top: 20px;">
                        Awesome! 
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeGiftTierConfirmation() {
            const modal = document.getElementById('gift-tier-confirmation-modal');
            if (modal) modal.remove();
            renderMerchCatalog();
        }

        async function redeemMerch(itemId) {
            const item = merchCatalog.find(m => m.id === itemId);
            if (!item) return;
            
            // Virtual items can't be purchased - they're earned
            if (item.category === 'virtual') {
                showToast('This reward must be earned!');
                return;
            }
            
            if (userData.wallet.coins < item.price) {
                showToast('Not enough coins!');
                return;
            }
            
            // Deduct coins
            spendCoins(item.price, ` Redeemed: ${item.name}`);
            
            // Physical items - create order for Goody fulfillment
            const order = {
                id: 'order_' + Date.now(),
                itemId: item.id,
                itemName: item.name,
                itemImage: item.image,
                price: item.price,
                goodyValue: item.goodyValue,
                status: 'pending_email', // Will send email to collect shipping
                createdAt: Date.now(),
                // In real implementation, Goody API would return a gift link
                goodyLink: null
            };
            
            merchOrders.push(order);
            saveMerchOrders();
            
            closeMerchDetails();
            showMerchOrderConfirmation(order);
        }

        function showMerchOrderConfirmation(order) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'merch-confirmation-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 380px; text-align: center;">
                    <div class="confirmation-icon"></div>
                    <h2>Order Confirmed!</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Your ${order.itemName} is on its way!
                    </p>
                    
                    <div class="order-summary">
                        <div class="order-item-preview">${order.itemImage}</div>
                        <div class="order-item-name">${order.itemName}</div>
                        <div class="order-status pending"> Check your email</div>
                    </div>
                    
                    <div class="confirmation-note">
                        <p>We'll send you an email shortly with a link to:</p>
                        <ul>
                            <li>View your gift options</li>
                            <li>Swap for something else if you prefer</li>
                            <li>Enter your shipping address</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-primary" onclick="closeMerchConfirmation()" style="width: 100%; margin-top: 20px;">
                        Got it!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeMerchConfirmation() {
            const modal = document.getElementById('merch-confirmation-modal');
            if (modal) modal.remove();
            renderMerchCatalog();
        }

        function showMerchOrders() {
            loadMerchOrders();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'merch-orders-modal';
            
            const ordersHTML = merchOrders.length === 0 ? 
                `<div class="battle-empty"><p>No orders yet</p></div>` :
                merchOrders.map(order => {
                    const statusText = {
                        'pending_email': ' Email sent',
                        'pending_address': ' Awaiting address',
                        'processing': ' Processing',
                        'shipped': ' Shipped',
                        'delivered': ' Delivered'
                    }[order.status] || order.status;
                    
                    return `
                        <div class="order-card">
                            <div class="order-card-image">${order.itemImage}</div>
                            <div class="order-card-info">
                                <div class="order-card-name">${order.itemName}</div>
                                <div class="order-card-date">${new Date(order.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div class="order-card-status">${statusText}</div>
                        </div>
                    `;
                }).join('');
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <h2> My Orders</h2>
                    <div class="orders-list" style="margin-top: 15px;">
                        ${ordersHTML}
                    </div>
                    <button class="btn btn-secondary" onclick="closeMerchOrders()" style="width: 100%; margin-top: 20px;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeMerchOrders() {
            const modal = document.getElementById('merch-orders-modal');
            if (modal) modal.remove();
        }

        // Convert game result to numeric score for battles
        function extractNumericScore(gameId, extracted) {
            const scoreStr = extracted.score || '';
            
            switch (gameId) {
                case 'wordle':
                    // Wordle: 1/6 = 30pts, 2/6 = 25pts, ... 6/6 = 5pts, X/6 = 0pts
                    const wordleMatch = scoreStr.match(/(\d|X)\/6/);
                    if (wordleMatch) {
                        const num = wordleMatch[1];
                        if (num === 'X') return 0;
                        return (7 - parseInt(num)) * 5;
                    }
                    return 10;
                    
                case 'connections':
                    // Connections: 0 mistakes = 25pts, 1 = 20pts, ... 4+ = 5pts
                    const connMatch = scoreStr.match(/(\d+)\s*mistake/);
                    if (connMatch) {
                        const mistakes = parseInt(connMatch[1]);
                        return Math.max(5, 25 - (mistakes * 5));
                    }
                    return 15;
                    
                case 'strands':
                    // Strands: No hints = 25pts, each hint -5pts
                    if (scoreStr.includes('No hints')) return 25;
                    const strandsMatch = scoreStr.match(/(\d+)\s*hint/);
                    if (strandsMatch) {
                        return Math.max(5, 25 - (parseInt(strandsMatch[1]) * 5));
                    }
                    return 15;
                    
                case 'mini':
                case 'queens':
                case 'tango':
                case 'crossclimb':
                    // Time-based games: Under 1min = 25pts, under 2min = 20pts, etc.
                    const timeMatch = scoreStr.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        const minutes = parseInt(timeMatch[1]);
                        const seconds = parseInt(timeMatch[2]);
                        const totalSeconds = minutes * 60 + seconds;
                        if (totalSeconds < 60) return 30;
                        if (totalSeconds < 120) return 25;
                        if (totalSeconds < 180) return 20;
                        if (totalSeconds < 300) return 15;
                        return 10;
                    }
                    return 15;
                
                case 'quotle':
                    // Quotle: 1/8 = 25pts, ... 8/8 = 4pts, X/8 = 0pts
                    const quotleMatch = scoreStr.match(/(\d|X)\/8/);
                    if (quotleMatch) {
                        const num = quotleMatch[1];
                        if (num === 'X') return 0;
                        return Math.max(4, 28 - (parseInt(num) * 3));
                    }
                    return 10;
                    
                case 'pinpoint':
                    // Pinpoint: 1 guess = 30pts, 2 = 25pts, 3 = 20pts, 4 = 15pts, 5 = 10pts
                    const pinpointMatch = scoreStr.match(/(\d+)\s*guess/);
                    if (pinpointMatch) {
                        const guesses = parseInt(pinpointMatch[1]);
                        return Math.max(5, 35 - (guesses * 5));
                    }
                    return 15;
                    
                case 'spelling-bee':
                    // Queen Bee = 30pts, Genius = 25pts, otherwise 15pts
                    if (scoreStr.includes('Queen')) return 30;
                    if (scoreStr.includes('Genius')) return 25;
                    return 15;
                    
                case 'quordle':
                case 'octordle':
                case 'sedecordle':
                case 'duotrigordle':
                    // Multi-word games: Completed = 20pts, Failed = 5pts
                    if (scoreStr.includes('Failed') || scoreStr.includes('X')) return 5;
                    return 20;
                    
                case 'worldle':
                case 'globle':
                case 'tradle':
                case 'wheretaken':
                    // Geography games with guesses
                    const geoMatch = scoreStr.match(/(\d+)/);
                    if (geoMatch) {
                        const guesses = parseInt(geoMatch[1]);
                        if (guesses <= 1) return 30;
                        if (guesses <= 3) return 25;
                        if (guesses <= 5) return 20;
                        return Math.max(5, 25 - guesses);
                    }
                    return 15;
                    
                case 'framed':
                case 'heardle':
                case 'moviedle':
                case 'actorle':
                case 'bandle':
                    // Media guess games: X/6 format
                    const mediaMatch = scoreStr.match(/(\d|X)\/[68]/);
                    if (mediaMatch) {
                        const num = mediaMatch[1];
                        if (num === 'X') return 0;
                        return (7 - parseInt(num)) * 5;
                    }
                    return 15;
                    
                case 'nerdle':
                case 'costcodle':
                case 'waffle':
                    // Standard X/6 games
                    const stdMatch = scoreStr.match(/(\d|X)\/[56]/);
                    if (stdMatch) {
                        const num = stdMatch[1];
                        if (num === 'X') return 0;
                        return (7 - parseInt(num)) * 5;
                    }
                    return 15;
                    
                case 'semantle':
                case 'redactle':
                    // Guess count games (fewer is better)
                    const guessMatch = scoreStr.match(/(\d+)\s*guess/);
                    if (guessMatch) {
                        const guesses = parseInt(guessMatch[1]);
                        if (guesses <= 10) return 30;
                        if (guesses <= 25) return 25;
                        if (guesses <= 50) return 20;
                        if (guesses <= 100) return 15;
                        return 10;
                    }
                    return 15;
                    
                case 'letterboxed':
                case 'slate':
                    // Word count games (fewer is better)
                    const wordMatch = scoreStr.match(/(\d+)\s*word/);
                    if (wordMatch) {
                        const words = parseInt(wordMatch[1]);
                        if (words <= 2) return 30;
                        if (words <= 3) return 25;
                        if (words <= 4) return 20;
                        if (words <= 5) return 15;
                        return 10;
                    }
                    return 15;
                    
                case 'rungs':
                case 'tiles':
                    // Move count games (fewer is better)
                    const moveMatch = scoreStr.match(/(\d+)\s*move/);
                    if (moveMatch) {
                        const moves = parseInt(moveMatch[1]);
                        if (moves <= 5) return 30;
                        if (moves <= 10) return 25;
                        if (moves <= 15) return 20;
                        if (moves <= 20) return 15;
                        return 10;
                    }
                    return 15;
                    
                case 'immaculate-grid':
                    // X/9 format
                    const gridMatch = scoreStr.match(/(\d+)\/9/);
                    if (gridMatch) {
                        const correct = parseInt(gridMatch[1]);
                        return Math.min(30, correct * 3);
                    }
                    return 15;
                    
                default:
                    // Default: 15pts for success, 5pts for completion without success
                    return extracted.success ? 15 : 5;
            }
        }

        // ============ ACHIEVEMENTS ============
        function getMaxStreak(data) {
            let maxStreak = 0;
            Object.values(data.stats || {}).forEach(stat => {
                if (stat.streak > maxStreak) maxStreak = stat.streak;
            });
            return maxStreak;
        }

        function hasPerfectDay(data) {
            const history = data.history || {};
            for (const day of Object.values(history)) {
                if (day.gamesPlayed > 0 && day.gamesPlayed >= day.totalGames) {
                    return true;
                }
            }
            return false;
        }

        function checkTimeAchievements() {
            const hour = new Date().getHours();
            if (hour < 7 && !userData.achievements['early-bird']) {
                // Will be unlocked when they play a game
            }
            if (hour >= 23 && !userData.achievements['night-owl']) {
                // Will be unlocked when they play a game
            }
        }

        function unlockTimeAchievement() {
            const hour = new Date().getHours();
            if (hour < 7 && !userData.achievements['early-bird']) {
                userData.achievements['early-bird'] = getTodayString();
                playSound('achievement');
                showToast(' Achievement Unlocked: Early Bird!');
            }
            if (hour >= 23 && !userData.achievements['night-owl']) {
                userData.achievements['night-owl'] = getTodayString();
                playSound('achievement');
                showToast(' Achievement Unlocked: Night Owl!');
            }
        }

        function checkAndUnlockAchievements() {
            let newUnlocks = [];
            
            ACHIEVEMENTS.forEach(achievement => {
                if (!userData.achievements[achievement.id] && achievement.check(userData)) {
                    userData.achievements[achievement.id] = getTodayString();
                    newUnlocks.push(achievement);
                }
            });
            
            if (newUnlocks.length > 0) {
                saveData();
                renderAchievements();
                playSound('achievement'); // Play achievement sound
                newUnlocks.forEach(a => {
                    setTimeout(() => showToast(` ${a.icon} ${a.name} unlocked!`), 500);
                    
                    // Award coins based on achievement difficulty
                    const coinReward = getAchievementCoinReward(a.id);
                    if (coinReward > 0) {
                        setTimeout(() => earnCoins(coinReward, ` Achievement: ${a.name}`), 1000);
                    }
                });
            }
        }

        function getAchievementCoinReward(achievementId) {
            // Higher rewards for harder achievements
            const hardAchievements = ['streak-30', 'games-100', 'perfect-month'];
            const mediumAchievements = ['streak-7', 'games-50', 'explorer', 'night-owl', 'early-bird'];
            
            if (hardAchievements.includes(achievementId)) {
                return TOKEN_REWARDS.achievementHard;
            } else if (mediumAchievements.includes(achievementId)) {
                return TOKEN_REWARDS.achievementMedium;
            }
            return TOKEN_REWARDS.achievementBasic;
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const progressFill = document.getElementById('achievements-progress-fill');
            const progressText = document.getElementById('achievements-progress-text');
            
            let unlockedCount = 0;
            
            grid.innerHTML = ACHIEVEMENTS.map(achievement => {
                const isUnlocked = userData.achievements && userData.achievements[achievement.id];
                if (isUnlocked) unlockedCount++;
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <span class="achievement-icon">${achievement.icon}</span>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${isUnlocked ? ' Unlocked' : achievement.desc}</div>
                    </div>
                `;
            }).join('');
            
            const percentage = (unlockedCount / ACHIEVEMENTS.length) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `${unlockedCount}/${ACHIEVEMENTS.length}`;
        }

        // ============ DAILY GOAL ============
        function updateDailyGoal() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            let playedToday = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
            });
            
            const goal = userData.dailyGoal || 5;
            const progress = Math.min(playedToday / goal, 1);
            const circumference = 2 * Math.PI * 25; // radius 25 for smaller ring
            const offset = circumference - (progress * circumference);
            
            // Update ring
            const circle = document.getElementById('goal-progress-circle');
            if (circle) {
                circle.setAttribute('stroke-dasharray', circumference);
                circle.setAttribute('stroke-dashoffset', offset);
                if (playedToday >= goal) {
                    circle.setAttribute('stroke', 'var(--accent-green)');
                } else {
                    circle.setAttribute('stroke', 'var(--accent-gold)');
                }
            }
            
            // Update numbers
            const currentEl = document.getElementById('goal-current');
            const targetEl = document.getElementById('goal-target');
            if (currentEl) currentEl.textContent = playedToday;
            if (targetEl) targetEl.textContent = goal;
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (chevron) {
                    chevron.textContent = '';
                    chevron.classList.add('open');
                }
            } else {
                content.style.display = 'none';
                if (chevron) {
                    chevron.textContent = '';
                    chevron.classList.remove('open');
                }
            }
        }

        function toggleQuickLog() {
            document.getElementById('quick-log-modal').classList.add('active');
        }

        function closeQuickLogModal() {
            document.getElementById('quick-log-modal').classList.remove('active');
            document.getElementById('parse-result').style.display = 'none';
        }

        function showGoalModal() {
            const goal = userData.dailyGoal || 5;
            document.querySelectorAll('.goal-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.goal) === goal);
            });
            document.getElementById('custom-goal').value = '';
            document.getElementById('goal-modal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        function selectGoal(value) {
            document.querySelectorAll('.goal-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.goal) === value);
            });
            document.getElementById('custom-goal').value = '';
        }

        function saveGoal() {
            const customGoal = document.getElementById('custom-goal').value;
            let goal;
            
            if (customGoal && parseInt(customGoal) > 0) {
                goal = Math.min(parseInt(customGoal), 20);
            } else {
                const selected = document.querySelector('.goal-option.selected');
                goal = selected ? parseInt(selected.dataset.goal) : 5;
            }
            
            userData.dailyGoal = goal;
            saveData();
            closeGoalModal();
            updateDailyGoal();
            showToast(` Daily goal set to ${goal} games!`);
        }

        // ============ INSIGHTS ============
        function setInsightsPeriod(period) {
            insightsPeriod = period;
            document.querySelectorAll('.insights-period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(period));
            });
            renderInsights();
        }

        function renderInsights() {
            const stats = calculatePeriodStats(insightsPeriod);
            
            // Update stat cards
            document.getElementById('insight-games-played').textContent = stats.gamesPlayed;
            document.getElementById('insight-completion').textContent = stats.completionRate + '%';
            document.getElementById('insight-current-streak').textContent = stats.currentStreak;
            document.getElementById('insight-best-streak').textContent = stats.bestStreak;
            
            // Change indicators
            const gamesChange = document.getElementById('insight-games-change');
            const completionChange = document.getElementById('insight-completion-change');
            
            if (stats.gamesChange !== 0) {
                gamesChange.textContent = (stats.gamesChange > 0 ? '' : '') + ' ' + Math.abs(stats.gamesChange) + ' vs last ' + insightsPeriod;
                gamesChange.className = 'insight-change ' + (stats.gamesChange > 0 ? 'positive' : 'negative');
            } else {
                gamesChange.textContent = ' same as last ' + insightsPeriod;
                gamesChange.className = 'insight-change';
            }
            
            // Best days grid
            renderBestDays(stats.dayBreakdown);
            
            // Game rankings
            renderGameRankings();
            
            // Cross-game insights
            renderCrossInsights();
            
            // Annual wrapped
            renderWrapped();
        }

        function calculatePeriodStats(period) {
            const today = new Date();
            let days = 7;
            if (period === 'month') days = 30;
            if (period === 'year') days = 365;
            
            let gamesPlayed = 0;
            let possibleGames = 0;
            let currentStreak = 0;
            let bestStreak = 0;
            let dayBreakdown = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
            let dayCount = [0, 0, 0, 0, 0, 0, 0];
            
            // Calculate current and previous period
            let prevGamesPlayed = 0;
            
            for (let i = 0; i < days * 2; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                
                const dayData = userData.history[dateStr];
                const played = dayData ? dayData.gamesPlayed : 0;
                const total = dayData ? dayData.totalGames : (FEATURED_GAMES.length + userData.games.length);
                
                if (i < days) {
                    gamesPlayed += played;
                    possibleGames += total;
                    dayBreakdown[dayOfWeek] += played;
                    dayCount[dayOfWeek]++;
                } else {
                    prevGamesPlayed += played;
                }
            }
            
            // Average by day count
            for (let i = 0; i < 7; i++) {
                if (dayCount[i] > 0) {
                    dayBreakdown[i] = Math.round(dayBreakdown[i] / dayCount[i] * 10) / 10;
                }
            }
            
            // Get streaks from stats
            Object.values(userData.stats || {}).forEach(stat => {
                if (stat.streak > currentStreak) currentStreak = stat.streak;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const completionRate = possibleGames > 0 ? Math.round((gamesPlayed / possibleGames) * 100) : 0;
            
            return {
                gamesPlayed,
                completionRate,
                currentStreak,
                bestStreak,
                gamesChange: gamesPlayed - prevGamesPlayed,
                dayBreakdown
            };
        }

        function renderBestDays(breakdown) {
            const grid = document.getElementById('best-days-grid');
            if (!grid) return;
            
            const max = Math.max(...breakdown, 1);
            
            grid.innerHTML = breakdown.map((val, i) => {
                const intensity = val / max;
                const isActive = intensity > 0.5;
                return `<div class="best-time-cell ${isActive ? 'active' : ''}" 
                    style="opacity: ${0.3 + intensity * 0.7}"
                    title="${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i]}: ${val} avg games">${val > 0 ? val.toFixed(1) : ''}</div>`;
            }).join('');
        }

        function renderGameRankings() {
            const container = document.getElementById('game-rankings');
            if (!container) return;
            
            const allGames = [...FEATURED_GAMES, ...userData.games];
            const rankings = allGames.map(game => {
                const stats = userData.stats[game.id] || { totalPlays: 0, streak: 0 };
                return { ...game, totalPlays: stats.totalPlays || 0, streak: stats.streak || 0 };
            }).sort((a, b) => b.totalPlays - a.totalPlays).slice(0, 5);
            
            if (rankings.length === 0 || rankings[0].totalPlays === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Play some games to see your rankings!</div>';
                return;
            }
            
            container.innerHTML = rankings.map((game, i) => `
                <div class="game-ranking-item">
                    <div class="game-ranking-position">${i + 1}</div>
                    <span class="game-ranking-icon">${game.icon}</span>
                    <div class="game-ranking-info">
                        <div class="game-ranking-name">${game.name}</div>
                        <div class="game-ranking-stats">${game.totalPlays} plays  <span class="game-ranking-streak">${game.streak}</span></div>
                    </div>
                </div>
            `).join('');
        }

        function renderCrossInsights() {
            const container = document.getElementById('cross-insights-list');
            if (!container) return;
            
            const insights = generateCrossInsights();
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="cross-insight-item"><div class="cross-insight-icon"></div><div class="cross-insight-text"><div class="cross-insight-title">Keep playing!</div><div class="cross-insight-desc">We\'ll show you patterns and insights after a few days of activity.</div></div></div>';
                return;
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="cross-insight-item">
                    <div class="cross-insight-icon">${insight.icon}</div>
                    <div class="cross-insight-text">
                        <div class="cross-insight-title">${insight.title}</div>
                        <div class="cross-insight-desc">${insight.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        function generateCrossInsights() {
            const insights = [];
            const history = userData.history || {};
            const historyDays = Object.keys(history);
            
            if (historyDays.length < 3) return insights;
            
            // Find best day of week
            const dayTotals = [0,0,0,0,0,0,0];
            const dayCounts = [0,0,0,0,0,0,0];
            
            historyDays.forEach(dateStr => {
                const day = new Date(dateStr).getDay();
                dayTotals[day] += history[dateStr].gamesPlayed || 0;
                dayCounts[day]++;
            });
            
            const dayAvgs = dayTotals.map((t, i) => dayCounts[i] > 0 ? t / dayCounts[i] : 0);
            const bestDayIndex = dayAvgs.indexOf(Math.max(...dayAvgs));
            const worstDayIndex = dayAvgs.indexOf(Math.min(...dayAvgs.filter(d => d > 0)));
            const dayNames = ['Sundays', 'Mondays', 'Tuesdays', 'Wednesdays', 'Thursdays', 'Fridays', 'Saturdays'];
            
            if (dayAvgs[bestDayIndex] > 0) {
                insights.push({
                    icon: '',
                    title: `${dayNames[bestDayIndex]} are your best days`,
                    desc: `You play ${dayAvgs[bestDayIndex].toFixed(1)} games on average`
                });
            }
            
            // Most consistent game
            const allGames = [...FEATURED_GAMES, ...userData.games];
            let mostConsistent = null;
            let highestStreak = 0;
            
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > highestStreak) {
                    highestStreak = stats.streak;
                    mostConsistent = game;
                }
            });
            
            if (mostConsistent && highestStreak > 2) {
                insights.push({
                    icon: mostConsistent.icon,
                    title: `${mostConsistent.name} is your most consistent`,
                    desc: `You've played it ${highestStreak} days in a row!`
                });
            }
            
            // Goal achievement rate
            const goalDays = historyDays.filter(d => {
                const data = history[d];
                return data.gamesPlayed >= (userData.dailyGoal || 5);
            }).length;
            
            if (historyDays.length >= 7) {
                const goalRate = Math.round((goalDays / historyDays.length) * 100);
                insights.push({
                    icon: '',
                    title: `${goalRate}% goal hit rate`,
                    desc: `You've hit your daily goal ${goalDays} out of ${historyDays.length} days`
                });
            }
            
            // Total games milestone
            const totalCompleted = userData.stats.totalCompleted || 0;
            if (totalCompleted >= 50) {
                insights.push({
                    icon: '',
                    title: `${totalCompleted} games completed!`,
                    desc: 'You\'re becoming a daily puzzle master'
                });
            }
            
            return insights.slice(0, 4);
        }

        // ============ ANNUAL WRAPPED ============
        function renderWrapped() {
            const history = userData.history || {};
            const allGames = [...FEATURED_GAMES, ...userData.games];
            
            // Calculate year stats
            let totalGames = 0;
            let daysActive = 0;
            let bestStreak = 0;
            const gamePlayCounts = {};
            
            Object.values(history).forEach(day => {
                totalGames += day.gamesPlayed || 0;
                if (day.gamesPlayed > 0) daysActive++;
            });
            
            // Get unique games played
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.totalPlays > 0) {
                    gamePlayCounts[game.id] = stats.totalPlays;
                }
                if (stats && stats.streak > bestStreak) bestStreak = stats.streak;
            });
            
            const uniqueGames = Object.keys(gamePlayCounts).length;
            
            // Find top game
            let topGame = null;
            let topPlays = 0;
            allGames.forEach(game => {
                const plays = gamePlayCounts[game.id] || 0;
                if (plays > topPlays) {
                    topPlays = plays;
                    topGame = game;
                }
            });
            
            // Update wrapped UI
            document.getElementById('wrapped-total-games').textContent = totalGames;
            document.getElementById('wrapped-total-days').textContent = daysActive;
            document.getElementById('wrapped-best-streak').textContent = bestStreak;
            document.getElementById('wrapped-unique-games').textContent = uniqueGames;
            
            const topGameEl = document.getElementById('wrapped-top-game');
            if (topGame) {
                topGameEl.innerHTML = `<span>${topGame.icon}</span> <span>${topGame.name}</span>`;
            } else {
                topGameEl.innerHTML = `<span></span> <span>Play more to find out!</span>`;
            }
        }

        function shareWrapped() {
            const totalGames = document.getElementById('wrapped-total-games').textContent;
            const daysActive = document.getElementById('wrapped-total-days').textContent;
            const bestStreak = document.getElementById('wrapped-best-streak').textContent;
            
            const text = ` My Game Shelf Wrapped 2025

 ${totalGames} games played
 ${daysActive} days active  
 ${bestStreak} best streak

What's your stats? gameshelf.app`;
            
            if (navigator.share) {
                navigator.share({ text }).then(() => {
                    if (!userData.achievements['social']) {
                        userData.achievements['social'] = getTodayString();
                        saveData();
                        checkAndUnlockAchievements();
                    }
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(text);
                showToast(' Wrapped copied to clipboard!');
            }
        }

        // ============ SHARE LINK ============
        function generateShareLink() {
            // Generate a simple hash from user data
            const games = [...FEATURED_GAMES.map(g => g.id), ...userData.games.map(g => g.id)];
            const hash = btoa(JSON.stringify({ g: games.slice(0, 10), n: userData.registered ? 'Player' : 'Guest' })).slice(0, 20);
            
            const linkEl = document.getElementById('share-link-url');
            if (linkEl) {
                linkEl.value = `gameshelf.app/s/${hash}`;
            }
        }

        function copyShareLink() {
            const link = document.getElementById('share-link-url').value;
            navigator.clipboard.writeText('https://' + link);
            showToast(' Link copied!');
            
            if (!userData.achievements['social']) {
                userData.achievements['social'] = getTodayString();
                saveData();
                checkAndUnlockAchievements();
            }
        }

        // ============ SHARE TEXT PARSING ============
        const GAME_PATTERNS = [
            {
                id: 'wordle',
                name: 'Wordle',
                icon: '',
                pattern: /Wordle\s+[\d,]+\s+(\d|X)\/6/i,
                extract: (match) => {
                    const score = match[0].match(/(\d|X)\/6/)[1];
                    return { score: score === 'X' ? 'X/6' : `${score}/6`, success: score !== 'X' };
                }
            },
            {
                id: 'connections',
                name: 'Connections',
                icon: '',
                pattern: /Connections\s*\n?Puzzle\s*#?\d+/i,
                extract: (match, text) => {
                    const lines = text.split('\n').filter(l => /^[]+$/.test(l.trim()));
                    const mistakes = lines.length - 4;
                    return { score: `${Math.max(0, 4 - mistakes)} mistakes`, success: mistakes <= 4 };
                }
            },
            {
                id: 'strands',
                name: 'Strands',
                icon: '',
                pattern: /Strands\s*#?\d+/i,
                extract: (match, text) => {
                    const hints = (text.match(//g) || []).length;
                    return { score: hints > 0 ? `${hints} hints` : 'No hints!', success: true };
                }
            },
            {
                id: 'spelling-bee',
                name: 'Spelling Bee',
                icon: '',
                pattern: /Spelling\s*Bee|.*Genius|.*Queen/i,
                extract: (match, text) => {
                    if (text.includes('Queen')) return { score: 'Queen Bee! ', success: true };
                    if (text.includes('Genius')) return { score: 'Genius!', success: true };
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'mini',
                name: 'Mini Crossword',
                icon: '',
                pattern: /Mini\s*Crossword|I\s+solved.*NYT\s+Mini/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { score: `${timeMatch[1]}:${timeMatch[2]}`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'letterboxed',
                name: 'Letterboxed',
                icon: '',
                pattern: /Letter\s*Boxed|I\s+solved.*Letter.*in\s+\d+/i,
                extract: (match, text) => {
                    const wordMatch = text.match(/in\s+(\d+)\s+word/i);
                    if (wordMatch) {
                        return { score: `${wordMatch[1]} words`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'quordle',
                name: 'Quordle',
                icon: '4',
                pattern: /Daily\s+Quordle\s+\d+/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'octordle',
                name: 'Octordle',
                icon: '8',
                pattern: /Daily\s+Octordle\s+#?\d+/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'worldle',
                name: 'Worldle',
                icon: '',
                pattern: /#Worldle\s+#?\d+/i,
                extract: (match, text) => {
                    const guesses = (text.match(/[]/g) || []).length / 5;
                    return { score: `${Math.ceil(guesses)}/6 guesses`, success: true };
                }
            },
            {
                id: 'globle',
                name: 'Globle',
                icon: '',
                pattern: /\s*\w+\s+\d+,\s+\d+\s+|Globle/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'tradle',
                name: 'Tradle',
                icon: '',
                pattern: /#Tradle\s+#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'framed',
                name: 'Framed',
                icon: '',
                pattern: /Framed\s+#?\d+/i,
                extract: (match, text) => {
                    const frames = (text.match(/||/g) || []).length;
                    return { score: `${frames}/6 frames`, success: text.includes('') };
                }
            },
            {
                id: 'nerdle',
                name: 'Nerdle',
                icon: '',
                pattern: /nerdlegame\s+\d+|Nerdle\s+\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'redactle',
                name: 'Redactle',
                icon: '',
                pattern: /Redactle\s+#?\d+|I\s+solved\s+Redactle/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]} guesses`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'semantle',
                name: 'Semantle',
                icon: '',
                pattern: /Semantle\s+#?\d+|I\s+solved\s+Semantle/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]} guesses`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'immaculate-grid',
                name: 'Immaculate Grid',
                icon: '',
                pattern: /Immaculate\s+Grid|.*\/9/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\/9/);
                    if (scoreMatch) {
                        return { score: `${scoreMatch[1]}/9`, success: parseInt(scoreMatch[1]) >= 5 };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'costcodle',
                name: 'Costcodle',
                icon: '',
                pattern: /Costcodle\s+#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            // NYT Games
            {
                id: 'tiles',
                name: 'Tiles',
                icon: '',
                pattern: /Tiles|NYT\s+Tiles/i,
                extract: (match, text) => {
                    const movesMatch = text.match(/(\d+)\s*moves?/i);
                    if (movesMatch) {
                        return { score: `${movesMatch[1]} moves`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'vertex',
                name: 'Vertex',
                icon: '',
                pattern: /Vertex|NYT\s+Vertex/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            // Music
            {
                id: 'heardle',
                name: 'Heardle',
                icon: '',
                pattern: /Heardle\s*#?\d+|.*Heardle/i,
                extract: (match, text) => {
                    const won = text.includes('');
                    const guesses = (text.match(/[]/g) || []).length;
                    return { score: won ? `${guesses}/6` : 'X/6', success: won };
                }
            },
            // LinkedIn Games
            {
                id: 'queens',
                name: 'Queens',
                icon: '',
                pattern: /Queens\s*#?\d+|.*Queens/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { score: `${timeMatch[1]}:${timeMatch[2]}`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'tango',
                name: 'Tango',
                icon: '',
                pattern: /Tango\s*#?\d+|.*Tango/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { score: `${timeMatch[1]}:${timeMatch[2]}`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'pinpoint',
                name: 'Pinpoint',
                icon: '',
                pattern: /Pinpoint\s*#?\d+|.*Pinpoint/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s*guess/i);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]} guesses`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'crossclimb',
                name: 'Crossclimb',
                icon: '',
                pattern: /Crossclimb\s*#?\d+|.*Crossclimb/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { score: `${timeMatch[1]}:${timeMatch[2]}`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            // Game Shelf Originals
            {
                id: 'quotle',
                name: 'Quotle',
                icon: '',
                pattern: /Quotle\s*#?\d+|.*Quotle|Quotle.*[1-8X]\/8/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/([1-8X])\/8/i);
                    if (scoreMatch) {
                        const won = scoreMatch[1] !== 'X';
                        return { score: `${scoreMatch[1]}/8`, success: won };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'slate',
                name: 'Slate',
                icon: '',
                pattern: /Slate\s*#?\d+|.*Slate/i,
                extract: (match, text) => {
                    const wordsMatch = text.match(/(\d+)\s*words?/i);
                    if (wordsMatch) {
                        return { score: `${wordsMatch[1]} words`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'rungs',
                name: 'Rungs',
                icon: '',
                pattern: /Rungs\s*#?\d+|.*Rungs/i,
                extract: (match, text) => {
                    const movesMatch = text.match(/(\d+)\s*moves?/i);
                    if (movesMatch) {
                        return { score: `${movesMatch[1]} moves`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            // Additional Popular Games
            {
                id: 'waffle',
                name: 'Waffle',
                icon: '',
                pattern: /#waffle\d+|Waffle\s*#?\d+/i,
                extract: (match, text) => {
                    const starsMatch = text.match(/([0-5])\/5\s*/);
                    if (starsMatch) {
                        return { score: `${starsMatch[1]}/5 `, success: parseInt(starsMatch[1]) >= 3 };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'actorle',
                name: 'Actorle',
                icon: '',
                pattern: /Actorle\s*#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/8/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/8`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'moviedle',
                name: 'Moviedle',
                icon: '',
                pattern: /Moviedle\s*#?\d+|#Moviedle/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'bandle',
                name: 'Bandle',
                icon: '',
                pattern: /Bandle\s*#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'wheretaken',
                name: 'WhereTaken',
                icon: '',
                pattern: /WhereTaken\s*#?\d+|.*WhereTaken/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'foodguessr',
                name: 'FoodGuessr',
                icon: '',
                pattern: /FoodGuessr\s*#?\d+/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*points?/i);
                    if (scoreMatch) {
                        return { score: `${scoreMatch[1]} pts`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'timeguessr',
                name: 'TimeGuessr',
                icon: '',
                pattern: /TimeGuessr\s*#?\d+/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*points?/i);
                    if (scoreMatch) {
                        return { score: `${scoreMatch[1]} pts`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'sedecordle',
                name: 'Sedecordle',
                icon: '',
                pattern: /Daily\s+Sedecordle\s*#?\d+/i,
                extract: (match, text) => {
                    const failed = text.includes('') || text.includes('');
                    return { score: failed ? 'Failed' : 'Completed', success: !failed };
                }
            },
            {
                id: 'duotrigordle',
                name: 'Duotrigordle',
                icon: '32',
                pattern: /Duotrigordle\s*#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/37/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/37`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            }
        ];

        function parseShareText() {
            const input = document.getElementById('parse-input');
            const result = document.getElementById('parse-result');
            const resultIcon = document.getElementById('parse-result-icon');
            const resultGame = document.getElementById('parse-result-game');
            const resultScore = document.getElementById('parse-result-score');
            
            const text = input.value.trim();
            
            if (!text) {
                showToast('Please paste your game results');
                return;
            }
            
            let matched = false;
            let gameId, gameName, gameIcon, displayScore, success, contestPoints, rawData;
            
            // Try new ShareParser first (more comprehensive)
            if (shareParser) {
                const parsed = shareParser.parse(text);
                if (parsed) {
                    gameId = parsed.gameId;
                    gameName = parsed.gameName;
                    gameIcon = parsed.icon;
                    displayScore = parsed.displayScore;
                    success = parsed.success;
                    contestPoints = parsed.contestPoints;
                    rawData = parsed.raw;
                    matched = true;
                    
                    // Track partner analytics if applicable
                    if (partnerManager) {
                        partnerManager.trackPlay(gameId);
                    }
                    
                    console.log(' Parsed with ShareParser:', parsed);
                }
            }
            
            // Fallback to legacy GAME_PATTERNS if ShareParser didn't match
            if (!matched) {
                for (const game of GAME_PATTERNS) {
                    const match = text.match(game.pattern);
                    if (match) {
                        const extracted = game.extract(match, text);
                        gameId = game.id;
                        gameName = game.name;
                        gameIcon = game.icon;
                        displayScore = extracted.score;
                        success = extracted.success;
                        contestPoints = extractNumericScore(gameId, extracted);
                        rawData = extracted;
                        matched = true;
                        break;
                    }
                }
            }
            
            if (matched) {
                // Mark the game as played
                const today = getTodayString();
                
                if (!userData.stats[gameId]) {
                    userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
                
                // Store contest points for leaderboards
                if (!userData.stats[gameId].contestScores) {
                    userData.stats[gameId].contestScores = {};
                }
                userData.stats[gameId].contestScores[today] = contestPoints;
                
                // Store raw data for analytics
                if (!userData.stats[gameId].rawHistory) {
                    userData.stats[gameId].rawHistory = {};
                }
                userData.stats[gameId].rawHistory[today] = rawData;
                
                if (userData.stats[gameId].lastPlayed !== today) {
                    const yesterday = getYesterdayString();
                    if (userData.stats[gameId].lastPlayed === yesterday) {
                        userData.stats[gameId].streak++;
                    } else {
                        userData.stats[gameId].streak = 1;
                    }
                    userData.stats[gameId].lastPlayed = today;
                    userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                    
                    // Also track in totalCompleted
                    if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                    userData.stats.totalCompleted++;
                    
                    // Award coins for game completion
                    earnTokens(TOKEN_REWARDS.gameComplete, ` Completed ${gameName}`);
                    
                    // Check for streak bonuses
                    checkStreakBonus(gameId);
                }
                
                saveData();
                recordHistory();
                
                // Publish activity to friends
                publishActivity(gameId, gameName);
                
                // Record anonymous global stat for percentile
                recordGlobalStat(gameId, displayScore, success);
                
                // Check if this responds to a nudge
                checkNudgeResponse(gameId);
                
                // Show result in modal
                result.style.display = 'block';
                result.style.borderLeft = '4px solid var(--accent-green)';
                resultIcon.textContent = gameIcon;
                resultGame.textContent = gameName;
                resultScore.textContent = displayScore + (success ? ' ' : '') + ` (${contestPoints} pts)`;
                
                // Update battle scores if user is in active battles
                try {
                    updateBattleScores(gameId, contestPoints);
                    checkTournamentCompletion(gameId); // Track tournament daily progress
                } catch (e) {
                    console.log('Battle score update skipped:', e);
                }
                
                // Update UI
                renderFeaturedGames();
                renderMyGames();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                renderLeaderboard();
                checkAndUnlockAchievements();
                unlockTimeAchievement();
                
                showToast(` ${gameName} logged!`);
                input.value = '';
                
                // Show share success modal instead of just closing
                closeQuickLogModal();
                showShareSuccessModal(gameIcon, gameName, displayScore, userData.stats[gameId].streak, contestPoints);
            } else {
                result.style.display = 'block';
                result.style.borderLeft = '4px solid var(--accent-red)';
                result.classList.remove('success');
                result.classList.add('error');
                resultIcon.textContent = '';
                resultGame.textContent = 'Unknown Game';
                resultScore.textContent = 'Could not parse results. Try another format.';
            }
        }


        // ============ STATS ============
        function updateStats() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            // Count played today
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (typeof stat === 'object' && stat.lastPlayed === today) playedToday++;
                if (typeof stat === 'object' && stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            // Update UI elements (null-safe)
            const streakEl = document.getElementById('best-streak');
            const gamesEl = document.getElementById('total-games');
            
            if (streakEl) streakEl.textContent = bestStreak;
            if (gamesEl) gamesEl.textContent = totalGames;
            
            // Also update share preview
            updateSharePreview();
        }

        // ============ UTILITIES ============
        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getYesterdayString() {
            const now = new Date();
            now.setDate(now.getDate() - 1);
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function isToday(dateStr) {
            return dateStr === getTodayString();
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(' RSS URL copied!');
            }).catch(() => {
                showToast('Failed to copy');
            });
        }

        // ============ CHAT/DISCUSSION ============
        function renderChat() {
            const container = document.getElementById('chat-messages');
            if (!container) return; // Element may not exist
            
            const messages = userData.chatMessages || [];
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="chat-empty">
                        <p> No messages yet!</p>
                        <p style="font-size: 0.8rem;">Share your daily results, tips, or thoughts.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map((msg, index) => `
                <div class="chat-message">
                    <div class="chat-message-header">
                        <span class="chat-message-time">${formatChatTime(msg.timestamp)}</span>
                        <button class="chat-message-delete" onclick="deleteChatMessage(${index})"></button>
                    </div>
                    <div class="chat-message-text">${escapeHtml(msg.text)}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function postChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (!userData.chatMessages) userData.chatMessages = [];
            
            userData.chatMessages.push({
                text: text,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 messages
            if (userData.chatMessages.length > 50) {
                userData.chatMessages = userData.chatMessages.slice(-50);
            }
            
            saveData();
            input.value = '';
            renderChat();
        }

        function deleteChatMessage(index) {
            if (!confirm('Delete this message?')) return;
            userData.chatMessages.splice(index, 1);
            saveData();
            renderChat();
        }

        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Enter key in chat
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        postChatMessage();
                    }
                });
            }
        });

        // ============ SHARE SHELF ============
        function updateSharePreview() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (typeof stat === 'object') {
                    if (stat.lastPlayed === today) playedToday++;
                    if (stat.streak > bestStreak) bestStreak = stat.streak;
                }
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            // Update share preview stats (null-safe - elements may not exist)
            const playedEl = document.getElementById('share-played');
            const streakEl = document.getElementById('share-streak');
            const totalEl = document.getElementById('share-total');
            const dateEl = document.getElementById('share-date');
            const gamesEl = document.getElementById('share-games');
            
            if (playedEl) playedEl.textContent = playedToday;
            if (streakEl) streakEl.textContent = bestStreak;
            if (totalEl) totalEl.textContent = totalGames;
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            
            // Show games in share preview
            if (gamesEl) {
                const allGames = [...FEATURED_GAMES, ...userData.games].slice(0, 8);
                gamesEl.innerHTML = allGames.map(game => {
                    const stats = userData.stats[game.id] || { streak: 0 };
                    const gamePlayedToday = isToday(stats.lastPlayed);
                    return `
                        <div class="share-game-item" style="${gamePlayedToday ? 'border: 2px solid var(--accent-green);' : ''}">
                            <span class="icon">${game.icon}</span>
                            <div class="name">${game.name}</div>
                            ${stats.streak > 0 ? `<div class="streak">${stats.streak}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        function shareAsText() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            const allGames = [...FEATURED_GAMES, ...userData.games];
            
            let text = ` My Game Shelf\n`;
            text += `${new Date().toLocaleDateString()}\n\n`;
            text += ` Today: ${playedToday}/${totalGames} |  Best Streak: ${bestStreak}\n\n`;
            
            const playedGames = allGames.filter(g => allStats[g.id] && isToday(allStats[g.id].lastPlayed));
            if (playedGames.length > 0) {
                text += ` Played: ${playedGames.map(g => g.icon).join(' ')}\n`;
            }
            
            text += `\n gameshelf.app`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast(' Copied to clipboard!');
                // Unlock social achievement
                if (!userData.achievements['social']) {
                    userData.achievements['social'] = getTodayString();
                    saveData();
                    checkAndUnlockAchievements();
                }
            });
        }

        function shareNative() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            const shareData = {
                title: 'My Game Shelf',
                text: ` Game Shelf - ${playedToday}/${totalGames} played today! Best streak: ${bestStreak}`,
                url: 'https://gameshelf.app'
            };
            
            if (navigator.share) {
                navigator.share(shareData).then(() => {
                    // Unlock social achievement
                    if (!userData.achievements['social']) {
                        userData.achievements['social'] = getTodayString();
                        saveData();
                        checkAndUnlockAchievements();
                    }
                }).catch(() => {});
            } else {
                shareAsText();
            }
        }

        async function shareAsImage() {
            const preview = document.getElementById('share-preview');
            
            try {
                // Use html2canvas if available, otherwise fallback
                if (typeof html2canvas !== 'undefined') {
                    const canvas = await html2canvas(preview, {
                        backgroundColor: '#1a1a2e',
                        scale: 2
                    });
                    
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'gameshelf-' + getTodayString() + '.png';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast(' Image saved!');
                    });
                } else {
                    // Fallback: copy text instead
                    showToast(' Copying text instead...');
                    shareAsText();
                }
            } catch (err) {
                shareAsText();
            }
        }

        // ============================================================================
        // SCREENSHOT PARSER MODULE - Import historical stats from screenshots
        // Version: 1.1.0 - Added NYT Profile multi-game support
        // ============================================================================

        const ScreenshotTemplates = {
            // NYT Profile "Me" view - shows multiple games
            nytProfile: {
                name: 'NYT Games Profile',
                icon: '',
                identifiers: ['spelling bee', 'wordle', 'connections', 'me', 'games', 'friends'],
                isMultiGame: true,
                // Game section headers to look for
                gameSections: ['spelling bee', 'wordle', 'connections', 'strands', 'mini', 'the crossword']
            },
            
            wordle: {
                name: 'Wordle Stats',
                icon: '',
                identifiers: ['played', 'win', 'current streak', 'max streak', 'guess distribution'],
                patterns: {
                    // Support both "123 Puzzles Played" and "Puzzles Played 123"
                    played: /(?:(\d[\d,]*)\s*(?:puzzles?\s*)?played|played\s*(\d[\d,]*))/i,
                    winPercent: /(?:(\d+)\s*%?\s*(?:win|won)|(?:win|won)\s*(?:rate)?\s*(\d+)\s*%?)/i,
                    currentStreak: /(?:(\d+)\s*current\s*streak|current\s*streak\s*(\d+))/i,
                    maxStreak: /(?:(\d+)\s*max\s*streak|max\s*streak\s*(\d+))/i,
                },
                dataFields: ['played', 'winPercent', 'currentStreak', 'maxStreak', 'guessDistribution']
            },
            
            connections: {
                name: 'Connections Stats',
                icon: '',
                identifiers: ['connections', 'puzzles', 'current streak', 'max streak'],
                patterns: {
                    solved: /(?:(\d[\d,]*)\s*(?:puzzles?\s*)?(?:played|solved)|(?:played|solved)\s*(\d[\d,]*))/i,
                    winPercent: /(?:(\d+)\s*%?\s*(?:win|won)|(?:win|won)\s*(?:rate)?\s*(\d+)\s*%?)/i,
                    currentStreak: /(?:(\d+)\s*current\s*streak|current\s*streak\s*(\d+))/i,
                    maxStreak: /(?:(\d+)\s*max\s*streak|max\s*streak\s*(\d+))/i,
                },
                dataFields: ['solved', 'currentStreak', 'maxStreak']
            },
            
            strands: {
                name: 'Strands Stats',
                icon: '',
                identifiers: ['strands', 'puzzles solved', 'hints used'],
                patterns: {
                    solved: /(?:(\d[\d,]*)\s*(?:puzzles?\s*)?solved|solved\s*(\d[\d,]*))/i,
                    hintsUsed: /(?:(\d+)\s*hints?\s*used|hints?\s*used\s*(\d+))/i,
                    perfectGames: /(?:(\d+)\s*perfect|perfect\s*(\d+))/i,
                },
                dataFields: ['solved', 'hintsUsed', 'perfectGames']
            },
            
            spellingBee: {
                name: 'Spelling Bee Stats',
                icon: '',
                identifiers: ['spelling bee', 'genius', 'pangram', 'puzzles'],
                patterns: {
                    puzzlesPlayed: /(?:(\d[\d,]*)\s*puzzles?\s*(?:played|started)|puzzles?\s*(?:played|started)\s*(\d[\d,]*))/i,
                    geniuses: /(?:(\d+)\s*genius(?:es)?|genius(?:es)?\s*(\d+))/i,
                    pangrams: /(?:(\d+)\s*pangrams?|pangrams?\s*(\d+))/i,
                    words: /(?:(\d[\d,]*)\s*words|words\s*(\d[\d,]*))/i,
                },
                dataFields: ['puzzlesPlayed', 'geniuses', 'pangrams', 'words']
            },
            
            mini: {
                name: 'Mini Crossword Stats',
                icon: '',
                identifiers: ['mini', 'crossword', 'solved', 'average time', 'best time'],
                patterns: {
                    solved: /(?:(\d[\d,]*)\s*solved|solved\s*(\d[\d,]*))/i,
                    avgTime: /average.*?(\d+):(\d+)/i,
                    bestTime: /best.*?(\d+):(\d+)/i,
                    currentStreak: /(?:(\d+)\s*current\s*streak|current\s*streak\s*(\d+))/i,
                },
                dataFields: ['solved', 'avgTime', 'bestTime', 'currentStreak']
            }
        };

        // Tesseract.js loader
        let tesseractWorker = null;
        let tesseractLoading = false;
        let tesseractReady = false;

        async function loadTesseract() {
            if (tesseractReady) return true;
            if (tesseractLoading) {
                return new Promise(resolve => {
                    const check = setInterval(() => {
                        if (tesseractReady) {
                            clearInterval(check);
                            resolve(true);
                        }
                    }, 100);
                });
            }
            
            tesseractLoading = true;
            
            try {
                if (typeof Tesseract === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                
                tesseractWorker = await Tesseract.createWorker('eng');
                tesseractReady = true;
                tesseractLoading = false;
                console.log(' Tesseract OCR loaded');
                return true;
            } catch (e) {
                console.error('Failed to load Tesseract:', e);
                tesseractLoading = false;
                return false;
            }
        }

        // Image Preprocessor
        const ImagePreprocessor = {
            async loadImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            },
            
            imageToCanvas(img) {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                return canvas;
            },
            
            preprocessForOCR(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const contrast = 1.5;
                    const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
                    const newGray = Math.min(255, Math.max(0, factor * (gray - 128) + 128));
                    const threshold = 128;
                    const final = newGray > threshold ? 255 : 0;
                    
                    data[i] = final;
                    data[i + 1] = final;
                    data[i + 2] = final;
                }
                
                ctx.putImageData(imageData, 0, 0);
                return canvas;
            },
            
            isDarkMode(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                let totalBrightness = 0;
                const pixels = data.length / 4;
                
                for (let i = 0; i < data.length; i += 4) {
                    totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                
                return (totalBrightness / pixels) < 128;
            },
            
            invertIfDark(canvas) {
                if (!this.isDarkMode(canvas)) return canvas;
                
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = 255 - data[i];
                    data[i + 1] = 255 - data[i + 1];
                    data[i + 2] = 255 - data[i + 2];
                }
                
                ctx.putImageData(imageData, 0, 0);
                return canvas;
            }
        };

        // Wordle Distribution Analyzer
        const WordleDistributionAnalyzer = {
            analyzeDistribution(canvas) {
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                
                const startY = Math.floor(height * 0.4);
                const endY = Math.floor(height * 0.95);
                const barRegions = this.findBarRegions(ctx, width, height, startY, endY);
                
                if (barRegions.length === 6) {
                    const maxWidth = Math.max(...barRegions.map(b => b.width));
                    barRegions.forEach((bar, i) => {
                        const ratio = bar.width / maxWidth;
                        distribution[i + 1] = bar.count || Math.round(ratio * 100);
                    });
                }
                
                return distribution;
            },
            
            findBarRegions(ctx, width, height, startY, endY) {
                const bars = [];
                const imageData = ctx.getImageData(0, startY, width, endY - startY);
                const data = imageData.data;
                const scanWidth = width;
                const scanHeight = endY - startY;
                
                const isGreenish = (r, g, b) => g > 100 && g > r && g > b * 0.8;
                
                let currentBar = null;
                
                for (let y = 0; y < scanHeight; y += 5) {
                    let greenPixels = 0;
                    let barStart = -1;
                    let barEnd = -1;
                    
                    for (let x = 0; x < scanWidth; x++) {
                        const idx = (y * scanWidth + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        
                        if (isGreenish(r, g, b)) {
                            greenPixels++;
                            if (barStart === -1) barStart = x;
                            barEnd = x;
                        }
                    }
                    
                    if (greenPixels > width * 0.05) {
                        if (!currentBar) {
                            currentBar = { startY: y, width: barEnd - barStart, count: 0 };
                        }
                    } else if (currentBar) {
                        bars.push(currentBar);
                        currentBar = null;
                        if (bars.length >= 6) break;
                    }
                }
                
                return bars;
            }
        };

        // Main Screenshot Parser
        const ScreenshotParser = {
            async parse(file, onProgress = () => {}) {
                const result = {
                    success: false,
                    gameType: null,
                    gameName: null,
                    data: {},
                    confidence: 0,
                    rawText: '',
                    error: null,
                    debugInfo: {},
                    // For multi-game screenshots
                    isMultiGame: false,
                    games: []
                };
                
                try {
                    onProgress({ stage: 'loading', message: 'Loading image...' });
                    
                    const img = await ImagePreprocessor.loadImage(file);
                    let canvas = ImagePreprocessor.imageToCanvas(img);
                    
                    onProgress({ stage: 'preprocessing', message: 'Preprocessing...' });
                    
                    // Skip inversion - NYT profile has colored cards that confuse dark mode detection
                    // canvas = ImagePreprocessor.invertIfDark(canvas);
                    
                    onProgress({ stage: 'ocr-loading', message: 'Loading OCR engine...' });
                    const ocrReady = await loadTesseract();
                    
                    if (!ocrReady) {
                        throw new Error('Failed to load OCR engine');
                    }
                    
                    onProgress({ stage: 'ocr', message: 'Reading text from image...' });
                    
                    const { data: { text } } = await tesseractWorker.recognize(canvas);
                    result.rawText = text;
                    
                    console.log('=== OCR RAW TEXT ===');
                    console.log(text);
                    console.log('=== END OCR ===');
                    
                    onProgress({ stage: 'detecting', message: 'Detecting game type...' });
                    
                    // Check if this is a multi-game profile screenshot
                    const isNytProfile = this.detectNytProfile(text);
                    result.debugInfo.isNytProfile = isNytProfile;
                    
                    console.log('NYT Profile detection:', isNytProfile);
                    
                    if (isNytProfile) {
                        onProgress({ stage: 'extracting', message: 'Extracting multiple game stats...' });
                        
                        result.isMultiGame = true;
                        result.gameType = 'nytProfile';
                        result.gameName = 'NYT Games Profile';
                        result.confidence = isNytProfile.confidence;
                        result.games = this.extractMultiGameData(text);
                        result.debugInfo.gamesFound = result.games.length;
                        result.debugInfo.gameTypes = result.games.map(g => g.gameType);
                        
                        console.log('Games extracted:', result.games);
                        
                        result.success = result.games.length > 0;
                        
                        if (!result.success) {
                            result.error = `Detected NYT profile but couldn't extract game data. Found game headers but no stats.`;
                        }
                        
                    } else {
                        // Single game detection
                        const detected = this.detectGameType(text);
                        result.debugInfo.singleGameDetection = detected;
                        
                        console.log('Single game detection:', detected);
                        
                        if (!detected) {
                            result.error = 'Could not identify which game this screenshot is from. Try uploading a stats screen.';
                            return result;
                        }
                        
                        result.gameType = detected.type;
                        result.gameName = detected.template.name;
                        result.confidence = detected.confidence;
                        
                        onProgress({ stage: 'extracting', message: `Extracting ${detected.template.name} data...` });
                        
                        const extractedData = this.extractData(text, detected.template);
                        result.data = extractedData;
                        
                        if (detected.type === 'wordle') {
                            try {
                                const distribution = WordleDistributionAnalyzer.analyzeDistribution(canvas);
                                result.data.guessDistribution = distribution;
                            } catch (e) {
                                console.log('Could not analyze distribution bars:', e);
                            }
                        }
                        
                        result.success = Object.keys(extractedData).length > 0;
                    }
                    
                    onProgress({ stage: 'complete', message: 'Done!' });
                    
                } catch (e) {
                    result.error = e.message;
                    console.error('Screenshot parsing error:', e);
                }
                
                return result;
            },
            
            /**
             * Detect if this is an NYT Games Profile (multi-game) screenshot
             */
            detectNytProfile(text) {
                const textLower = text.toLowerCase();
                
                // Primary game headers (exact match)
                const gameHeaders = ['spelling bee', 'wordle', 'connections', 'strands'];
                // Fallback partial matches (OCR might miss parts)
                const partialMatches = ['spelli', 'wordl', 'connect', 'strand', 'puzzles played', 'win rate', 'max streak'];
                
                let foundGames = 0;
                let foundGamesList = [];
                
                for (const game of gameHeaders) {
                    if (textLower.includes(game)) {
                        foundGames++;
                        foundGamesList.push(game);
                    }
                }
                
                // If we didn't find enough exact matches, try partial
                if (foundGames < 2) {
                    let partialCount = 0;
                    for (const partial of partialMatches) {
                        if (textLower.includes(partial)) {
                            partialCount++;
                        }
                    }
                    // If we found several partial matches, likely a profile
                    if (partialCount >= 3) {
                        foundGames = 2; // Force detection
                        foundGamesList.push('(partial matches)');
                    }
                }
                
                console.log('NYT Profile detection - found games:', foundGamesList);
                
                // If we find 2+ game headers, it's likely a profile view
                if (foundGames >= 2) {
                    return { confidence: Math.min(foundGames / 3, 1), foundGames: foundGamesList };
                }
                
                // Also check for "Me" tab indicator
                if (textLower.includes('games') && textLower.includes('friends') && textLower.includes('me')) {
                    return { confidence: 0.8 };
                }
                
                // Last resort - check for NYT-specific stat patterns
                const hasStats = (textLower.includes('puzzles') || textLower.includes('played')) &&
                                (textLower.includes('streak') || textLower.includes('win'));
                if (hasStats) {
                    return { confidence: 0.5, fallback: true };
                }
                
                return null;
            },
            
            /**
             * Extract data for multiple games from NYT Profile screenshot
             * Uses position-based parsing since OCR returns numbers and labels on separate lines
             */
            extractMultiGameData(text) {
                const games = [];
                
                // Split text into sections by game headers
                const sections = this.splitByGameSections(text);
                
                console.log('Found sections:', sections.map(s => s.gameType));
                
                for (const section of sections) {
                    const gameType = section.gameType;
                    const { data, ocrWarnings } = this.extractNytProfileGameData(gameType, section.text);
                    
                    if (Object.keys(data).length > 0) {
                        const template = ScreenshotTemplates[gameType];
                        games.push({
                            gameType: gameType,
                            gameName: template?.name || gameType,
                            icon: template?.icon || '',
                            data: data,
                            ocrWarnings: ocrWarnings || []
                        });
                    }
                }
                
                return games;
            },
            
            /**
             * Extract game data from NYT Profile format
             * Format is: numbers on one line, labels on following lines
             */
            extractNytProfileGameData(gameType, text) {
                const data = {};
                const ocrWarnings = []; // Track fields with OCR issues
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                
                console.log(`Parsing ${gameType}:`, lines);
                
                // Find the line with numbers (contains multiple numbers/percentages)
                let numbersLine = null;
                let numbersLineIndex = -1;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // Look for line with multiple numbers
                    const numbers = line.match(/[\d,]+[.\-]{0,5}%?/g);
                    if (numbers && numbers.length >= 2) {
                        numbersLine = line;
                        numbersLineIndex = i;
                        break;
                    }
                }
                
                if (!numbersLine) {
                    console.log(`No numbers line found for ${gameType}`);
                    return { data, ocrWarnings };
                }
                
                // Extract all numbers from the numbers line
                const numberMatches = numbersLine.match(/[\d,]+[.\-]{0,5}%?/g) || [];
                const numbers = numberMatches.map(n => {
                    const hasPercent = n.includes('%');
                    // Check for truncation indicators: ..., ---, , or numbers ending in dots/dashes
                    const isTruncated = /[.\-]{2,}/.test(n) || /\d[.\-]+$/.test(n);
                    const cleaned = n.replace(/[,%.\-]/g, '');
                    const value = parseInt(cleaned) || 0;
                    return { value, hasPercent, raw: n, isTruncated };
                });
                
                console.log(`Numbers found:`, numbers);
                
                // Collect all label text after the numbers line
                const labelText = lines.slice(numbersLineIndex + 1).join(' ').toLowerCase();
                
                console.log(`Labels text: "${labelText}"`);
                
                // Helper to add warning if value looks suspicious
                const addIfTruncated = (index, fieldName) => {
                    if (numbers[index]?.isTruncated) {
                        ocrWarnings.push({
                            field: fieldName,
                            raw: numbers[index].raw,
                            value: numbers[index].value
                        });
                    }
                };
                
                // Map numbers to fields based on game type and label detection
                switch (gameType) {
                    case 'spellingBee':
                        // Expected: Puzzles Played, Words, Pangrams, Geniuses
                        if (numbers.length >= 1) { data.puzzlesPlayed = numbers[0].value; addIfTruncated(0, 'puzzlesPlayed'); }
                        if (numbers.length >= 2) { data.words = numbers[1].value; addIfTruncated(1, 'words'); }
                        if (numbers.length >= 3) { data.pangrams = numbers[2].value; addIfTruncated(2, 'pangrams'); }
                        if (numbers.length >= 4) { data.geniuses = numbers[3].value; addIfTruncated(3, 'geniuses'); }
                        break;
                        
                    case 'wordle':
                        // Expected: Puzzles Played, Win Rate %, Current Streak, Max Streak
                        if (numbers.length >= 1) { data.played = numbers[0].value; addIfTruncated(0, 'played'); }
                        if (numbers.length >= 2) { data.winPercent = numbers[1].value; addIfTruncated(1, 'winPercent'); }
                        if (numbers.length >= 3) { data.currentStreak = numbers[2].value; addIfTruncated(2, 'currentStreak'); }
                        if (numbers.length >= 4) { data.maxStreak = numbers[3].value; addIfTruncated(3, 'maxStreak'); }
                        break;
                        
                    case 'connections':
                        // Expected: Puzzles Played, Win Rate %, Current Streak, Max Streak
                        if (numbers.length >= 1) { data.solved = numbers[0].value; addIfTruncated(0, 'solved'); }
                        if (numbers.length >= 2) { data.winPercent = numbers[1].value; addIfTruncated(1, 'winPercent'); }
                        if (numbers.length >= 3) { data.currentStreak = numbers[2].value; addIfTruncated(2, 'currentStreak'); }
                        if (numbers.length >= 4) { data.maxStreak = numbers[3].value; addIfTruncated(3, 'maxStreak'); }
                        break;
                        
                    case 'strands':
                        // Expected: Puzzles Solved, Hints Used, Perfect Games
                        if (numbers.length >= 1) { data.solved = numbers[0].value; addIfTruncated(0, 'solved'); }
                        if (numbers.length >= 2) { data.hintsUsed = numbers[1].value; addIfTruncated(1, 'hintsUsed'); }
                        if (numbers.length >= 3) { data.perfectGames = numbers[2].value; addIfTruncated(2, 'perfectGames'); }
                        break;
                        
                    case 'mini':
                        // Expected: Solved, Best Time, Avg Time, Streak
                        if (numbers.length >= 1) { data.solved = numbers[0].value; addIfTruncated(0, 'solved'); }
                        if (numbers.length >= 2) { data.currentStreak = numbers[1].value; addIfTruncated(1, 'currentStreak'); }
                        break;
                }
                
                console.log(`Extracted data for ${gameType}:`, data);
                if (ocrWarnings.length > 0) {
                    console.log(`OCR Warnings for ${gameType}:`, ocrWarnings);
                }
                
                // Fix common OCR errors
                // Win percentages > 100 are likely misread (e.g., "81%" read as "817")
                if (data.winPercent && data.winPercent > 100) {
                    // Try to extract a reasonable percentage
                    const str = String(data.winPercent);
                    if (str.length === 3 && str.endsWith('7')) {
                        // 817 -> 81, 987 -> 98, etc. (7 is often misread %)
                        data.winPercent = parseInt(str.slice(0, 2));
                    } else if (str.length === 3) {
                        data.winPercent = parseInt(str.slice(0, 2));
                    }
                }
                
                return { data, ocrWarnings };
            },
            
            /**
             * Split OCR text into game sections
             */
            splitByGameSections(text) {
                const sections = [];
                const lines = text.split('\n');
                
                // Game markers - include partial matches for OCR errors
                const gameMarkers = {
                    'spelling bee': 'spellingBee',
                    'spelling': 'spellingBee',
                    'spelli': 'spellingBee',
                    'wordle': 'wordle',
                    'wordl': 'wordle',
                    'connections': 'connections',
                    'connect': 'connections',
                    'strands': 'strands',
                    'strand': 'strands',
                    'mini': 'mini',
                    'the crossword': 'crossword'
                };
                
                let currentGame = null;
                let currentLines = [];
                
                console.log('splitByGameSections - input lines:', lines.length);
                
                for (const line of lines) {
                    const lineLower = line.toLowerCase().trim();
                    
                    // Skip empty lines
                    if (!lineLower) continue;
                    
                    // Check if this line is a game header
                    let foundGame = null;
                    for (const [marker, gameType] of Object.entries(gameMarkers)) {
                        // Check if line starts with or contains marker, and isn't too long
                        if ((lineLower.startsWith(marker) || lineLower.includes(marker)) && lineLower.length < 40) {
                            foundGame = gameType;
                            console.log(`Found game header: "${lineLower}" -> ${gameType}`);
                            break;
                        }
                    }
                    
                    if (foundGame) {
                        // Save previous section
                        if (currentGame && currentLines.length > 0) {
                            sections.push({
                                gameType: currentGame,
                                text: currentLines.join('\n')
                            });
                            console.log(`Saved section for ${currentGame} with ${currentLines.length} lines`);
                        }
                        // Start new section
                        currentGame = foundGame;
                        currentLines = [line];
                    } else if (currentGame) {
                        currentLines.push(line);
                    }
                }
                
                // Don't forget the last section
                if (currentGame && currentLines.length > 0) {
                    sections.push({
                        gameType: currentGame,
                        text: currentLines.join('\n')
                    });
                    console.log(`Saved final section for ${currentGame} with ${currentLines.length} lines`);
                }
                
                console.log('splitByGameSections - total sections:', sections.length);
                return sections;
            },
            
            detectGameType(text) {
                const textLower = text.toLowerCase();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const [type, template] of Object.entries(ScreenshotTemplates)) {
                    if (template.isMultiGame) continue; // Skip multi-game template
                    
                    let score = 0;
                    
                    for (const identifier of template.identifiers) {
                        if (textLower.includes(identifier.toLowerCase())) {
                            score++;
                        }
                    }
                    
                    const confidence = score / template.identifiers.length;
                    
                    if (confidence > bestScore && confidence > 0.3) {
                        bestScore = confidence;
                        bestMatch = { type, template, confidence };
                    }
                }
                
                return bestMatch;
            },
            
            extractData(text, template) {
                const data = {};
                
                // Clean up text - handle OCR artifacts
                const cleanText = text
                    .replace(/[|]/g, '')
                    .replace(/\s+/g, ' ')
                    .replace(/(\d),(\d)/g, '$1$2'); // Remove commas in numbers for parsing
                
                for (const [field, pattern] of Object.entries(template.patterns)) {
                    const match = cleanText.match(pattern);
                    
                    if (match) {
                        // Handle bidirectional patterns (value might be in group 1 or 2)
                        if (match.length === 2) {
                            data[field] = this.parseNumber(match[1]);
                        } else if (match.length === 3) {
                            // Time format OR bidirectional pattern
                            if (match[1] && match[2] && !isNaN(parseInt(match[1])) && !isNaN(parseInt(match[2]))) {
                                // Could be time (min:sec) - check if field suggests time
                                if (field.toLowerCase().includes('time')) {
                                    data[field] = {
                                        minutes: parseInt(match[1]),
                                        seconds: parseInt(match[2]),
                                        total: `${match[1]}:${match[2].padStart(2, '0')}`
                                    };
                                } else {
                                    // Bidirectional - take whichever matched
                                    data[field] = this.parseNumber(match[1] || match[2]);
                                }
                            } else {
                                // Bidirectional pattern - one will be undefined
                                data[field] = this.parseNumber(match[1] || match[2]);
                            }
                        }
                    }
                }
                
                return data;
            },
            
            /**
             * Parse a number string, handling commas and truncation
             */
            parseNumber(str) {
                if (!str) return null;
                // Remove commas and handle "1,3..." truncated numbers
                const cleaned = str.replace(/,/g, '').replace(/\.{2,}$/, '');
                const num = parseInt(cleaned);
                return isNaN(num) ? str : num;
            },
            
            toGameShelfFormat(parseResult) {
                if (!parseResult.success) return null;
                
                // Handle multi-game results
                if (parseResult.isMultiGame) {
                    return parseResult.games.map(game => this.singleGameToFormat(game.gameType, game.data));
                }
                
                // Single game
                return this.singleGameToFormat(parseResult.gameType, parseResult.data);
            },
            
            singleGameToFormat(gameType, data) {
                const result = {
                    gameId: gameType,
                    stats: {
                        totalPlays: 0,
                        streak: 0,
                        maxStreak: 0
                    },
                    importedAt: new Date().toISOString(),
                    source: 'screenshot'
                };
                
                switch (gameType) {
                    case 'wordle':
                        result.stats.totalPlays = data.played || 0;
                        result.stats.streak = data.currentStreak || 0;
                        result.stats.maxStreak = data.maxStreak || 0;
                        result.stats.winPercent = data.winPercent || 0;
                        result.stats.guessDistribution = data.guessDistribution || null;
                        break;
                        
                    case 'connections':
                        result.stats.totalPlays = data.solved || 0;
                        result.stats.streak = data.currentStreak || 0;
                        result.stats.maxStreak = data.maxStreak || 0;
                        result.stats.winPercent = data.winPercent || 0;
                        break;
                        
                    case 'strands':
                        result.stats.totalPlays = data.solved || 0;
                        result.stats.hintsUsed = data.hintsUsed || 0;
                        result.stats.perfectGames = data.perfectGames || 0;
                        break;
                        
                    case 'spellingBee':
                        result.gameId = 'spelling-bee';
                        result.stats.totalPlays = data.puzzlesPlayed || 0;
                        result.stats.geniusCount = data.geniuses || 0;
                        result.stats.pangrams = data.pangrams || 0;
                        result.stats.words = data.words || 0;
                        break;
                        
                    case 'mini':
                        result.stats.totalPlays = data.solved || 0;
                        result.stats.streak = data.currentStreak || 0;
                        result.stats.bestTime = data.bestTime || null;
                        result.stats.avgTime = data.avgTime || null;
                        break;
                }
                
                return result;
            }
        };

        // Screenshot Import UI
        const ScreenshotImportUI = {
            show() {
                this.hide();
                
                const modal = document.createElement('div');
                modal.id = 'screenshot-import-modal';
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 480px;">
                        <h2> Import from Screenshot</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Upload a screenshot of your game stats to import your history.
                        </p>
                        
                        <div class="screenshot-dropzone" id="screenshot-dropzone">
                            <div class="dropzone-content">
                                <div class="dropzone-icon"></div>
                                <div class="dropzone-text">
                                    <strong>Drop screenshot here</strong>
                                    <span>or tap to select</span>
                                </div>
                            </div>
                            <input type="file" id="screenshot-input" accept="image/*" style="display: none;">
                        </div>
                        
                        <div class="supported-games">
                            <div class="supported-label">Supported stats screens:</div>
                            <div class="supported-list">
                                ${Object.values(ScreenshotTemplates).map(t => 
                                    `<span class="supported-game">${t.icon} ${t.name}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div id="screenshot-preview" style="display: none;">
                            <img id="screenshot-preview-img" style="max-width: 100%; border-radius: 8px; margin: 15px 0;">
                        </div>
                        
                        <div id="screenshot-progress" style="display: none;">
                            <div class="screenshot-progress-bar">
                                <div class="screenshot-progress-fill" id="screenshot-progress-fill"></div>
                            </div>
                            <div class="screenshot-progress-text" id="screenshot-progress-text">Processing...</div>
                        </div>
                        
                        <div id="screenshot-results" style="display: none;"></div>
                        
                        <div class="btn-group" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="ScreenshotImportUI.hide()">Cancel</button>
                            <button class="btn btn-primary" id="screenshot-import-btn" style="display: none;" onclick="ScreenshotImportUI.confirmImport()">
                                Import Data
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        .screenshot-dropzone {
                            border: 2px dashed var(--bg-hover);
                            border-radius: 12px;
                            padding: 40px 20px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.2s;
                            margin-bottom: 20px;
                        }
                        .screenshot-dropzone:hover,
                        .screenshot-dropzone.dragover {
                            border-color: var(--accent-gold);
                            background: var(--bg-secondary);
                        }
                        .dropzone-icon {
                            font-size: 3rem;
                            margin-bottom: 10px;
                        }
                        .dropzone-text {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        .dropzone-text strong {
                            color: var(--text-primary);
                        }
                        .dropzone-text span {
                            color: var(--text-muted);
                            font-size: 0.85rem;
                        }
                        
                        .supported-games {
                            background: var(--bg-secondary);
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 15px;
                        }
                        .supported-label {
                            font-size: 0.8rem;
                            color: var(--text-muted);
                            margin-bottom: 8px;
                        }
                        .supported-list {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 8px;
                        }
                        .supported-game {
                            background: var(--bg-card);
                            padding: 4px 10px;
                            border-radius: 12px;
                            font-size: 0.8rem;
                        }
                        
                        .screenshot-progress-bar {
                            height: 6px;
                            background: var(--bg-hover);
                            border-radius: 3px;
                            overflow: hidden;
                            margin-bottom: 10px;
                        }
                        .screenshot-progress-fill {
                            height: 100%;
                            background: var(--accent-gold);
                            width: 0%;
                            transition: width 0.3s;
                        }
                        .screenshot-progress-text {
                            font-size: 0.85rem;
                            color: var(--text-secondary);
                            text-align: center;
                        }
                        
                        .import-result {
                            background: var(--bg-secondary);
                            border-radius: 12px;
                            padding: 15px;
                            margin-top: 15px;
                        }
                        .import-result.success {
                            border-left: 4px solid var(--accent-green);
                        }
                        .import-result.error {
                            border-left: 4px solid var(--accent-red);
                        }
                        .result-header {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            margin-bottom: 10px;
                        }
                        .result-icon {
                            font-size: 1.5rem;
                        }
                        .result-title {
                            font-weight: 700;
                        }
                        .result-data {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                        }
                        .result-stat {
                            background: var(--bg-card);
                            padding: 10px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        .result-stat-value {
                            font-size: 1.3rem;
                            font-weight: 700;
                            color: var(--accent-gold);
                        }
                        .result-stat-label {
                            font-size: 0.75rem;
                            color: var(--text-muted);
                        }
                    </style>
                `;
                
                document.body.appendChild(modal);
                this._setupEventListeners();
            },
            
            hide() {
                const modal = document.getElementById('screenshot-import-modal');
                if (modal) modal.remove();
            },
            
            _setupEventListeners() {
                const dropzone = document.getElementById('screenshot-dropzone');
                const input = document.getElementById('screenshot-input');
                
                dropzone.addEventListener('click', () => input.click());
                
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this._handleFile(e.target.files[0]);
                    }
                });
                
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length > 0) {
                        this._handleFile(e.dataTransfer.files[0]);
                    }
                });
            },
            
            async _handleFile(file) {
                const preview = document.getElementById('screenshot-preview');
                const previewImg = document.getElementById('screenshot-preview-img');
                previewImg.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                const progress = document.getElementById('screenshot-progress');
                const progressFill = document.getElementById('screenshot-progress-fill');
                const progressText = document.getElementById('screenshot-progress-text');
                progress.style.display = 'block';
                
                const result = await ScreenshotParser.parse(file, ({ stage, message }) => {
                    progressText.textContent = message;
                    
                    const stages = ['loading', 'preprocessing', 'ocr-loading', 'ocr', 'detecting', 'extracting', 'complete'];
                    const stageIndex = stages.indexOf(stage);
                    progressFill.style.width = `${((stageIndex + 1) / stages.length) * 100}%`;
                });
                
                this._parseResult = result;
                this._showResults(result);
            },
            
            _showResults(result) {
                const resultsDiv = document.getElementById('screenshot-results');
                const importBtn = document.getElementById('screenshot-import-btn');
                
                // Helper to check if game has existing data
                const getExistingData = (gameType) => {
                    const gameId = gameType;
                    const stats = userData.stats[gameId];
                    if (!stats || (!stats.totalPlays && !stats.streak && !stats.maxStreak)) {
                        return null;
                    }
                    return stats;
                };
                
                // Helper to format existing vs new comparison
                const formatComparison = (gameType, existingStats) => {
                    if (!existingStats) return '';
                    
                    const fields = [];
                    if (existingStats.totalPlays) fields.push(`${existingStats.totalPlays} played`);
                    if (existingStats.streak) fields.push(`${existingStats.streak} streak`);
                    if (existingStats.maxStreak) fields.push(`${existingStats.maxStreak} max`);
                    if (existingStats.winPercent) fields.push(`${existingStats.winPercent}% win`);
                    
                    if (fields.length === 0) return '';
                    
                    return `
                        <div class="existing-data-warning">
                             Existing data: ${fields.join('  ')}
                            <div class="merge-note">Higher values will be kept</div>
                        </div>
                    `;
                };
                
                if (result.success) {
                    // Handle multi-game results
                    if (result.isMultiGame && result.games.length > 0) {
                        // Check which games have existing data
                        const gamesWithExisting = result.games.filter(g => getExistingData(g.gameType));
                        const hasExistingData = gamesWithExisting.length > 0;
                        
                        resultsDiv.innerHTML = `
                            <div class="import-result success">
                                <div class="result-header">
                                    <span class="result-icon"></span>
                                    <div>
                                        <div class="result-title">NYT Games Profile</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            Found ${result.games.length} game${result.games.length > 1 ? 's' : ''} - review & correct before importing
                                        </div>
                                    </div>
                                </div>
                                ${hasExistingData ? `
                                    <div class="existing-data-banner">
                                         ${gamesWithExisting.length} game${gamesWithExisting.length > 1 ? 's have' : ' has'} existing data. 
                                        Import will merge (keeping higher values).
                                    </div>
                                ` : ''}
                                ${result.games.some(g => g.ocrWarnings?.length > 0) ? `
                                    <div class="ocr-warning-banner">
                                         Some values may be incorrect (truncated numbers detected). Fields marked with  need review.
                                    </div>
                                ` : ''}
                                ${result.games.map((game, gameIndex) => {
                                    const existingStats = getExistingData(game.gameType);
                                    const hasOcrIssues = game.ocrWarnings?.length > 0;
                                    return `
                                    <div class="multi-game-section ${existingStats ? 'has-existing' : ''} ${hasOcrIssues ? 'has-ocr-warning' : ''}" data-game-index="${gameIndex}" data-game-type="${game.gameType}">
                                        <div class="multi-game-header">
                                            <input type="checkbox" class="game-import-checkbox" id="import-game-${gameIndex}" checked>
                                            <label for="import-game-${gameIndex}" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <span>${game.icon}</span>
                                                <span>${game.gameName}</span>
                                                ${hasOcrIssues ? '<span class="ocr-warning-badge" title="OCR may have misread some values"></span>' : ''}
                                            </label>
                                        </div>
                                        ${hasOcrIssues ? `
                                            <div class="ocr-field-warning">
                                                 Check these fields: ${game.ocrWarnings.map(w => `<strong>${w.field}</strong> (read as "${w.raw}")`).join(', ')}
                                            </div>
                                        ` : ''}
                                        ${formatComparison(game.gameType, existingStats)}
                                        <div class="result-data-editable">
                                            ${this._formatEditableGameData(game.gameType, game.data, gameIndex, game.ocrWarnings)}
                                        </div>
                                    </div>
                                `}).join('')}
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; text-align: center;">
                                     Click any value to correct OCR errors
                                </p>
                            </div>
                            <style>
                                .ocr-warning-banner {
                                    background: rgba(96, 165, 250, 0.15);
                                    border: 1px solid var(--accent-blue);
                                    border-radius: 8px;
                                    padding: 10px 12px;
                                    margin-bottom: 12px;
                                    font-size: 0.85rem;
                                    color: var(--accent-blue);
                                }
                                .ocr-field-warning {
                                    background: rgba(96, 165, 250, 0.1);
                                    border-radius: 6px;
                                    padding: 8px 10px;
                                    margin-bottom: 10px;
                                    font-size: 0.75rem;
                                    color: var(--accent-blue);
                                }
                                .ocr-warning-badge {
                                    font-size: 0.9rem;
                                }
                                .multi-game-section.has-ocr-warning {
                                    border: 1px solid rgba(96, 165, 250, 0.3);
                                }
                                .existing-data-banner {
                                    background: rgba(251, 146, 60, 0.15);
                                    border: 1px solid var(--accent-orange);
                                    border-radius: 8px;
                                    padding: 10px 12px;
                                    margin-bottom: 12px;
                                    font-size: 0.85rem;
                                    color: var(--accent-orange);
                                }
                                .existing-data-warning {
                                    background: rgba(251, 146, 60, 0.1);
                                    border-radius: 6px;
                                    padding: 8px 10px;
                                    margin-bottom: 10px;
                                    font-size: 0.8rem;
                                    color: var(--accent-orange);
                                }
                                .existing-data-warning .merge-note {
                                    font-size: 0.7rem;
                                    color: var(--text-muted);
                                    margin-top: 2px;
                                }
                                .multi-game-section.has-existing {
                                    border: 1px solid rgba(251, 146, 60, 0.3);
                                }
                                .multi-game-section {
                                    background: var(--bg-card);
                                    border-radius: 8px;
                                    padding: 12px;
                                    margin-top: 12px;
                                }
                                .multi-game-header {
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    font-weight: 700;
                                    margin-bottom: 10px;
                                    padding-bottom: 8px;
                                    border-bottom: 1px solid var(--bg-hover);
                                }
                                .game-import-checkbox {
                                    width: 18px;
                                    height: 18px;
                                    cursor: pointer;
                                }
                                .result-data-editable {
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 10px;
                                }
                                .result-stat-editable {
                                    background: var(--bg-secondary);
                                    padding: 8px;
                                    border-radius: 8px;
                                    text-align: center;
                                }
                                .result-stat-editable input {
                                    width: 80px;
                                    background: var(--bg-primary);
                                    border: 1px solid var(--bg-hover);
                                    border-radius: 6px;
                                    color: var(--accent-gold);
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                    text-align: center;
                                    padding: 4px 8px;
                                    font-family: inherit;
                                }
                                .result-stat-editable input:focus {
                                    outline: none;
                                    border-color: var(--accent-gold);
                                }
                                .result-stat-editable .stat-label {
                                    font-size: 0.75rem;
                                    color: var(--text-muted);
                                    margin-top: 4px;
                                }
                                .result-stat-editable.ocr-suspect {
                                    background: rgba(96, 165, 250, 0.15);
                                    border: 1px solid var(--accent-blue);
                                }
                                .result-stat-editable.ocr-suspect input {
                                    border-color: var(--accent-blue);
                                    color: var(--accent-blue);
                                }
                                .result-stat-editable.ocr-suspect .stat-label {
                                    color: var(--accent-blue);
                                }
                            </style>
                        `;
                    } else {
                        // Single game result
                        const gsData = ScreenshotParser.toGameShelfFormat(result);
                        const existingStats = getExistingData(result.gameType);
                        
                        resultsDiv.innerHTML = `
                            <div class="import-result success">
                                <div class="result-header">
                                    <span class="result-icon">${ScreenshotTemplates[result.gameType]?.icon || ''}</span>
                                    <div>
                                        <div class="result-title">${result.gameName}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            Confidence: ${Math.round(result.confidence * 100)}% - review & correct before importing
                                        </div>
                                    </div>
                                </div>
                                ${formatComparison(result.gameType, existingStats)}
                                <div class="result-data-editable" data-game-type="${result.gameType}">
                                    ${this._formatEditableResultData(result.gameType, gsData.stats, 0)}
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; text-align: center;">
                                     Click any value to correct OCR errors
                                </p>
                            </div>
                            <style>
                                .existing-data-warning {
                                    background: rgba(251, 146, 60, 0.1);
                                    border-radius: 6px;
                                    padding: 8px 10px;
                                    margin-bottom: 10px;
                                    font-size: 0.8rem;
                                    color: var(--accent-orange);
                                }
                                .existing-data-warning .merge-note {
                                    font-size: 0.7rem;
                                    color: var(--text-muted);
                                    margin-top: 2px;
                                }
                                .result-data-editable {
                                    display: grid;
                                    grid-template-columns: repeat(2, 1fr);
                                    gap: 10px;
                                    margin-top: 12px;
                                }
                                .result-stat-editable {
                                    background: var(--bg-secondary);
                                    padding: 8px;
                                    border-radius: 8px;
                                    text-align: center;
                                }
                                .result-stat-editable input {
                                    width: 80px;
                                    background: var(--bg-primary);
                                    border: 1px solid var(--bg-hover);
                                    border-radius: 6px;
                                    color: var(--accent-gold);
                                    font-size: 1.2rem;
                                    font-weight: 700;
                                    text-align: center;
                                    padding: 4px 8px;
                                    font-family: inherit;
                                }
                                .result-stat-editable input:focus {
                                    outline: none;
                                    border-color: var(--accent-gold);
                                }
                                .result-stat-editable .stat-label {
                                    font-size: 0.75rem;
                                    color: var(--text-muted);
                                    margin-top: 4px;
                                }
                            </style>
                        `;
                    }
                    
                    importBtn.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = `
                        <div class="import-result error">
                            <div class="result-header">
                                <span class="result-icon"></span>
                                <div>
                                    <div class="result-title">Could not parse screenshot</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                        ${result.error || 'Make sure you uploaded a stats screen from a supported game.'}
                                    </div>
                                </div>
                            </div>
                            ${result.rawText ? `
                                <details style="margin-top: 10px;" open>
                                    <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.8rem;">Show OCR text (debug)</summary>
                                    <pre style="font-size: 0.7rem; color: var(--text-muted); white-space: pre-wrap; margin-top: 8px; max-height: 200px; overflow-y: auto; background: var(--bg-card); padding: 10px; border-radius: 8px;">${result.rawText}</pre>
                                    ${result.debugInfo ? `
                                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">
                                            <strong>Debug:</strong> NYT Profile: ${result.debugInfo.isNytProfile ? 'Yes' : 'No'}, 
                                            Games found: ${result.debugInfo.gamesFound || 0}
                                            ${result.debugInfo.gameTypes ? ', Types: ' + result.debugInfo.gameTypes.join(', ') : ''}
                                        </div>
                                    ` : ''}
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    importBtn.style.display = 'none';
                }
                
                resultsDiv.style.display = 'block';
            },
            
            _formatGameData(gameType, data) {
                const items = [];
                
                switch (gameType) {
                    case 'wordle':
                        if (data.played) items.push({ label: 'Played', value: data.played });
                        if (data.winPercent) items.push({ label: 'Win %', value: data.winPercent + '%' });
                        if (data.currentStreak) items.push({ label: 'Streak', value: data.currentStreak });
                        if (data.maxStreak) items.push({ label: 'Max', value: data.maxStreak });
                        break;
                    case 'connections':
                        if (data.solved) items.push({ label: 'Played', value: data.solved });
                        if (data.winPercent) items.push({ label: 'Win %', value: data.winPercent + '%' });
                        if (data.currentStreak) items.push({ label: 'Streak', value: data.currentStreak });
                        if (data.maxStreak) items.push({ label: 'Max', value: data.maxStreak });
                        break;
                    case 'spellingBee':
                        if (data.puzzlesPlayed) items.push({ label: 'Played', value: data.puzzlesPlayed });
                        if (data.words) items.push({ label: 'Words', value: data.words });
                        if (data.pangrams) items.push({ label: 'Pangrams', value: data.pangrams });
                        if (data.geniuses) items.push({ label: 'Geniuses', value: data.geniuses });
                        break;
                    case 'strands':
                        if (data.solved) items.push({ label: 'Solved', value: data.solved });
                        if (data.hintsUsed) items.push({ label: 'Hints', value: data.hintsUsed });
                        if (data.perfectGames) items.push({ label: 'Perfect', value: data.perfectGames });
                        break;
                    default:
                        // Generic display
                        for (const [key, value] of Object.entries(data)) {
                            if (value !== null && value !== undefined) {
                                items.push({ label: key, value: value });
                            }
                        }
                }
                
                return items.map(item => `
                    <div class="result-stat">
                        <div class="result-stat-value">${item.value}</div>
                        <div class="result-stat-label">${item.label}</div>
                    </div>
                `).join('');
            },
            
            _formatResultData(stats) {
                const items = [];
                
                if (stats.totalPlays !== undefined) {
                    items.push({ label: 'Games Played', value: stats.totalPlays });
                }
                if (stats.streak !== undefined) {
                    items.push({ label: 'Current Streak', value: stats.streak });
                }
                if (stats.maxStreak !== undefined) {
                    items.push({ label: 'Max Streak', value: stats.maxStreak });
                }
                if (stats.winPercent !== undefined) {
                    items.push({ label: 'Win %', value: stats.winPercent + '%' });
                }
                if (stats.geniusCount !== undefined) {
                    items.push({ label: 'Genius Achieved', value: stats.geniusCount });
                }
                if (stats.bestTime !== undefined && stats.bestTime.total) {
                    items.push({ label: 'Best Time', value: stats.bestTime.total });
                }
                
                return items.map(item => `
                    <div class="result-stat">
                        <div class="result-stat-value">${item.value}</div>
                        <div class="result-stat-label">${item.label}</div>
                    </div>
                `).join('');
            },
            
            /**
             * Format game data with editable input fields for multi-game view
             */
            _formatEditableGameData(gameType, data, gameIndex, ocrWarnings = []) {
                const fields = [];
                const warningFields = new Set(ocrWarnings.map(w => w.field));
                
                switch (gameType) {
                    case 'wordle':
                        fields.push({ key: 'played', label: 'Played', value: data.played || 0 });
                        fields.push({ key: 'winPercent', label: 'Win %', value: data.winPercent || 0, suffix: '%' });
                        fields.push({ key: 'currentStreak', label: 'Streak', value: data.currentStreak || 0 });
                        fields.push({ key: 'maxStreak', label: 'Max Streak', value: data.maxStreak || 0 });
                        break;
                    case 'connections':
                        fields.push({ key: 'solved', label: 'Played', value: data.solved || 0 });
                        fields.push({ key: 'winPercent', label: 'Win %', value: data.winPercent || 0, suffix: '%' });
                        fields.push({ key: 'currentStreak', label: 'Streak', value: data.currentStreak || 0 });
                        fields.push({ key: 'maxStreak', label: 'Max Streak', value: data.maxStreak || 0 });
                        break;
                    case 'spellingBee':
                        fields.push({ key: 'puzzlesPlayed', label: 'Played', value: data.puzzlesPlayed || 0 });
                        fields.push({ key: 'words', label: 'Words', value: data.words || 0 });
                        fields.push({ key: 'pangrams', label: 'Pangrams', value: data.pangrams || 0 });
                        fields.push({ key: 'geniuses', label: 'Geniuses', value: data.geniuses || 0 });
                        break;
                    case 'strands':
                        fields.push({ key: 'solved', label: 'Solved', value: data.solved || 0 });
                        fields.push({ key: 'hintsUsed', label: 'Hints', value: data.hintsUsed || 0 });
                        fields.push({ key: 'perfectGames', label: 'Perfect', value: data.perfectGames || 0 });
                        break;
                    case 'mini':
                        fields.push({ key: 'solved', label: 'Solved', value: data.solved || 0 });
                        fields.push({ key: 'currentStreak', label: 'Streak', value: data.currentStreak || 0 });
                        break;
                }
                
                return fields.map(field => {
                    const hasWarning = warningFields.has(field.key);
                    return `
                    <div class="result-stat-editable ${hasWarning ? 'ocr-suspect' : ''}">
                        <input type="number" 
                               data-game-index="${gameIndex}" 
                               data-field="${field.key}" 
                               value="${field.value}" 
                               min="0"
                               class="${hasWarning ? 'ocr-suspect-input' : ''}">
                        <div class="stat-label">${hasWarning ? ' ' : ''}${field.label}${field.suffix || ''}</div>
                    </div>
                `}).join('');
            },
            
            /**
             * Format single game result with editable input fields
             */
            _formatEditableResultData(gameType, stats, gameIndex) {
                const fields = [];
                
                if (stats.totalPlays !== undefined) {
                    fields.push({ key: 'totalPlays', label: 'Games Played', value: stats.totalPlays });
                }
                if (stats.streak !== undefined) {
                    fields.push({ key: 'streak', label: 'Current Streak', value: stats.streak });
                }
                if (stats.maxStreak !== undefined) {
                    fields.push({ key: 'maxStreak', label: 'Max Streak', value: stats.maxStreak });
                }
                if (stats.winPercent !== undefined) {
                    fields.push({ key: 'winPercent', label: 'Win %', value: stats.winPercent, suffix: '%' });
                }
                if (stats.geniusCount !== undefined) {
                    fields.push({ key: 'geniusCount', label: 'Geniuses', value: stats.geniusCount });
                }
                
                return fields.map(field => `
                    <div class="result-stat-editable">
                        <input type="number" 
                               data-game-index="${gameIndex}" 
                               data-field="${field.key}" 
                               value="${field.value}" 
                               min="0">
                        <div class="stat-label">${field.label}${field.suffix || ''}</div>
                    </div>
                `).join('');
            },
            
            /**
             * Read edited values from input fields
             */
            _getEditedValues() {
                const results = [];
                const sections = document.querySelectorAll('.multi-game-section');
                
                if (sections.length > 0) {
                    // Multi-game mode
                    sections.forEach((section, index) => {
                        const checkbox = section.querySelector('.game-import-checkbox');
                        if (checkbox && !checkbox.checked) return; // Skip unchecked games
                        
                        const gameType = section.dataset.gameType;
                        const inputs = section.querySelectorAll('input[type="number"]');
                        const data = {};
                        
                        inputs.forEach(input => {
                            const field = input.dataset.field;
                            const value = parseInt(input.value) || 0;
                            data[field] = value;
                        });
                        
                        results.push({ gameType, data });
                    });
                } else {
                    // Single game mode
                    const container = document.querySelector('.result-data-editable');
                    if (container) {
                        const gameType = container.dataset.gameType;
                        const inputs = container.querySelectorAll('input[type="number"]');
                        const data = {};
                        
                        inputs.forEach(input => {
                            const field = input.dataset.field;
                            const value = parseInt(input.value) || 0;
                            data[field] = value;
                        });
                        
                        results.push({ gameType, data, isSingleGame: true });
                    }
                }
                
                return results;
            },
            
            confirmImport() {
                if (!this._parseResult || !this._parseResult.success) return;
                
                // Get edited values from input fields
                const editedGames = this._getEditedValues();
                
                if (editedGames.length === 0) {
                    showToast(' No games selected for import');
                    return;
                }
                
                let importCount = 0;
                
                for (const game of editedGames) {
                    let gsData;
                    
                    if (game.isSingleGame) {
                        // Single game - data is already in stats format
                        gsData = {
                            gameId: game.gameType,
                            stats: game.data,
                            importedAt: new Date().toISOString(),
                            source: 'screenshot'
                        };
                    } else {
                        // Multi-game - convert from raw data
                        gsData = ScreenshotParser.singleGameToFormat(game.gameType, game.data);
                    }
                    
                    if (gsData) {
                        this._importSingleGame(gsData);
                        importCount++;
                    }
                }
                
                if (importCount > 0) {
                    saveData();
                    
                    if (typeof renderFeaturedGames === 'function') renderFeaturedGames();
                    if (typeof renderMyGames === 'function') renderMyGames();
                    if (typeof updateStats === 'function') updateStats();
                    
                    const msg = importCount > 1 
                        ? ` Imported stats for ${importCount} games!`
                        : ' Stats imported successfully!';
                    showToast(msg);
                    
                    this.hide();
                }
            },
            
            _importSingleGame(gsData) {
                const gameId = gsData.gameId;
                
                if (!userData.stats[gameId]) {
                    userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
                
                const stats = userData.stats[gameId];
                
                // Only update if imported values are higher
                if (gsData.stats.totalPlays > (stats.totalPlays || 0)) {
                    stats.totalPlays = gsData.stats.totalPlays;
                }
                if (gsData.stats.maxStreak > (stats.maxStreak || 0)) {
                    stats.maxStreak = gsData.stats.maxStreak;
                }
                if (!stats.streak && gsData.stats.streak) {
                    stats.streak = gsData.stats.streak;
                }
                
                // Store additional stats based on game type
                if (gsData.stats.winPercent) stats.winPercent = gsData.stats.winPercent;
                if (gsData.stats.guessDistribution) stats.guessDistribution = gsData.stats.guessDistribution;
                if (gsData.stats.bestTime) stats.bestTime = gsData.stats.bestTime;
                if (gsData.stats.geniusCount) stats.geniusCount = gsData.stats.geniusCount;
                if (gsData.stats.pangrams) stats.pangrams = gsData.stats.pangrams;
                if (gsData.stats.words) stats.words = gsData.stats.words;
                if (gsData.stats.hintsUsed) stats.hintsUsed = gsData.stats.hintsUsed;
                if (gsData.stats.perfectGames) stats.perfectGames = gsData.stats.perfectGames;
                
                stats.importedFromScreenshot = true;
                stats.importedAt = gsData.importedAt;
            }
        };

        // ============ SERVICE WORKER (PWA) ============
        if ('serviceWorker' in navigator) {
            // Use relative path for GitHub Pages compatibility
            const swPath = new URL('sw.js', window.location.href).href;
            navigator.serviceWorker.register(swPath)
                .then((registration) => {
                    console.log(' Game Shelf PWA ready');
                })
                .catch((error) => {
                    console.log('Service worker registration failed:', error);
                });
        }

        // ============ START ============
        init();

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // ============ TOUR SYSTEM ============
        const TOUR_STEPS = [
            // WELCOME
            {
                target: null,
                icon: '',
                title: 'Welcome to Game Shelf!',
                problem: 'Daily puzzles are scattered across different apps and sites.',
                solution: 'Game Shelf is your central hub for ALL daily puzzle games. Track, compete, and share - all in one place!',
                position: 'center',
                action: null
            },
            
            // FEATURED GAMES
            {
                target: '#featured-games',
                icon: '',
                title: 'Featured Games',
                problem: 'Hard to discover new puzzle games worth playing.',
                solution: 'Browse curated games including NYT favorites and our originals (Quotle, Slate, Rungs). Click any card to play instantly!',
                position: 'bottom',
                action: () => switchTab('games')
            },
            
            // MY GAMES
            {
                target: '#my-games',
                icon: '',
                title: 'Your Personal Shelf',
                problem: '"Did I do Wordle today?" Hard to remember across 10+ games.',
                solution: 'Your added games appear here. Green border = completed today. Add games with the + button or from Discover below.',
                position: 'top',
                action: null
            },
            
            // ADD GAME
            {
                target: '.add-btn',
                icon: '',
                title: 'Add Games',
                problem: 'Your favorite game might not be featured.',
                solution: 'Click here to add from our catalog of 50+ games, or paste ANY game URL to add a custom game!',
                position: 'bottom',
                action: null
            },
            
            // INSIGHTS TAB
            {
                target: '[onclick="switchTab(\'insights\')"]',
                icon: '',
                title: 'Insights & Stats',
                problem: 'No way to see your puzzle performance over time.',
                solution: 'Click to see streaks, achievements, calendar history, and cross-game analytics. Let\'s take a look...',
                position: 'top',
                action: () => switchTab('insights')
            },
            
            // STREAKS (in Insights)
            {
                target: '#insights-stats-grid',
                icon: '',
                title: 'Streak Tracking',
                problem: 'Breaking a streak feels terrible, but you had no warning.',
                solution: 'See all your active streaks at a glance. We\'ll warn you when a streak is at risk of breaking!',
                position: 'bottom',
                action: null
            },
            
            // ACHIEVEMENTS (in Insights)
            {
                target: '#achievements-content',
                icon: '',
                title: 'Achievements',
                problem: 'Playing puzzles daily has no tangible reward.',
                solution: 'Unlock achievements for milestones like 7-day streaks, completing 100 games, or playing before 7am!',
                position: 'top',
                action: () => { const el = document.getElementById('achievements-content'); if(el) el.style.display = 'block'; }
            },
            
            // BATTLE TAB
            {
                target: '[onclick="switchTab(\'battle\')"]',
                icon: '',
                title: 'Brain Battles',
                problem: 'Puzzles are solo experiences with no competition.',
                solution: 'Challenge friends to puzzle duels! Compare scores across multiple games. Let\'s explore...',
                position: 'top',
                action: () => switchTab('battle')
            },
            
            // BATTLE CONTENT
            {
                target: '#battle-content',
                icon: '',
                title: 'Battle Types',
                problem: 'Everyone has different puzzle strengths.',
                solution: '1v1 Duels for head-to-head, Group Battles for friend groups, or Weekly Challenges. Create custom rules for any game!',
                position: 'bottom',
                action: () => { const el = document.getElementById('battle-content'); if(el) el.style.display = 'block'; }
            },
            
            // COMMUNITY TAB
            {
                target: '[onclick="switchTab(\'community\')"]',
                icon: '',
                title: 'Community',
                problem: 'You don\'t know what puzzles your friends play.',
                solution: 'See friend activity, add new friends, and discover what games are trending. Let\'s check it out...',
                position: 'top',
                action: () => switchTab('community')
            },
            
            // FRIENDS
            {
                target: '.add-friend-btn',
                icon: '',
                title: 'Add Friends',
                problem: 'Finding puzzle friends is hard.',
                solution: 'Share your unique friend code or link. See when friends complete games in real-time!',
                position: 'bottom',
                action: null
            },
            
            // SHARE HUB (back to games)
            {
                target: '.share-quick-btn',
                icon: '',
                title: 'Share Hub',
                problem: 'Sharing results to social media is tedious.',
                solution: 'One-click sharing to Twitter, Discord, and more. Combine multiple game results into a single post!',
                position: 'bottom',
                action: () => switchTab('games')
            },
            
            // SETTINGS
            {
                target: '.menu-btn',
                icon: '',
                title: 'Settings & More',
                problem: 'Every app works differently.',
                solution: 'Customize sounds, themes, tracking preferences. Set up app vs browser for each game. Export your data anytime.',
                position: 'bottom',
                action: null
            },
            
            // TOKENS & ECONOMY
            {
                target: '.hero-stats',
                icon: '',
                title: 'Earn Rewards',
                problem: 'Playing puzzles has no tangible benefit.',
                solution: 'Earn tokens for daily logins, streaks, and achievements. Spend on battles, cosmetics, or real merch!',
                position: 'bottom',
                action: () => switchTab('games')
            },
            
            // WRAP UP
            {
                target: null,
                icon: '',
                title: 'You\'re All Set!',
                problem: null,
                solution: 'Start by adding your favorite games, then invite friends to compete! Check back daily to maintain streaks.',
                position: 'center',
                action: null
            }
        ];
        
        let currentTourStep = 0;
        let tourActive = false;
        
        function startTour() {
            // Enable demo mode if not already
            if (!isDemoMode) {
                document.getElementById('demo-mode-toggle').checked = true;
                toggleDemoMode(true);
            }
            
            // Close any open modals
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            closePitchModal();
            
            // Start from games tab
            switchTab('games');
            
            currentTourStep = 0;
            tourActive = true;
            
            // Show tour overlay
            document.getElementById('tour-overlay').classList.add('active');
            
            // Show first step
            showTourStep(0);
        }
        
        function showTourStep(stepIndex) {
            const step = TOUR_STEPS[stepIndex];
            const tooltip = document.getElementById('tour-tooltip');
            const overlay = document.getElementById('tour-overlay');
            
            // Remove previous highlight
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            
            // Execute navigation action if present
            if (step.action && typeof step.action === 'function') {
                step.action();
            }
            
            // Small delay to let navigation complete
            setTimeout(() => {
                // Update progress dots (dynamically generate based on step count)
                const progressContainer = document.getElementById('tour-progress');
                if (progressContainer) {
                    // Only regenerate if count doesn't match
                    const dots = progressContainer.querySelectorAll('.tour-progress-dot');
                    if (dots.length !== TOUR_STEPS.length) {
                        progressContainer.innerHTML = TOUR_STEPS.map((_, i) => 
                            `<div class="tour-progress-dot ${i < stepIndex ? 'completed' : ''} ${i === stepIndex ? 'active' : ''}"></div>`
                        ).join('');
                    } else {
                        dots.forEach((dot, i) => {
                            dot.classList.remove('active', 'completed');
                            if (i < stepIndex) dot.classList.add('completed');
                            if (i === stepIndex) dot.classList.add('active');
                        });
                    }
                }
                
                // Update content
                document.getElementById('tour-icon').textContent = step.icon;
                document.getElementById('tour-title').textContent = step.title;
                
                const problemEl = document.getElementById('tour-problem');
                const solutionEl = document.getElementById('tour-solution');
                
                if (step.problem) {
                    problemEl.innerHTML = `<strong> Problem:</strong> ${step.problem}`;
                    problemEl.style.display = 'block';
                } else {
                    problemEl.style.display = 'none';
                }
                
                solutionEl.innerHTML = `<strong> Solution:</strong> ${step.solution}`;
                
                // Update button text
                const nextBtn = document.getElementById('tour-next-btn');
                nextBtn.textContent = stepIndex === TOUR_STEPS.length - 1 ? 'Finish Tour' : 'Next';
                
                // Update step counter
                document.getElementById('tour-step-counter').textContent = `Step ${stepIndex + 1} of ${TOUR_STEPS.length}`;
                
                // Position tooltip
                if (step.target && step.position !== 'center') {
                    const targetEl = document.querySelector(step.target);
                    if (targetEl) {
                        positionTooltipAtTarget(targetEl, step.position);
                    } else {
                        centerTooltip();
                    }
                } else {
                    centerTooltip();
                }
                
                // Show tooltip
                tooltip.classList.add('active');
            }, step.action ? 150 : 0);
        }
        
        function positionTooltipAtTarget(targetEl, position) {
            const tooltip = document.getElementById('tour-tooltip');
            const arrow = document.getElementById('tour-arrow');
            const rect = targetEl.getBoundingClientRect();
            
            // Highlight target
            targetEl.classList.add('tour-highlight');
            
            // Calculate position
            let top, left;
            const tooltipWidth = 340;
            const tooltipHeight = tooltip.offsetHeight || 300;
            const padding = 15;
            
            if (position === 'bottom') {
                top = rect.bottom + padding;
                left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                arrow.className = 'tour-tooltip-arrow top';
            } else if (position === 'top') {
                top = rect.top - tooltipHeight - padding;
                left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                arrow.className = 'tour-tooltip-arrow bottom';
            }
            
            // Keep on screen
            left = Math.max(10, Math.min(left, window.innerWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, window.innerHeight - tooltipHeight - 10));
            
            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
            arrow.style.display = 'block';
        }
        
        function centerTooltip() {
            const tooltip = document.getElementById('tour-tooltip');
            const arrow = document.getElementById('tour-arrow');
            
            tooltip.style.top = '50%';
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
            arrow.style.display = 'none';
            
            // Reset transform after positioning
            setTimeout(() => {
                tooltip.style.transform = '';
                const rect = tooltip.getBoundingClientRect();
                tooltip.style.top = (window.innerHeight - rect.height) / 2 + 'px';
                tooltip.style.left = (window.innerWidth - rect.width) / 2 + 'px';
            }, 10);
        }
        
        function nextTourStep() {
            currentTourStep++;
            
            if (currentTourStep >= TOUR_STEPS.length) {
                endTour();
            } else {
                showTourStep(currentTourStep);
            }
        }
        
        function endTour() {
            tourActive = false;
            
            // Hide overlay and tooltip
            document.getElementById('tour-overlay').classList.remove('active');
            document.getElementById('tour-tooltip').classList.remove('active');
            
            // Remove highlights
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            
            // Return to games tab
            switchTab('games');
            
            showToast(' Tour complete! Explore on your own.');
        }
        
        function skipTour() {
            endTour();
            showToast('Tour skipped. You can restart from the menu.');
        }
        
        // ============ URL PARAMETER HANDLING ============
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            // ?pitch - Show pitch page
            if (params.has('pitch')) {
                setTimeout(() => showPitchPage(), 500);
            }
            
            // ?market - Show market page
            if (params.has('market')) {
                setTimeout(() => showMarketPage(), 500);
            }
            
            // ?data - Show data strategy page
            if (params.has('data')) {
                setTimeout(() => showDataStrategyPage(), 500);
            }
            
            // ?pyramid - Show value pyramid page
            if (params.has('pyramid')) {
                setTimeout(() => showPyramidPage(), 500);
            }
            
            // ?demo - Enable demo mode
            if (params.has('demo')) {
                setTimeout(() => {
                    document.getElementById('demo-mode-toggle').checked = true;
                    toggleDemoMode(true);
                }, 500);
            }
            
            // ?tour - Start tour
            if (params.has('tour')) {
                setTimeout(() => startTour(), 800);
            }
        }
        
        // Run on load
        document.addEventListener('DOMContentLoaded', () => {
            handleUrlParams();
        });
        
        // Also check immediately in case DOM is already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(handleUrlParams, 100);
        }
    </script>
    
    <!-- Tour Overlay -->
    <div class="tour-overlay" id="tour-overlay"></div>
    
    <!-- Tour Tooltip -->
    <div class="tour-tooltip" id="tour-tooltip">
        <div class="tour-tooltip-arrow top" id="tour-arrow"></div>
        <div class="tour-tooltip-header">
            <div class="tour-tooltip-icon" id="tour-icon"></div>
            <div class="tour-tooltip-title" id="tour-title">Welcome!</div>
        </div>
        <div class="tour-tooltip-problem" id="tour-problem"></div>
        <div class="tour-tooltip-solution" id="tour-solution"></div>
        <div class="tour-progress" id="tour-progress">
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
            <div class="tour-progress-dot"></div>
        </div>
        <div class="tour-buttons">
            <button class="tour-btn tour-btn-skip" onclick="skipTour()">Skip</button>
             <span class="tour-step-counter" id="tour-step-counter">Step 1 of 7</span>
            <button class="tour-btn tour-btn-next" id="tour-next-btn" onclick="nextTourStep()">Next</button>
        </div>
    </div>
</body>
</html>
