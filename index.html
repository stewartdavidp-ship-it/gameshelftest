<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Track your daily puzzle games, build streaks, compete with friends!">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Game Shelf">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" href="icons/icon-32.png">
    
    <title>Game Shelf PWA</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-hover: #22222f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border: #2a2a3a;
            --accent-purple: #667eea;
            --accent-green: #48bb78;
            --accent-red: #f56565;
            --accent-orange: #ed8936;
            --accent-gold: #ffd700;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .wallet-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        .tokens { color: var(--accent-purple); }
        .coins { color: var(--accent-gold); }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .avatar.signed-out {
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(70px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }
        
        /* Screens */
        .screen {
            display: none;
            padding: 0 0 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Primary Action Card */
        .primary-action {
            margin: 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 20px;
        }
        
        .big-log-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .big-log-button:active {
            transform: scale(0.97);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .quick-games {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .quick-game-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-game-btn:active {
            transform: scale(0.9);
        }
        
        .quick-game-btn.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.15);
        }
        
        /* Progress Section */
        .progress-section {
            margin: 0 16px 12px;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: 14px;
            border: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .progress-bar-container {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .streak-badge {
            color: var(--accent-orange);
            font-weight: 600;
        }
        
        /* Widget Cards */
        .widget {
            margin: 0 16px 12px;
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .widget-icon { font-size: 1.1rem; }
        
        .widget-title {
            font-weight: 700;
            font-size: 0.95rem;
            flex: 1;
        }
        
        .widget-badge {
            font-size: 0.7rem;
            background: var(--accent-orange);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .widget-action {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 12px;
            transition: background 0.15s;
        }
        
        .widget-action:active {
            background: var(--bg-hover);
        }
        
        /* Battle Widget */
        .battle-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .battle-standings {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .standing {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .standing.winning { color: var(--accent-green); }
        
        /* Friends Widget */
        .friends-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 6px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 56px;
        }
        
        .friend-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: var(--bg-tertiary);
        }
        
        .friend-item.played .friend-avatar {
            border-color: var(--accent-green);
        }
        
        .friend-item.waiting .friend-avatar {
            opacity: 0.5;
        }
        
        .friend-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .friend-item.played .friend-status {
            color: var(--accent-green);
        }
        
        /* Games Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            margin-bottom: 12px;
        }
        
        .section-title {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .see-all {
            color: var(--accent-purple);
            font-size: 0.85rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 16px;
        }
        
        .game-card {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        
        .game-card:active {
            transform: scale(0.95);
        }
        
        .game-card.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.08);
        }
        
        .game-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
        }
        
        .game-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .game-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .game-card.done .game-status {
            color: var(--accent-green);
        }
        
        /* Bottom Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0 calc(8px + var(--safe-bottom));
            z-index: 100;
        }
        
        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-tab.active {
            color: var(--accent-purple);
        }
        
        .nav-icon { font-size: 1.3rem; }
        .nav-label { font-size: 0.7rem; font-weight: 600; }
        
        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .bottom-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            padding: 12px 20px calc(20px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .bottom-sheet-overlay.active .bottom-sheet {
            transform: translateY(0);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        
        .bottom-sheet-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .log-textarea {
            width: 100%;
            height: 180px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
            font-family: inherit;
        }
        
        .log-textarea::placeholder {
            color: var(--text-muted);
        }
        
        .log-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
        }
        
        .log-btn:active {
            opacity: 0.9;
        }
        
        /* Parse Result Preview */
        .parse-preview {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px;
            display: none;
        }
        
        .parse-preview.visible { display: block; }
        
        .parse-game-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .parse-score {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Clipboard Prompt */
        .clipboard-prompt {
            position: fixed;
            bottom: calc(80px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-purple);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 150;
            transform: translateY(150%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .clipboard-prompt.visible {
            transform: translateY(0);
        }
        
        .prompt-icon { font-size: 1.3rem; }
        .prompt-text { flex: 1; font-size: 0.9rem; }
        
        .prompt-yes, .prompt-no {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .prompt-yes {
            background: var(--accent-green);
            color: white;
        }
        
        .prompt-yes:active {
            background: #3a9d68;
        }
        
        .prompt-no {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .prompt-no:active {
            background: var(--bg-hover);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: calc(var(--safe-top) + 70px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            z-index: 300;
            transition: transform 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }
        
        /* Games Tab */
        .games-list {
            padding: 16px;
        }
        
        .games-category {
            margin-bottom: 24px;
        }
        
        .category-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        /* Social Tab */
        .social-section {
            padding: 16px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        
        .leaderboard-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .leaderboard-rank.gold { background: linear-gradient(135deg, #ffd700, #ffb700); color: #000; }
        .leaderboard-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .leaderboard-rank.bronze { background: linear-gradient(135deg, #cd7f32, #b5651d); color: #fff; }
        
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 600; font-size: 0.95rem; }
        .leaderboard-streak { font-size: 0.8rem; color: var(--text-secondary); }
        .leaderboard-score { font-weight: 700; color: var(--accent-purple); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon { font-size: 3rem; margin-bottom: 12px; }
        .empty-title { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-desc { font-size: 0.9rem; }
        
        /* Account Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 250;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
        .modal-desc { font-size: 0.9rem; color: var(--text-secondary); }
        
        .google-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #333;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 100%;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 12px;
        }
        
        /* Signed In Account */
        .account-info {
            text-align: center;
        }
        
        .account-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 auto 12px;
        }
        
        .account-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .account-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .sync-status { font-size: 0.8rem; color: var(--accent-green); margin-bottom: 16px; }
        
        .signout-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 12px;
            color: var(--accent-red);
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        /* Success Modal */
        .success-modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%;
            max-width: 320px;
            border: 1px solid var(--border);
            text-align: center;
            animation: successPop 0.4s ease-out;
        }
        
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-celebration {
            font-size: 3rem;
            animation: bounce 0.6s ease infinite;
            margin-bottom: 8px;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .success-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .success-game {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .success-score {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .success-points {
            font-size: 1rem;
            color: var(--accent-purple);
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .success-streak {
            font-size: 0.95rem;
            color: var(--accent-orange);
            margin-bottom: 20px;
        }
        
        .success-close-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span>üéÆ</span>
            <span>Game Shelf</span>
        </div>
        <div class="header-right">
            <div class="wallet-display">
                <span class="tokens">üíé <span id="token-count">0</span></span>
                <span class="coins">ü™ô <span id="coin-count">0</span></span>
            </div>
            <div class="avatar" id="avatar-btn" onclick="openAccountModal()">?</div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Screen -->
        <div class="screen active" id="screen-home">
            <div class="primary-action">
                <button class="big-log-button" onclick="openLogSheet()">
                    <span style="font-size: 1.3rem;">üìã</span>
                    <span>Log Today's Games</span>
                </button>
                <div class="quick-games" id="quick-games">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="progress-section">
                <div class="progress-header">
                    <span>Today's Progress</span>
                    <span id="goal-display">0/5 games</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-stats">
                    <span id="games-today-text">Play your first game!</span>
                    <span class="streak-badge" id="streak-badge">üî• 0</span>
                </div>
            </div>
            
            <div class="widget" id="battle-widget" style="display: none;">
                <div class="widget-header">
                    <span class="widget-icon">‚öîÔ∏è</span>
                    <span class="widget-title">Active Battle</span>
                    <span class="widget-badge" id="battle-time-left">--</span>
                </div>
                <div class="battle-name" id="battle-name">--</div>
                <div class="battle-standings" id="battle-standings">
                    <!-- Populated by JS -->
                </div>
                <button class="widget-action" onclick="switchTab('social')">View Battle ‚Üí</button>
            </div>
            
            <div class="widget" id="friends-widget">
                <div class="widget-header">
                    <span class="widget-icon">üë•</span>
                    <span class="widget-title">Friends Today</span>
                </div>
                <div class="friends-row" id="friends-row">
                    <div class="empty-state" style="padding: 10px;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Sign in to see friends</div>
                    </div>
                </div>
                <button class="widget-action" onclick="switchTab('social')">See All Friends ‚Üí</button>
            </div>
            
            <div class="section-header">
                <span class="section-title">Your Games</span>
                <button class="see-all" onclick="switchTab('games')">See All</button>
            </div>
            <div class="games-grid" id="home-games-grid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Games Screen -->
        <div class="screen" id="screen-games">
            <div class="games-list">
                <div class="games-category">
                    <div class="category-title">Your Shelf</div>
                    <div class="games-grid" id="shelf-games-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <div class="games-category">
                    <div class="category-title">Popular Games</div>
                    <div class="games-grid" id="popular-games-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Social Screen -->
        <div class="screen" id="screen-social">
            <div class="social-section">
                <div class="section-header" style="padding: 0; margin-bottom: 16px;">
                    <span class="section-title">Today's Leaderboard</span>
                </div>
                <div id="leaderboard-list">
                    <!-- Populated by JS -->
                </div>
                
                <div class="widget" style="margin: 24px 0 0;">
                    <div class="widget-header">
                        <span class="widget-icon">‚öîÔ∏è</span>
                        <span class="widget-title">Battles</span>
                    </div>
                    <div id="battles-list">
                        <div class="empty-state" style="padding: 20px;">
                            <div class="empty-icon">‚öîÔ∏è</div>
                            <div class="empty-title">No Active Battles</div>
                            <div class="empty-desc">Start a battle with friends!</div>
                        </div>
                    </div>
                    <button class="widget-action" onclick="showToast('Battle creation coming soon!')">+ Start New Battle</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Bottom Navigation -->
    <nav class="nav-bar">
        <button class="nav-tab active" data-tab="home" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-tab" data-tab="games" onclick="switchTab('games')">
            <span class="nav-icon">üéÆ</span>
            <span class="nav-label">Games</span>
        </button>
        <button class="nav-tab" data-tab="social" onclick="switchTab('social')">
            <span class="nav-icon">üë•</span>
            <span class="nav-label">Social</span>
        </button>
    </nav>
    
    <!-- Log Sheet -->
    <div class="bottom-sheet-overlay" id="log-sheet" onclick="closeLogSheet(event)">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üìã Log Game Result</div>
            <textarea class="log-textarea" id="log-input" placeholder="Paste your game results here...

Example:
Wordle 1,234 3/6

‚¨õ‚¨õüü®‚¨õ‚¨õ
üü®üü©‚¨õ‚¨õ‚¨õ
üü©üü©üü©üü©üü©" oninput="parseLogInput()"></textarea>
            <div class="parse-preview" id="parse-preview">
                <div class="parse-game-name" id="parse-game-name"></div>
                <div class="parse-score" id="parse-score"></div>
            </div>
            <button class="log-btn" id="log-btn" onclick="submitLog()">Log It!</button>
        </div>
    </div>
    
    <!-- Clipboard Prompt -->
    <div class="clipboard-prompt" id="clipboard-prompt" style="display:none;">
        <span class="prompt-icon" id="prompt-icon">üìù</span>
        <span class="prompt-text" id="prompt-text">Log game?</span>
        <button class="prompt-yes" id="prompt-yes-btn" type="button" onclick="acceptClipboard()" ontouchend="event.preventDefault(); acceptClipboard();">‚úì</button>
        <button class="prompt-no" id="prompt-no-btn" type="button" onclick="dismissClipboard()" ontouchend="event.preventDefault(); dismissClipboard();">‚úï</button>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Account Modal -->
    <div class="modal-overlay" id="account-modal" onclick="closeAccountModal(event)">
        <div class="modal-content" id="modal-content" onclick="event.stopPropagation()">
            <!-- Populated by JS based on auth state -->
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal-overlay" id="success-modal" onclick="closeSuccessModal()">
        <div class="success-modal-content" onclick="event.stopPropagation()">
            <div class="success-celebration" id="success-celebration">üéâ</div>
            <div class="success-icon" id="success-icon">üü©</div>
            <div class="success-game" id="success-game">Wordle</div>
            <div class="success-score" id="success-score">3/6</div>
            <div class="success-points" id="success-points">+25 pts</div>
            <div class="success-streak" id="success-streak">üî• 5 day streak!</div>
            <button class="success-close-btn" onclick="closeSuccessModal()">Nice! üëç</button>
        </div>
    </div>
    
    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
            authDomain: "word-boxing.firebaseapp.com",
            databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
            projectId: "word-boxing"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // ============ APP STATE ============
        let currentUser = null;
        let appData = null;
        let detectedClipboard = null;
        
        // ============ GAME CATALOG ============
        const GAMES = {
            // NYT Games
            wordle: { id: 'wordle', name: 'Wordle', icon: 'üü©', url: 'https://www.nytimes.com/games/wordle' },
            connections: { id: 'connections', name: 'Connections', icon: 'üîó', url: 'https://www.nytimes.com/games/connections' },
            strands: { id: 'strands', name: 'Strands', icon: 'üßµ', url: 'https://www.nytimes.com/games/strands' },
            mini: { id: 'mini', name: 'Mini', icon: 'üìù', url: 'https://www.nytimes.com/crosswords/game/mini' },
            'spelling-bee': { id: 'spelling-bee', name: 'Spelling Bee', icon: 'üêù', url: 'https://www.nytimes.com/puzzles/spelling-bee' },
            letterboxed: { id: 'letterboxed', name: 'Letterboxed', icon: 'üì¶', url: 'https://www.nytimes.com/puzzles/letter-boxed' },
            // Popular Word Games
            quordle: { id: 'quordle', name: 'Quordle', icon: '4Ô∏è‚É£', url: 'https://www.quordle.com' },
            octordle: { id: 'octordle', name: 'Octordle', icon: '8Ô∏è‚É£', url: 'https://octordle.com' },
            worldle: { id: 'worldle', name: 'Worldle', icon: 'üåç', url: 'https://worldle.teuteuf.fr' },
            globle: { id: 'globle', name: 'Globle', icon: 'üåé', url: 'https://globle-game.com' },
            tradle: { id: 'tradle', name: 'Tradle', icon: 'üö¢', url: 'https://oec.world/en/tradle' },
            waffle: { id: 'waffle', name: 'Waffle', icon: 'üßá', url: 'https://wafflegame.net' },
            // Movie/TV/Music
            framed: { id: 'framed', name: 'Framed', icon: 'üé¨', url: 'https://framed.wtf' },
            actorle: { id: 'actorle', name: 'Actorle', icon: 'üé≠', url: 'https://actorle.com' },
            moviedle: { id: 'moviedle', name: 'Moviedle', icon: 'üé•', url: 'https://moviedle.app' },
            heardle: { id: 'heardle', name: 'Heardle', icon: 'üéµ', url: 'https://www.spotify.com/heardle' },
            bandle: { id: 'bandle', name: 'Bandle', icon: 'üé∏', url: 'https://bandle.app' },
            // Math/Logic
            nerdle: { id: 'nerdle', name: 'Nerdle', icon: 'üßÆ', url: 'https://nerdlegame.com' },
            // LinkedIn Games
            queens: { id: 'queens', name: 'Queens', icon: 'üëë', url: 'https://www.linkedin.com/games/queens' },
            tango: { id: 'tango', name: 'Tango', icon: 'üíÉ', url: 'https://www.linkedin.com/games/tango' },
            pinpoint: { id: 'pinpoint', name: 'Pinpoint', icon: 'üìç', url: 'https://www.linkedin.com/games/pinpoint' },
            crossclimb: { id: 'crossclimb', name: 'Crossclimb', icon: 'üßó', url: 'https://www.linkedin.com/games/crossclimb' },
            // Sports
            'immaculate-grid': { id: 'immaculate-grid', name: 'Immaculate Grid', icon: '‚öæ', url: 'https://www.immaculategrid.com' },
            // Misc
            redactle: { id: 'redactle', name: 'Redactle', icon: '‚ñà', url: 'https://redactle.net' },
            semantle: { id: 'semantle', name: 'Semantle', icon: 'üß†', url: 'https://semantle.com' },
            costcodle: { id: 'costcodle', name: 'Costcodle', icon: 'üõí', url: 'https://costcodle.com' },
            wheretaken: { id: 'wheretaken', name: 'WhereTaken', icon: 'üì∏', url: 'https://wheretaken.teuteuf.fr' },
            foodguessr: { id: 'foodguessr', name: 'FoodGuessr', icon: 'üçï', url: 'https://www.foodguessr.com' },
            // Game Shelf Originals - use absolute URLs
            quotle: { id: 'quotle', name: 'Quotle', icon: 'üí¨', url: 'https://stewartdavidp-ship-it.github.io/quotle.html' },
            slate: { id: 'slate', name: 'Slate', icon: 'üìù', url: 'https://stewartdavidp-ship-it.github.io/slate.html' },
            rungs: { id: 'rungs', name: 'Rungs', icon: 'ü™ú', url: 'https://stewartdavidp-ship-it.github.io/rungs.html' },
            wordboxing: { id: 'wordboxing', name: 'Word Boxing', icon: 'ü•ä', url: 'https://stewartdavidp-ship-it.github.io/wordboxing.html' }
        };
        
        const DEFAULT_SHELF = ['wordle', 'connections', 'strands', 'mini', 'spelling-bee', 'worldle'];
        const POPULAR_GAMES = ['quotle', 'slate', 'rungs', 'quordle', 'framed', 'queens', 'heardle', 'nerdle'];
        
        // ============ SHARE TEXT PARSERS ============
        const PARSERS = [
            // NYT Games
            {
                id: 'wordle',
                regex: /Wordle\s+[\d,]+\s+([1-6X])\/6/i,
                extract: (match, text) => ({
                    gameId: 'wordle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 5
                })
            },
            {
                id: 'connections',
                regex: /Connections\s*\n?Puzzle\s*#?\d+/i,
                extract: (match, text) => {
                    const lines = text.split('\n').filter(l => /^[üü®üü©üü¶üü™]+$/.test(l.trim()));
                    const solved = lines.length >= 4;
                    return {
                        gameId: 'connections',
                        score: solved ? 'Solved!' : `${lines.length}/4`,
                        won: solved,
                        numericScore: solved ? 25 : lines.length * 5
                    };
                }
            },
            {
                id: 'strands',
                regex: /Strands\s*#?\d+/i,
                extract: (match, text) => {
                    const hints = (text.match(/üí°/g) || []).length;
                    return {
                        gameId: 'strands',
                        score: hints > 0 ? `${hints} hints` : 'No hints!',
                        won: true,
                        numericScore: hints === 0 ? 25 : Math.max(15 - hints * 3, 5)
                    };
                }
            },
            {
                id: 'mini',
                regex: /Mini\s*Crossword|I\s+solved.*Mini.*in\s+(\d+):(\d+)/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        const secs = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
                        return {
                            gameId: 'mini',
                            score: `${timeMatch[1]}:${timeMatch[2]}`,
                            won: true,
                            numericScore: Math.max(30 - Math.floor(secs / 10), 5)
                        };
                    }
                    return { gameId: 'mini', score: 'Done', won: true, numericScore: 15 };
                }
            },
            {
                id: 'spelling-bee',
                regex: /Spelling\s*Bee|üêù.*Genius|üêù.*Queen/i,
                extract: (match, text) => {
                    if (text.includes('Queen')) return { gameId: 'spelling-bee', score: 'Queen Bee! üëë', won: true, numericScore: 50 };
                    if (text.includes('Genius')) return { gameId: 'spelling-bee', score: 'Genius!', won: true, numericScore: 30 };
                    return { gameId: 'spelling-bee', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'letterboxed',
                regex: /Letter\s*Boxed|I\s+solved.*Letter.*in\s+(\d+)/i,
                extract: (match, text) => {
                    const wordMatch = text.match(/in\s+(\d+)\s+word/i);
                    if (wordMatch) {
                        const words = parseInt(wordMatch[1]);
                        return { gameId: 'letterboxed', score: `${words} words`, won: true, numericScore: Math.max(30 - words * 5, 10) };
                    }
                    return { gameId: 'letterboxed', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Popular Word Games
            {
                id: 'quordle',
                regex: /Daily\s+Quordle\s+\d+/i,
                extract: (match, text) => ({
                    gameId: 'quordle',
                    score: text.includes('üü•') ? 'Partial' : 'Solved!',
                    won: !text.includes('üü•'),
                    numericScore: text.includes('üü•') ? 10 : 25
                })
            },
            {
                id: 'octordle',
                regex: /Daily\s+Octordle\s+#?\d+/i,
                extract: () => ({ gameId: 'octordle', score: 'Completed', won: true, numericScore: 20 })
            },
            {
                id: 'worldle',
                regex: /#Worldle\s+#?\d+\s*([1-6X])\/6/i,
                extract: (match, text) => ({
                    gameId: 'worldle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'globle',
                regex: /üåé.*üåç|Globle/i,
                extract: () => ({ gameId: 'globle', score: 'Completed', won: true, numericScore: 15 })
            },
            {
                id: 'tradle',
                regex: /#Tradle\s+#?\d+\s*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'tradle',
                    score: match[1] + '/6',
                    won: true,
                    numericScore: (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'waffle',
                regex: /#waffle\d+|Waffle\s*#?\d+/i,
                extract: (match, text) => {
                    const starsMatch = text.match(/([0-5])\/5\s*‚≠ê/);
                    const stars = starsMatch ? parseInt(starsMatch[1]) : 3;
                    return { gameId: 'waffle', score: `${stars}/5 ‚≠ê`, won: stars >= 3, numericScore: stars * 5 };
                }
            },
            // Movie/TV Games
            {
                id: 'framed',
                regex: /Framed\s+#?\d+/i,
                extract: (match, text) => {
                    const won = text.includes('üü©');
                    const frames = (text.match(/[üé•üü©üü•]/g) || []).length;
                    return { gameId: 'framed', score: won ? `${frames}/6` : 'X/6', won, numericScore: won ? (7 - frames) * 4 : 0 };
                }
            },
            {
                id: 'actorle',
                regex: /Actorle\s*#?\d+\s*([1-8X])\/8/i,
                extract: (match) => ({
                    gameId: 'actorle',
                    score: match[1] + '/8',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (9 - parseInt(match[1])) * 3
                })
            },
            {
                id: 'moviedle',
                regex: /Moviedle\s*#?\d+|#Moviedle.*(\d+)\/6/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { gameId: 'moviedle', score: guessMatch[1] + '/6', won: true, numericScore: (7 - parseInt(guessMatch[1])) * 4 };
                    }
                    return { gameId: 'moviedle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Music Games
            {
                id: 'heardle',
                regex: /Heardle\s*#?\d+|üéµ.*Heardle/i,
                extract: (match, text) => {
                    const won = text.includes('üü©');
                    const guesses = (text.match(/[üü•üü©‚¨úüü®]/g) || []).length;
                    return { gameId: 'heardle', score: won ? `${guesses}/6` : 'X/6', won, numericScore: won ? (7 - guesses) * 4 : 0 };
                }
            },
            {
                id: 'bandle',
                regex: /Bandle\s*#?\d+\s*([1-6X])\/6/i,
                extract: (match) => ({
                    gameId: 'bandle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            // Math/Logic Games
            {
                id: 'nerdle',
                regex: /nerdlegame\s+\d+|Nerdle\s+\d+.*(\d+)\/6/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { gameId: 'nerdle', score: guessMatch[1] + '/6', won: guessMatch[1] !== 'X', numericScore: (7 - parseInt(guessMatch[1])) * 4 };
                    }
                    return { gameId: 'nerdle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // LinkedIn Games
            {
                id: 'queens',
                regex: /Queens\s*#?\d+|üëë.*Queens/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'queens', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'queens', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'tango',
                regex: /Tango\s*#?\d+|üíÉ.*Tango/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'tango', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'tango', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'pinpoint',
                regex: /Pinpoint\s*#?\d+|üìç.*Pinpoint/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s*guess/i);
                    if (guessMatch) {
                        return { gameId: 'pinpoint', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(25 - parseInt(guessMatch[1]) * 3, 5) };
                    }
                    return { gameId: 'pinpoint', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'crossclimb',
                regex: /Crossclimb\s*#?\d+|üßó.*Crossclimb/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'crossclimb', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'crossclimb', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Sports
            {
                id: 'immaculate-grid',
                regex: /Immaculate\s+Grid|‚öæ.*\/9/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\/9/);
                    if (scoreMatch) {
                        const score = parseInt(scoreMatch[1]);
                        return { gameId: 'immaculate-grid', score: `${score}/9`, won: score >= 5, numericScore: score * 3 };
                    }
                    return { gameId: 'immaculate-grid', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Misc
            {
                id: 'redactle',
                regex: /Redactle\s+#?\d+|I\s+solved\s+Redactle.*(\d+)\s+guesses/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { gameId: 'redactle', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(30 - Math.floor(parseInt(guessMatch[1]) / 10), 5) };
                    }
                    return { gameId: 'redactle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'semantle',
                regex: /Semantle\s+#?\d+|I\s+solved\s+Semantle.*(\d+)\s+guesses/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { gameId: 'semantle', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(30 - Math.floor(parseInt(guessMatch[1]) / 5), 5) };
                    }
                    return { gameId: 'semantle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'costcodle',
                regex: /Costcodle\s+#?\d+.*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'costcodle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'wheretaken',
                regex: /WhereTaken\s*#?\d+.*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'wheretaken',
                    score: match[1] + '/6',
                    won: true,
                    numericScore: (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'foodguessr',
                regex: /FoodGuessr\s*#?\d+/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*points?/i);
                    if (scoreMatch) {
                        return { gameId: 'foodguessr', score: `${scoreMatch[1]} pts`, won: true, numericScore: Math.min(Math.floor(parseInt(scoreMatch[1]) / 100), 25) };
                    }
                    return { gameId: 'foodguessr', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Game Shelf Originals
            {
                id: 'quotle',
                regex: /Quotle\s*#?\d+.*([1-8X])\/8|Quotle.*üéØ|Quotle.*‚úÖ|Quotle.*‚ùå/i,
                extract: (match, text) => {
                    if (text.includes('üéØ')) return { gameId: 'quotle', score: 'Perfect! üéØ', won: true, numericScore: 40 };
                    const scoreMatch = text.match(/([1-8X])\/8/);
                    if (scoreMatch) {
                        const won = scoreMatch[1] !== 'X';
                        return { gameId: 'quotle', score: scoreMatch[1] + '/8', won, numericScore: won ? (9 - parseInt(scoreMatch[1])) * 4 : 0 };
                    }
                    return { gameId: 'quotle', score: text.includes('‚ùå') ? 'X/8' : 'Done', won: !text.includes('‚ùå'), numericScore: 15 };
                }
            },
            {
                id: 'slate',
                regex: /Slate\s*#?\d+/i,
                extract: (match, text) => {
                    const wordsMatch = text.match(/(\d+)\s*words?/i);
                    if (wordsMatch) {
                        return { gameId: 'slate', score: `${wordsMatch[1]} words`, won: true, numericScore: Math.min(parseInt(wordsMatch[1]) * 2, 30) };
                    }
                    return { gameId: 'slate', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'rungs',
                regex: /Rungs\s*#?\d+/i,
                extract: (match, text) => {
                    const movesMatch = text.match(/(\d+)\s*moves?/i);
                    if (movesMatch) {
                        return { gameId: 'rungs', score: `${movesMatch[1]} moves`, won: true, numericScore: Math.max(25 - parseInt(movesMatch[1]), 5) };
                    }
                    return { gameId: 'rungs', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'wordboxing',
                regex: /Word\s*Boxing|ü•ä.*Boxing/i,
                extract: () => ({ gameId: 'wordboxing', score: 'Completed', won: true, numericScore: 20 })
            }
        ];
        
        // ============ DATA MANAGEMENT ============
        function loadData() {
            try {
                const stored = localStorage.getItem('gameShelfData');
                if (stored) {
                    appData = JSON.parse(stored);
                } else {
                    appData = createDefaultData();
                    saveData();
                }
            } catch (e) {
                console.error('Load error:', e);
                appData = createDefaultData();
            }
            return appData;
        }
        
        function createDefaultData() {
            return {
                games: DEFAULT_SHELF.map(id => ({ id, addedAt: new Date().toISOString() })),
                stats: {},
                history: {},
                wallet: { tokens: 100, coins: 0 },
                achievements: [],
                dailyGoal: 5,
                friends: [],
                settings: {}
            };
        }
        
        function saveData() {
            try {
                localStorage.setItem('gameShelfData', JSON.stringify(appData));
            } catch (e) {
                console.error('Save error:', e);
            }
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getTodayHistory() {
            const today = getTodayString();
            return appData.history[today] || {};
        }
        
        function getGamesPlayedToday() {
            return Object.keys(getTodayHistory()).length;
        }
        
        function getMaxStreak() {
            let maxStreak = 0;
            for (const gameId in appData.stats) {
                const streak = appData.stats[gameId]?.currentStreak || 0;
                if (streak > maxStreak) maxStreak = streak;
            }
            return maxStreak;
        }
        
        // ============ PARSE SHARE TEXT ============
        function parseShareText(text) {
            if (!text || typeof text !== 'string') return null;
            
            for (const parser of PARSERS) {
                const match = text.match(parser.regex);
                if (match) {
                    try {
                        return parser.extract(match, text);
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                }
            }
            return null;
        }
        
        // ============ LOG GAME ============
        function logGame(result) {
            if (!result || !result.gameId) return false;
            
            const today = getTodayString();
            
            // Update history
            if (!appData.history[today]) {
                appData.history[today] = {};
            }
            appData.history[today][result.gameId] = {
                score: result.score,
                won: result.won,
                numericScore: result.numericScore || 0,
                time: new Date().toISOString()
            };
            
            // Update stats
            if (!appData.stats[result.gameId]) {
                appData.stats[result.gameId] = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    lastPlayed: null
                };
            }
            
            const stats = appData.stats[result.gameId];
            stats.gamesPlayed++;
            if (result.won) stats.gamesWon++;
            stats.lastPlayed = today;
            
            // Streak calculation
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (stats.lastPlayed === yesterdayStr || stats.currentStreak === 0) {
                stats.currentStreak++;
            }
            if (stats.currentStreak > stats.maxStreak) {
                stats.maxStreak = stats.currentStreak;
            }
            
            // Award tokens
            const isFirstToday = getGamesPlayedToday() === 1;
            if (isFirstToday) {
                appData.wallet.tokens += 10;
            } else {
                appData.wallet.tokens += 5;
            }
            
            saveData();
            syncToCloud();
            return true;
        }
        
        // ============ CLOUD SYNC ============
        async function syncToCloud() {
            if (!currentUser) return;
            
            try {
                await db.ref(`users/${currentUser.uid}/shelf`).set(appData);
                console.log('Synced to cloud');
            } catch (e) {
                console.error('Sync error:', e);
            }
        }
        
        async function loadFromCloud() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.ref(`users/${currentUser.uid}/shelf`).once('value');
                const cloudData = snapshot.val();
                if (cloudData) {
                    // Merge with local (cloud wins for history)
                    appData = { ...appData, ...cloudData };
                    saveData();
                }
            } catch (e) {
                console.error('Load from cloud error:', e);
            }
        }
        
        // ============ AUTH ============
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            updateAuthUI();
            
            if (user) {
                await loadFromCloud();
            }
            
            renderAll();
        });
        
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => {
                console.error('Sign in error:', e);
                showToast('Sign in failed', 'error');
            });
        }
        
        function signOut() {
            auth.signOut();
            closeAccountModal();
            showToast('Signed out');
        }
        
        function updateAuthUI() {
            const avatarBtn = document.getElementById('avatar-btn');
            
            if (currentUser) {
                const initial = (currentUser.displayName || currentUser.email || '?')[0].toUpperCase();
                avatarBtn.textContent = initial;
                avatarBtn.classList.remove('signed-out');
            } else {
                avatarBtn.textContent = '?';
                avatarBtn.classList.add('signed-out');
            }
        }
        
        // ============ UI RENDERING ============
        function renderAll() {
            renderWallet();
            renderQuickGames();
            renderProgress();
            renderHomeGames();
            renderShelfGames();
            renderPopularGames();
            renderLeaderboard();
            renderFriendsWidget();
        }
        
        function renderWallet() {
            document.getElementById('token-count').textContent = appData.wallet.tokens || 0;
            document.getElementById('coin-count').textContent = appData.wallet.coins || 0;
        }
        
        function renderQuickGames() {
            const container = document.getElementById('quick-games');
            const shelf = appData.games.slice(0, 6);
            const todayHistory = getTodayHistory();
            
            container.innerHTML = shelf.map(g => {
                const game = GAMES[g.id];
                if (!game) return '';
                const done = todayHistory[g.id];
                return `<button class="quick-game-btn ${done ? 'done' : ''}" 
                    onclick="${done ? `showToast('${game.name} already logged!')` : 'openLogSheet()'}"
                    title="${game.name}">${game.icon}</button>`;
            }).join('');
        }
        
        function renderProgress() {
            const played = getGamesPlayedToday();
            const goal = appData.dailyGoal || 5;
            const pct = Math.min(100, (played / goal) * 100);
            const maxStreak = getMaxStreak();
            
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('goal-display').textContent = `${played}/${goal} games`;
            document.getElementById('streak-badge').textContent = `üî• ${maxStreak}`;
            
            if (played === 0) {
                document.getElementById('games-today-text').textContent = 'Play your first game!';
            } else if (played >= goal) {
                document.getElementById('games-today-text').textContent = 'üéâ Goal reached!';
            } else {
                document.getElementById('games-today-text').textContent = `${goal - played} more to go`;
            }
        }
        
        function renderHomeGames() {
            const container = document.getElementById('home-games-grid');
            const shelf = appData.games.slice(0, 6);
            const todayHistory = getTodayHistory();
            
            container.innerHTML = shelf.map(g => {
                const game = GAMES[g.id];
                if (!game) return '';
                const done = todayHistory[g.id];
                const stats = appData.stats[g.id];
                const streak = stats?.currentStreak || 0;
                
                let status = streak > 0 ? `üî• ${streak}` : 'Play';
                if (done) status = `‚úì ${done.score}`;
                
                return `<div class="game-card ${done ? 'done' : ''}" onclick="playGame('${g.id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">${status}</div>
                </div>`;
            }).join('');
        }
        
        function renderShelfGames() {
            const container = document.getElementById('shelf-games-grid');
            const todayHistory = getTodayHistory();
            
            container.innerHTML = appData.games.map(g => {
                const game = GAMES[g.id];
                if (!game) return '';
                const done = todayHistory[g.id];
                const stats = appData.stats[g.id];
                const streak = stats?.currentStreak || 0;
                
                let status = streak > 0 ? `üî• ${streak}` : 'Play';
                if (done) status = `‚úì ${done.score}`;
                
                return `<div class="game-card ${done ? 'done' : ''}" onclick="playGame('${g.id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">${status}</div>
                </div>`;
            }).join('');
        }
        
        function renderPopularGames() {
            const container = document.getElementById('popular-games-grid');
            const onShelf = new Set(appData.games.map(g => g.id));
            
            container.innerHTML = POPULAR_GAMES.filter(id => !onShelf.has(id)).map(id => {
                const game = GAMES[id];
                if (!game) return '';
                return `<div class="game-card" onclick="addToShelf('${id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">+ Add</div>
                </div>`;
            }).join('');
        }
        
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            
            // Mock leaderboard for now
            const leaderboard = [
                { name: 'You', streak: getMaxStreak(), score: getGamesPlayedToday() * 10, isYou: true },
            ];
            
            if (leaderboard.length === 0 || (leaderboard.length === 1 && leaderboard[0].score === 0)) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-icon">üèÜ</div>
                    <div class="empty-title">Play games to rank!</div>
                    <div class="empty-desc">Your daily scores appear here</div>
                </div>`;
                return;
            }
            
            container.innerHTML = leaderboard.map((p, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `<div class="leaderboard-item">
                    <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${p.name}${p.isYou ? ' (You)' : ''}</div>
                        <div class="leaderboard-streak">üî• ${p.streak} streak</div>
                    </div>
                    <div class="leaderboard-score">${p.score} pts</div>
                </div>`;
            }).join('');
        }
        
        function renderFriendsWidget() {
            const container = document.getElementById('friends-row');
            
            if (!currentUser || appData.friends.length === 0) {
                container.innerHTML = `<div style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">
                    ${currentUser ? 'Add friends to see their progress' : 'Sign in to see friends'}
                </div>`;
                return;
            }
            
            // Mock friends for now
            container.innerHTML = `<div style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">
                Friends feature coming soon!
            </div>`;
        }
        
        // ============ INTERACTIONS ============
        function playGame(gameId) {
            const game = GAMES[gameId];
            if (!game) return;
            
            const todayHistory = getTodayHistory();
            if (todayHistory[gameId]) {
                showToast(`${game.name} already logged today!`);
                return;
            }
            
            // Open game URL
            if (game.url.startsWith('http')) {
                window.open(game.url, '_blank');
            } else {
                window.location.href = game.url;
            }
        }
        
        function addToShelf(gameId) {
            if (appData.games.find(g => g.id === gameId)) {
                showToast('Already on your shelf!');
                return;
            }
            
            appData.games.push({ id: gameId, addedAt: new Date().toISOString() });
            saveData();
            syncToCloud();
            renderAll();
            showToast(`${GAMES[gameId].name} added!`, 'success');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + tab).classList.add('active');
        }
        
        // ============ LOG SHEET ============
        function openLogSheet() {
            document.getElementById('log-sheet').classList.add('active');
            document.getElementById('log-input').focus();
        }
        
        function closeLogSheet(e) {
            if (e && e.target.id !== 'log-sheet') return;
            document.getElementById('log-sheet').classList.remove('active');
            document.getElementById('log-input').value = '';
            document.getElementById('parse-preview').classList.remove('visible');
        }
        
        function parseLogInput() {
            const input = document.getElementById('log-input').value;
            const result = parseShareText(input);
            const preview = document.getElementById('parse-preview');
            
            if (result) {
                const game = GAMES[result.gameId];
                document.getElementById('parse-game-name').textContent = `${game?.icon || 'üéÆ'} ${game?.name || result.gameId}`;
                document.getElementById('parse-score').textContent = `Score: ${result.score}`;
                preview.classList.add('visible');
            } else {
                preview.classList.remove('visible');
            }
        }
        
        function submitLog() {
            const input = document.getElementById('log-input').value;
            const result = parseShareText(input);
            
            if (!result) {
                showToast('Could not detect game. Try pasting share text.', 'error');
                return;
            }
            
            const game = GAMES[result.gameId];
            const todayHistory = getTodayHistory();
            
            if (todayHistory[result.gameId]) {
                showToast(`${game?.name || result.gameId} already logged today!`);
                closeLogSheet({ target: { id: 'log-sheet' } });
                return;
            }
            
            if (logGame(result)) {
                closeLogSheet({ target: { id: 'log-sheet' } });
                renderAll();
                showSuccessModal(game, result);
            }
        }
        
        // ============ CLIPBOARD DETECTION ============
        async function checkClipboard() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) return;
                
                const text = await navigator.clipboard.readText();
                const result = parseShareText(text);
                
                if (result) {
                    const todayHistory = getTodayHistory();
                    if (todayHistory[result.gameId]) return; // Already logged
                    
                    const game = GAMES[result.gameId];
                    detectedClipboard = { text, result };
                    
                    showClipboardPrompt(game, result);
                }
            } catch (e) {
                // Clipboard access denied - that's fine
                console.log('Clipboard check:', e.message);
            }
        }
        
        function acceptClipboard() {
            if (detectedClipboard) {
                if (logGame(detectedClipboard.result)) {
                    const game = GAMES[detectedClipboard.result.gameId];
                    renderAll();
                    showToast(`${game?.icon || 'üéÆ'} Logged!`, 'success');
                }
            }
            dismissClipboard();
        }
        
        function dismissClipboard() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt) {
                prompt.style.display = 'none';
                prompt.classList.remove('visible');
            }
            detectedClipboard = null;
        }
        
        function showClipboardPrompt(game, result) {
            const prompt = document.getElementById('clipboard-prompt');
            if (!prompt) return;
            
            document.getElementById('prompt-icon').textContent = game?.icon || 'üéÆ';
            document.getElementById('prompt-text').textContent = `Log ${game?.name || result.gameId} ${result.score}?`;
            
            prompt.style.display = 'flex';
            // Small delay to trigger CSS transition
            setTimeout(() => prompt.classList.add('visible'), 10);
            
            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                if (prompt.classList.contains('visible')) {
                    dismissClipboard();
                }
            }, 8000);
        }
        
        // ============ SUCCESS MODAL ============
        function showSuccessModal(game, result) {
            const modal = document.getElementById('success-modal');
            const stats = appData.stats[result.gameId] || {};
            const streak = stats.currentStreak || 1;
            
            // Determine celebration emoji based on score
            let celebration = 'üéâ';
            if (result.score?.includes('1/') || result.score === 'Perfect! üéØ' || result.score === 'Queen Bee! üëë') {
                celebration = 'üèÜ';
            } else if (result.score?.includes('2/') || result.score === 'No hints!' || result.score === 'Genius!') {
                celebration = 'üåü';
            }
            
            document.getElementById('success-celebration').textContent = celebration;
            document.getElementById('success-icon').textContent = game?.icon || 'üéÆ';
            document.getElementById('success-game').textContent = game?.name || result.gameId;
            document.getElementById('success-score').textContent = result.score;
            document.getElementById('success-points').textContent = `+${result.numericScore || 15} pts`;
            
            if (streak > 1) {
                document.getElementById('success-streak').textContent = `üî• ${streak} day streak!`;
                document.getElementById('success-streak').style.display = 'block';
            } else {
                document.getElementById('success-streak').style.display = 'none';
            }
            
            modal.classList.add('active');
        }
        
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.remove('active');
        }
        
        // Bind clipboard prompt buttons (call after DOM ready)
        function bindClipboardButtons() {
            const yesBtn = document.getElementById('prompt-yes-btn');
            const noBtn = document.getElementById('prompt-no-btn');
            
            if (yesBtn) {
                yesBtn.onclick = function(e) {
                    e.preventDefault();
                    acceptClipboard();
                };
            }
            if (noBtn) {
                noBtn.onclick = function(e) {
                    e.preventDefault();
                    dismissClipboard();
                };
            }
        }
        
        // ============ ACCOUNT MODAL ============
        function openAccountModal() {
            const modal = document.getElementById('account-modal');
            const content = document.getElementById('modal-content');
            
            if (currentUser) {
                const initial = (currentUser.displayName || currentUser.email || '?')[0].toUpperCase();
                content.innerHTML = `
                    <div class="account-info">
                        <div class="account-avatar">${initial}</div>
                        <div class="account-name">${currentUser.displayName || 'Player'}</div>
                        <div class="account-email">${currentUser.email}</div>
                        <div class="sync-status">‚òÅÔ∏è Synced</div>
                        <button class="signout-btn" onclick="signOut()">Sign Out</button>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="modal-header">
                        <div class="modal-title">Sign In</div>
                        <div class="modal-desc">Sync your progress across devices</div>
                    </div>
                    <button class="google-btn" onclick="signInWithGoogle()">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continue with Google
                    </button>
                    <button class="modal-close" onclick="closeAccountModal()">Maybe later</button>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function closeAccountModal(e) {
            if (e && e.target.id !== 'account-modal') return;
            document.getElementById('account-modal').classList.remove('active');
        }
        
        // ============ TOAST ============
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast visible ' + type;
            setTimeout(() => toast.classList.remove('visible'), 2500);
        }
        
        // ============ PWA / SERVICE WORKER ============
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered'))
                .catch(e => console.log('SW registration failed:', e));
        }
        
        // Handle share target (when app receives shared text)
        function handleShareTarget() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('share-target') === 'true') {
                // The share text would be in the POST body - need server for this
                // For now, just open log sheet
                setTimeout(openLogSheet, 500);
            }
            
            // Handle action=log shortcut
            if (params.get('action') === 'log') {
                setTimeout(openLogSheet, 300);
            }
        }
        
        // ============ INIT ============
        function init() {
            loadData();
            renderAll();
            handleShareTarget();
            bindClipboardButtons();
            
            // Check clipboard when app becomes visible
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    setTimeout(checkClipboard, 500);
                }
            });
            
            // Initial clipboard check (delayed)
            setTimeout(checkClipboard, 1500);
            
            console.log('üéÆ Game Shelf PWA v0.2.2 initialized');
        }
        
        init();
    </script>
</body>
</html>
