<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Track your daily puzzle games, build streaks, compete with friends!">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Game Shelf">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    
    <title>Game Shelf PWA</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-hover: #22222f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border: #2a2a3a;
            --accent-purple: #667eea;
            --accent-green: #48bb78;
            --accent-red: #f56565;
            --accent-orange: #ed8936;
            --accent-gold: #ffd700;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8ed;
            --bg-hover: #d8d8e0;
            --text-primary: #1a1a1f;
            --text-secondary: #505060;
            --text-muted: #909098;
            --border: #d0d0d8;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        
        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .wallet-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        .tokens { color: var(--accent-purple); }
        .coins { color: var(--accent-gold); }
        
        .menu-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 4px 8px;
            touch-action: manipulation;
            color: var(--text-primary);
        }
        
        /* Slide-out Settings Menu */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .settings-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 85%;
            max-width: 300px;
            height: 100%;
            background: var(--bg-secondary);
            z-index: 500;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }
        
        .settings-menu.active {
            transform: translateX(0);
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .settings-header h2 {
            font-size: 1.2rem;
            margin: 0;
        }
        
        .settings-close {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .settings-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .settings-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.95rem;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .settings-link:active {
            opacity: 0.7;
        }
        
        .settings-link .icon {
            font-size: 1.1rem;
        }
        
        .settings-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: -8px 0 8px 32px;
        }
        
        .theme-options {
            display: flex;
            gap: 10px;
        }
        
        .theme-option {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border);
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            transition: border-color 0.2s;
        }
        
        .theme-option.active {
            border-color: var(--accent-purple);
        }
        
        .theme-option .label {
            font-size: 0.85rem;
            margin-top: 4px;
        }
        
        .settings-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }
        
        .settings-toggle-row label {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .settings-toggle-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .settings-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            text-align: center;
        }
        
        .settings-version {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .avatar.signed-out {
            background: var(--bg-tertiary);
            border: 2px dashed var(--border);
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(70px + var(--safe-bottom));
            -webkit-overflow-scrolling: touch;
        }
        
        /* Screens */
        .screen {
            display: none;
            padding: 0 0 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Primary Action Card */
        .primary-action {
            margin: 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 20px;
        }
        
        .big-log-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .big-log-button:active {
            transform: scale(0.97);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        .quick-games {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .quick-game-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-game-btn:active {
            transform: scale(0.9);
        }
        
        .quick-game-btn.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.15);
        }
        
        /* Progress Section */
        .progress-section {
            margin: 0 16px 12px;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: 14px;
            border: 1px solid var(--border);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .progress-bar-container {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .streak-badge {
            color: var(--accent-orange);
            font-weight: 600;
        }
        
        /* Widget Cards */
        .widget {
            margin: 0 16px 12px;
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .widget-icon { font-size: 1.1rem; }
        
        .widget-title {
            font-weight: 700;
            font-size: 0.95rem;
            flex: 1;
        }
        
        .widget-badge {
            font-size: 0.7rem;
            background: var(--accent-orange);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .widget-action {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 12px;
            transition: background 0.15s;
        }
        
        .widget-action:active {
            background: var(--bg-hover);
        }
        
        /* Battle Widget */
        .battle-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .battle-standings {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .standing {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .standing.winning { color: var(--accent-green); }
        
        /* Friends Widget */
        .friends-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 6px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 56px;
        }
        
        .friend-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: var(--bg-tertiary);
        }
        
        .friend-item.played .friend-avatar {
            border-color: var(--accent-green);
        }
        
        .friend-item.waiting .friend-avatar {
            opacity: 0.5;
        }
        
        .friend-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .friend-item.played .friend-status {
            color: var(--accent-green);
        }
        
        /* Games Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            margin-bottom: 12px;
        }
        
        .section-title {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .see-all {
            color: var(--accent-purple);
            font-size: 0.85rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 16px;
        }
        
        .game-card {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        
        .game-card:active {
            transform: scale(0.95);
        }
        
        .game-card.done {
            border-color: var(--accent-green);
            background: rgba(72, 187, 120, 0.08);
        }
        
        .game-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
        }
        
        .game-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .game-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .game-card.done .game-status {
            color: var(--accent-green);
        }
        
        /* Bottom Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 0 calc(8px + var(--safe-bottom));
            z-index: 100;
        }
        
        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-tab.active {
            color: var(--accent-purple);
        }
        
        .nav-icon { font-size: 1.3rem; }
        .nav-label { font-size: 0.7rem; font-weight: 600; }
        
        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .bottom-sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            padding: 12px 20px calc(20px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 301;
        }
        
        .bottom-sheet-overlay.active .bottom-sheet {
            transform: translateY(0);
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 16px;
        }
        
        .bottom-sheet-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .log-textarea {
            width: 100%;
            height: 180px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
            font-family: inherit;
        }
        
        .log-textarea::placeholder {
            color: var(--text-muted);
        }
        
        .log-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
        }
        
        .log-btn:active {
            opacity: 0.9;
        }
        
        /* Parse Result Preview */
        .parse-preview {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px;
            display: none;
        }
        
        .parse-preview.visible { display: block; }
        
        .parse-game-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .parse-score {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Clipboard Prompt */
        .clipboard-prompt {
            position: fixed;
            bottom: calc(80px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-purple);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 150;
            transform: translateY(150%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .clipboard-prompt.visible {
            transform: translateY(0);
        }
        
        .prompt-icon { font-size: 1.3rem; }
        .prompt-text { flex: 1; font-size: 0.9rem; }
        
        .prompt-yes, .prompt-no {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .prompt-yes {
            background: var(--accent-green);
            color: white;
        }
        
        .prompt-yes:active {
            background: #3a9d68;
        }
        
        .prompt-no {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .prompt-no:active {
            background: var(--bg-hover);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: calc(var(--safe-top) + 70px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            z-index: 300;
            transition: transform 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }
        
        /* Games Tab */
        .games-list {
            padding: 16px;
        }
        
        .games-category {
            margin-bottom: 24px;
        }
        
        .category-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        /* Social Tab */
        .social-section {
            padding: 16px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        
        .leaderboard-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .leaderboard-rank.gold { background: linear-gradient(135deg, #ffd700, #ffb700); color: #000; }
        .leaderboard-rank.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .leaderboard-rank.bronze { background: linear-gradient(135deg, #cd7f32, #b5651d); color: #fff; }
        
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 600; font-size: 0.95rem; }
        .leaderboard-streak { font-size: 0.8rem; color: var(--text-secondary); }
        .leaderboard-score { font-weight: 700; color: var(--accent-purple); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon { font-size: 3rem; margin-bottom: 12px; }
        .empty-title { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-desc { font-size: 0.9rem; }
        
        /* Account Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 250;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
        .modal-desc { font-size: 0.9rem; color: var(--text-secondary); }
        
        .google-btn {
            width: 100%;
            padding: 14px;
            background: white;
            color: #333;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 100%;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 12px;
        }
        
        /* Signed In Account */
        .account-info {
            text-align: center;
        }
        
        .account-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 auto 12px;
        }
        
        .account-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .account-email { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .sync-status { font-size: 0.8rem; color: var(--accent-green); margin-bottom: 16px; }
        
        .signout-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 12px;
            color: var(--accent-red);
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        /* Success Modal */
        .success-modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%;
            max-width: 320px;
            border: 1px solid var(--border);
            text-align: center;
            animation: successPop 0.4s ease-out;
        }
        
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-celebration {
            font-size: 3rem;
            animation: bounce 0.6s ease infinite;
            margin-bottom: 8px;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .success-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .success-game {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .success-score {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .success-points {
            font-size: 1rem;
            color: var(--accent-purple);
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .success-streak {
            font-size: 0.95rem;
            color: var(--accent-orange);
            margin-bottom: 20px;
        }
        
        .success-close-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Share Hub */
        .share-hub-modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .share-hub-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .share-hub-header h2 {
            font-size: 1.3rem;
            margin: 8px 0 4px;
        }
        
        .share-hub-header p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .share-results-section {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .share-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .share-results-header h4 {
            margin: 0;
            font-size: 0.95rem;
        }
        
        .share-results-date {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .share-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .share-result-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .share-result-tag .score {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .share-composer {
            margin-bottom: 16px;
        }
        
        .share-composer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .share-composer-header label {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .share-template-select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        
        .share-textarea {
            width: 100%;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        
        .share-emoji-bar {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .share-emoji-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 1rem;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .share-platforms {
            margin-bottom: 16px;
        }
        
        .share-platforms h4 {
            margin: 0 0 12px;
            font-size: 0.95rem;
        }
        
        .share-platforms-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .share-platform-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 12px;
            padding: 12px 8px;
            cursor: pointer;
            touch-action: manipulation;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .share-platform-btn:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        
        .share-platform-btn .icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }
        
        .share-platform-btn .label {
            font-size: 0.7rem;
            color: white;
        }
        
        .share-utility-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .share-close-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        /* Merch Store */
        .merch-balance-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 100%);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .merch-balance-amount {
            font-weight: 700;
            color: var(--accent-gold);
            flex: 1;
        }
        
        .merch-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .merch-tab {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            touch-action: manipulation;
        }
        
        .merch-tab.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }
        
        .merch-catalog {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding-bottom: 10px;
        }
        
        .merch-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .merch-card.owned {
            border-color: var(--accent-green);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .merch-card.unaffordable {
            opacity: 0.6;
        }
        
        .merch-image {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .merch-info { text-align: center; }
        
        .merch-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        
        .merch-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .merch-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .merch-price {
            font-weight: 700;
            color: var(--accent-gold);
            font-size: 0.85rem;
        }
        
        .merch-owned {
            color: var(--accent-green);
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .merch-section-header {
            grid-column: 1 / -1;
            padding: 10px 0;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .merch-earn-hint {
            font-size: 0.7rem;
            color: var(--accent-gold);
            font-weight: 500;
        }
        
        /* Battles */
        .battle-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .battle-action-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .battle-action-btn .action-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 4px;
        }
        
        .battle-action-btn .action-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .battle-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .battle-card-header {
            padding: 10px 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .battle-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: auto;
        }
        
        .battle-badge.live {
            background: #f44336;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .battle-card-content {
            padding: 14px;
        }
        
        .battle-card-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .battle-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .battle-stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .battle-leaderboard {
            margin-top: 10px;
        }
        
        .battle-leaderboard-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .battle-leaderboard-row:last-child {
            border-bottom: none;
        }
        
        .battle-rank {
            width: 24px;
            text-align: center;
            font-weight: 700;
        }
        
        .battle-participant-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .battle-participant-name {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .battle-participant-score {
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .battle-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }
        
        .battle-empty .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .battle-form-group {
            margin-bottom: 16px;
        }
        
        .battle-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .battle-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .battle-game-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .battle-game-chip {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            touch-action: manipulation;
        }
        
        .battle-game-chip.selected {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }
        
        /* Achievements */
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .achievements-progress {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .achievements-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .achievements-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-orange));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .achievement-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .achievement-card.unlocked {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.1));
            border: 1px solid var(--accent-gold);
        }
        
        .achievement-card.locked {
            opacity: 0.5;
        }
        
        .achievement-icon {
            font-size: 1.8rem;
            display: block;
            margin-bottom: 6px;
        }
        
        .achievement-card.locked .achievement-icon {
            filter: grayscale(100%);
        }
        
        .achievement-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }
        
        .achievement-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
            line-height: 1.2;
        }
        
        .achievement-card.unlocked .achievement-desc {
            color: var(--accent-green);
        }
        
        /* Achievement unlock animation */
        @keyframes achievementPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .achievement-card.just-unlocked {
            animation: achievementPop 0.5s ease-out;
        }
        
        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: calc(70px + var(--safe-bottom));
            left: 12px;
            right: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 16px;
            padding: 16px;
            z-index: 180;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            display: none;
            animation: slideUp 0.3s ease-out;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .install-banner:active {
            transform: scale(0.98);
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-banner.visible {
            display: block;
        }
        
        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .install-banner-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.8rem;
            font-weight: 300;
            color: white;
        }
        
        .install-banner-text {
            flex: 1;
        }
        
        .install-banner-title {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .install-banner-desc {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.85);
            line-height: 1.3;
        }
        
        .install-banner-desc .share-icon {
            display: inline-block;
            vertical-align: middle;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 4px;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .install-banner-close {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span>üéÆ</span>
            <span>Game Shelf</span>
            <span style="font-size: 0.6rem; color: #ff0000; margin-left: 4px; font-weight: bold;">v0.4.9-DEBUG</span>
        </div>
        <div class="header-right">
            <div class="wallet-display">
                <span class="tokens">üíé <span id="token-count">0</span></span>
                <span class="coins">ü™ô <span id="coin-count">0</span></span>
            </div>
            <button class="menu-btn" onclick="toggleSettingsMenu()">‚ò∞</button>
        </div>
    </header>
    
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settings-overlay" onclick="toggleSettingsMenu()"></div>
    
    <!-- Slide-out Settings Menu -->
    <div class="settings-menu" id="settings-menu">
        <div class="settings-header">
            <h2>‚ò∞ Menu</h2>
            <button class="settings-close" onclick="toggleSettingsMenu()">‚úï</button>
        </div>
        <div class="settings-body">
            <!-- Account -->
            <div class="settings-section">
                <div class="settings-section-title">‚òÅÔ∏è Account</div>
                <div id="menu-account-section">
                    <a class="settings-link" onclick="signInWithGoogle(); toggleSettingsMenu();">
                        <span class="icon">üîê</span>
                        <span id="auth-menu-text">Sign in with Google</span>
                    </a>
                    <p class="settings-desc">Save progress across devices</p>
                </div>
            </div>
            
            <!-- Display -->
            <div class="settings-section">
                <div class="settings-section-title">üé® Display</div>
                <div class="theme-options">
                    <div class="theme-option active" id="theme-dark" onclick="setTheme('dark')">
                        <div class="label">üåô Dark</div>
                    </div>
                    <div class="theme-option" id="theme-light" onclick="setTheme('light')">
                        <div class="label">‚òÄÔ∏è Light</div>
                    </div>
                </div>
            </div>
            
            <!-- Sound -->
            <div class="settings-section">
                <div class="settings-section-title">üîä Sound</div>
                <div class="settings-toggle-row">
                    <label>
                        <span class="icon">üîî</span>
                        <span>Sound Effects</span>
                    </label>
                    <input type="checkbox" id="sound-toggle" onchange="toggleSound(this.checked)">
                </div>
            </div>
            
            <!-- Goals -->
            <div class="settings-section">
                <div class="settings-section-title">üéØ Goals</div>
                <a class="settings-link" onclick="resetDailyGoal(); toggleSettingsMenu();">
                    <span class="icon">üéØ</span>
                    Set Daily Goal
                </a>
            </div>
            
            <!-- Social -->
            <div class="settings-section">
                <div class="settings-section-title">üë• Social</div>
                <a class="settings-link" onclick="showShareHub(); toggleSettingsMenu();">
                    <span class="icon">üì¢</span>
                    Share Hub
                </a>
                <p class="settings-desc">Share results to social media</p>
                <a class="settings-link" onclick="showCreateBattle(); toggleSettingsMenu();">
                    <span class="icon">‚öîÔ∏è</span>
                    Create Battle
                </a>
                <a class="settings-link" onclick="showJoinBattle(); toggleSettingsMenu();">
                    <span class="icon">üîç</span>
                    Join Battle
                </a>
            </div>
            
            <!-- Progress -->
            <div class="settings-section">
                <div class="settings-section-title">üèÜ Progress</div>
                <a class="settings-link" onclick="showAchievements(); toggleSettingsMenu();">
                    <span class="icon">üèÜ</span>
                    Achievements
                </a>
                <p class="settings-desc">View your unlocked badges</p>
            </div>
            
            <!-- Shop -->
            <div class="settings-section">
                <div class="settings-section-title">üõçÔ∏è Shop</div>
                <a class="settings-link" onclick="showMerchStore(); toggleSettingsMenu();">
                    <span class="icon">üõçÔ∏è</span>
                    Merch Store
                </a>
                <p class="settings-desc">Redeem coins for rewards & gifts</p>
            </div>
            
            <!-- Data -->
            <div class="settings-section">
                <div class="settings-section-title">üóëÔ∏è Data</div>
                <a class="settings-link" onclick="exportData(); toggleSettingsMenu();">
                    <span class="icon">üì§</span>
                    Export Data
                </a>
                <a class="settings-link" onclick="importData(); toggleSettingsMenu();">
                    <span class="icon">üì•</span>
                    Import Data
                </a>
                <a class="settings-link" onclick="clearAllData(); toggleSettingsMenu();" style="color: var(--accent-red);">
                    <span class="icon">üóëÔ∏è</span>
                    Reset All Data
                </a>
            </div>
            
            <!-- About -->
            <div class="settings-section">
                <div class="settings-section-title">‚ÑπÔ∏è About</div>
                <a class="settings-link" onclick="showAbout(); toggleSettingsMenu();">
                    <span class="icon">üéÆ</span>
                    About Game Shelf
                </a>
            </div>
        </div>
        <div class="settings-footer">
            <div class="settings-version">Game Shelf PWA v0.4.9</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Screen -->
        <div class="screen active" id="screen-home">
            
            <!-- DEBUG MARKER 1 -->
            <div style="background: red; color: white; padding: 10px; text-align: center; font-weight: bold;">
                SECTION 1: YOUR GAMES (should be first)
            </div>
            
            <div class="section-header">
                <span class="section-title">Your Games</span>
                <button class="see-all" onclick="switchTab('games')">See All</button>
            </div>
            <div class="games-grid" id="home-games-grid" style="min-height: 100px; background: rgba(255,0,0,0.1);">
                <!-- DEBUG: If you see this, JS didn't run -->
                <div class="game-card">
                    <div class="game-icon">‚ùì</div>
                    <div class="game-name">Loading...</div>
                    <div class="game-status">Wait</div>
                </div>
            </div>
            
            <!-- DEBUG MARKER 2 -->
            <div style="background: blue; color: white; padding: 10px; text-align: center; font-weight: bold;">
                SECTION 2: LOG TODAY'S GAMES (should be second)
            </div>
            
            <div class="primary-action">
                <button class="big-log-button" onclick="openLogSheet()">
                    <span style="font-size: 1.3rem;">üìã</span>
                    <span>Log Today's Games</span>
                </button>
                <div class="quick-games" id="quick-games">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- DEBUG MARKER 3 -->
            <div style="background: green; color: white; padding: 10px; text-align: center; font-weight: bold;">
                SECTION 3: TODAY'S PROGRESS (should be third)
            </div>
            
            <div class="progress-section">
                <div class="progress-header">
                    <span>Today's Progress</span>
                    <span id="goal-display">0/5 games</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-stats">
                    <span id="games-today-text">Play your first game!</span>
                    <span class="streak-badge" id="streak-badge">üî• 0</span>
                </div>
            </div>
            
            <div class="widget" id="friends-widget">
                <div class="widget-header">
                    <span class="widget-icon">üë•</span>
                    <span class="widget-title">Friends Today</span>
                </div>
                <div class="friends-row" id="friends-row">
                    <div class="empty-state" style="padding: 10px;">
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Sign in to see friends</div>
                    </div>
                </div>
                <button class="widget-action" onclick="switchTab('social')">See All Friends ‚Üí</button>
            </div>
            
            <div class="widget" id="battle-widget" style="display: none;">
                <div class="widget-header">
                    <span class="widget-icon">‚öîÔ∏è</span>
                    <span class="widget-title">Active Battle</span>
                    <span class="widget-badge" id="battle-time-left">--</span>
                </div>
                <div class="battle-name" id="battle-name">--</div>
                <div class="battle-standings" id="battle-standings">
                    <!-- Populated by JS -->
                </div>
                <button class="widget-action" onclick="switchTab('social')">View Battle ‚Üí</button>
            </div>
        </div>
        
        <!-- Games Screen -->
        <div class="screen" id="screen-games">
            <div class="games-list">
                <div class="games-category">
                    <div class="category-title">Your Shelf</div>
                    <div class="games-grid" id="shelf-games-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <div class="games-category">
                    <div class="category-title">Popular Games</div>
                    <div class="games-grid" id="popular-games-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Social Screen -->
        <div class="screen" id="screen-social">
            <div class="social-section">
                <div class="section-header" style="padding: 0; margin-bottom: 16px;">
                    <span class="section-title">Today's Leaderboard</span>
                </div>
                <div id="leaderboard-list">
                    <!-- Populated by JS -->
                </div>
                
                <div class="widget" style="margin: 24px 0 0;">
                    <div class="widget-header">
                        <span class="widget-icon">‚öîÔ∏è</span>
                        <span class="widget-title">Brain Battles</span>
                    </div>
                    
                    <div class="battle-actions">
                        <div class="battle-action-btn" onclick="showCreateBattle()">
                            <span class="action-icon">‚öîÔ∏è</span>
                            <span class="action-text">Create</span>
                        </div>
                        <div class="battle-action-btn" onclick="showJoinBattle()">
                            <span class="action-icon">üîç</span>
                            <span class="action-text">Join</span>
                        </div>
                    </div>
                    
                    <div id="battles-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Bottom Navigation -->
    <nav class="nav-bar">
        <button class="nav-tab active" data-tab="home" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-tab" data-tab="games" onclick="switchTab('games')">
            <span class="nav-icon">üéÆ</span>
            <span class="nav-label">Games</span>
        </button>
        <button class="nav-tab" data-tab="social" onclick="switchTab('social')">
            <span class="nav-icon">üë•</span>
            <span class="nav-label">Social</span>
        </button>
        <button class="nav-tab" onclick="showShareHub()">
            <span class="nav-icon">üì¢</span>
            <span class="nav-label">Share</span>
        </button>
    </nav>
    
    <!-- Install Banner -->
    <div class="install-banner" id="install-banner" onclick="triggerInstall()">
        <div class="install-banner-content">
            <div class="install-banner-icon">üì≤</div>
            <div class="install-banner-text">
                <div class="install-banner-title">Install Game Shelf</div>
                <div class="install-banner-desc" id="install-desc">
                    Tap here, then "Add to Home Screen"
                </div>
            </div>
            <button class="install-banner-close" onclick="dismissInstallBanner(event)">‚úï</button>
        </div>
    </div>
    
    <!-- Log Sheet -->
    <div class="bottom-sheet-overlay" id="log-sheet" onclick="closeLogSheet(event)">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üìã Log Game Result</div>
            <textarea class="log-textarea" id="log-input" placeholder="Paste your game results here...

Example:
Wordle 1,234 3/6

‚¨õ‚¨õüü®‚¨õ‚¨õ
üü®üü©‚¨õ‚¨õ‚¨õ
üü©üü©üü©üü©üü©" oninput="parseLogInput()"></textarea>
            <div class="parse-preview" id="parse-preview">
                <div class="parse-game-name" id="parse-game-name"></div>
                <div class="parse-score" id="parse-score"></div>
            </div>
            <button class="log-btn" id="log-btn" onclick="submitLog()">Log It!</button>
        </div>
    </div>
    
    <!-- Clipboard Prompt -->
    <div class="clipboard-prompt" id="clipboard-prompt" style="display:none;">
        <span class="prompt-icon" id="prompt-icon">üìù</span>
        <span class="prompt-text" id="prompt-text">Log game?</span>
        <button class="prompt-yes" id="prompt-yes-btn" type="button" onclick="acceptClipboard()" ontouchend="event.preventDefault(); acceptClipboard();">‚úì</button>
        <button class="prompt-no" id="prompt-no-btn" type="button" onclick="dismissClipboard()" ontouchend="event.preventDefault(); dismissClipboard();">‚úï</button>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Account Modal -->
    <div class="bottom-sheet-overlay" id="account-sheet" onclick="closeAccountModal()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üë§ Account</div>
            <div id="modal-content">
                <!-- Populated by JS based on auth state -->
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal-overlay" id="success-modal" onclick="closeSuccessModal()" ontouchend="closeSuccessModal()">
        <div class="success-modal-content" onclick="event.stopPropagation()" ontouchend="event.stopPropagation()">
            <div class="success-celebration" id="success-celebration">üéâ</div>
            <div class="success-icon" id="success-icon">üü©</div>
            <div class="success-game" id="success-game">Wordle</div>
            <div class="success-score" id="success-score">3/6</div>
            <div class="success-points" id="success-points">+25 pts</div>
            <div class="success-streak" id="success-streak">üî• 5 day streak!</div>
            <button class="success-close-btn" onclick="closeSuccessModal()" ontouchend="event.preventDefault(); closeSuccessModal();">Nice! üëç</button>
        </div>
    </div>
    
    <!-- Share Hub Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="share-hub-sheet" onclick="closeShareHub()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="share-hub-header">
                <div style="font-size: 2rem;">üì¢</div>
                <h2>Share Hub</h2>
                <p>Write once, share everywhere</p>
            </div>
            
            <!-- Today's Results -->
            <div class="share-results-section">
                <div class="share-results-header">
                    <h4>üìä Today's Results</h4>
                    <span class="share-results-date" id="share-hub-date"></span>
                </div>
                <div class="share-result-tags" id="share-hub-results">
                    <!-- Filled dynamically -->
                </div>
            </div>
            
            <!-- Message Composer -->
            <div class="share-composer">
                <div class="share-composer-header">
                    <label>‚úçÔ∏è Your Message</label>
                    <select class="share-template-select" id="share-template-select" onchange="applyShareTemplate()">
                        <option value="default">Default</option>
                        <option value="brag">Bragging üèÜ</option>
                        <option value="humble">Humble üòÖ</option>
                        <option value="streak">Streak Focus üî•</option>
                        <option value="challenge">Challenge ‚öîÔ∏è</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>
                <textarea class="share-textarea" id="share-message" rows="4" placeholder="Write your message here..."></textarea>
                <div class="share-emoji-bar">
                    <button class="share-emoji-btn" onclick="insertShareEmoji('üéÆ')">üéÆ</button>
                    <button class="share-emoji-btn" onclick="insertShareEmoji('üß†')">üß†</button>
                    <button class="share-emoji-btn" onclick="insertShareEmoji('üî•')">üî•</button>
                    <button class="share-emoji-btn" onclick="insertShareEmoji('üí™')">üí™</button>
                    <button class="share-emoji-btn" onclick="insertShareEmoji('üéØ')">üéØ</button>
                    <button class="share-emoji-btn" onclick="insertShareEmoji('‚ú®')">‚ú®</button>
                </div>
            </div>
            
            <!-- Share Platforms -->
            <div class="share-platforms">
                <h4>üöÄ Share To</h4>
                
                <!-- Primary Platforms -->
                <div class="share-platforms-grid">
                    <button class="share-platform-btn" style="background: #000;" onclick="shareToTwitter()">
                        <span class="icon">ùïè</span>
                        <span class="label">Twitter/X</span>
                    </button>
                    <button class="share-platform-btn" style="background: #1877F2;" onclick="shareToFacebook()">
                        <span class="icon">üìò</span>
                        <span class="label">Facebook</span>
                    </button>
                    <button class="share-platform-btn" style="background: #0A66C2;" onclick="shareToLinkedIn()">
                        <span class="icon">üíº</span>
                        <span class="label">LinkedIn</span>
                    </button>
                    <button class="share-platform-btn" style="background: #000;" onclick="shareToThreads()">
                        <span class="icon">üßµ</span>
                        <span class="label">Threads</span>
                    </button>
                </div>
                
                <!-- Secondary Platforms -->
                <div class="share-platforms-grid">
                    <button class="share-platform-btn" style="background: #FF4500;" onclick="shareToReddit()">
                        <span class="icon">üî¥</span>
                        <span class="label">Reddit</span>
                    </button>
                    <button class="share-platform-btn" style="background: #5865F2;" onclick="shareToDiscord()">
                        <span class="icon">üí¨</span>
                        <span class="label">Discord</span>
                    </button>
                    <button class="share-platform-btn" style="background: #0085FF;" onclick="shareToBlueSky()">
                        <span class="icon">ü¶ã</span>
                        <span class="label">BlueSky</span>
                    </button>
                    <button class="share-platform-btn" style="background: #6364FF;" onclick="shareToMastodon()">
                        <span class="icon">üêò</span>
                        <span class="label">Mastodon</span>
                    </button>
                </div>
                
                <!-- Utility -->
                <div class="share-utility-grid">
                    <button class="share-platform-btn" style="background: var(--bg-tertiary); border: 1px solid var(--border);" onclick="copyShareMessage()">
                        <span class="icon">üìã</span>
                        <span class="label" style="color: var(--text-primary);">Copy</span>
                    </button>
                    <button class="share-platform-btn" style="background: var(--accent-green);" onclick="shareNative()">
                        <span class="icon">üì§</span>
                        <span class="label">More...</span>
                    </button>
                </div>
            </div>
            
            <button class="share-close-btn" onclick="closeShareHub()">Close</button>
        </div>
    </div>
    
    <!-- Merch Store Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="merch-sheet" onclick="closeMerchStore()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üõçÔ∏è Merch Store</div>
            
            <div class="merch-balance-bar">
                <span>Your Balance:</span>
                <span class="merch-balance-amount">ü™ô <span id="merch-balance">0</span></span>
            </div>
            
            <div class="merch-tabs">
                <button class="merch-tab active" onclick="filterMerch('all')">All</button>
                <button class="merch-tab" onclick="filterMerch('virtual')">üèÜ Rewards</button>
                <button class="merch-tab" onclick="filterMerch('physical')">üéÅ Gifts</button>
            </div>
            
            <div id="merch-catalog" class="merch-catalog">
                <!-- Rendered by JS -->
            </div>
            
            <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted); padding-top: 10px; border-top: 1px solid var(--border); margin-top: 10px;">
                Physical gifts fulfilled by Goody
            </div>
            
            <button class="share-close-btn" style="margin-top: 15px;" onclick="closeMerchStore()">Close</button>
        </div>
    </div>
    
    <!-- Create Battle Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="create-battle-sheet" onclick="closeCreateBattle()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">‚öîÔ∏è Create Battle</div>
            
            <div class="battle-form-group">
                <label class="battle-form-label">Battle Name</label>
                <input type="text" class="battle-input" id="battle-name-input" placeholder="e.g., Weekend Showdown" maxlength="30">
            </div>
            
            <div class="battle-form-group">
                <label class="battle-form-label">Select Games</label>
                <div class="battle-game-select" id="battle-game-select">
                    <div class="battle-game-chip selected" data-game="wordle" onclick="toggleBattleGame(this)">üü© Wordle</div>
                    <div class="battle-game-chip selected" data-game="connections" onclick="toggleBattleGame(this)">üîó Connections</div>
                    <div class="battle-game-chip" data-game="strands" onclick="toggleBattleGame(this)">üßµ Strands</div>
                    <div class="battle-game-chip" data-game="mini" onclick="toggleBattleGame(this)">üì∞ Mini</div>
                </div>
            </div>
            
            <div class="battle-form-group">
                <label class="battle-form-label">Duration</label>
                <select class="battle-input" id="battle-duration">
                    <option value="1">1 Day</option>
                    <option value="3" selected>3 Days</option>
                    <option value="7">7 Days</option>
                </select>
            </div>
            
            <div class="battle-form-group">
                <label class="battle-form-label">Entry Fee (optional)</label>
                <select class="battle-input" id="battle-entry-fee">
                    <option value="0">Free - Just for fun</option>
                    <option value="5">ü™ô 5 coins</option>
                    <option value="10">ü™ô 10 coins</option>
                    <option value="25">ü™ô 25 coins</option>
                </select>
            </div>
            
            <button class="share-close-btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-top: 10px;" onclick="createBattle()">Create Battle</button>
            <button class="share-close-btn" style="margin-top: 10px;" onclick="closeCreateBattle()">Cancel</button>
        </div>
    </div>
    
    <!-- Join Battle Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="join-battle-sheet" onclick="closeJoinBattle()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üîç Join Battle</div>
            
            <div class="battle-form-group">
                <label class="battle-form-label">Enter Battle Code</label>
                <input type="text" class="battle-input" id="join-code-input" placeholder="e.g., ABC123" maxlength="6" style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 4px;">
            </div>
            
            <div id="join-battle-preview" style="display: none; padding: 15px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 15px;">
                <div style="font-weight: 700;" id="join-battle-name"></div>
                <div style="font-size: 0.85rem; color: var(--text-muted);" id="join-battle-info"></div>
            </div>
            
            <div id="join-battle-error" style="display: none; color: var(--accent-red); padding: 10px; text-align: center;"></div>
            
            <button class="share-close-btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;" onclick="lookupBattleCode()">Find Battle</button>
            <button class="share-close-btn" style="margin-top: 10px;" onclick="closeJoinBattle()">Cancel</button>
        </div>
    </div>
    
    <!-- Battle Details Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="battle-details-sheet" onclick="closeBattleDetails()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header" id="battle-details-title">‚öîÔ∏è Battle Details</div>
            
            <div id="battle-status-banner" style="padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: 600;"></div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Games</div>
                    <div style="font-weight: 600;" id="battle-games-display">-</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Time Left</div>
                    <div style="font-weight: 600;" id="battle-time-display">-</div>
                </div>
                <div style="flex: 1; text-align: center;" id="battle-prize-display">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Prize Pool</div>
                    <div style="font-weight: 600; color: var(--accent-gold);" id="battle-prize-amount">-</div>
                </div>
            </div>
            
            <div id="battle-share-code" style="display: none; background: var(--bg-tertiary); padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Share Code</div>
                <div style="font-size: 1.5rem; font-weight: 700; letter-spacing: 3px;" id="battle-code-display"></div>
                <button style="margin-top: 8px; padding: 6px 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-size: 0.8rem;" onclick="copyBattleCode()">üìã Copy</button>
            </div>
            
            <div style="font-weight: 600; margin-bottom: 10px;">üèÜ Leaderboard</div>
            <div id="battle-leaderboard-display">
                <!-- Populated by JS -->
            </div>
            
            <button class="share-close-btn" style="margin-top: 15px;" onclick="closeBattleDetails()">Close</button>
        </div>
    </div>
    
    <!-- Achievements Bottom Sheet -->
    <div class="bottom-sheet-overlay" id="achievements-sheet" onclick="closeAchievements()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">üèÜ Achievements</div>
            
            <div class="achievements-header">
                <span>Your Progress</span>
                <span class="achievements-progress" id="achievements-count">0/14</span>
            </div>
            <div class="achievements-progress-bar">
                <div class="achievements-progress-fill" id="achievements-fill" style="width: 0%"></div>
            </div>
            
            <div class="achievements-grid" id="achievements-grid">
                <!-- Populated by JS -->
            </div>
            
            <button class="share-close-btn" style="margin-top: 15px;" onclick="closeAchievements()">Close</button>
        </div>
    </div>
    
    <script>
        // ============ FIREBASE CONFIG ============
        const firebaseConfig = {
            apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
            authDomain: "word-boxing.firebaseapp.com",
            databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
            projectId: "word-boxing"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // ============ APP STATE ============
        let currentUser = null;
        let appData = null;
        let detectedClipboard = null;
        
        // ============ GAME CATALOG ============
        const GAMES = {
            // NYT Games
            wordle: { id: 'wordle', name: 'Wordle', icon: 'üü©', url: 'https://www.nytimes.com/games/wordle' },
            connections: { id: 'connections', name: 'Connections', icon: 'üîó', url: 'https://www.nytimes.com/games/connections' },
            strands: { id: 'strands', name: 'Strands', icon: 'üßµ', url: 'https://www.nytimes.com/games/strands' },
            mini: { id: 'mini', name: 'Mini', icon: 'üìù', url: 'https://www.nytimes.com/crosswords/game/mini' },
            'spelling-bee': { id: 'spelling-bee', name: 'Spelling Bee', icon: 'üêù', url: 'https://www.nytimes.com/puzzles/spelling-bee' },
            letterboxed: { id: 'letterboxed', name: 'Letterboxed', icon: 'üì¶', url: 'https://www.nytimes.com/puzzles/letter-boxed' },
            // Popular Word Games
            quordle: { id: 'quordle', name: 'Quordle', icon: '4Ô∏è‚É£', url: 'https://www.quordle.com' },
            octordle: { id: 'octordle', name: 'Octordle', icon: '8Ô∏è‚É£', url: 'https://octordle.com' },
            worldle: { id: 'worldle', name: 'Worldle', icon: 'üåç', url: 'https://worldle.teuteuf.fr' },
            globle: { id: 'globle', name: 'Globle', icon: 'üåé', url: 'https://globle-game.com' },
            tradle: { id: 'tradle', name: 'Tradle', icon: 'üö¢', url: 'https://oec.world/en/tradle' },
            waffle: { id: 'waffle', name: 'Waffle', icon: 'üßá', url: 'https://wafflegame.net' },
            // Movie/TV/Music
            framed: { id: 'framed', name: 'Framed', icon: 'üé¨', url: 'https://framed.wtf' },
            actorle: { id: 'actorle', name: 'Actorle', icon: 'üé≠', url: 'https://actorle.com' },
            moviedle: { id: 'moviedle', name: 'Moviedle', icon: 'üé•', url: 'https://moviedle.app' },
            heardle: { id: 'heardle', name: 'Heardle', icon: 'üéµ', url: 'https://www.spotify.com/heardle' },
            bandle: { id: 'bandle', name: 'Bandle', icon: 'üé∏', url: 'https://bandle.app' },
            // Math/Logic
            nerdle: { id: 'nerdle', name: 'Nerdle', icon: 'üßÆ', url: 'https://nerdlegame.com' },
            // LinkedIn Games
            queens: { id: 'queens', name: 'Queens', icon: 'üëë', url: 'https://www.linkedin.com/games/queens' },
            tango: { id: 'tango', name: 'Tango', icon: 'üíÉ', url: 'https://www.linkedin.com/games/tango' },
            pinpoint: { id: 'pinpoint', name: 'Pinpoint', icon: 'üìç', url: 'https://www.linkedin.com/games/pinpoint' },
            crossclimb: { id: 'crossclimb', name: 'Crossclimb', icon: 'üßó', url: 'https://www.linkedin.com/games/crossclimb' },
            // Sports
            'immaculate-grid': { id: 'immaculate-grid', name: 'Immaculate Grid', icon: '‚öæ', url: 'https://www.immaculategrid.com' },
            // Misc
            redactle: { id: 'redactle', name: 'Redactle', icon: '‚ñà', url: 'https://redactle.net' },
            semantle: { id: 'semantle', name: 'Semantle', icon: 'üß†', url: 'https://semantle.com' },
            costcodle: { id: 'costcodle', name: 'Costcodle', icon: 'üõí', url: 'https://costcodle.com' },
            wheretaken: { id: 'wheretaken', name: 'WhereTaken', icon: 'üì∏', url: 'https://wheretaken.teuteuf.fr' },
            foodguessr: { id: 'foodguessr', name: 'FoodGuessr', icon: 'üçï', url: 'https://www.foodguessr.com' },
            // Game Shelf Originals - use absolute URLs
            quotle: { id: 'quotle', name: 'Quotle', icon: 'üí¨', url: 'https://stewartdavidp-ship-it.github.io/Quotle/' },
            slate: { id: 'slate', name: 'Slate', icon: 'üìù', url: 'https://stewartdavidp-ship-it.github.io/Slate/' },
            rungs: { id: 'rungs', name: 'Rungs', icon: 'ü™ú', url: 'https://stewartdavidp-ship-it.github.io/Rungstest/' },
            wordboxing: { id: 'wordboxing', name: 'Word Boxing', icon: 'ü•ä', url: 'https://stewartdavidp-ship-it.github.io/WordBoxing/' }
        };
        
        const DEFAULT_SHELF = ['wordle', 'connections', 'strands', 'mini', 'spelling-bee', 'worldle'];
        const POPULAR_GAMES = ['quotle', 'slate', 'rungs', 'wordboxing', 'quordle', 'framed', 'queens', 'heardle', 'nerdle'];
        
        // ============ SHARE TEXT PARSERS ============
        const PARSERS = [
            // NYT Games
            {
                id: 'wordle',
                regex: /Wordle\s+[\d,]+\s+([1-6X])\/6/i,
                extract: (match, text) => ({
                    gameId: 'wordle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 5
                })
            },
            {
                id: 'connections',
                regex: /Connections\s*\n?Puzzle\s*#?\d+/i,
                extract: (match, text) => {
                    const lines = text.split('\n').filter(l => /^[üü®üü©üü¶üü™]+$/.test(l.trim()));
                    const solved = lines.length >= 4;
                    return {
                        gameId: 'connections',
                        score: solved ? 'Solved!' : `${lines.length}/4`,
                        won: solved,
                        numericScore: solved ? 25 : lines.length * 5
                    };
                }
            },
            {
                id: 'strands',
                regex: /Strands\s*#?\d+/i,
                extract: (match, text) => {
                    const hints = (text.match(/üí°/g) || []).length;
                    return {
                        gameId: 'strands',
                        score: hints > 0 ? `${hints} hints` : 'No hints!',
                        won: true,
                        numericScore: hints === 0 ? 25 : Math.max(15 - hints * 3, 5)
                    };
                }
            },
            {
                id: 'mini',
                regex: /Mini\s*Crossword|I\s+solved.*Mini.*in\s+(\d+):(\d+)/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        const secs = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
                        return {
                            gameId: 'mini',
                            score: `${timeMatch[1]}:${timeMatch[2]}`,
                            won: true,
                            numericScore: Math.max(30 - Math.floor(secs / 10), 5)
                        };
                    }
                    return { gameId: 'mini', score: 'Done', won: true, numericScore: 15 };
                }
            },
            {
                id: 'spelling-bee',
                regex: /Spelling\s*Bee|üêù.*Genius|üêù.*Queen/i,
                extract: (match, text) => {
                    if (text.includes('Queen')) return { gameId: 'spelling-bee', score: 'Queen Bee! üëë', won: true, numericScore: 50 };
                    if (text.includes('Genius')) return { gameId: 'spelling-bee', score: 'Genius!', won: true, numericScore: 30 };
                    return { gameId: 'spelling-bee', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'letterboxed',
                regex: /Letter\s*Boxed|I\s+solved.*Letter.*in\s+(\d+)/i,
                extract: (match, text) => {
                    const wordMatch = text.match(/in\s+(\d+)\s+word/i);
                    if (wordMatch) {
                        const words = parseInt(wordMatch[1]);
                        return { gameId: 'letterboxed', score: `${words} words`, won: true, numericScore: Math.max(30 - words * 5, 10) };
                    }
                    return { gameId: 'letterboxed', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Popular Word Games
            {
                id: 'quordle',
                regex: /Daily\s+Quordle\s+\d+/i,
                extract: (match, text) => ({
                    gameId: 'quordle',
                    score: text.includes('üü•') ? 'Partial' : 'Solved!',
                    won: !text.includes('üü•'),
                    numericScore: text.includes('üü•') ? 10 : 25
                })
            },
            {
                id: 'octordle',
                regex: /Daily\s+Octordle\s+#?\d+/i,
                extract: () => ({ gameId: 'octordle', score: 'Completed', won: true, numericScore: 20 })
            },
            {
                id: 'worldle',
                regex: /#Worldle\s+#?\d+\s*([1-6X])\/6/i,
                extract: (match, text) => ({
                    gameId: 'worldle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'globle',
                regex: /üåé.*üåç|Globle/i,
                extract: () => ({ gameId: 'globle', score: 'Completed', won: true, numericScore: 15 })
            },
            {
                id: 'tradle',
                regex: /#Tradle\s+#?\d+\s*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'tradle',
                    score: match[1] + '/6',
                    won: true,
                    numericScore: (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'waffle',
                regex: /#waffle\d+|Waffle\s*#?\d+/i,
                extract: (match, text) => {
                    const starsMatch = text.match(/([0-5])\/5\s*‚≠ê/);
                    const stars = starsMatch ? parseInt(starsMatch[1]) : 3;
                    return { gameId: 'waffle', score: `${stars}/5 ‚≠ê`, won: stars >= 3, numericScore: stars * 5 };
                }
            },
            // Movie/TV Games
            {
                id: 'framed',
                regex: /Framed\s+#?\d+/i,
                extract: (match, text) => {
                    const won = text.includes('üü©');
                    const frames = (text.match(/[üé•üü©üü•]/g) || []).length;
                    return { gameId: 'framed', score: won ? `${frames}/6` : 'X/6', won, numericScore: won ? (7 - frames) * 4 : 0 };
                }
            },
            {
                id: 'actorle',
                regex: /Actorle\s*#?\d+\s*([1-8X])\/8/i,
                extract: (match) => ({
                    gameId: 'actorle',
                    score: match[1] + '/8',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (9 - parseInt(match[1])) * 3
                })
            },
            {
                id: 'moviedle',
                regex: /Moviedle\s*#?\d+|#Moviedle.*(\d+)\/6/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { gameId: 'moviedle', score: guessMatch[1] + '/6', won: true, numericScore: (7 - parseInt(guessMatch[1])) * 4 };
                    }
                    return { gameId: 'moviedle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Music Games
            {
                id: 'heardle',
                regex: /Heardle\s*#?\d+|üéµ.*Heardle/i,
                extract: (match, text) => {
                    const won = text.includes('üü©');
                    const guesses = (text.match(/[üü•üü©‚¨úüü®]/g) || []).length;
                    return { gameId: 'heardle', score: won ? `${guesses}/6` : 'X/6', won, numericScore: won ? (7 - guesses) * 4 : 0 };
                }
            },
            {
                id: 'bandle',
                regex: /Bandle\s*#?\d+\s*([1-6X])\/6/i,
                extract: (match) => ({
                    gameId: 'bandle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            // Math/Logic Games
            {
                id: 'nerdle',
                regex: /nerdlegame\s+\d+|Nerdle\s+\d+.*(\d+)\/6/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { gameId: 'nerdle', score: guessMatch[1] + '/6', won: guessMatch[1] !== 'X', numericScore: (7 - parseInt(guessMatch[1])) * 4 };
                    }
                    return { gameId: 'nerdle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // LinkedIn Games
            {
                id: 'queens',
                regex: /Queens\s*#?\d+|üëë.*Queens/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'queens', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'queens', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'tango',
                regex: /Tango\s*#?\d+|üíÉ.*Tango/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'tango', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'tango', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'pinpoint',
                regex: /Pinpoint\s*#?\d+|üìç.*Pinpoint/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s*guess/i);
                    if (guessMatch) {
                        return { gameId: 'pinpoint', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(25 - parseInt(guessMatch[1]) * 3, 5) };
                    }
                    return { gameId: 'pinpoint', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'crossclimb',
                regex: /Crossclimb\s*#?\d+|üßó.*Crossclimb/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'crossclimb', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'crossclimb', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Sports
            {
                id: 'immaculate-grid',
                regex: /Immaculate\s+Grid|‚öæ.*\/9/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\/9/);
                    if (scoreMatch) {
                        const score = parseInt(scoreMatch[1]);
                        return { gameId: 'immaculate-grid', score: `${score}/9`, won: score >= 5, numericScore: score * 3 };
                    }
                    return { gameId: 'immaculate-grid', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Misc
            {
                id: 'redactle',
                regex: /Redactle\s+#?\d+|I\s+solved\s+Redactle.*(\d+)\s+guesses/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { gameId: 'redactle', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(30 - Math.floor(parseInt(guessMatch[1]) / 10), 5) };
                    }
                    return { gameId: 'redactle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'semantle',
                regex: /Semantle\s+#?\d+|I\s+solved\s+Semantle.*(\d+)\s+guesses/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { gameId: 'semantle', score: `${guessMatch[1]} guesses`, won: true, numericScore: Math.max(30 - Math.floor(parseInt(guessMatch[1]) / 5), 5) };
                    }
                    return { gameId: 'semantle', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'costcodle',
                regex: /Costcodle\s+#?\d+.*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'costcodle',
                    score: match[1] + '/6',
                    won: match[1] !== 'X',
                    numericScore: match[1] === 'X' ? 0 : (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'wheretaken',
                regex: /WhereTaken\s*#?\d+.*(\d+)\/6/i,
                extract: (match) => ({
                    gameId: 'wheretaken',
                    score: match[1] + '/6',
                    won: true,
                    numericScore: (7 - parseInt(match[1])) * 4
                })
            },
            {
                id: 'foodguessr',
                regex: /FoodGuessr\s*#?\d+/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*points?/i);
                    if (scoreMatch) {
                        return { gameId: 'foodguessr', score: `${scoreMatch[1]} pts`, won: true, numericScore: Math.min(Math.floor(parseInt(scoreMatch[1]) / 100), 25) };
                    }
                    return { gameId: 'foodguessr', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            // Game Shelf Originals
            {
                id: 'quotle',
                regex: /Quotle\s*#?\d+.*([1-8X])\/8|Quotle.*üéØ|Quotle.*‚úÖ|Quotle.*‚ùå/i,
                extract: (match, text) => {
                    if (text.includes('üéØ')) return { gameId: 'quotle', score: 'Perfect! üéØ', won: true, numericScore: 40 };
                    const scoreMatch = text.match(/([1-8X])\/8/);
                    if (scoreMatch) {
                        const won = scoreMatch[1] !== 'X';
                        return { gameId: 'quotle', score: scoreMatch[1] + '/8', won, numericScore: won ? (9 - parseInt(scoreMatch[1])) * 4 : 0 };
                    }
                    return { gameId: 'quotle', score: text.includes('‚ùå') ? 'X/8' : 'Done', won: !text.includes('‚ùå'), numericScore: 15 };
                }
            },
            {
                id: 'slate',
                regex: /Slate\s*#?\d+/i,
                extract: (match, text) => {
                    const wordsMatch = text.match(/(\d+)\s*words?/i);
                    if (wordsMatch) {
                        return { gameId: 'slate', score: `${wordsMatch[1]} words`, won: true, numericScore: Math.min(parseInt(wordsMatch[1]) * 2, 30) };
                    }
                    return { gameId: 'slate', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'rungs',
                regex: /Rungs\s*#?\d+/i,
                extract: (match, text) => {
                    const movesMatch = text.match(/(\d+)\s*moves?/i);
                    if (movesMatch) {
                        return { gameId: 'rungs', score: `${movesMatch[1]} moves`, won: true, numericScore: Math.max(25 - parseInt(movesMatch[1]), 5) };
                    }
                    return { gameId: 'rungs', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'wordboxing',
                regex: /Word\s*Boxing|ü•ä.*Boxing/i,
                extract: () => ({ gameId: 'wordboxing', score: 'Completed', won: true, numericScore: 20 })
            },
            // Missing parsers from desktop
            {
                id: 'duotrigordle',
                regex: /Daily\s+Duotrigordle\s+#?\d+/i,
                extract: (match, text) => {
                    const failed = (text.match(/üü•/g) || []).length;
                    return { gameId: 'duotrigordle', score: failed > 0 ? `${32-failed}/32` : '32/32', won: failed === 0, numericScore: Math.max(32 - failed, 10) };
                }
            },
            {
                id: 'sedecordle',
                regex: /Daily\s+Sedecordle\s+#?\d+/i,
                extract: (match, text) => {
                    const failed = (text.match(/üü•/g) || []).length;
                    return { gameId: 'sedecordle', score: failed > 0 ? `${16-failed}/16` : '16/16', won: failed === 0, numericScore: Math.max(20 - failed, 5) };
                }
            },
            {
                id: 'tiles',
                regex: /Tiles\s*#?\d+|üî≤.*Tiles/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*pts?/i);
                    if (scoreMatch) {
                        return { gameId: 'tiles', score: `${scoreMatch[1]} pts`, won: true, numericScore: Math.min(Math.floor(parseInt(scoreMatch[1]) / 10), 25) };
                    }
                    return { gameId: 'tiles', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'timeguessr',
                regex: /TimeGuessr\s*#?\d+/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\s*pts?/i);
                    if (scoreMatch) {
                        return { gameId: 'timeguessr', score: `${scoreMatch[1]} pts`, won: true, numericScore: Math.min(Math.floor(parseInt(scoreMatch[1]) / 1000), 25) };
                    }
                    return { gameId: 'timeguessr', score: 'Completed', won: true, numericScore: 15 };
                }
            },
            {
                id: 'vertex',
                regex: /Vertex\s*#?\d+|I\s+solved\s+Vertex/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { gameId: 'vertex', score: `${timeMatch[1]}:${timeMatch[2]}`, won: true, numericScore: 20 };
                    }
                    return { gameId: 'vertex', score: 'Completed', won: true, numericScore: 15 };
                }
            }
        ];
        
        // ============ DATA MANAGEMENT ============
        function loadData() {
            try {
                const stored = localStorage.getItem('gameShelfData');
                if (stored) {
                    appData = JSON.parse(stored);
                    // Ensure achievements is an object
                    if (!appData.achievements || Array.isArray(appData.achievements)) {
                        appData.achievements = {};
                    }
                } else {
                    appData = createDefaultData();
                    saveData();
                }
            } catch (e) {
                console.error('Load error:', e);
                appData = createDefaultData();
            }
            return appData;
        }
        
        function createDefaultData() {
            return {
                games: DEFAULT_SHELF.map(id => ({ id, addedAt: new Date().toISOString() })),
                stats: {},
                history: {},
                wallet: { tokens: 100, coins: 0 },
                achievements: {},
                dailyGoal: 5,
                friends: [],
                settings: {}
            };
        }
        
        function saveData() {
            try {
                localStorage.setItem('gameShelfData', JSON.stringify(appData));
            } catch (e) {
                console.error('Save error:', e);
            }
        }
        
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getTodayHistory() {
            const today = getTodayString();
            return appData.history[today] || {};
        }
        
        function getGamesPlayedToday() {
            return Object.keys(getTodayHistory()).length;
        }
        
        function getMaxStreak() {
            let maxStreak = 0;
            for (const gameId in appData.stats) {
                const streak = appData.stats[gameId]?.currentStreak || 0;
                if (streak > maxStreak) maxStreak = streak;
            }
            return maxStreak;
        }
        
        // ============ PARSE SHARE TEXT ============
        function parseShareText(text) {
            if (!text || typeof text !== 'string') return null;
            
            for (const parser of PARSERS) {
                const match = text.match(parser.regex);
                if (match) {
                    try {
                        return parser.extract(match, text);
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                }
            }
            return null;
        }
        
        // ============ LOG GAME ============
        function logGame(result) {
            if (!result || !result.gameId) return false;
            
            const today = getTodayString();
            
            // Update history
            if (!appData.history[today]) {
                appData.history[today] = {};
            }
            appData.history[today][result.gameId] = {
                score: result.score,
                won: result.won,
                numericScore: result.numericScore || 0,
                time: new Date().toISOString()
            };
            
            // Update stats
            if (!appData.stats[result.gameId]) {
                appData.stats[result.gameId] = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    lastPlayed: null
                };
            }
            
            const stats = appData.stats[result.gameId];
            stats.gamesPlayed++;
            if (result.won) stats.gamesWon++;
            stats.lastPlayed = today;
            
            // Streak calculation
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (stats.lastPlayed === yesterdayStr || stats.currentStreak === 0) {
                stats.currentStreak++;
            }
            if (stats.currentStreak > stats.maxStreak) {
                stats.maxStreak = stats.currentStreak;
            }
            
            // Award tokens
            const isFirstToday = getGamesPlayedToday() === 1;
            if (isFirstToday) {
                appData.wallet.tokens += 10;
            } else {
                appData.wallet.tokens += 5;
            }
            
            // Check achievements
            checkTimeAchievements();
            checkAndUnlockAchievements();
            
            // Update battle scores if in active battle
            updateBattleScore(result.gameId, result.numericScore || 1);
            
            saveData();
            syncToCloud();
            return true;
        }
        
        // ============ CLOUD SYNC ============
        async function syncToCloud() {
            if (!currentUser) return;
            
            try {
                await db.ref(`users/${currentUser.uid}/shelf`).set(appData);
                console.log('Synced to cloud');
            } catch (e) {
                console.error('Sync error:', e);
            }
        }
        
        async function loadFromCloud() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.ref(`users/${currentUser.uid}/shelf`).once('value');
                const cloudData = snapshot.val();
                if (cloudData) {
                    // Merge with local (cloud wins for history)
                    appData = { ...appData, ...cloudData };
                    saveData();
                }
            } catch (e) {
                console.error('Load from cloud error:', e);
            }
        }
        
        // ============ AUTH ============
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user ? user.email : 'null');
            currentUser = user;
            updateAuthUI();
            
            if (user) {
                showToast('Signed in: ' + user.email);
                await loadFromCloud();
                loadUserBattles();
                
                // Unlock cloud sync achievement
                if (!appData.achievements) appData.achievements = {};
                if (!appData.achievements['cloud-sync']) {
                    unlockAchievement('cloud-sync');
                }
            }
            
            renderAll();
        });
        
        // Handle redirect result (for PWA standalone mode)
        auth.getRedirectResult().then(result => {
            console.log('Redirect result:', result);
            if (result.user) {
                console.log('Redirect sign-in successful:', result.user.email);
                showToast('Welcome ' + result.user.displayName);
            }
        }).catch(e => {
            console.error('Redirect sign-in error:', e);
            showToast('Auth error: ' + e.code, 'error');
        });
        
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Use redirect for standalone PWA (popups don't work)
            if (isStandalone()) {
                auth.signInWithRedirect(provider).catch(e => {
                    console.error('Sign in redirect error:', e);
                    showToast('Sign in failed', 'error');
                });
            } else {
                // Use popup for regular browser
                auth.signInWithPopup(provider).catch(e => {
                    console.error('Sign in popup error:', e);
                    // Fallback to redirect if popup fails
                    if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
                        auth.signInWithRedirect(provider);
                    } else {
                        showToast('Sign in failed', 'error');
                    }
                });
            }
        }
        
        function signOut() {
            auth.signOut();
            closeAccountModal();
            showToast('Signed out');
        }
        
        function updateAuthUI() {
            const authMenuText = document.getElementById('auth-menu-text');
            const menuAccountSection = document.getElementById('menu-account-section');
            
            if (currentUser) {
                if (authMenuText) authMenuText.textContent = 'Sign Out (' + (currentUser.displayName || currentUser.email || 'User') + ')';
                if (menuAccountSection) {
                    menuAccountSection.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                ${(currentUser.displayName || currentUser.email || '?')[0].toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${currentUser.displayName || 'User'}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${currentUser.email || ''}</div>
                            </div>
                        </div>
                        <a class="settings-link" onclick="signOut(); toggleSettingsMenu();" style="color: var(--accent-red);">
                            <span class="icon">üö™</span>
                            Sign Out
                        </a>
                    `;
                }
            } else {
                if (authMenuText) authMenuText.textContent = 'Sign in with Google';
                if (menuAccountSection) {
                    menuAccountSection.innerHTML = `
                        <a class="settings-link" onclick="signInWithGoogle(); toggleSettingsMenu();">
                            <span class="icon">üîê</span>
                            <span>Sign in with Google</span>
                        </a>
                        <p class="settings-desc">Save progress across devices</p>
                    `;
                }
            }
        }
        
        // ============ SETTINGS MENU ============
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        function handleAuthAction() {
            if (currentUser) {
                signOut();
            } else {
                signInWithGoogle();
            }
        }
        
        function setTheme(theme) {
            document.body.classList.remove('light-mode', 'dark-mode');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }
            document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
            document.getElementById('theme-light').classList.toggle('active', theme === 'light');
            appData.settings.theme = theme;
            saveData();
        }
        
        function toggleSound(enabled) {
            appData.settings.soundEnabled = enabled;
            saveData();
            showToast(enabled ? 'üîî Sound enabled' : 'üîï Sound disabled');
            if (enabled) playSound('toggle');
        }
        
        // ============ SOUND SYSTEM ============
        const SoundManager = {
            ctx: null,
            enabled: true,
            volume: 0.5,
            
            getContext() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.ctx;
            },
            
            // Sound definitions
            sounds: {
                achievement: { freq: [523, 659, 784], duration: 0.15, type: 'sine' },
                coin: { freq: [987, 1319], duration: 0.1, type: 'square' },
                success: { freq: [440, 554, 659], duration: 0.12, type: 'sine' },
                complete: { freq: [523, 659, 784, 1047], duration: 0.1, type: 'sine' },
                click: { freq: [800], duration: 0.05, type: 'sine' },
                toggle: { freq: [600, 800], duration: 0.08, type: 'sine' },
                error: { freq: [200, 150], duration: 0.2, type: 'sawtooth' },
                streak: { freq: [440, 550, 660, 880], duration: 0.12, type: 'sine' },
                levelup: { freq: [523, 659, 784, 1047, 1319], duration: 0.1, type: 'sine' }
            },
            
            play(soundId) {
                // Default to enabled if setting not set
                const soundEnabled = appData.settings?.soundEnabled !== false;
                if (!this.enabled || !soundEnabled) return;
                
                const sound = this.sounds[soundId];
                if (!sound) return;
                
                try {
                    const ctx = this.getContext();
                    if (ctx.state === 'suspended') ctx.resume();
                    
                    const now = ctx.currentTime;
                    
                    sound.freq.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.type = sound.type;
                        osc.frequency.value = freq;
                        
                        gain.gain.setValueAtTime(this.volume * 0.3, now + i * sound.duration);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + (i + 1) * sound.duration);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.start(now + i * sound.duration);
                        osc.stop(now + (i + 1) * sound.duration + 0.1);
                    });
                } catch (e) {
                    console.log('Sound error:', e);
                }
            }
        };
        
        function playSound(soundId) {
            SoundManager.play(soundId);
        }
        
        function resetDailyGoal() {
            const goal = prompt('Set your daily game goal (1-10):', appData.dailyGoal || 5);
            if (goal && !isNaN(goal)) {
                appData.dailyGoal = Math.min(10, Math.max(1, parseInt(goal)));
                saveData();
                renderProgress();
                showToast(`Daily goal set to ${appData.dailyGoal}`);
            }
        }
        
        function clearAllData() {
            if (confirm('Clear all local data? This cannot be undone.')) {
                localStorage.removeItem('gameshelf-pwa-data');
                appData = {
                    games: [...DEFAULT_SHELF.map(id => ({ id, addedAt: Date.now() }))],
                    stats: {},
                    history: {},
                    wallet: { tokens: 0, coins: 0 },
                    achievements: [],
                    dailyGoal: 5,
                    friends: [],
                    settings: {}
                };
                renderAll();
                showToast('Data cleared');
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gameshelf-backup-' + getTodayString() + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('üì§ Data exported');
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.games && importedData.history) {
                            appData = { ...appData, ...importedData };
                            saveData();
                            renderAll();
                            showToast('üì• Data imported successfully');
                        } else {
                            showToast('Invalid backup file', 'error');
                        }
                    } catch (err) {
                        showToast('Failed to import data', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function showAbout() {
            alert('üéÆ Game Shelf PWA\n\nTrack your daily puzzle games in one place.\n\nVersion: 0.4.9\n\n¬© 2026 Game Shelf');
        }
        
        // ============ MERCH STORE ============
        const MERCH_CATALOG = [
            // Virtual Rewards
            { id: 'frame-bronze', name: 'Bronze Profile Frame', category: 'virtual', image: 'ü•â', description: 'Sleek bronze frame', reward: true, earnedBy: 'Win any Brain Battle' },
            { id: 'frame-silver', name: 'Silver Profile Frame', category: 'virtual', image: 'ü•à', description: 'Polished silver frame', reward: true, earnedBy: 'Win 5 Brain Battles' },
            { id: 'frame-gold', name: 'Gold Profile Frame', category: 'virtual', image: 'ü•á', description: 'Prestigious gold frame', reward: true, earnedBy: 'Win a tournament' },
            { id: 'badge-champion', name: 'Champion Badge', category: 'virtual', image: 'üèÜ', description: 'Brain Battle Champion', reward: true, earnedBy: 'Top 3 in tournament' },
            { id: 'badge-streak', name: 'Streak Master Badge', category: 'virtual', image: 'üî•', description: 'Daily puzzle dedication', reward: true, earnedBy: '30-day streak' },
            { id: 'title-warrior', name: '"Brain Warrior" Title', category: 'virtual', image: '‚öîÔ∏è', description: 'Title under your name', reward: true, earnedBy: 'Win 10 Brain Battles' },
            // Physical Gifts
            { id: 'goody-15', name: '$15 Gift of Choice', category: 'physical', image: 'üéÅ', description: '50+ gifts: snacks, treats', price: 15 },
            { id: 'goody-30', name: '$30 Gift of Choice', category: 'physical', image: 'üéÅ', description: '100+ gifts: coffee, candles', price: 30, popular: true },
            { id: 'goody-50', name: '$50 Gift of Choice', category: 'physical', image: 'üéÅ', description: '150+ gifts: premium items', price: 50 },
            { id: 'goody-75', name: '$75 Gift of Choice', category: 'physical', image: 'üéÅ', description: '200+ gifts: tech, apparel', price: 75 },
            { id: 'goody-100', name: '$100 Gift of Choice', category: 'physical', image: 'üéÅ', description: '250+ gifts: luxury items', price: 100 }
        ];
        
        let currentMerchFilter = 'all';
        
        function showMerchStore() {
            document.getElementById('merch-balance').textContent = appData.wallet?.coins || 0;
            renderMerchCatalog();
            document.getElementById('merch-sheet').classList.add('active');
        }
        
        function closeMerchStore() {
            document.getElementById('merch-sheet').classList.remove('active');
        }
        
        function filterMerch(filter) {
            currentMerchFilter = filter;
            document.querySelectorAll('.merch-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(filter) || (filter === 'all' && tab.textContent === 'All'));
            });
            renderMerchCatalog();
        }
        
        function renderMerchCatalog() {
            const container = document.getElementById('merch-catalog');
            const coins = appData.wallet?.coins || 0;
            const owned = appData.ownedMerch || [];
            
            let items = MERCH_CATALOG;
            if (currentMerchFilter === 'virtual') {
                items = items.filter(i => i.category === 'virtual');
            } else if (currentMerchFilter === 'physical') {
                items = items.filter(i => i.category === 'physical');
            }
            
            const virtualItems = items.filter(i => i.category === 'virtual');
            const physicalItems = items.filter(i => i.category === 'physical');
            
            let html = '';
            
            if (virtualItems.length > 0 && currentMerchFilter !== 'physical') {
                html += `<div class="merch-section-header">üèÜ Rewards<br><span class="merch-earn-hint">Earned through battles & achievements</span></div>`;
                virtualItems.forEach(item => {
                    const isOwned = owned.includes(item.id);
                    html += `
                        <div class="merch-card ${isOwned ? 'owned' : ''}" onclick="showMerchDetails('${item.id}')">
                            <div class="merch-image">${item.image}</div>
                            <div class="merch-info">
                                <div class="merch-name">${item.name}</div>
                                <div class="merch-desc">${item.description}</div>
                                <div class="merch-footer">
                                    ${isOwned ? '<span class="merch-owned">‚úì Owned</span>' : `<span class="merch-earn-hint">${item.earnedBy}</span>`}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (physicalItems.length > 0 && currentMerchFilter !== 'virtual') {
                html += `<div class="merch-section-header">üéÅ Gift of Choice<br><span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted);">Redeem coins for real gifts via Goody</span></div>`;
                physicalItems.forEach(item => {
                    const canAfford = coins >= item.price;
                    html += `
                        <div class="merch-card ${canAfford ? '' : 'unaffordable'}" onclick="showMerchDetails('${item.id}')">
                            <div class="merch-image">${item.image}${item.popular ? '‚≠ê' : ''}</div>
                            <div class="merch-info">
                                <div class="merch-name">${item.name}</div>
                                <div class="merch-desc">${item.description}</div>
                                <div class="merch-footer">
                                    <span class="merch-price ${canAfford ? '' : 'too-expensive'}">ü™ô ${item.price}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html || '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 20px;">No items found</div>';
        }
        
        function showMerchDetails(itemId) {
            const item = MERCH_CATALOG.find(m => m.id === itemId);
            if (!item) return;
            
            const coins = appData.wallet?.coins || 0;
            const owned = (appData.ownedMerch || []).includes(itemId);
            
            if (item.category === 'virtual') {
                alert(`${item.image} ${item.name}\n\n${item.description}\n\n${owned ? '‚úì You own this!' : `Earn by: ${item.earnedBy}`}`);
            } else {
                if (owned) {
                    alert(`${item.image} ${item.name}\n\n‚úì Already redeemed!`);
                } else if (coins >= item.price) {
                    if (confirm(`${item.image} ${item.name}\n\n${item.description}\n\nRedeem for ü™ô ${item.price} coins?`)) {
                        redeemMerch(itemId);
                    }
                } else {
                    alert(`${item.image} ${item.name}\n\nYou need ü™ô ${item.price} coins\nYou have: ü™ô ${coins}`);
                }
            }
        }
        
        function redeemMerch(itemId) {
            const item = MERCH_CATALOG.find(m => m.id === itemId);
            if (!item || item.category !== 'physical') return;
            
            const coins = appData.wallet?.coins || 0;
            if (coins < item.price) {
                showToast('Not enough coins', 'error');
                return;
            }
            
            // Deduct coins
            appData.wallet.coins -= item.price;
            
            // Add to owned
            if (!appData.ownedMerch) appData.ownedMerch = [];
            appData.ownedMerch.push(itemId);
            
            saveData();
            renderWallet();
            document.getElementById('merch-balance').textContent = appData.wallet.coins;
            renderMerchCatalog();
            
            showToast(`üéÅ Redeemed ${item.name}!`);
            
            // In production, this would trigger Goody API
            alert(`üéâ Gift Redeemed!\n\n${item.name}\n\nYou'll receive an email from Goody to choose your gift.\n\n(Demo mode - no actual email sent)`);
        }
        
        // ============ UI RENDERING ============
        
        // ============ ACHIEVEMENTS ============
        const ACHIEVEMENTS = [
            { id: 'first-game', name: 'First Steps', icon: 'üë∂', desc: 'Log your first game', check: (d) => getTotalGamesPlayed(d) >= 1 },
            { id: 'streak-3', name: 'Hat Trick', icon: 'üé©', desc: '3-day streak', check: (d) => getMaxStreak(d) >= 3 },
            { id: 'streak-7', name: 'Week Warrior', icon: '‚öîÔ∏è', desc: '7-day streak', check: (d) => getMaxStreak(d) >= 7 },
            { id: 'streak-30', name: 'Monthly Master', icon: 'üëë', desc: '30-day streak', check: (d) => getMaxStreak(d) >= 30 },
            { id: 'games-5', name: 'Collector', icon: 'üìö', desc: 'Track 5 different games', check: (d) => Object.keys(d.games || {}).length >= 5 },
            { id: 'games-10', name: 'Enthusiast', icon: 'üéÆ', desc: 'Track 10 different games', check: (d) => Object.keys(d.games || {}).length >= 10 },
            { id: 'total-10', name: 'Getting Started', icon: 'üå±', desc: 'Complete 10 games total', check: (d) => getTotalGamesPlayed(d) >= 10 },
            { id: 'total-50', name: 'Dedicated', icon: 'üí™', desc: 'Complete 50 games total', check: (d) => getTotalGamesPlayed(d) >= 50 },
            { id: 'total-100', name: 'Centurion', icon: 'üèõÔ∏è', desc: 'Complete 100 games total', check: (d) => getTotalGamesPlayed(d) >= 100 },
            { id: 'early-bird', name: 'Early Bird', icon: 'üê¶', desc: 'Log a game before 7 AM', check: (d) => d.achievements?.['early-bird'] },
            { id: 'night-owl', name: 'Night Owl', icon: 'ü¶â', desc: 'Log a game after 11 PM', check: (d) => d.achievements?.['night-owl'] },
            { id: 'social', name: 'Social Butterfly', icon: 'ü¶ã', desc: 'Share your results', check: (d) => d.achievements?.['social'] },
            { id: 'cloud-sync', name: 'Cloud Gamer', icon: '‚òÅÔ∏è', desc: 'Sign in and sync', check: (d) => d.achievements?.['cloud-sync'] },
            { id: 'battle-join', name: 'Challenger', icon: '‚öîÔ∏è', desc: 'Join a Brain Battle', check: (d) => d.achievements?.['battle-join'] },
        ];
        
        function getTotalGamesPlayed(data) {
            let total = 0;
            Object.values(data.stats || {}).forEach(stat => {
                total += stat.gamesPlayed || 0;
            });
            return total;
        }
        
        function getMaxStreak(data) {
            let maxStreak = 0;
            Object.values(data.stats || {}).forEach(stat => {
                if ((stat.currentStreak || 0) > maxStreak) maxStreak = stat.currentStreak;
                if ((stat.maxStreak || 0) > maxStreak) maxStreak = stat.maxStreak;
            });
            return maxStreak;
        }
        
        function checkTimeAchievements() {
            const hour = new Date().getHours();
            if (hour < 7 && !appData.achievements?.['early-bird']) {
                unlockAchievement('early-bird');
            }
            if (hour >= 23 && !appData.achievements?.['night-owl']) {
                unlockAchievement('night-owl');
            }
        }
        
        function unlockAchievement(id) {
            if (!appData.achievements) appData.achievements = {};
            if (appData.achievements[id]) return; // Already unlocked
            
            appData.achievements[id] = getTodayString();
            const achievement = ACHIEVEMENTS.find(a => a.id === id);
            if (achievement) {
                playSound('achievement');
                showToast(`üèÜ ${achievement.icon} ${achievement.name} unlocked!`);
                
                // Award coins
                const coins = getAchievementCoins(id);
                if (coins > 0) {
                    appData.wallet.coins = (appData.wallet?.coins || 0) + coins;
                    setTimeout(() => showToast(`+${coins} coins!`), 1000);
                }
            }
            saveData();
            renderAchievements();
        }
        
        function getAchievementCoins(id) {
            const hard = ['streak-30', 'total-100'];
            const medium = ['streak-7', 'total-50', 'games-10', 'early-bird', 'night-owl'];
            if (hard.includes(id)) return 50;
            if (medium.includes(id)) return 20;
            return 10;
        }
        
        function checkAndUnlockAchievements() {
            if (!appData.achievements) appData.achievements = {};
            
            let newUnlocks = [];
            
            ACHIEVEMENTS.forEach(achievement => {
                if (!appData.achievements[achievement.id] && achievement.check(appData)) {
                    appData.achievements[achievement.id] = getTodayString();
                    newUnlocks.push(achievement);
                }
            });
            
            if (newUnlocks.length > 0) {
                saveData();
                renderAchievements();
                
                newUnlocks.forEach((a, i) => {
                    setTimeout(() => {
                        showToast(`üèÜ ${a.icon} ${a.name} unlocked!`);
                        const coins = getAchievementCoins(a.id);
                        if (coins > 0) {
                            appData.wallet.coins = (appData.wallet?.coins || 0) + coins;
                            renderWallet();
                        }
                    }, i * 1500);
                });
            }
        }
        
        function showAchievements() {
            renderAchievements();
            document.getElementById('achievements-sheet').classList.add('active');
        }
        
        function closeAchievements() {
            document.getElementById('achievements-sheet').classList.remove('active');
        }
        
        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const countEl = document.getElementById('achievements-count');
            const fillEl = document.getElementById('achievements-fill');
            
            if (!grid) return;
            
            let unlockedCount = 0;
            
            grid.innerHTML = ACHIEVEMENTS.map(achievement => {
                const isUnlocked = appData.achievements && appData.achievements[achievement.id];
                if (isUnlocked) unlockedCount++;
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <span class="achievement-icon">${achievement.icon}</span>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${isUnlocked ? '‚úì Unlocked' : achievement.desc}</div>
                    </div>
                `;
            }).join('');
            
            const percentage = (unlockedCount / ACHIEVEMENTS.length) * 100;
            if (fillEl) fillEl.style.width = percentage + '%';
            if (countEl) countEl.textContent = `${unlockedCount}/${ACHIEVEMENTS.length}`;
        }
        
        // ============ BATTLES ============
        let userBattles = [];
        let currentBattleId = null;
        
        function showCreateBattle() {
            if (!currentUser) {
                showToast('Sign in to create battles', 'error');
                return;
            }
            document.getElementById('battle-name-input').value = '';
            document.getElementById('create-battle-sheet').classList.add('active');
        }
        
        function closeCreateBattle() {
            document.getElementById('create-battle-sheet').classList.remove('active');
        }
        
        function showJoinBattle() {
            if (!currentUser) {
                showToast('Sign in to join battles', 'error');
                return;
            }
            document.getElementById('join-code-input').value = '';
            document.getElementById('join-battle-preview').style.display = 'none';
            document.getElementById('join-battle-error').style.display = 'none';
            document.getElementById('join-battle-sheet').classList.add('active');
        }
        
        function closeJoinBattle() {
            document.getElementById('join-battle-sheet').classList.remove('active');
        }
        
        function toggleBattleGame(el) {
            el.classList.toggle('selected');
        }
        
        function generateBattleCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        async function createBattle() {
            if (!currentUser) return;
            
            const name = document.getElementById('battle-name-input').value.trim() || 'Brain Battle';
            const duration = parseInt(document.getElementById('battle-duration').value);
            const entryFee = parseInt(document.getElementById('battle-entry-fee').value);
            
            const selectedGames = [];
            document.querySelectorAll('.battle-game-chip.selected').forEach(chip => {
                selectedGames.push(chip.dataset.game);
            });
            
            if (selectedGames.length === 0) {
                showToast('Select at least one game', 'error');
                return;
            }
            
            // Check if user has enough coins for entry fee
            const coins = appData.wallet?.coins || 0;
            if (entryFee > 0 && coins < entryFee) {
                showToast(`Need ${entryFee} coins to create`, 'error');
                return;
            }
            
            const battleId = 'battle_' + Date.now();
            const joinCode = generateBattleCode();
            const now = Date.now();
            
            const battle = {
                id: battleId,
                name: name,
                type: 'challenge',
                status: 'pending',
                games: selectedGames,
                createdBy: currentUser.uid,
                createdAt: now,
                startDate: now,
                endDate: now + (duration * 24 * 60 * 60 * 1000),
                entryFee: entryFee,
                joinCode: joinCode,
                participants: {
                    [currentUser.uid]: {
                        odataId: currentUser.uid,
                        displayName: currentUser.displayName || 'Player',
                        score: 0,
                        joinedAt: now
                    }
                }
            };
            
            try {
                await db.ref(`battles/${battleId}`).set(battle);
                
                // Deduct entry fee
                if (entryFee > 0) {
                    appData.wallet.coins -= entryFee;
                    saveData();
                    renderWallet();
                }
                
                closeCreateBattle();
                showToast('Battle created! Share code: ' + joinCode);
                
                // Unlock battle achievement
                if (!appData.achievements) appData.achievements = {};
                if (!appData.achievements['battle-join']) {
                    unlockAchievement('battle-join');
                }
                
                // Show the battle details with share code
                loadUserBattles();
                setTimeout(() => showBattleDetails(battleId), 500);
                
            } catch (e) {
                console.error('Error creating battle:', e);
                showToast('Error creating battle', 'error');
            }
        }
        
        async function lookupBattleCode() {
            const code = document.getElementById('join-code-input').value.toUpperCase().trim();
            if (code.length !== 6) {
                document.getElementById('join-battle-error').textContent = 'Enter a 6-character code';
                document.getElementById('join-battle-error').style.display = 'block';
                return;
            }
            
            try {
                const snapshot = await db.ref('battles').orderByChild('joinCode').equalTo(code).once('value');
                const battles = snapshot.val();
                
                if (!battles) {
                    document.getElementById('join-battle-error').textContent = 'Battle not found';
                    document.getElementById('join-battle-error').style.display = 'block';
                    document.getElementById('join-battle-preview').style.display = 'none';
                    return;
                }
                
                const battleId = Object.keys(battles)[0];
                const battle = battles[battleId];
                
                if (battle.status !== 'pending') {
                    document.getElementById('join-battle-error').textContent = 'Battle has already started';
                    document.getElementById('join-battle-error').style.display = 'block';
                    return;
                }
                
                if (battle.participants && battle.participants[currentUser.uid]) {
                    document.getElementById('join-battle-error').textContent = 'You\'re already in this battle';
                    document.getElementById('join-battle-error').style.display = 'block';
                    return;
                }
                
                // Show preview
                document.getElementById('join-battle-error').style.display = 'none';
                document.getElementById('join-battle-name').textContent = battle.name;
                document.getElementById('join-battle-info').textContent = `${battle.games.length} games ‚Ä¢ ${battle.entryFee > 0 ? 'ü™ô ' + battle.entryFee + ' entry' : 'Free entry'}`;
                document.getElementById('join-battle-preview').style.display = 'block';
                document.getElementById('join-battle-preview').dataset.battleId = battleId;
                
                // Change button to Join
                const btn = document.querySelector('#join-battle-sheet .share-close-btn');
                btn.textContent = 'Join Battle';
                btn.onclick = () => joinBattle(battleId, battle);
                
            } catch (e) {
                console.error('Error looking up battle:', e);
                document.getElementById('join-battle-error').textContent = 'Error finding battle';
                document.getElementById('join-battle-error').style.display = 'block';
            }
        }
        
        async function joinBattle(battleId, battle) {
            if (!currentUser) return;
            
            const entryFee = battle.entryFee || 0;
            const coins = appData.wallet?.coins || 0;
            
            if (entryFee > 0 && coins < entryFee) {
                showToast(`Need ${entryFee} coins to join`, 'error');
                return;
            }
            
            try {
                // Add participant
                await db.ref(`battles/${battleId}/participants/${currentUser.uid}`).set({
                    odataId: currentUser.uid,
                    displayName: currentUser.displayName || 'Player',
                    score: 0,
                    joinedAt: Date.now()
                });
                
                // Start the battle
                await db.ref(`battles/${battleId}/status`).set('active');
                
                // Deduct entry fee
                if (entryFee > 0) {
                    appData.wallet.coins -= entryFee;
                    saveData();
                    renderWallet();
                }
                
                closeJoinBattle();
                showToast('Joined battle!');
                loadUserBattles();
                
                // Unlock battle achievement
                if (!appData.achievements) appData.achievements = {};
                if (!appData.achievements['battle-join']) {
                    unlockAchievement('battle-join');
                }
                
            } catch (e) {
                console.error('Error joining battle:', e);
                showToast('Error joining battle', 'error');
            }
        }
        
        async function loadUserBattles() {
            if (!currentUser) {
                userBattles = [];
                renderBattles();
                return;
            }
            
            try {
                const snapshot = await db.ref('battles').once('value');
                const allBattles = snapshot.val() || {};
                
                userBattles = Object.values(allBattles).filter(b => 
                    b.participants && b.participants[currentUser.uid]
                );
                
                // Check for completed battles
                const now = Date.now();
                userBattles.forEach(battle => {
                    if (battle.status === 'active' && battle.endDate < now) {
                        completeBattle(battle);
                    }
                });
                
                renderBattles();
                updateHomeBattleWidget();
                
            } catch (e) {
                console.error('Error loading battles:', e);
            }
        }
        
        async function completeBattle(battle) {
            if (battle.status === 'completed') return;
            
            const participants = Object.entries(battle.participants || {})
                .map(([uid, data]) => ({ odataId: uid, ...data }))
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            const winner = participants[0];
            const prizePool = (battle.entryFee || 0) * participants.length;
            
            try {
                await db.ref(`battles/${battle.id}`).update({
                    status: 'completed',
                    completedAt: Date.now(),
                    winner: winner ? {
                        odataId: winner.odataId,
                        displayName: winner.displayName,
                        score: winner.score
                    } : null,
                    prizePool: prizePool
                });
                
                // Award prize if current user won
                if (prizePool > 0 && winner?.odataId === currentUser?.uid) {
                    appData.wallet.coins = (appData.wallet?.coins || 0) + prizePool;
                    saveData();
                    renderWallet();
                    showToast(`üèÜ You won ${prizePool} coins!`);
                }
                
            } catch (e) {
                console.error('Error completing battle:', e);
            }
        }
        
        function renderBattles() {
            const container = document.getElementById('battles-list');
            if (!container) return;
            
            const activeBattles = userBattles.filter(b => b.status === 'active');
            const pendingBattles = userBattles.filter(b => b.status === 'pending' && b.createdBy === currentUser?.uid);
            const pastBattles = userBattles.filter(b => b.status === 'completed').slice(0, 5);
            
            if (activeBattles.length === 0 && pendingBattles.length === 0 && pastBattles.length === 0) {
                container.innerHTML = `
                    <div class="battle-empty">
                        <div class="empty-icon">‚öîÔ∏è</div>
                        <p>No battles yet</p>
                        <p style="font-size: 0.85rem; margin-top: 5px;">Create a battle or join one with a code!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Pending battles
            pendingBattles.forEach(battle => {
                html += renderBattleCard(battle, 'pending');
            });
            
            // Active battles
            activeBattles.forEach(battle => {
                html += renderBattleCard(battle, 'active');
            });
            
            // Past battles
            if (pastBattles.length > 0) {
                html += '<div style="font-size: 0.85rem; color: var(--text-muted); margin: 15px 0 10px;">Past Battles</div>';
                pastBattles.forEach(battle => {
                    html += renderBattleCard(battle, 'completed');
                });
            }
            
            container.innerHTML = html;
        }
        
        function renderBattleCard(battle, status) {
            const participants = Object.values(battle.participants || {}).sort((a, b) => (b.score || 0) - (a.score || 0));
            const daysLeft = Math.max(0, Math.ceil((battle.endDate - Date.now()) / 86400000));
            
            let badge = '';
            let headerStyle = 'background: linear-gradient(135deg, #667eea, #764ba2);';
            
            if (status === 'pending') {
                badge = '<span class="battle-badge" style="background: #ff9800;">PENDING</span>';
                headerStyle = 'background: linear-gradient(135deg, #ff9800, #f57c00);';
            } else if (status === 'active') {
                badge = '<span class="battle-badge live">LIVE</span>';
            } else {
                badge = '<span class="battle-badge">ENDED</span>';
                headerStyle = 'background: var(--bg-tertiary);';
            }
            
            const topPlayers = participants.slice(0, 3).map((p, i) => `
                <div class="battle-leaderboard-row">
                    <div class="battle-rank">${['ü•á', 'ü•à', 'ü•â'][i]}</div>
                    <div class="battle-participant-avatar" style="background: ${getAvatarColor(p.displayName)}">${(p.displayName || 'U')[0]}</div>
                    <div class="battle-participant-name">${p.displayName || 'Unknown'}${p.odataId === currentUser?.uid ? ' (You)' : ''}</div>
                    <div class="battle-participant-score">${p.score || 0}</div>
                </div>
            `).join('');
            
            return `
                <div class="battle-card" onclick="showBattleDetails('${battle.id}')">
                    <div class="battle-card-header" style="${headerStyle}">
                        ‚öîÔ∏è ${badge}
                    </div>
                    <div class="battle-card-content">
                        <div class="battle-card-title">${battle.name}</div>
                        <div class="battle-stats">
                            <span>üéÆ ${battle.games?.join(', ') || '-'}</span>
                            <span>‚è±Ô∏è ${status === 'completed' ? 'Ended' : daysLeft + 'd left'}</span>
                            ${battle.entryFee > 0 ? `<span>ü™ô ${battle.entryFee * participants.length}</span>` : ''}
                        </div>
                        <div class="battle-leaderboard">${topPlayers}</div>
                    </div>
                </div>
            `;
        }
        
        function showBattleDetails(battleId) {
            const battle = userBattles.find(b => b.id === battleId);
            if (!battle) return;
            
            currentBattleId = battleId;
            
            const participants = Object.values(battle.participants || {}).sort((a, b) => (b.score || 0) - (a.score || 0));
            const daysLeft = Math.max(0, Math.ceil((battle.endDate - Date.now()) / 86400000));
            const prizePool = (battle.entryFee || 0) * participants.length;
            
            document.getElementById('battle-details-title').textContent = `‚öîÔ∏è ${battle.name}`;
            document.getElementById('battle-games-display').textContent = battle.games?.join(', ') || '-';
            document.getElementById('battle-time-display').textContent = battle.status === 'completed' ? 'Ended' : `${daysLeft} days`;
            
            if (prizePool > 0) {
                document.getElementById('battle-prize-display').style.display = 'block';
                document.getElementById('battle-prize-amount').textContent = `ü™ô ${prizePool}`;
            } else {
                document.getElementById('battle-prize-display').style.display = 'none';
            }
            
            // Status banner
            const banner = document.getElementById('battle-status-banner');
            if (battle.status === 'completed') {
                const winner = participants[0];
                const isWinner = winner?.odataId === currentUser?.uid;
                banner.style.background = isWinner ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'var(--bg-tertiary)';
                banner.style.color = isWinner ? '#000' : 'var(--text-primary)';
                banner.textContent = isWinner ? 'üèÜ YOU WON!' : `üèÜ Winner: ${winner?.displayName || 'Unknown'}`;
            } else if (battle.status === 'pending') {
                banner.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                banner.style.color = '#fff';
                banner.textContent = '‚è≥ Waiting for opponent...';
            } else {
                banner.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                banner.style.color = '#fff';
                banner.textContent = `üî¥ LIVE ‚Ä¢ ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left`;
            }
            
            // Share code (for pending battles)
            const shareCodeEl = document.getElementById('battle-share-code');
            if (battle.status === 'pending' && battle.joinCode) {
                shareCodeEl.style.display = 'block';
                document.getElementById('battle-code-display').textContent = battle.joinCode;
            } else {
                shareCodeEl.style.display = 'none';
            }
            
            // Leaderboard
            document.getElementById('battle-leaderboard-display').innerHTML = participants.map((p, i) => `
                <div class="battle-leaderboard-row" style="${p.odataId === currentUser?.uid ? 'background: rgba(102, 126, 234, 0.1);' : ''}">
                    <div class="battle-rank">${i < 3 ? ['ü•á', 'ü•à', 'ü•â'][i] : (i + 1)}</div>
                    <div class="battle-participant-avatar" style="background: ${getAvatarColor(p.displayName)}">${(p.displayName || 'U')[0]}</div>
                    <div class="battle-participant-name">${p.displayName || 'Unknown'}${p.odataId === currentUser?.uid ? ' (You)' : ''}</div>
                    <div class="battle-participant-score">${p.score || 0}</div>
                </div>
            `).join('') || '<div style="color: var(--text-muted); text-align: center;">No participants yet</div>';
            
            document.getElementById('battle-details-sheet').classList.add('active');
        }
        
        function closeBattleDetails() {
            document.getElementById('battle-details-sheet').classList.remove('active');
            currentBattleId = null;
        }
        
        function copyBattleCode() {
            const code = document.getElementById('battle-code-display').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied!');
            });
        }
        
        function updateHomeBattleWidget() {
            const widget = document.getElementById('battle-widget');
            const activeBattle = userBattles.find(b => b.status === 'active');
            
            if (!activeBattle) {
                widget.style.display = 'none';
                return;
            }
            
            widget.style.display = 'block';
            
            const daysLeft = Math.max(0, Math.ceil((activeBattle.endDate - Date.now()) / 86400000));
            document.getElementById('battle-time-left').textContent = `${daysLeft}d`;
            document.getElementById('battle-name').textContent = activeBattle.name;
            
            const participants = Object.values(activeBattle.participants || {}).sort((a, b) => (b.score || 0) - (a.score || 0));
            document.getElementById('battle-standings').innerHTML = participants.slice(0, 3).map((p, i) => `
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; padding: 4px 0;">
                    <span>${['ü•á', 'ü•à', 'ü•â'][i]} ${p.displayName || 'Unknown'}${p.odataId === currentUser?.uid ? ' (You)' : ''}</span>
                    <span style="color: var(--accent-green);">${p.score || 0}</span>
                </div>
            `).join('');
        }
        
        // Update battle score when logging a game
        async function updateBattleScore(gameId, score) {
            if (!currentUser) return;
            
            const today = getTodayString();
            
            for (const battle of userBattles) {
                if (battle.status !== 'active') continue;
                if (!battle.games?.includes(gameId)) continue;
                
                try {
                    // Add daily score
                    await db.ref(`battles/${battle.id}/participants/${currentUser.uid}/dailyScores/${today}_${gameId}`).set(score);
                    
                    // Update total score
                    const participant = battle.participants[currentUser.uid];
                    const newTotal = (participant?.score || 0) + score;
                    await db.ref(`battles/${battle.id}/participants/${currentUser.uid}/score`).set(newTotal);
                    
                } catch (e) {
                    console.error('Error updating battle score:', e);
                }
            }
            
            loadUserBattles();
        }
        
        function getAvatarColor(name) {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#43e97b', '#fa709a', '#fee140'];
            const index = (name || 'U').charCodeAt(0) % colors.length;
            return colors[index];
        }
        function renderAll() {
            renderWallet();
            renderQuickGames();
            renderProgress();
            renderHomeGames();
            renderShelfGames();
            renderPopularGames();
            renderLeaderboard();
            renderFriendsWidget();
        }
        
        function renderWallet() {
            document.getElementById('token-count').textContent = appData.wallet.tokens || 0;
            document.getElementById('coin-count').textContent = appData.wallet.coins || 0;
        }
        
        function renderQuickGames() {
            const container = document.getElementById('quick-games');
            const shelf = appData.games.slice(0, 6);
            const todayHistory = getTodayHistory();
            
            container.innerHTML = shelf.map(g => {
                const game = GAMES[g.id];
                if (!game) return '';
                const done = todayHistory[g.id];
                return `<button class="quick-game-btn ${done ? 'done' : ''}" 
                    onclick="${done ? `showToast('${game.name} already logged!')` : 'openLogSheet()'}"
                    title="${game.name}">${game.icon}</button>`;
            }).join('');
        }
        
        function renderProgress() {
            const played = getGamesPlayedToday();
            const goal = appData.dailyGoal || 5;
            const pct = Math.min(100, (played / goal) * 100);
            const maxStreak = getMaxStreak();
            
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('goal-display').textContent = `${played}/${goal} games`;
            document.getElementById('streak-badge').textContent = `üî• ${maxStreak}`;
            
            if (played === 0) {
                document.getElementById('games-today-text').textContent = 'Play your first game!';
            } else if (played >= goal) {
                document.getElementById('games-today-text').textContent = 'üéâ Goal reached!';
            } else {
                document.getElementById('games-today-text').textContent = `${goal - played} more to go`;
            }
        }
        
        function renderHomeGames() {
            console.log('renderHomeGames called');
            const container = document.getElementById('home-games-grid');
            console.log('container:', container);
            const shelf = appData.games.slice(0, 6);
            console.log('shelf:', shelf);
            const todayHistory = getTodayHistory();
            
            const html = shelf.map(g => {
                const game = GAMES[g.id];
                console.log('Game:', g.id, game);
                if (!game) return '';
                const done = todayHistory[g.id];
                const stats = appData.stats[g.id];
                const streak = stats?.currentStreak || 0;
                
                let status = streak > 0 ? `üî• ${streak}` : 'Play';
                if (done) status = `‚úì ${done.score}`;
                
                return `<div class="game-card ${done ? 'done' : ''}" onclick="playGame('${g.id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">${status}</div>
                </div>`;
            }).join('');
            
            console.log('Generated HTML length:', html.length);
            container.innerHTML = html;
            console.log('Container innerHTML set');
        }
        
        function renderShelfGames() {
            const container = document.getElementById('shelf-games-grid');
            const todayHistory = getTodayHistory();
            
            container.innerHTML = appData.games.map(g => {
                const game = GAMES[g.id];
                if (!game) return '';
                const done = todayHistory[g.id];
                const stats = appData.stats[g.id];
                const streak = stats?.currentStreak || 0;
                
                let status = streak > 0 ? `üî• ${streak}` : 'Play';
                if (done) status = `‚úì ${done.score}`;
                
                return `<div class="game-card ${done ? 'done' : ''}" onclick="playGame('${g.id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">${status}</div>
                </div>`;
            }).join('');
        }
        
        function renderPopularGames() {
            const container = document.getElementById('popular-games-grid');
            const onShelf = new Set(appData.games.map(g => g.id));
            
            container.innerHTML = POPULAR_GAMES.filter(id => !onShelf.has(id)).map(id => {
                const game = GAMES[id];
                if (!game) return '';
                return `<div class="game-card" onclick="addToShelf('${id}')">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-status">+ Add</div>
                </div>`;
            }).join('');
        }
        
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            
            // Mock leaderboard for now
            const leaderboard = [
                { name: 'You', streak: getMaxStreak(), score: getGamesPlayedToday() * 10, isYou: true },
            ];
            
            if (leaderboard.length === 0 || (leaderboard.length === 1 && leaderboard[0].score === 0)) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-icon">üèÜ</div>
                    <div class="empty-title">Play games to rank!</div>
                    <div class="empty-desc">Your daily scores appear here</div>
                </div>`;
                return;
            }
            
            container.innerHTML = leaderboard.map((p, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `<div class="leaderboard-item">
                    <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${p.name}${p.isYou ? ' (You)' : ''}</div>
                        <div class="leaderboard-streak">üî• ${p.streak} streak</div>
                    </div>
                    <div class="leaderboard-score">${p.score} pts</div>
                </div>`;
            }).join('');
        }
        
        function renderFriendsWidget() {
            const container = document.getElementById('friends-row');
            
            if (!currentUser || appData.friends.length === 0) {
                container.innerHTML = `<div style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">
                    ${currentUser ? 'Add friends to see their progress' : 'Sign in to see friends'}
                </div>`;
                return;
            }
            
            // Mock friends for now
            container.innerHTML = `<div style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">
                Friends feature coming soon!
            </div>`;
        }
        
        // ============ INTERACTIONS ============
        function playGame(gameId) {
            const game = GAMES[gameId];
            if (!game) return;
            
            const todayHistory = getTodayHistory();
            if (todayHistory[gameId]) {
                showToast(`${game.name} already logged today!`);
                return;
            }
            
            // Open game URL
            if (game.url.startsWith('http')) {
                window.open(game.url, '_blank');
            } else {
                window.location.href = game.url;
            }
        }
        
        function addToShelf(gameId) {
            if (appData.games.find(g => g.id === gameId)) {
                showToast('Already on your shelf!');
                return;
            }
            
            appData.games.push({ id: gameId, addedAt: new Date().toISOString() });
            saveData();
            syncToCloud();
            renderAll();
            showToast(`${GAMES[gameId].name} added!`, 'success');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + tab).classList.add('active');
        }
        
        // ============ LOG SHEET ============
        function openLogSheet() {
            document.getElementById('log-sheet').classList.add('active');
            document.getElementById('log-input').focus();
        }
        
        function closeLogSheet(e) {
            if (e && e.target.id !== 'log-sheet') return;
            document.getElementById('log-sheet').classList.remove('active');
            document.getElementById('log-input').value = '';
            document.getElementById('parse-preview').classList.remove('visible');
        }
        
        function parseLogInput() {
            const input = document.getElementById('log-input').value;
            const result = parseShareText(input);
            const preview = document.getElementById('parse-preview');
            
            if (result) {
                const game = GAMES[result.gameId];
                document.getElementById('parse-game-name').textContent = `${game?.icon || 'üéÆ'} ${game?.name || result.gameId}`;
                document.getElementById('parse-score').textContent = `Score: ${result.score}`;
                preview.classList.add('visible');
            } else {
                preview.classList.remove('visible');
            }
        }
        
        function submitLog() {
            const input = document.getElementById('log-input').value;
            const result = parseShareText(input);
            
            if (!result) {
                showToast('Could not detect game. Try pasting share text.', 'error');
                return;
            }
            
            const game = GAMES[result.gameId];
            const todayHistory = getTodayHistory();
            
            if (todayHistory[result.gameId]) {
                showToast(`${game?.name || result.gameId} already logged today!`);
                closeLogSheet({ target: { id: 'log-sheet' } });
                return;
            }
            
            if (logGame(result)) {
                closeLogSheet({ target: { id: 'log-sheet' } });
                renderAll();
                showSuccessModal(game, result);
            }
        }
        
        // ============ CLIPBOARD DETECTION ============
        async function checkClipboard() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) return;
                
                const text = await navigator.clipboard.readText();
                const result = parseShareText(text);
                
                if (result) {
                    const todayHistory = getTodayHistory();
                    if (todayHistory[result.gameId]) return; // Already logged
                    
                    const game = GAMES[result.gameId];
                    detectedClipboard = { text, result };
                    
                    showClipboardPrompt(game, result);
                }
            } catch (e) {
                // Clipboard access denied - that's fine
                console.log('Clipboard check:', e.message);
            }
        }
        
        function acceptClipboard() {
            if (detectedClipboard) {
                if (logGame(detectedClipboard.result)) {
                    const game = GAMES[detectedClipboard.result.gameId];
                    renderAll();
                    showToast(`${game?.icon || 'üéÆ'} Logged!`, 'success');
                }
            }
            dismissClipboard();
        }
        
        function dismissClipboard() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt) {
                prompt.style.display = 'none';
                prompt.classList.remove('visible');
            }
            detectedClipboard = null;
        }
        
        function showClipboardPrompt(game, result) {
            const prompt = document.getElementById('clipboard-prompt');
            if (!prompt) return;
            
            document.getElementById('prompt-icon').textContent = game?.icon || 'üéÆ';
            document.getElementById('prompt-text').textContent = `Log ${game?.name || result.gameId} ${result.score}?`;
            
            prompt.style.display = 'flex';
            // Small delay to trigger CSS transition
            setTimeout(() => prompt.classList.add('visible'), 10);
            
            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                if (prompt.classList.contains('visible')) {
                    dismissClipboard();
                }
            }, 8000);
        }
        
        // ============ SUCCESS MODAL ============
        function showSuccessModal(game, result) {
            const modal = document.getElementById('success-modal');
            const stats = appData.stats[result.gameId] || {};
            const streak = stats.currentStreak || 1;
            
            // Play success sound
            playSound('complete');
            
            // Determine celebration emoji based on score
            let celebration = 'üéâ';
            if (result.score?.includes('1/') || result.score === 'Perfect! üéØ' || result.score === 'Queen Bee! üëë') {
                celebration = 'üèÜ';
                playSound('achievement'); // Extra sound for perfect scores
            } else if (result.score?.includes('2/') || result.score === 'No hints!' || result.score === 'Genius!') {
                celebration = 'üåü';
            }
            
            document.getElementById('success-celebration').textContent = celebration;
            document.getElementById('success-icon').textContent = game?.icon || 'üéÆ';
            document.getElementById('success-game').textContent = game?.name || result.gameId;
            document.getElementById('success-score').textContent = result.score;
            document.getElementById('success-points').textContent = `+${result.numericScore || 15} pts`;
            
            if (streak > 1) {
                document.getElementById('success-streak').textContent = `üî• ${streak} day streak!`;
                document.getElementById('success-streak').style.display = 'block';
                if (streak % 7 === 0) playSound('streak'); // Milestone streaks
            } else {
                document.getElementById('success-streak').style.display = 'none';
            }
            
            modal.classList.add('active');
            
            // Auto-dismiss after 4 seconds
            setTimeout(() => {
                if (modal.classList.contains('active')) {
                    closeSuccessModal();
                }
            }, 4000);
        }
        
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.remove('active');
        }
        
        // ============ SHARE HUB ============
        function showShareHub() {
            console.log('showShareHub called');
            alert('Share Hub clicked!'); // Temporary debug
            populateShareHubResults();
            applyShareTemplate();
            
            const today = new Date();
            document.getElementById('share-hub-date').textContent = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            const sheet = document.getElementById('share-hub-sheet');
            console.log('share-hub-sheet element:', sheet);
            sheet.classList.add('active');
            console.log('active class added');
        }
        
        function closeShareHub() {
            document.getElementById('share-hub-sheet').classList.remove('active');
        }
        
        function populateShareHubResults() {
            const container = document.getElementById('share-hub-results');
            const todayHistory = getTodayHistory();
            
            const results = [];
            
            // Check all games in shelf and catalog
            for (const gameId of Object.keys(todayHistory)) {
                const game = GAMES[gameId];
                if (game) {
                    results.push({
                        name: game.name,
                        icon: game.icon,
                        score: todayHistory[gameId].score || '‚úì'
                    });
                }
            }
            
            if (results.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted);">No games logged today yet</span>';
            } else {
                container.innerHTML = results.map(r => `
                    <span class="share-result-tag">${r.icon} ${r.name}: <span class="score">${r.score}</span></span>
                `).join('');
            }
        }
        
        function applyShareTemplate() {
            const template = document.getElementById('share-template-select').value;
            const todayHistory = getTodayHistory();
            
            let gamesPlayed = 0;
            let gamesList = [];
            
            for (const gameId of Object.keys(todayHistory)) {
                const game = GAMES[gameId];
                if (game) {
                    gamesPlayed++;
                    gamesList.push(`${game.icon} ${todayHistory[gameId].score || '‚úì'}`);
                }
            }
            
            const maxStreak = getMaxStreak();
            let message = '';
            
            switch(template) {
                case 'brag':
                    message = `üèÜ Crushed it today!\n\n${gamesList.join('\n')}\n\n${gamesPlayed} games completed. Who else is keeping up? üí™`;
                    break;
                case 'humble':
                    message = `Just another day of puzzles üòÖ\n\n${gamesList.join('\n')}\n\nSome wins, some struggles. That's the game!`;
                    break;
                case 'streak':
                    message = `üî• ${maxStreak} day streak!\n\n${gamesList.join('\n')}\n\nKeeping the daily puzzle habit going strong!`;
                    break;
                case 'challenge':
                    message = `‚öîÔ∏è Daily puzzle challenge!\n\n${gamesList.join('\n')}\n\nThink you can beat my scores? Let's see what you got!`;
                    break;
                case 'minimal':
                    message = gamesList.join(' | ');
                    break;
                default:
                    message = `üéÆ Daily Puzzles Complete!\n\n${gamesList.join('\n')}\n\n${gamesPlayed > 0 ? `${gamesPlayed} game${gamesPlayed > 1 ? 's' : ''} down for today!` : 'Time to play some puzzles!'}`;
            }
            
            document.getElementById('share-message').value = message;
        }
        
        function insertShareEmoji(emoji) {
            const textarea = document.getElementById('share-message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
        }
        
        function getShareMessage() {
            return document.getElementById('share-message').value;
        }
        
        function shareToTwitter() {
            const message = getShareMessage();
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening Twitter...');
            unlockSocialAchievement();
        }
        
        function shareToFacebook() {
            copyShareMessage(true);
            const url = `https://www.facebook.com/`;
            window.open(url, '_blank');
            showToast('üìã Copied! Paste in Facebook');
            unlockSocialAchievement();
        }
        
        function shareToLinkedIn() {
            copyShareMessage(true);
            const url = `https://www.linkedin.com/`;
            window.open(url, '_blank');
            showToast('üìã Copied! Paste in LinkedIn');
            unlockSocialAchievement();
        }
        
        function shareToThreads() {
            const message = getShareMessage();
            const url = `https://www.threads.net/intent/post?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening Threads...');
            unlockSocialAchievement();
        }
        
        function shareToReddit() {
            const message = getShareMessage();
            const url = `https://www.reddit.com/submit?title=${encodeURIComponent('üéÆ Daily Puzzle Results')}&text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening Reddit...');
            unlockSocialAchievement();
        }
        
        function shareToDiscord() {
            copyShareMessage();
            showToast('üìã Copied! Paste in Discord');
            unlockSocialAchievement();
        }
        
        function shareToBlueSky() {
            const message = getShareMessage();
            const url = `https://bsky.app/intent/compose?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening BlueSky...');
            unlockSocialAchievement();
        }
        
        function shareToMastodon() {
            const message = getShareMessage();
            const url = `https://mastodonshare.com/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            showToast('Opening Mastodon...');
            unlockSocialAchievement();
        }
        
        function unlockSocialAchievement() {
            if (!appData.achievements) appData.achievements = {};
            if (!appData.achievements['social']) {
                unlockAchievement('social');
            }
        }
        
        function copyShareMessage(silent = false) {
            const message = getShareMessage();
            navigator.clipboard.writeText(message).then(() => {
                if (!silent) {
                    showToast('üìã Copied to clipboard!');
                }
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = message;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                if (!silent) {
                    showToast('üìã Copied to clipboard!');
                }
            });
        }
        
        function shareNative() {
            const message = getShareMessage();
            
            if (navigator.share) {
                navigator.share({
                    title: 'üéÆ Daily Puzzle Results',
                    text: message
                }).catch((err) => {
                    if (err.name !== 'AbortError') {
                        copyShareMessage();
                    }
                });
            } else {
                copyShareMessage();
            }
        }
        
        // Bind clipboard prompt buttons (call after DOM ready)
        function bindClipboardButtons() {
            const yesBtn = document.getElementById('prompt-yes-btn');
            const noBtn = document.getElementById('prompt-no-btn');
            
            if (yesBtn) {
                yesBtn.onclick = function(e) {
                    e.preventDefault();
                    acceptClipboard();
                };
            }
            if (noBtn) {
                noBtn.onclick = function(e) {
                    e.preventDefault();
                    dismissClipboard();
                };
            }
        }
        
        // ============ ACCOUNT MODAL ============
        function openAccountModal() {
            const sheet = document.getElementById('account-sheet');
            const content = document.getElementById('modal-content');
            
            if (currentUser) {
                const initial = (currentUser.displayName || currentUser.email || '?')[0].toUpperCase();
                content.innerHTML = `
                    <div class="account-info">
                        <div class="account-avatar">${initial}</div>
                        <div class="account-name">${currentUser.displayName || 'Player'}</div>
                        <div class="account-email">${currentUser.email}</div>
                        <div class="sync-status">‚òÅÔ∏è Synced</div>
                        <button class="signout-btn" onclick="signOut()">Sign Out</button>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Sign In</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">Sync your progress across devices</div>
                        <button class="google-btn" onclick="signInWithGoogle()">
                            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            Continue with Google
                        </button>
                        <button style="margin-top: 12px; background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px;" onclick="closeAccountModal()">Maybe later</button>
                    </div>
                `;
            }
            
            sheet.classList.add('active');
        }
        
        function closeAccountModal() {
            document.getElementById('account-sheet').classList.remove('active');
        }
        
        // ============ TOAST ============
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast visible ' + type;
            
            // Play sounds for certain toast types
            if (type === 'error') {
                playSound('error');
            } else if (message.includes('coins') || message.includes('ü™ô')) {
                playSound('coin');
            }
            
            setTimeout(() => toast.classList.remove('visible'), 2500);
        }
        
        // ============ PWA / SERVICE WORKER ============
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js?v=0.4.9')
                .then(reg => console.log('SW registered'))
                .catch(e => console.log('SW registration failed:', e));
        }
        
        // ============ INSTALL BANNER ============
        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }
        
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function showInstallBanner() {
            // Don't show if already installed
            if (isStandalone()) {
                console.log('Already installed - skipping banner');
                return;
            }
            
            // Don't show if dismissed in last 24 hours
            const dismissed = localStorage.getItem('installBannerDismissed');
            if (dismissed && (Date.now() - parseInt(dismissed)) < 24 * 60 * 60 * 1000) {
                console.log('Banner dismissed recently - skipping');
                return;
            }
            
            const banner = document.getElementById('install-banner');
            const desc = document.getElementById('install-desc');
            
            if (isIOS()) {
                desc.innerHTML = 'Tap here, then "Add to Home Screen"';
            } else if (window.deferredPrompt) {
                desc.innerHTML = 'Tap to install the app';
            } else {
                desc.innerHTML = 'Tap here, then "Install" or "Add to Home"';
            }
            
            console.log('Showing install banner');
            banner.classList.add('visible');
        }
        
        function dismissInstallBanner(event) {
            if (event) {
                event.stopPropagation();
            }
            document.getElementById('install-banner').classList.remove('visible');
            localStorage.setItem('installBannerDismissed', Date.now().toString());
        }
        
        // Trigger native install/share dialog
        function triggerInstall() {
            // For Chrome/Android with beforeinstallprompt
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('Installing...');
                        dismissInstallBanner();
                    }
                    window.deferredPrompt = null;
                });
                return;
            }
            
            // For iOS - use Web Share API to open share sheet
            if (navigator.share) {
                navigator.share({
                    title: 'Game Shelf',
                    text: 'Track your daily puzzle games!',
                    url: window.location.href
                }).then(() => {
                    showToast('Tap "Add to Home Screen" in the menu');
                    dismissInstallBanner();
                }).catch((err) => {
                    // User cancelled or error - show manual instructions
                    if (err.name !== 'AbortError') {
                        showToast('Tap the share button ‚Üë then "Add to Home Screen"');
                    }
                });
            } else {
                // Fallback for browsers without share API
                showToast('Use your browser menu to "Add to Home Screen"');
            }
        }
        
        // Capture beforeinstallprompt for Chrome/Android
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            showInstallBanner();
        });
        
        // Handle share target (when app receives shared text)
        function handleShareTarget() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('share-target') === 'true') {
                // The share text would be in the POST body - need server for this
                // For now, just open log sheet
                setTimeout(openLogSheet, 500);
            }
            
            // Handle action=log shortcut
            if (params.get('action') === 'log') {
                setTimeout(openLogSheet, 300);
            }
        }
        
        // ============ INIT ============
        function init() {
            // VERSION CHECK - Log version prominently
            console.log('%cüéÆ GAME SHELF PWA v0.4.9-TEST üéÆ', 'background: #ff0000; color: white; font-size: 20px; padding: 10px;');
            console.log('%cBuild: Jan 16, 2026', 'color: #ff6600; font-size: 14px;');
            
            loadData();
            renderAll();
            handleShareTarget();
            bindClipboardButtons();
            loadUserBattles();
            
            // Load theme setting
            if (appData.settings?.theme) {
                setTheme(appData.settings.theme);
            }
            
            // Load sound setting (default to enabled)
            const soundToggle = document.getElementById('sound-toggle');
            if (soundToggle) {
                soundToggle.checked = appData.settings?.soundEnabled !== false;
            }
            
            // Check clipboard when app becomes visible
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    setTimeout(checkClipboard, 500);
                }
            });
            
            // Initial clipboard check (delayed)
            setTimeout(checkClipboard, 1500);
            
            // Show install banner after delay (unless already installed)
            setTimeout(showInstallBanner, 1500);
            
            console.log('üéÆ Game Shelf PWA v0.4.9 initialized');
            console.log('Standalone:', isStandalone(), 'iOS:', isIOS());
            console.log('Bottom sheets:', document.querySelectorAll('.bottom-sheet-overlay').length);
            
            // Debug: show version visibly on screen
            showToast('PWA v0.4.9 loaded');
        }
        
        init();
    </script>
</body>
</html>
